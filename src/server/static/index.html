<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDW 智能助手</title>
    <!-- 引入外部库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --bg-message-ai: #1e1e1e;
            --bg-message-user: linear-gradient(135deg, #4f46e5, #7c3aed);
            --bg-message-agent: linear-gradient(135deg, #059669, #0d9488);
            --border-color: #333333;
            --text-primary: #e5e5e5;
            --text-secondary: #888888;
            --accent-primary: #4f46e5;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --code-bg: #0d1117;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 15px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== 主页容器 ===== */
        .homepage-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            padding: 40px;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .homepage-container.slide-out {
            transform: translateY(-100%);
            opacity: 0;
        }

        .homepage-container.hidden {
            display: none;
        }

        .logo {
            font-size: 64px;
            font-weight: 300;
            color: #ffffff;
            letter-spacing: 8px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoGlow 3s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            0% { filter: drop-shadow(0 0 10px rgba(79, 70, 229, 0.3)); }
            100% { filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.6)); }
        }

        .search-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            margin-bottom: 40px;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 18px 70px 18px 28px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 30px;
            font-size: 18px;
            font-family: inherit;
            color: var(--text-primary);
            outline: none;
            resize: none;
            overflow-y: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 1.5;
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15), 0 8px 32px rgba(0, 0, 0, 0.4);
            text-align: left;
            border-radius: 20px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            text-align: center;
        }

        .search-input:focus::placeholder {
            text-align: left;
        }

        /* 输入建议样式 */
        .input-suggestions {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }

        .input-suggestions.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .suggestions-header {
            text-align: center;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            max-width: 100%;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }

        .suggestion-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.15);
        }

        .suggestion-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 为每个建议项添加延迟动画 */
        .suggestion-item:nth-child(1) { animation-delay: 0.1s; }
        .suggestion-item:nth-child(2) { animation-delay: 0.2s; }
        .suggestion-item:nth-child(3) { animation-delay: 0.3s; }
        .suggestion-item:nth-child(4) { animation-delay: 0.4s; }
        .suggestion-item:nth-child(5) { animation-delay: 0.5s; }
        .suggestion-item:nth-child(6) { animation-delay: 0.6s; }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }

        .search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        /* ===== 聊天容器系统 ===== */
        .chat-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: none;
            flex-direction: column;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-container.slide-in {
            animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInFromBottom {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 工作区模式：聊天容器变为左侧50% */
        .chat-container.workspace-mode {
            width: 50%;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-container.workspace-transition {
            animation: shrinkToLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes shrinkToLeft {
            from {
                width: 100%;
                background: var(--bg-primary);
            }
            to {
                width: 50%;
                background: var(--bg-secondary);
            }
        }

        /* 聊天头部 */
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .chat-container.workspace-mode .chat-header {
            background: #252525;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn, .session-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover, .session-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* 消息区域 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .chat-container.workspace-mode .chat-messages {
            padding: 20px;
            gap: 20px;
            background: var(--bg-secondary);
        }

        /* ===== 优化的用户消息样式 ===== */

        /* 用户消息容器基础样式 */
        .message.user {
            flex-direction: row-reverse;
            margin-bottom: 24px;
            animation: slideInFromRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            justify-content: flex-start;
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 用户头像优化 */
        .message.user .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .message.user .avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message.user .avatar:hover::before {
            opacity: 1;
        }

        .message.user .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* 用户消息内容容器 */
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 20px 20px 4px 20px;
            max-width: 70%;
            position: relative;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.5;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .message.user .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: inherit;
            pointer-events: none;
        }

        .message.user .message-content:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4),
                        0 0 0 1px rgba(102, 126, 234, 0.5),
                        0 0 25px rgba(102, 126, 234, 0.2);
        }

        /* 用户消息边框高亮效果 */
        .message.user .message-content::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, 
                rgba(102, 126, 234, 0.6), 
                rgba(118, 75, 162, 0.6),
                rgba(245, 87, 108, 0.6),
                rgba(102, 126, 234, 0.6)
            );
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            filter: blur(8px);
            animation: userBorderFlow 4s ease-in-out infinite;
        }

        .message.user .message-content:hover::after {
            opacity: 1;
        }

        @keyframes userBorderFlow {
            0%, 100% { 
                background-position: 0% 50%;
                filter: blur(8px);
            }
            50% { 
                background-position: 100% 50%;
                filter: blur(12px);
            }
        }

        /* 用户消息文本样式 */
        .message.user .message-content p {
            margin: 0;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 用户消息中的代码样式 */
        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
            color: #e8f4fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 用户消息中的链接样式 */
        .message.user .message-content a {
            color: #e8f4fd;
            text-decoration: underline;
            text-decoration-color: rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
        }

        .message.user .message-content a:hover {
            text-decoration-color: white;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        /* ===== 工作区模式下的用户消息优化 ===== */

        .chat-container.workspace-mode .message.user {
            justify-content: flex-end;
            margin-bottom: 0; /* 使用统一的message margin-bottom */
            padding: 0;
            background: transparent;
            border: none;
        }

        .chat-container.workspace-mode .message.user .avatar {
            display: none;
        }

        .chat-container.workspace-mode .message.user .user-message {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 14px 18px;
            border-radius: 18px 18px 4px 18px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 3px 12px rgba(79, 70, 229, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            margin-right: 12px; /* 为小尾巴留出空间 */
        }

        /* 用户消息右侧小尾巴 */
        .chat-container.workspace-mode .message.user .user-message::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid #6366f1;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 2;
        }

        /* 移除原有的before，用于边框高亮 */

        .chat-container.workspace-mode .message.user .user-message:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.5),
                        0 0 0 1px rgba(79, 70, 229, 0.6),
                        0 0 20px rgba(79, 70, 229, 0.3);
        }

        /* 工作区模式用户消息边框高亮（改为before避免与小尾巴冲突） */
        .chat-container.workspace-mode .message.user .user-message:hover::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, 
                rgba(79, 70, 229, 0.7), 
                rgba(124, 58, 237, 0.7),
                rgba(139, 92, 246, 0.7),
                rgba(79, 70, 229, 0.7)
            );
            border-radius: inherit;
            opacity: 1;
            z-index: -1;
            filter: blur(6px);
            animation: workspaceUserBorderGlow 3s ease-in-out infinite;
        }

        @keyframes workspaceUserBorderGlow {
            0%, 100% { 
                filter: blur(6px);
                transform: scale(1);
            }
            50% { 
                filter: blur(10px);
                transform: scale(1.02);
            }
        }

        /* 工作区模式下的代码样式 */
        .chat-container.workspace-mode .message.user .user-message code {
            background: rgba(255, 255, 255, 0.2);
            color: #ddd6fe;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* ===== 消息时间戳样式 ===== */
        .message.user .message-timestamp {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            text-align: right;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message.user:hover .message-timestamp {
            opacity: 1;
        }

        /* ===== 消息状态指示器 ===== */
        .message.user .status-indicator {
            position: absolute;
            bottom: 6px;
            right: 12px;
            font-size: 10px;
            opacity: 0.8;
        }

        .message.user .status-indicator.sent {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.user .status-indicator.delivered {
            color: #10b981;
        }

        .message.user .status-indicator.read {
            color: #3b82f6;
        }

        /* 消息样式 */
        .message {
            display: flex;
            padding: 0 24px;
            gap: 12px;
            margin-bottom: 20px; /* 统一消息间距 */
        }

        .chat-container.workspace-mode .message {
            padding: 0;
            margin-bottom: 18px; /* 工作区模式下稍小的间距 */
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.ai .avatar {
            background: #2a2a2a;
        }

        /* 工作区模式的AI消息样式 */
        .chat-container.workspace-mode .message.ai {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--accent-primary);
            position: relative;
            margin-left: 12px; /* 为小尾巴留出空间 */
        }

        /* AI消息左侧小尾巴 */
        .chat-container.workspace-mode .message.ai::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-right: 8px solid var(--bg-tertiary);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 1;
        }

        .chat-container.workspace-mode .message.ai .avatar {
            display: none;
        }

        /* Agent消息样式 - 添加强保护机制 */
        .message.agent {
            position: relative !important;
            margin: 16px 24px !important;
            border-radius: 12px !important;
            overflow: hidden !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            animation: slideInAgent 0.4s ease-out !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            /* 强制隔离，确保不被其他样式影响 */
            isolation: isolate !important;
            contain: layout style !important;
            z-index: 10 !important;
        }

        /* Agent消息悬停效果 */
        .message.agent:hover {
            transform: translateY(-2px) scale(1.01) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4) !important;
        }

        /* Agent消息边框高亮 */
        .message.agent::before {
            content: '' !important;
            position: absolute !important;
            inset: -1px !important;
            border-radius: inherit !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            z-index: -1 !important;
            filter: blur(6px) !important;
        }

        .message.agent:hover::before {
            opacity: 1 !important;
        }

        /* 不同类型Agent消息的边框高亮颜色 */
        .message.agent.page-switch::before {
            background: linear-gradient(45deg, rgba(79, 70, 229, 0.8), rgba(99, 102, 241, 0.8)) !important;
        }

        .message.agent.agent-handoff::before {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.8), rgba(139, 92, 246, 0.8)) !important;
        }

        .message.agent.tool-start::before {
            background: linear-gradient(45deg, rgba(8, 145, 178, 0.8), rgba(6, 182, 212, 0.8)) !important;
        }

        .message.agent.tool-end::before {
            background: linear-gradient(45deg, rgba(5, 150, 105, 0.8), rgba(16, 185, 129, 0.8)) !important;
        }

        .message.agent.code-found::before {
            background: linear-gradient(45deg, rgba(220, 38, 38, 0.8), rgba(239, 68, 68, 0.8)) !important;
        }

        .message.agent.code-error::before {
            background: linear-gradient(45deg, rgba(234, 88, 12, 0.8), rgba(249, 115, 22, 0.8)) !important;
        }

        .message.agent.code-update::before {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.8), rgba(168, 85, 247, 0.8)) !important;
        }

        .message.agent.agent-end::before {
            background: linear-gradient(45deg, rgba(22, 163, 74, 0.8), rgba(34, 197, 94, 0.8)) !important;
        }

        .chat-container.workspace-mode .message.agent {
            margin: 12px 0 12px 12px !important; /* 为小尾巴留出空间 */
            border-radius: 10px !important;
            max-width: 95% !important;
            align-self: flex-start !important;
            /* 工作区模式下也保持稳定 */
            isolation: isolate !important;
            contain: layout style !important;
        }

        /* Agent消息左侧小尾巴（使用after避免与before冲突） */
        .chat-container.workspace-mode .message.agent::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-right: 8px solid;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 2;
        }

        /* 不同类型Agent消息的小尾巴颜色 */
        .chat-container.workspace-mode .message.agent.page-switch::after {
            border-right-color: #4f46e5;
        }

        .chat-container.workspace-mode .message.agent.agent-handoff::after {
            border-right-color: #7c3aed;
        }

        .chat-container.workspace-mode .message.agent.tool-start::after {
            border-right-color: #0891b2;
        }

        .chat-container.workspace-mode .message.agent.tool-end::after {
            border-right-color: #059669;
        }

        .chat-container.workspace-mode .message.agent.code-found::after {
            border-right-color: #dc2626;
        }

        .chat-container.workspace-mode .message.agent.code-error::after {
            border-right-color: #ea580c;
        }

        .chat-container.workspace-mode .message.agent.code-update::after {
            border-right-color: #7c3aed;
        }

        .chat-container.workspace-mode .message.agent.agent-end::after {
            border-right-color: #16a34a;
        }

        @keyframes slideInAgent {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .agent-message-header {
            padding: 12px 16px !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            /* 防止内容溢出 */
            min-height: 44px !important;
            box-sizing: border-box !important;
        }

        .agent-message-content {
            padding: 14px 16px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            /* 防止内容影响布局 */
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }

        .agent-title {
            flex: 1 !important;
            /* 防止标题被压缩 */
            min-width: 0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .agent-time {
            margin-left: auto !important;
            font-size: 11px !important;
            opacity: 0.8 !important;
            /* 固定时间显示位置 */
            flex-shrink: 0 !important;
        }

        /* 不同类型的Agent消息样式 - 使用!important确保优先级 */
        .message.agent.page-switch {
            background: linear-gradient(135deg, #4f46e5, #6366f1) !important;
            color: white !important;
        }

        .message.agent.agent-handoff {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important;
            color: white !important;
        }

        .message.agent.tool-start {
            background: linear-gradient(135deg, #0891b2, #06b6d4) !important;
            color: white !important;
        }

        .message.agent.tool-end {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            color: white !important;
        }

        .message.agent.code-found {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            color: white !important;
        }

        .message.agent.code-error {
            background: linear-gradient(135deg, #ea580c, #f97316) !important;
            color: white !important;
        }

        .message.agent.code-update {
            background: linear-gradient(135deg, #7c3aed, #a855f7) !important;
            color: white !important;
        }

        .message.agent.agent-end {
            background: linear-gradient(135deg, #16a34a, #22c55e) !important;
            color: white !important;
        }

        .agent-icon {
            font-size: 16px !important;
            width: 24px !important;
            height: 24px !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* 流式消息特殊样式 */
        .message[data-message-type="stream"] {
            position: relative;
        }

        .message[data-message-type="stream"]::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: rgba(79, 70, 229, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message[data-message-type="stream"].streaming::before {
            opacity: 1;
        }

        /* 消息内容 */
        .message-content {
            max-width: 620px; /* 增加宽度 */
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.7;
            position: relative;
            padding: 16px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
        }

        .chat-container.workspace-mode .message-content {
            line-height: 1.6;
            color: #e5e5e5;
            flex: 1;
            max-width: 100%;
            background: rgba(42, 42, 42, 0.7);
        }

        /* AI消息内容悬停效果 - 精确定位 */
        .message.ai .message-content {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .message.ai .message-content:hover {
            transform: translateY(-2px) translateX(3px) scale(1.01);
            background: rgba(30, 30, 30, 0.9);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25),
                        0 0 0 1px rgba(79, 70, 229, 0.4),
                        0 0 25px rgba(79, 70, 229, 0.15);
        }

        /* AI消息内容边框高亮效果 */
        .message.ai .message-content::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(45deg, 
                rgba(79, 70, 229, 0.6), 
                rgba(124, 58, 237, 0.6),
                rgba(59, 130, 246, 0.6),
                rgba(79, 70, 229, 0.6)
            );
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: -1;
            filter: blur(8px);
            animation: aiBorderFlow 4s ease-in-out infinite;
        }

        .message.ai .message-content:hover::after {
            opacity: 1;
        }

        @keyframes aiBorderFlow {
            0%, 100% { 
                filter: blur(8px);
                background-position: 0% 50%;
            }
            50% { 
                filter: blur(12px);
                background-position: 100% 50%;
            }
        }

        /* 处理中状态 */
        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            margin: 0 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        .chat-container.workspace-mode .processing-indicator {
            margin: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .processing-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            color: var(--accent-primary);
            font-weight: 500;
        }

        /* ===== 思考框样式（只使用thinking-steps-content） ===== */
        .thinking-steps-content {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(79, 70, 229, 0.15));
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            margin: 20px auto; /* 居中显示 */
            width: 85%; /* 适中宽度 */
            max-width: 800px; /* 合适的最大宽度 */
            min-width: 320px;
            padding: 16px 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.15);
            position: relative;
            z-index: 10;
            animation: thinkingFadeIn 0.4s ease-out;
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.5;
        }

        @keyframes thinkingFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .thinking-status-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0 8px 0;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
            margin-bottom: 12px;
        }

        .thinking-status-text {
            font-weight: 600;
            color: #a855f7;
            font-size: 14px;
        }

        .thinking-detail-text {
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.5;
            min-height: 20px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .thinking-steps-content {
                width: 95%;
                min-width: 280px;
                margin: 16px auto;
                padding: 12px 16px;
            }
            
            .thinking-status-text {
                font-size: 13px;
            }
            
            .thinking-detail-text {
                font-size: 13px;
            }
        }

        .thinking-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #a855f7;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1.5s linear infinite;
        }

        /* 工作区模式下的思考框样式 */
        .chat-container.workspace-mode .thinking-steps-content {
            margin: 16px auto;
            width: 92%;
            max-width: 100%;
            z-index: 15; /* 确保在工作区模式下不被遮挡 */
        }

        .thinking-step {
            display: block; /* 改为flex布局 */
            padding: 16px 24px; /* 增加内边距 */
            margin: 12px 0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05); /* 稍微加深背景 */
            border-left: 4px solid rgba(124, 58, 237, 0.5); /* 加粗左边框 */
            transition: all 0.3s ease;
            opacity: 0.9; /* 提高透明度 */
            backdrop-filter: blur(8px);
        }

        .thinking-step:last-child {
            border-bottom: none;
        }

        .thinking-step.current {
            opacity: 1;
            background: rgba(124, 58, 237, 0.12);
            border-left-color: rgba(124, 58, 237, 0.8);
            border-left-width: 5px;
            transform: scale(1.01);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.3);
            animation: thinkingGlow 2s ease-in-out infinite alternate;
        }

        .thinking-step.completed {
            opacity: 0.9;
            background: rgba(16, 185, 129, 0.06);
            border-left-color: #10b981;
            color: #10b981;
        }

        .thinking-step.failed {
            opacity: 0.9;
            background: rgba(239, 68, 68, 0.06);
            border-left-color: #ef4444;
            color: #ef4444;
        }

        @keyframes thinkingGlow {
            from {
                box-shadow: 0 0 8px rgba(124, 58, 237, 0.2);
            }
            to {
                box-shadow: 0 0 16px rgba(124, 58, 237, 0.4);
            }
        }

        .thinking-step-icon {
            display: none; /* 隐藏左侧图标 */
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .thinking-step-text {
            font-size: 16px; /* 放大字体 */
            line-height: 1.6;
            font-weight: 600; /* 加粗字体 */
            color: #ffffff; /* 高亮显示 */
            margin-bottom: 8px;
        }

        .thinking-step-detail {
            font-size: 14px; /* 放大字体 */
            color: #e2e8f0; /* 更明亮的颜色 */
            margin-top: 6px;
            line-height: 1.5;
            opacity: 0.85;
        }

        .thinking-step.current .thinking-step-icon {
            animation: iconPulse 1s ease-in-out infinite;
        }

        .thinking-step.completed .thinking-step-icon {
            animation: none;
        }

        .thinking-step.failed .thinking-step-icon {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* 隐藏思考过程消息的动画 */
        .thinking-steps-content.hiding {
            animation: thinkingFadeOut 0.5s ease-in forwards;
        }

        @keyframes thinkingFadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px) scale(0.98);
                margin-top: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
                max-height: 0;
            }
        }

        /* 输入区域 */
        .chat-input-area {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-container.workspace-mode .chat-input-area {
            padding: 20px;
            background: var(--bg-secondary);
        }

        .input-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .input-wrapper:focus-within {
            border-color: #404040;
        }

        .chat-container.workspace-mode .input-wrapper {
            background: var(--bg-tertiary);
            border-radius: 25px;
            padding: 8px 16px;
            border: 1px solid #404040;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            max-height: 200px;
            font-family: inherit;
        }

        .chat-container.workspace-mode .chat-input {
            padding: 8px 12px;
            font-size: 14px;
        }

        .chat-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-button {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: var(--accent-primary);
            color: white;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-container.workspace-mode .send-button {
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
        }

        .chat-container.workspace-mode .send-button:hover {
            background: #4338ca;
        }
        
        /* 聊天输入建议样式 */
        .chat-input-suggestions {
            margin-top: 16px;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }
        
        .chat-input-suggestions.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        
        .chat-input-suggestions .suggestions-header {
            text-align: left;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        .chat-input-suggestions .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 8px;
        }
        
        .chat-input-suggestions .suggestion-item {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 13px;
        }
        
        .chat-input-suggestions .suggestion-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        
        .chat-input-suggestions .suggestion-icon {
            font-size: 14px;
        }
        
        /* 工作区模式下的建议样式 */
        .chat-container.workspace-mode .chat-input-suggestions {
            margin-top: 12px;
        }
        
        .chat-container.workspace-mode .chat-input-suggestions .suggestion-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
        }

        .workspace-actions {
            display: none;
            gap: 8px;
            margin-left: 10px;
        }

        .chat-container.workspace-mode .workspace-actions {
            display: flex;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #888888;
        }

        .action-btn:hover {
            background: #404040;
        }

        .model-info {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #888888;
            margin-top: 8px;
        }

        .chat-container.workspace-mode .model-info {
            display: flex;
        }

        /* ===== 代码面板 ===== */
        .code-panel {
            position: absolute;
            top: 0;
            right: -50%;
            width: 50%;
            height: 100%;
            background: var(--code-bg);
            display: none;
            flex-direction: column;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 40;
        }

        .code-panel.active {
            display: flex;
            right: 0;
            animation: slideInFromRight 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInFromRight {
            from {
                right: -50%;
                opacity: 0;
            }
            to {
                right: 0;
                opacity: 1;
            }
        }

        .code-panel-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 14px 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .language-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: #ffffff;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
        }

        .file-name {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        /* 新增：分支信息样式 */
        .branch-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(59, 130, 246, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .branch-icon {
            color: #3b82f6;
            font-size: 14px;
        }

        .branch-name {
            color: #3b82f6;
            font-size: 12px;
            font-weight: 500;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        .code-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modified-indicator {
            color: #f59e0b;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modified-indicator.show {
            opacity: 1;
        }

        .save-btn {
            padding: 6px 12px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .save-btn.show {
            opacity: 1;
        }

        .save-btn:hover {
            background: #2ea043;
        }

        .save-btn:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        .code-editor {
            flex: 1;
            background: var(--code-bg);
            color: #e6edf3;
            font-family: 'SFMono-Regular', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 20px;
            overflow-y: auto;
            border: none;
            outline: none;
            resize: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* ===== Markdown样式（全模式通用）===== */
        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin: 20px 0 12px 0;
            font-weight: 600;
            color: #ffffff;
        }

        .message-content h1 {
            font-size: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content h2 {
            font-size: 20px;
        }

        .message-content h3 {
            font-size: 18px;
        }

        .message-content p {
            margin: 12px 0;
        }

        .message-content ul,
        .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 6px 0;
        }

        .message-content li::marker {
            color: var(--accent-primary);
        }

        /* 工作区模式下的Markdown样式优化 */
        .chat-container.workspace-mode .message-content h1,
        .chat-container.workspace-mode .message-content h2,
        .chat-container.workspace-mode .message-content h3 {
            margin: 16px 0 10px 0;
            font-weight: 600;
            color: #ffffff;
        }

        .chat-container.workspace-mode .message-content h1 {
            font-size: 20px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-container.workspace-mode .message-content h2 {
            font-size: 18px;
        }

        .chat-container.workspace-mode .message-content h3 {
            font-size: 16px;
        }

        .chat-container.workspace-mode .message-content p {
            margin: 10px 0;
            line-height: 1.5;
        }

        .chat-container.workspace-mode .message-content ul,
        .chat-container.workspace-mode .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .chat-container.workspace-mode .message-content li {
            margin: 4px 0;
        }

        /* 代码块样式 */
        .message-content pre {
            background: var(--code-bg);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin: 16px 0;
            overflow: hidden;
            font-size: 14px;
        }

        .chat-container.workspace-mode .message-content pre {
            background: var(--code-bg);
            border: 1px solid #404040;
            border-radius: 6px;
            margin: 12px 0;
            overflow: hidden;
            font-size: 13px;
        }

        .code-header {
            background: #161b22;
            padding: 8px 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .code-lang {
            color: var(--accent-primary);
            font-weight: 500;
        }

        .copy-btn {
            background: transparent;
            border: 1px solid #30363d;
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .message-content pre code {
            display: block;
            padding: 16px;
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e6edf3;
        }

        .chat-container.workspace-mode .message-content pre code {
            display: block;
            padding: 12px;
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #e6edf3;
        }

        .message-content code:not(pre code) {
            background: rgba(110, 118, 129, 0.2);
            color: #79c0ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 13px;
        }

        .chat-container.workspace-mode .message-content code:not(pre code) {
            background: rgba(110, 118, 129, 0.3);
            color: #79c0ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 12px;
        }

        /* 强调文本 */
        .message-content strong {
            color: #ffffff;
            font-weight: 600;
        }

        .chat-container.workspace-mode .message-content strong {
            color: #ffffff;
            font-weight: 600;
        }

        .message-content em {
            font-style: italic;
            color: var(--text-secondary);
        }

        /* 链接样式 */
        .message-content a {
            color: #58a6ff;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .message-content a:hover {
            border-bottom-color: #58a6ff;
        }

        /* 引用块样式 */
        .message-content blockquote {
            border-left: 4px solid var(--accent-primary);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .chat-container.workspace-mode .message-content blockquote {
            border-left: 3px solid var(--accent-primary);
            padding-left: 12px;
            margin: 12px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* 表格样式 */
        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content th,
        .message-content td {
            padding: 10px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .message-content tr:last-child td {
            border-bottom: none;
        }

        .message-content tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* 分隔线 */
        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 24px 0;
        }

        /* 图片样式 */
        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }

        /* ===== 会话历史面板 ===== */
        .session-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .session-panel.open {
            right: 0;
        }

        .session-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }

        .session-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-session-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 18px;
        }

        .close-session-panel:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .session-item {
            background: var(--bg-tertiary);
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .session-item:hover {
            border-color: var(--accent-primary);
        }

        .session-item.active {
            border-color: var(--accent-primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .session-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .session-id {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .session-message-count {
            font-size: 11px;
            background: var(--accent-primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .session-last-activity {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .session-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .session-clear-btn {
            flex: 1;
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .session-clear-btn:hover {
            background: #b91c1c;
        }

        .session-load-btn {
            flex: 1;
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .session-load-btn:hover {
            background: #4338ca;
        }


        /* ===== 状态通知样式 ===== */
        .status-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .status-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .status-notification.success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-notification.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-notification.warning {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-notification.info {
            border-color: var(--accent-primary);
            background: rgba(79, 70, 229, 0.1);
            color: var(--accent-primary);
        }

        .status-notification.loading {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
            color: #06b6d4;
        }

        /* 加载动画 */
        .status-notification.loading #notificationMessage::before {
            content: "";
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* ===== 滚动条样式 ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }

        .code-panel ::-webkit-scrollbar-track {
            background: #161b22;
        }

        .code-panel ::-webkit-scrollbar-thumb {
            background: #30363d;
        }

        .code-panel ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* ===== 响应式设计 ===== */
        
        /* 大屏幕优化 (1200px以上) */
        @media (min-width: 1200px) {
            .message.thinking {
                max-width: min(80vw, 1000px); /* 大屏幕可以更宽 */
                margin: 24px auto;
            }

            .thinking-content {
                padding: 28px 36px;
                overflow: visible;
            }

            .thinking-step {
                padding: 18px 28px;
                margin: 14px 0;
                border-radius: 14px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 17px;
                margin-bottom: 10px;
            }

            .thinking-step-detail {
                font-size: 15px;
                margin-top: 8px;
            }
        }

        /* 中等屏幕优化 (769px - 1199px) */
        @media (min-width: 769px) and (max-width: 1199px) {
            .message.thinking {
                max-width: min(85vw, 900px);
                margin: 22px auto;
            }

            .thinking-content {
                padding: 26px 32px;
                overflow: visible;
            }

            .thinking-step {
                padding: 16px 24px;
                margin: 12px 0;
                border-radius: 13px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .thinking-step-detail {
                font-size: 14px;
                margin-top: 6px;
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 48px;
                margin-bottom: 30px;
            }

            .search-container {
                max-width: 100%;
                margin-bottom: 30px;
            }

            .search-input {
                font-size: 16px;
                padding: 16px 60px 16px 24px;
                min-height: 52px;
            }

            .suggestions-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .suggestion-item {
                padding: 14px 16px;
            }

            .suggestion-text {
                font-size: 13px;
            }

            .search-btn {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }

            .chat-container.workspace-mode,
            .code-panel.active {
                width: 100%;
                height: 50%;
            }

            .chat-container.workspace-mode {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .code-panel.active {
                top: 50%;
                right: 0;
                height: 50%;
            }

            .chat-messages {
                padding: 24px 0;
            }

            .message {
                padding: 0 16px;
            }

            .message-content {
                font-size: 14px;
            }

            .session-panel {
                width: 100%;
                right: -100%;
            }

            .status-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-100%);
            }

            .status-notification.show {
                transform: translateY(0);
            }

            .message.user .message-content {
                max-width: 85%;
                padding: 14px 16px;
                font-size: 14px;
                border-radius: 18px 18px 4px 18px;
            }

            .message.user .avatar {
                width: 32px;
                height: 32px;
                font-size: 16px;
                margin-left: 8px;
            }

            .chat-container.workspace-mode .message.user .user-message {
                max-width: 90%;
                padding: 12px 14px;
                font-size: 13px;
                border-radius: 16px 16px 4px 16px;
                margin-right: 10px;
            }

            .chat-container.workspace-mode .message.user .user-message::after {
                right: -7px;
                border-left-width: 7px;
                border-top-width: 5px;
                border-bottom-width: 5px;
            }

            /* 移动端思考框优化 */
            .message.thinking {
                max-width: min(95vw, 900px); /* 移动端使用更大的宽度 */
                margin: 16px auto;
                border-radius: 12px;
            }

            .thinking-header {
                padding: 12px 16px 10px;
            }

            .thinking-title {
                font-size: 13px;
            }

            .thinking-content {
                padding: 20px 24px;
                overflow: visible;
                min-height: 60px;
            }

            .thinking-step {
                padding: 14px 20px;
                margin: 10px 0;
                border-radius: 10px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 15px;
                line-height: 1.5;
                margin-bottom: 6px;
            }

            .thinking-step-detail {
                font-size: 13px;
                margin-top: 5px;
            }
        }

        @media (max-width: 480px) {
            .message.user .message-content {
                max-width: 90%;
                padding: 12px 14px;
                border-radius: 16px 16px 4px 16px;
            }

            .chat-container.workspace-mode .message.user .user-message {
                max-width: 95%;
                padding: 10px 12px;
                border-radius: 14px 14px 4px 14px;
                margin-right: 8px;
            }

            .chat-container.workspace-mode .message.user .user-message::after {
                right: -6px;
                border-left-width: 6px;
                border-top-width: 4px;
                border-bottom-width: 4px;
            }

            /* 小屏幕思考框进一步优化 */
            .message.thinking {
                max-width: 98vw; /* 小屏幕几乎全宽 */
                margin: 12px auto;
                border-radius: 10px;
            }

            .thinking-header {
                padding: 10px 12px 8px;
            }

            .thinking-title {
                font-size: 12px;
                gap: 6px;
            }

            .thinking-spinner {
                width: 14px;
                height: 14px;
            }

            .thinking-content {
                padding: 18px 22px;
                overflow: visible;
                min-height: 50px;
            }

            .thinking-step {
                padding: 12px 18px;
                margin: 8px 0;
                border-radius: 8px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 14px;
                line-height: 1.4;
                margin-bottom: 5px;
            }

            .thinking-step-detail {
                font-size: 12px;
                margin-top: 4px;
                opacity: 0.85;
            }
        }

        /* hljs覆盖 */
        .hljs {
            background: transparent !important;
            padding: 0 !important;
        }

        /* 工作区流式消息特殊处理 */
        .chat-container.workspace-mode .message[data-stream-isolated="true"] {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--accent-primary);
            margin-bottom: 20px;
        }

        .chat-container.workspace-mode .message[data-stream-isolated="true"] .avatar {
            display: none;
        }

        .chat-container.workspace-mode .message[data-stream-isolated="true"] .message-content {
            flex: 1;
            max-width: 100%;
            line-height: 1.6;
            color: #e5e5e5;
        }

        /* ===== 复制反馈动画 ===== */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* ===== 删除动画 ===== */
        @keyframes slideOutRight {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== 菜单项样式 ===== */
        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .menu-item:hover {
            background: var(--bg-tertiary);
        }

        /* ===== 聊天框内确认卡片样式 ===== */
        .message.confirm-card {
            padding: 0 24px !important;
            margin-bottom: 24px !important;
            animation: slideInFromLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .chat-container.workspace-mode .message.confirm-card {
            padding: 0 !important;
            margin-bottom: 20px !important;
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .confirm-card-content {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 480px;
            margin-left: 44px; /* 为AI头像留出空间 */
            position: relative;
        }

        .chat-container.workspace-mode .confirm-card-content {
            margin-left: 0;
            max-width: 100%;
        }

        .confirm-card-header {
            padding: 20px 20px 16px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .confirm-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .confirm-card-icon {
            font-size: 40px;
            margin-bottom: 8px;
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .confirm-card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 6px 0;
        }

        .confirm-card-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
        }

        .confirm-card-body {
            padding: 20px;
            text-align: center;
        }

        .confirm-card-message {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .file-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .confirm-card-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
            position: relative;
            overflow: hidden;
        }

        .confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .confirm-btn:hover::before {
            left: 100%;
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 3px 12px rgba(79, 70, 229, 0.3);
        }

        .confirm-btn-primary:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            transform: translateY(-1px);
        }

        .confirm-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .confirm-btn-secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .confirm-btn-loading {
            position: relative;
            color: transparent !important;
        }

        .confirm-btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 14px;
            height: 14px;
            margin: -7px 0 0 -7px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .confirm-card-content {
                margin-left: 36px;
            }
            
            .confirm-card-header {
                padding: 16px 16px 12px 16px;
            }
            
            .confirm-card-icon {
                font-size: 32px;
                margin-bottom: 6px;
            }
            
            .confirm-card-title {
                font-size: 16px;
            }
            
            .confirm-card-subtitle {
                font-size: 12px;
            }
            
            .confirm-card-body {
                padding: 16px;
            }
            
            .confirm-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .confirm-btn {
                min-width: auto;
                width: 100%;
            }
        }

        /* 文件信息显示样式 */
        .file-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 14px;
            color: #495057;
            line-height: 1.5;
        }

        .file-info strong {
            color: #212529;
            font-weight: 600;
        }
        
        /* ===== EDW相关样式 ===== */
        
        /* 进度条样式 */
        .progress-container {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 24px;
            border: 1px solid var(--border-color);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .progress-step {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .progress-percent {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .progress-bar-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--accent-color), #764ba2);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        
        /* 增强代码显示样式 */
        .message.enhanced-code,
        .message.refined-code,
        .message.original-code {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-color);
            margin: 16px 24px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .enhanced-code-header,
        .refined-code-header,
        .original-code-header {
            background: linear-gradient(135deg, var(--accent-color), #764ba2);
            color: white;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* 原始代码特殊样式 */
        .message.original-code {
            border-color: #10b981;
        }
        
        .original-code-header {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .code-meta-info {
            margin-top: 8px;
        }
        
        /* 隐藏元数据面板，信息已移到header */
        .code-meta-panel {
            display: none !important;
        }
        
        .message.enhanced-code pre,
        .message.refined-code pre,
        .message.original-code pre {
            margin: 0;
            padding: 16px;
            background: var(--bg-primary);
            overflow-x: auto;
        }
        
        .code-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .code-actions button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .code-actions button:hover {
            background: #5a52d5;
            transform: translateY(-1px);
        }
        
        
        /* 节点状态样式 */
        .node-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 12px;
            margin: 4px;
        }
        
        .node-status.processing {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .node-status.success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .node-status.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        /* SQL模态框样式 */
        .sql-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }
        
        .sql-modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .sql-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sql-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .sql-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .sql-modal-body pre {
            margin: 0;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .sql-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .sql-modal-footer button {
            padding: 8px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .sql-modal-footer button:first-child {
            background: var(--accent-color);
            color: white;
        }
        
        .sql-modal-footer button:first-child:hover {
            background: #5a52d5;
            transform: translateY(-1px);
        }
        
        .sql-modal-footer button:last-child {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .sql-modal-footer button:last-child:hover {
            background: var(--border-color);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* 代码标签页样式 */
        .code-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 16px;
            gap: 4px;
        }
        
        .code-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-size: 13px;
            position: relative;
            user-select: none;
        }
        
        .code-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        
        .code-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: var(--bg-primary);
        }
        
        .code-tab .tab-icon {
            font-size: 14px;
        }
        
        .code-tab .tab-text {
            font-weight: 500;
        }
        
        /* 标签内容区域 */
        .code-tab-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .tab-pane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
        }
        
        .tab-pane.active {
            display: flex;
            flex-direction: column;
        }
        
        /* 代码显示包装器 */
        .code-display-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
        }
        
        /* 代码工具栏 */
        .code-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(139, 148, 158, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .code-tool-btn {
            padding: 6px 14px;
            background: rgba(139, 148, 158, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(139, 148, 158, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .code-tool-btn:hover {
            background: rgba(139, 148, 158, 0.2);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        
        /* 代码显示区域 */
        .code-display {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .code-display pre {
            margin: 0;
            padding: 20px;
            background: transparent;
            min-height: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .code-display pre code {
            display: block;
            background: transparent;
            color: #e6edf3;
            padding: 0;
            border-radius: 0;
            white-space: pre;
            word-wrap: normal;
            overflow-x: auto;
        }
        
        /* 行号样式 */
        .code-display pre.line-numbers {
            counter-reset: line;
            padding-left: 60px;
            position: relative;
        }
        
        .code-display pre.line-numbers code {
            counter-increment: line;
        }
        
        .code-display pre.line-numbers::before {
            content: counter(line);
            display: inline-block;
            width: 40px;
            text-align: right;
            margin-right: 16px;
            color: rgba(139, 148, 158, 0.4);
            position: absolute;
            left: 16px;
        }
        
        /* 编辑模式的textarea */
        .code-editor-raw {
            width: 100%;
            height: 100%;
            border: none;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: #0d1117;
            color: #e6edf3;
            resize: none;
            outline: none;
            overflow-y: auto;
        }
        
        /* 语法高亮增强 */
        .hljs {
            background: transparent !important;
            padding: 0 !important;
        }
        
        .hljs-keyword {
            color: #ff79c6;
            font-weight: bold;
        }
        
        .hljs-string {
            color: #f1fa8c;
        }
        
        .hljs-comment {
            color: #6272a4;
            font-style: italic;
        }
        
        .hljs-number {
            color: #bd93f9;
        }
        
        .hljs-function {
            color: #50fa7b;
        }
        
        .hljs-variable {
            color: #8be9fd;
        }
        
        .hljs-type {
            color: #ff79c6;
        }
        
        /* 调整代码面板布局以适应标签页 */
        #codePanel {
            display: flex;
            flex-direction: column;
        }
        
        #codePanel .code-panel-header {
            flex-shrink: 0;
        }
        
        #codePanel .code-tabs {
            flex-shrink: 0;
        }
        
        #codePanel .code-tab-content {
            flex: 1;
            min-height: 0;
        }
    </style>
</head>
<body>

<!-- 主页 -->
<div class="homepage-container" id="homepage">
    <div class="logo">Turing</div>
    <div class="search-container">
        <div class="search-input-wrapper">
            <textarea class="search-input" id="searchInput" placeholder="嗨！我是 Turing，有什么可以帮助你的？" rows="1"></textarea>
            <button class="search-btn" id="searchBtn">➤</button>
        </div>
        
        <!-- 输入建议 -->
        <div class="input-suggestions" id="inputSuggestions">
            <div class="suggestions-header">💡 试试这些问题</div>
            <div class="suggestions-grid">
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">📊</span>
                    <span class="suggestion-text">帮我分析销售数据表的字段结构</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">🔧</span>
                    <span class="suggestion-text">为用户表添加新的业务字段</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">📈</span>
                    <span class="suggestion-text">优化财务报表的查询性能</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">🎯</span>
                    <span class="suggestion-text">创建客户画像分析模型</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">💰</span>
                    <span class="suggestion-text">生成订单金额统计代码</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">🔍</span>
                    <span class="suggestion-text">帮我检查数据质量问题</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 聊天容器 -->
<div class="chat-container" id="chatContainer">
    <!-- 头部 -->
    <div class="chat-header">
        <div class="chat-title">
            <span id="chatTitle">与 Turing 对话</span>
            <div class="session-info" id="sessionInfo">
                <span>💬</span>
                <span id="sessionMessageCount">新会话</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="session-btn" onclick="toggleSessionPanel()">
                📚 历史
            </button>
            <button class="back-btn" onclick="goBackToHomepage()">
                ← 返回主页
            </button>
        </div>
    </div>

    <!-- 消息区域 -->
    <div class="chat-messages" id="chatMessages">
        <!-- 初始欢迎消息 -->
        <div class="message ai" data-message-type="static" data-stable="true">
            <div class="avatar">🤖</div>
            <div class="message-content">
                <p>您好！我是 <strong>Turing</strong>，问你想问。</p>
            </div>
        </div>
    </div>

    <!-- 输入区域 -->
    <div class="chat-input-area">
        <div class="input-wrapper">
            <textarea
                    class="chat-input"
                    id="chatInput"
                    placeholder="输入消息..."
                    rows="1"
            ></textarea>
            <div class="workspace-actions">
                <button class="action-btn" onclick="uploadFiles()">📎</button>
                <button class="action-btn">🔍</button>
            </div>
            <button class="send-button" id="sendBtn" onclick="sendMessage()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
        
        <!-- 聊天输入建议 -->
        <div class="chat-input-suggestions" id="chatInputSuggestions">
            <div class="suggestions-header">💡 快速输入</div>
            <div class="suggestions-grid">
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">📊</span>
                    <span class="suggestion-text">帮我分析销售数据表的字段结构</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">🔧</span>
                    <span class="suggestion-text">为用户表添加新的业务字段</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">📈</span>
                    <span class="suggestion-text">优化订单表的查询性能</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">🔍</span>
                    <span class="suggestion-text">检查数据质量问题并生成报告</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">🏗️</span>
                    <span class="suggestion-text">设计一个新的数据模型</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">⚡</span>
                    <span class="suggestion-text">批量更新表字段的业务逻辑</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 代码面板 -->
<div class="code-panel" id="codePanel">
    <div class="code-panel-header">
        <div class="file-info">
            <div class="language-tag" id="languageTag">代码</div>
            <div class="file-name" id="fileName">请在左侧描述你的需求...</div>
            <div class="branch-info" id="branchInfo" style="display: none;">
                <span class="branch-icon">🌿</span>
                <span class="branch-name" id="branchName">未知分支</span>
            </div>
        </div>
        <div class="code-actions">
            <div class="modified-indicator" id="modifiedIndicator">已修改</div>
            <button class="save-btn" id="saveBtn" onclick="saveCode()">💾 保存</button>
        </div>
    </div>
    
    <!-- 标签页导航 -->
    <div class="code-tabs" id="codeTabs">
        <div class="code-tab active" data-tab="enhanced-code" onclick="switchCodeTab('enhanced-code')">
            <span class="tab-icon">📝</span>
            <span class="tab-text">增强代码</span>
        </div>
        <div class="code-tab" data-tab="create-table" onclick="switchCodeTab('create-table')">
            <span class="tab-icon">🔨</span>
            <span class="tab-text">CREATE TABLE</span>
        </div>
        <div class="code-tab" data-tab="alter-table" onclick="switchCodeTab('alter-table')">
            <span class="tab-icon">🔧</span>
            <span class="tab-text">ALTER TABLE</span>
        </div>
    </div>
    
    <!-- 文件元数据信息区域 -->
    <div class="code-meta-panel" id="codeMetaPanel" style="display: none;">
        <div class="meta-info-row">
            <span class="meta-label">📁 文件:</span>
            <span class="meta-value" id="metaFileName">未知文件</span>
        </div>
        <div class="meta-info-row">
            <span class="meta-label">🌿 分支:</span>
            <span class="meta-value" id="metaBranch">未知分支</span>
        </div>
        <div class="meta-info-row" id="metaBaseTablesRow" style="display: none;">
            <span class="meta-label">📊 底表:</span>
            <span class="meta-value" id="metaBaseTables"></span>
        </div>
    </div>

    <!-- 标签页内容区域 -->
    <div class="code-tab-content" id="codeTabContent">
        <!-- 增强代码标签页 -->
        <div class="tab-pane active" data-pane="enhanced-code">
            <div class="code-display-wrapper">
                <div class="code-toolbar">
                    <button class="code-tool-btn" onclick="copyCodeContent('enhanced')">📋 复制</button>
                    <button class="code-tool-btn" onclick="toggleFullscreen('enhanced')">🔍 全屏</button>
                    <button class="code-tool-btn" onclick="toggleEditMode('enhanced')">✏️ 编辑</button>
                </div>
                <div class="code-display" id="enhancedCodeDisplay">
                    <pre class="line-numbers"><code class="language-sql" id="enhancedCodeContent">-- 欢迎使用数据开发助手！
-- 请在左侧描述你的需求，我将为你生成相应的代码
-- 增强代码将在这里显示...</code></pre>
                </div>
                <textarea class="code-editor-raw" id="codeEditor" style="display:none;" placeholder="编辑模式下可修改代码..."></textarea>
            </div>
        </div>
        
        <!-- CREATE TABLE标签页 -->
        <div class="tab-pane" data-pane="create-table">
            <div class="code-display-wrapper">
                <div class="code-toolbar">
                    <button class="code-tool-btn" onclick="copyCodeContent('create')">📋 复制</button>
                    <button class="code-tool-btn" onclick="toggleFullscreen('create')">🔍 全屏</button>
                </div>
                <div class="code-display" id="createTableDisplay">
                    <pre class="line-numbers"><code class="language-sql" id="createTableContent">-- CREATE TABLE 语句将在这里显示
-- 等待生成增强代码...</code></pre>
                </div>
                <textarea class="code-editor-raw" id="createTableEditor" style="display:none;"></textarea>
            </div>
        </div>
        
        <!-- ALTER TABLE标签页 -->
        <div class="tab-pane" data-pane="alter-table">
            <div class="code-display-wrapper">
                <div class="code-toolbar">
                    <button class="code-tool-btn" onclick="copyCodeContent('alter')">📋 复制</button>
                    <button class="code-tool-btn" onclick="toggleFullscreen('alter')">🔍 全屏</button>
                </div>
                <div class="code-display" id="alterTableDisplay">
                    <pre class="line-numbers"><code class="language-sql" id="alterTableContent">-- ALTER TABLE 语句将在这里显示
-- 等待生成增强代码...</code></pre>
                </div>
                <textarea class="code-editor-raw" id="alterTableEditor" style="display:none;"></textarea>
            </div>
        </div>
    </div>
</div>

<!-- 会话历史面板 -->
<div class="session-panel" id="sessionPanel">
    <div class="session-panel-header">
        <div class="session-panel-title">💬 会话历史</div>
        <button class="close-session-panel" onclick="toggleSessionPanel()">×</button>
    </div>
    <div class="session-list" id="sessionList">
        <!-- 会话列表将动态加载 -->
    </div>
</div>


<!-- 状态通知 -->
<div class="status-notification" id="statusNotification">
    <span id="notificationMessage"></span>
</div>


<script>
    // ===== 全局变量 =====
    let selectedModule = null;
    let currentFile = null;
    let originalCode = '';
    let isCodeModified = false;
    let currentPage = 'homepage'; // 'homepage', 'chat', 'workspace'
    let currentMode = 'chat';
    let currentSessionId = null;
    let sessionPanelOpen = false;
    let pendingUserInput = '';
    let isProcessing = false; // 防止重复发送

    // SocketIO相关变量
    let socket = null;
    let socketConnected = false;

    // 消息去重和保护
    let processedMessages = new Set();
    let agentMessageRegistry = new Map(); // 保护Agent消息注册表

    // 添加处理状态管理
    const messageProcessingStates = new Map();

    // 确认卡片状态管理
    let isUpdateCodeCardVisible = false;
    let isRunCodeCardVisible = false;
    let pendingUpdateAction = null;
    let pendingRunAction = null;
    
    // 模型增强完成信息缓存
    let pendingEnhanceInfo = null;
    
    // 思考框状态管理
    let thinkingBoxVisible = false;
    let thinkingSteps = new Map(); // 存储思考步骤状态
    let currentThinkingMessageId = null; // 当前思考消息的ID
    
    // ===== 统一消息管理系统 =====
    /**
     * 消息类型枚举
     */
    const MessageType = {
        USER: 'user',              // 用户输入消息
        AI_STREAM: 'ai_stream',    // chat_stream API响应
        THINKING: 'thinking',      // 思考框消息
        SYSTEM: 'system',          // 后端主动推送的系统消息
        AGENT: 'agent'             // Agent实时消息
    };
    
    /**
     * 消息管理器类 - 统一管理所有消息和思考框生命周期
     */
    class MessageManager {
        constructor() {
            this.messages = new Map();
            this.thinkingState = {
                visible: false,
                messageId: null,
                streamSessionId: null,  // 关联的stream会话ID
                startTime: null,
                timeout: null
            };
            this.messageOrder = [];  // 维护消息顺序
        }
        
        /**
         * 添加消息到容器
         */
        addMessage(type, content, options = {}) {
            const messageId = this.generateMessageId(type);
            const messageData = {
                id: messageId,
                type: type,
                content: content,
                timestamp: Date.now(),
                ...options
            };
            
            this.messages.set(messageId, messageData);
            this.messageOrder.push(messageId);
            
            // 根据消息类型选择渲染方式
            switch(type) {
                case MessageType.USER:
                    return this.renderUserMessage(messageData);
                case MessageType.AI_STREAM:
                    return this.renderStreamMessage(messageData);
                case MessageType.THINKING:
                    return this.renderThinkingBox(messageData);
                case MessageType.SYSTEM:
                    return this.renderSystemMessage(messageData);
                case MessageType.AGENT:
                    return this.renderAgentMessage(messageData);
                default:
                    console.warn('未知消息类型:', type);
                    return null;
            }
        }
        
        /**
         * 开始思考框显示
         */
        startThinking(sessionId) {
            // 如果已有思考框在显示，先结束它
            if (this.thinkingState.visible) {
                console.log('🔄 结束之前的思考框，开始新的');
                this.endThinking();
            }
            
            console.log('🧠 开始显示思考框，sessionId:', sessionId);
            
            const messageId = this.generateMessageId(MessageType.THINKING);
            
            this.thinkingState = {
                visible: true,
                messageId: messageId,
                streamSessionId: sessionId,
                startTime: Date.now(),
                timeout: setTimeout(() => {
                    console.warn('⏰ 思考框超时，自动隐藏');
                    this.endThinking();
                }, 60000)  // 60秒超时
            };
            
            // 创建思考框DOM
            const messagesContainer = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = messageId;
            thinkingDiv.className = 'thinking-steps-content';
            thinkingDiv.innerHTML = `
                <div class="thinking-status-line">
                    <div class="thinking-spinner"></div>
                    <div class="thinking-status-text">AI正在思考...</div>
                </div>
                <div class="thinking-detail-text"></div>
            `;
            
            // 添加到容器末尾
            messagesContainer.appendChild(thinkingDiv);
            
            // 更新全局状态（为了兼容旧代码）
            thinkingBoxVisible = true;
            currentThinkingMessageId = messageId;
            
            // 滚动到底部
            this.scrollToBottom();
            
            return messageId;
        }
        
        /**
         * 结束思考框显示
         */
        endThinking(force = false) {
            if (!this.thinkingState.visible && !force) {
                console.log('⚠️ 思考框已经隐藏');
                return;
            }
            
            console.log('🧠 结束思考框显示');
            
            // 清理超时定时器
            if (this.thinkingState.timeout) {
                clearTimeout(this.thinkingState.timeout);
            }
            
            // 移除思考框DOM
            const thinkingBox = document.getElementById(this.thinkingState.messageId);
            if (thinkingBox) {
                thinkingBox.classList.add('hiding');
                setTimeout(() => {
                    thinkingBox.remove();
                }, 500);
            }
            
            // 重置状态
            this.thinkingState = {
                visible: false,
                messageId: null,
                streamSessionId: null,
                startTime: null,
                timeout: null
            };
            
            // 更新全局状态（为了兼容旧代码）
            thinkingBoxVisible = false;
            currentThinkingMessageId = null;
            thinkingSteps.clear();
        }
        
        /**
         * 更新思考框进度
         */
        updateThinkingProgress(stepId, status, message) {
            if (!this.thinkingState.visible || !this.thinkingState.messageId) {
                console.warn('⚠️ 思考框不可见，无法更新进度');
                return;
            }
            
            const thinkingBox = document.getElementById(this.thinkingState.messageId);
            if (!thinkingBox) return;
            
            const statusText = thinkingBox.querySelector('.thinking-status-text');
            const detailText = thinkingBox.querySelector('.thinking-detail-text');
            
            if (statusText) {
                statusText.textContent = message || 'AI正在思考...';
            }
            
            if (detailText && status !== 'completed') {
                detailText.textContent = `${stepId}: ${status}`;
            }
        }
        
        /**
         * 生成消息ID
         */
        generateMessageId(type) {
            return `${type}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
        }
        
        /**
         * 渲染用户消息
         */
        renderUserMessage(messageData) {
            return addUserMessage(messageData.content, messageData);
        }
        
        /**
         * 渲染流式消息
         */
        renderStreamMessage(messageData) {
            return addStreamMessage(messageData.content, 'ai');
        }
        
        /**
         * 渲染系统消息
         */
        renderSystemMessage(messageData) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.setAttribute('data-message-type', 'system');
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="system-message-content">${messageData.content}</div>
                </div>
            `;
            
            // 插入到思考框前面
            this.insertBeforeThinking(messageDiv, messagesContainer);
            this.scrollToBottom();
            
            return messageData.id;
        }
        
        /**
         * 渲染Agent消息
         */
        renderAgentMessage(messageData) {
            // 使用现有的Agent消息处理逻辑
            return this.renderSystemMessage(messageData);
        }
        
        /**
         * 在思考框前插入消息
         */
        insertBeforeThinking(element, container) {
            if (this.thinkingState.visible && this.thinkingState.messageId) {
                const thinkingBox = document.getElementById(this.thinkingState.messageId);
                if (thinkingBox && thinkingBox.parentNode === container) {
                    container.insertBefore(element, thinkingBox);
                    console.log('📍 消息插入到思考框前面');
                    return true;
                }
            }
            
            // 思考框不存在，正常添加到末尾
            container.appendChild(element);
            return false;
        }
        
        /**
         * 滚动到底部
         */
        scrollToBottom() {
            requestAnimationFrame(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTo({
                        top: messagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            });
        }
        
        /**
         * 检查是否为当前stream会话的思考框
         */
        isCurrentStreamThinking(sessionId) {
            return this.thinkingState.visible && 
                   this.thinkingState.streamSessionId === sessionId;
        }
        
        /**
         * 清理过期消息
         */
        cleanupOldMessages() {
            const maxMessages = 1000;
            if (this.messageOrder.length > maxMessages) {
                const toRemove = this.messageOrder.splice(0, this.messageOrder.length - maxMessages);
                toRemove.forEach(id => this.messages.delete(id));
                console.log('🧹 清理了', toRemove.length, '条过期消息');
            }
        }
    }
    
    // 创建全局消息管理器实例
    const messageManager = new MessageManager();
    
    /**
     * 保存等待中的增强信息
     * @param {Object} codeInfo - 代码信息
     */
    function savePendingEnhanceInfo(codeInfo) {
        console.log('💾 保存待处理增强信息:', codeInfo);
        pendingEnhanceInfo = {
            ...codeInfo,
            timestamp: Date.now()
        };
    }
    
    /**
     * 检查并处理待处理的增强信息
     */
    function checkPendingEnhanceInfo() {
        if (pendingEnhanceInfo) {
            console.log('🔍 检测到待处理增强信息，检查是否显示卡片');
            checkAndShowUpdateWorkflow(pendingEnhanceInfo);
            // 清理已处理的信息
            pendingEnhanceInfo = null;
        }
    }

    // ===== 页面切换管理 =====
    function switchToChatMode() {
        const homepage = document.getElementById('homepage');
        const chatContainer = document.getElementById('chatContainer');

        currentPage = 'chat';

        // 隐藏主页，显示聊天界面
        homepage.classList.add('slide-out');
        chatContainer.classList.add('active', 'slide-in');

        setTimeout(() => {
            homepage.classList.add('hidden');
        }, 600);

        // 重置聊天建议状态（初次进入聊天时可以显示建议）
        if (chatSuggestionsPermanentlyHidden === undefined) {
            chatSuggestionsPermanentlyHidden = false;
        }

        // 加载会话历史
        loadSessionHistory();

        // 聚焦输入框
        document.getElementById('chatInput').focus();

        console.log('📱 切换到聊天模式');
    }

    function switchToWorkspaceMode(mode) {
        const chatContainer = document.getElementById('chatContainer');
        const codePanel = document.getElementById('codePanel');
        const chatTitle = document.getElementById('chatTitle');

        currentPage = 'workspace';
        currentMode = mode;

        // 更新标题
        if (mode === 'enhance') {
            chatTitle.textContent = '🚀 增强模型';
        } else if (mode === 'new') {
            chatTitle.textContent = '✨ 新增模型';
        }

        // 聊天容器变为工作区模式
        chatContainer.classList.add('workspace-mode', 'workspace-transition');

        // 显示代码面板
        codePanel.classList.add('active');

        // 初始化工作区
        initializeWorkspace(mode);

        console.log('📱 切换到工作区模式:', mode);
        showSuccess(`已切换到${mode === 'enhance' ? '模型增强' : '新增模型'}工作区`, 2000);
    }

    function goBackToHomepage() {
        // 离开SocketIO房间
        if (currentSessionId && socket && socketConnected) {
            leaveSession(currentSessionId);
        }

        const homepage = document.getElementById('homepage');
        const chatContainer = document.getElementById('chatContainer');
        const codePanel = document.getElementById('codePanel');

        currentPage = 'homepage';

        // 重置聊天容器状态
        chatContainer.classList.remove('active', 'slide-in', 'workspace-mode', 'workspace-transition');
        codePanel.classList.remove('active');

        // 显示主页
        homepage.classList.remove('slide-out', 'hidden');

        // 清理状态
        currentSessionId = null;
        pendingUserInput = '';
        isProcessing = false;

        // 清理确认卡片状态
        isUpdateCodeCardVisible = false;
        isRunCodeCardVisible = false;
        pendingUpdateAction = null;
        pendingRunAction = null;
        pendingEnhanceInfo = null; // 清理待处理增强信息
        
        // 隐藏思考框
        if (thinkingBoxVisible) {
            hideThinkingBox();
        }
        
        // 清理卡片ID
        window.currentUpdateCardId = null;
        window.currentRunCardId = null;

        // 清空消息（保留欢迎消息）
        const messagesContainer = document.getElementById('chatMessages');
        const welcomeMessage = messagesContainer.querySelector('.message.ai[data-stable="true"]');
        messagesContainer.innerHTML = '';
        if (welcomeMessage) {
            messagesContainer.appendChild(welcomeMessage);
        }

        // 清理注册表
        agentMessageRegistry.clear();

        // 清空输入框
        document.getElementById('chatInput').value = '';
        document.getElementById('searchInput').value = '';

        // 重置会话状态
        updateSessionInfo();

        // 关闭会话面板
        if (sessionPanelOpen) {
            toggleSessionPanel();
        }

        // 启用搜索按钮
        const searchBtn = document.getElementById('searchBtn');
        searchBtn.disabled = false;

        // 聚焦搜索框
        document.getElementById('searchInput').focus();

        // 重新显示首页建议
        checkSuggestionsVisibility();
        
        // 重置聊天建议状态，下次进入聊天时可以显示
        chatSuggestionsPermanentlyHidden = false;

        console.log('🏠 已返回主页');
    }

    // ===== 增强的用户消息处理函数 =====

    /**
     * 优化的添加用户消息函数
     * @param {string} content - 消息内容
     * @param {Object} options - 消息选项
     */
    function addUserMessage(content, options = {}) {
        const {
            showTyping = true,        // 是否显示打字动画
            showTimestamp = true,     // 是否显示时间戳
            highlight = false,        // 是否高亮显示
            messageType = 'normal'    // 消息类型: normal, code, quote, long
        } = options;

        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');

        // 生成唯一ID
        const messageId = `user-msg-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
        messageDiv.id = messageId;

        // 设置基础类名
        let className = 'message user';

        // 根据消息类型添加特殊类
        if (content.length > 200) className += ' long-message';
        if (content.includes('```') || content.includes('`')) className += ' has-code';
        if (content.startsWith('>')) className += ' quote';
        if (highlight) className += ' highlight';
        if (showTyping) className += ' typing';

        messageDiv.className = className;
        messageDiv.setAttribute('data-message-type', 'user');
        messageDiv.setAttribute('data-timestamp', Date.now());

        // 处理消息内容
        const processedContent = preprocessUserMessage(content);

        // 创建消息结构
        if (currentPage === 'workspace') {
            messageDiv.innerHTML = createWorkspaceUserMessage(processedContent, showTimestamp);
        } else {
            messageDiv.innerHTML = createNormalUserMessage(processedContent, showTimestamp);
        }

        // 使用智能插入函数，确保思考框始终在底部
        insertMessageBeforeThinking(messageDiv, messagesContainer);

        // 添加交互效果
        enhanceUserMessageInteractions(messageDiv);

        // 平滑滚动
        requestAnimationFrame(() => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        });

        // 移除打字动画
        if (showTyping) {
            setTimeout(() => {
                messageDiv.classList.remove('typing');
            }, 500);
        }

        // 移除高亮效果
        if (highlight) {
            setTimeout(() => {
                messageDiv.classList.remove('highlight');
            }, 1500);
        }

        console.log('✨ 添加优化用户消息:', messageId);
        return messageId;
    }

    /**
     * 预处理用户消息内容
     */
    function preprocessUserMessage(content) {
        // 转义HTML
        let processed = escapeHtml(content);

        // 处理代码块
        processed = processed.replace(/```([\s\S]*?)```/g, (match, code) => {
            return `<pre><code>${code.trim()}</code></pre>`;
        });

        // 处理行内代码
        processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');

        // 处理链接
        processed = processed.replace(
            /(https?:\/\/[^\s]+)/g,
            '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
        );

        // 处理换行
        processed = processed.replace(/\n/g, '<br>');

        return processed;
    }

    /**
     * 创建普通模式用户消息
     */
    function createNormalUserMessage(content, showTimestamp) {
        const timestamp = showTimestamp ?
            `<div class="message-timestamp">${new Date().toLocaleTimeString()}</div>` : '';

        return `
            <div class="avatar">
                <span style="
                    background: linear-gradient(45deg, #ffffff, #f0f0f0);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    font-weight: bold;
                ">👤</span>
            </div>
            <div class="message-content">
                <p>${content}</p>
                ${timestamp}
                <div class="status-indicator sent">✓</div>
            </div>
        `;
    }

    /**
     * 创建工作区模式用户消息
     */
    function createWorkspaceUserMessage(content, showTimestamp) {
        const timestamp = showTimestamp ?
            `<div class="message-timestamp">${new Date().toLocaleTimeString()}</div>` : '';

        return `
            <div class="user-message">
                ${content}
                ${timestamp}
                <div class="status-indicator sent">✓</div>
            </div>
        `;
    }

    /**
     * 增强用户消息交互效果
     */
    function enhanceUserMessageInteractions(messageDiv) {
        // 添加悬停效果
        messageDiv.addEventListener('mouseenter', () => {
            const messageContent = messageDiv.querySelector('.message-content, .user-message');
            if (messageContent) {
                messageContent.style.transform = 'translateY(-2px)';
            }
        });

        messageDiv.addEventListener('mouseleave', () => {
            const messageContent = messageDiv.querySelector('.message-content, .user-message');
            if (messageContent) {
                messageContent.style.transform = 'translateY(0)';
            }
        });

        // 添加点击复制功能
        messageDiv.addEventListener('click', (e) => {
            if (e.detail === 2) { // 双击
                copyMessageContent(messageDiv);
            }
        });

        // 添加长按菜单（移动端）
        let pressTimer = null;

        messageDiv.addEventListener('touchstart', (e) => {
            pressTimer = setTimeout(() => {
                showMessageContextMenu(messageDiv, e.touches[0]);
            }, 500);
        });

        messageDiv.addEventListener('touchend', () => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        });

        messageDiv.addEventListener('touchmove', () => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        });
    }

    /**
     * 复制消息内容
     */
    function copyMessageContent(messageDiv) {
        const content = messageDiv.querySelector('.message-content p, .user-message');
        if (content) {
            const text = content.textContent || content.innerText;

            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(messageDiv);
                showSuccess('消息已复制到剪贴板', 1500);
            }).catch(() => {
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                showCopyFeedback(messageDiv);
                showSuccess('消息已复制到剪贴板', 1500);
            });
        }
    }

    /**
     * 显示复制反馈效果
     */
    function showCopyFeedback(messageDiv) {
        const feedback = document.createElement('div');
        feedback.className = 'copy-feedback';
        feedback.textContent = '已复制';
        feedback.style.cssText = `
            position: absolute;
            top: -30px;
            right: 10px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        `;

        messageDiv.style.position = 'relative';
        messageDiv.appendChild(feedback);

        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 2000);
    }

    /**
     * 显示消息上下文菜单
     */
    function showMessageContextMenu(messageDiv, touch) {
        const menu = document.createElement('div');
        menu.className = 'message-context-menu';
        menu.style.cssText = `
            position: fixed;
            top: ${touch.clientY - 10}px;
            left: ${touch.clientX - 50}px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 120px;
        `;

        menu.innerHTML = `
            <div class="menu-item" onclick="copyMessageContent(document.getElementById('${messageDiv.id}'))">
                📋 复制消息
            </div>
            <div class="menu-item" onclick="editMessage('${messageDiv.id}')">
                ✏️ 编辑消息
            </div>
            <div class="menu-item" onclick="deleteMessage('${messageDiv.id}')">
                🗑️ 删除消息
            </div>
        `;

        document.body.appendChild(menu);

        // 点击外部关闭菜单
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                if (menu.parentNode) {
                    menu.parentNode.removeChild(menu);
                }
                document.removeEventListener('click', closeMenu);
            });
        }, 100);
    }

    /**
     * 编辑消息功能
     */
    function editMessage(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const content = messageDiv.querySelector('.message-content p, .user-message');
        if (!content) return;

        const originalText = content.textContent || content.innerText;

        // 创建编辑输入框
        const editInput = document.createElement('textarea');
        editInput.value = originalText;
        editInput.className = 'edit-message-input';
        editInput.style.cssText = `
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        `;

        // 创建操作按钮
        const actions = document.createElement('div');
        actions.style.cssText = 'margin-top: 8px; display: flex; gap: 8px; justify-content: flex-end;';
        actions.innerHTML = `
            <button onclick="cancelEdit('${messageId}')" style="
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
            ">取消</button>
            <button onclick="saveEdit('${messageId}')" style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
            ">保存</button>
        `;

        // 保存原始内容
        content.setAttribute('data-original', originalText);

        // 替换内容
        content.innerHTML = '';
        content.appendChild(editInput);
        content.appendChild(actions);

        // 聚焦输入框
        editInput.focus();
        editInput.setSelectionRange(editInput.value.length, editInput.value.length);
    }

    /**
     * 取消编辑
     */
    window.cancelEdit = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const content = messageDiv.querySelector('.message-content p, .user-message');
        if (!content) return;

        const originalText = content.getAttribute('data-original');
        const processedContent = preprocessUserMessage(originalText);

        content.innerHTML = processedContent;
        content.removeAttribute('data-original');
    };

    /**
     * 保存编辑
     */
    window.saveEdit = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const content = messageDiv.querySelector('.message-content p, .user-message');
        const editInput = content?.querySelector('.edit-message-input');

        if (!content || !editInput) return;

        const newText = editInput.value.trim();
        if (!newText) return;

        const processedContent = preprocessUserMessage(newText);
        content.innerHTML = processedContent;
        content.removeAttribute('data-original');

        // 添加编辑标记
        const editMark = document.createElement('span');
        editMark.textContent = '(已编辑)';
        editMark.style.cssText = 'font-size: 11px; opacity: 0.7; margin-left: 8px;';
        content.appendChild(editMark);

        showSuccess('消息已更新', 1500);
    };

    /**
     * 删除消息
     */
    window.deleteMessage = function(messageId) {
        if (!confirm('确定要删除这条消息吗？')) return;

        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
            messageDiv.style.animation = 'slideOutRight 0.3s ease-in-out';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);

            showInfo('消息已删除', 1500);
        }
    };

    // ===== 修复版本的消息处理 =====
    function addMessage(content, type) {
        if (type === 'user') {
            // 使用新的用户消息函数
            return addUserMessage(content, {
                showTyping: true,
                showTimestamp: true,
                highlight: false
            });
        } else {
            // AI消息保持原有逻辑
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.setAttribute('data-message-type', 'static');

            if (type === 'ai') {
                try {
                    const markdownContent = marked.parse(content);
                    messageDiv.innerHTML = `
                    <div class="avatar">🤖</div>
                    <div class="message-content">
                        ${markdownContent}
                    </div>
                `;

                    setTimeout(() => {
                        processCodeBlocksInMessage(messageDiv);
                    }, 50);

                } catch (error) {
                    console.error('❌ 静态消息markdown解析失败:', error);
                    messageDiv.innerHTML = `
                    <div class="avatar">🤖</div>
                    <div class="message-content">
                        <p style="white-space: pre-wrap;">${escapeHtml(content)}</p>
                    </div>
                `;
                }
            }

            // 使用智能插入函数，确保思考框始终在底部
            insertMessageBeforeThinking(messageDiv, messagesContainer);

            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);

            console.log('📝 添加静态消息:', type, content.substring(0, 50) + '...');
        }
    }

    function addProcessingIndicator() {
        // 不立即显示思考框，等后端通过导航节点判断为EDW任务后再显示
        console.log('⏳ 开始处理 - 等待后端路由判断');
    }

    function removeProcessingIndicator() {
        // 不立即隐藏思考框，让它在收到AI回复时自然消失
        console.log('✅ 处理完成 - 保持思考框直到回复生成');
    }

    // ===== 流式消息处理（隔离版本）=====
    function addStreamMessage(content, type) {
        const messageId = 'stream-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8);
        const messagesContainer = document.getElementById('chatMessages');

        if (!messagesContainer) {
            console.error('❌ 找不到消息容器');
            return null;
        }

        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = `message ${type}`;
        messageDiv.setAttribute('data-message-type', 'stream'); // 标记为流式消息
        messageDiv.setAttribute('data-stream-isolated', 'true'); // 标记为隔离消息

        if (type === 'ai') {
            // 根据当前页面模式创建不同的结构
            if (currentPage === 'workspace') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="stream-content" data-stream-id="${messageId}">${content || ''}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="avatar">🤖</div>
                    <div class="message-content">
                        <div class="stream-content" data-stream-id="${messageId}">${content || ''}</div>
                    </div>
                `;
            }
        }

        // 如果是空内容的AI消息，先隐藏直到有实际内容
        if (type === 'ai' && (!content || content.trim() === '')) {
            messageDiv.style.display = 'none';
            messageDiv.setAttribute('data-empty-ai', 'true');
        }

        // 使用智能插入函数，确保思考框始终在底部
        insertMessageBeforeThinking(messageDiv, messagesContainer);

        // 延迟滚动，确保不影响Agent消息
        requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        console.log('📝 创建隔离流式消息:', messageId, '模式:', currentPage);
        return messageId;
    }

    function appendStreamMessage(messageId, content) {
        // 只操作指定的流式消息，完全隔离
        const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);
        if (streamContent && streamContent.closest('[data-stream-isolated="true"]')) {
            streamContent.textContent += content;

            // 如果这是第一次添加内容到空的AI消息，显示它
            const messageDiv = streamContent.closest('.message');
            if (messageDiv && messageDiv.getAttribute('data-empty-ai') === 'true' && content.trim()) {
                messageDiv.style.display = '';
                messageDiv.removeAttribute('data-empty-ai');
            }

            // 确保工作区模式下的滚动
            if (currentPage === 'workspace') {
                const messagesContainer = document.getElementById('chatMessages');
                requestAnimationFrame(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }
        } else {
            console.warn('⚠️ 未找到隔离的流式内容容器:', messageId);
        }
    }

    /**
     * 等待DOM更新完成
     */
    function waitForDOMUpdate() {
        return new Promise(resolve => {
            // 使用MutationObserver或requestAnimationFrame
            if (typeof MutationObserver !== 'undefined') {
                const observer = new MutationObserver(() => {
                    observer.disconnect();
                    resolve();
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });

                // 超时保护
                setTimeout(() => {
                    observer.disconnect();
                    resolve();
                }, 200);
            } else {
                // 降级到延迟
                setTimeout(resolve, 150);
            }
        });
    }

    /**
     * 后处理Markdown消息
     */
    async function postProcessMarkdownMessage(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) {
            console.warn('⚠️ 未找到消息元素:', messageId);
            return;
        }

        // 等待DOM更新完成
        await waitForDOMUpdate();

        try {
            // 处理代码块
            processCodeBlocksInMessage(messageDiv);

            // 工作区模式特殊样式
            if (currentPage === 'workspace') {
                ensureWorkspaceMarkdownStyles(messageDiv);
            }

            // 处理链接（添加target="_blank"等）
            processLinks(messageDiv);

            // 处理表格（添加响应式样式）
            processTables(messageDiv);

            // 最终滚动
            scrollToBottom();

            console.log('✅ 消息后处理完成:', messageId);

        } catch (error) {
            console.error('❌ 消息后处理失败:', error);
        }
    }

    /**
     * 处理链接
     */
    function processLinks(messageDiv) {
        const links = messageDiv.querySelectorAll('a[href]');
        links.forEach(link => {
            // 外部链接在新窗口打开
            if (link.href.startsWith('http') && !link.href.includes(window.location.hostname)) {
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
            }

            // 添加样式类
            link.classList.add('markdown-link');
        });
    }

    /**
     * 处理表格
     */
    function processTables(messageDiv) {
        const tables = messageDiv.querySelectorAll('table');
        tables.forEach(table => {
            // 添加响应式包装器
            if (!table.parentElement.classList.contains('table-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                wrapper.style.cssText = 'overflow-x: auto; margin: 16px 0;';

                table.parentElement.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            }

            // 添加样式类
            table.classList.add('markdown-table');
        });
    }

    /**
     * 优化版流式消息完成处理函数
     * 改进: 添加状态管理、错误处理、性能优化
     */
    async function finalizeStreamMessage(messageId) {
        // 防止重复处理
        if (messageProcessingStates.get(messageId)?.isProcessing) {
            console.log('⚠️ 消息正在处理中，跳过重复调用:', messageId);
            return;
        }

        // 设置处理状态
        messageProcessingStates.set(messageId, {
            isProcessing: true,
            startTime: Date.now()
        });

        try {
            const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);

            if (!streamContent || !streamContent.closest('[data-stream-isolated="true"]')) {
                console.warn('⚠️ 未找到隔离的流式内容容器:', messageId);
                return;
            }

            const rawContent = streamContent.textContent;
            console.log('🔄 开始Markdown处理 (长度: ' + rawContent.length + ', 工作区: ' + (currentPage === 'workspace') + ')');

            // 检查是否为特殊响应格式
            if (isModelEnhanceJsonResponse(rawContent)) {
                await handleSpecialJsonResponse(streamContent, rawContent, messageId);
            } else {
                await handleStandardMarkdownResponse(streamContent, rawContent, messageId);
            }

            // 后处理（代码块、样式等）
            await postProcessMarkdownMessage(messageId);

            console.log('✅ Markdown处理完成:', messageId);

        } catch (error) {
            console.error('❌ Markdown处理失败:', error);
            await handleMarkdownProcessingError(messageId, error);
        } finally {
            // 更新处理状态
            messageProcessingStates.set(messageId, {
                isProcessing: false,
                completed: true,
                completedAt: Date.now()
            });
        }
    }

    /**
     * 错误处理
     */
    async function handleMarkdownProcessingError(messageId, error) {
        const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);

        if (streamContent) {
            const errorContent = `
            <div class="markdown-error" style="
                color: #ef4444;
                padding: 16px;
                border-left: 4px solid #ef4444;
                background: rgba(239, 68, 68, 0.1);
                border-radius: 8px;
                margin: 12px 0;
            ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">❌</span>
                    <strong>内容处理失败</strong>
                </div>
                <p style="margin: 4px 0; font-size: 14px;">
                    ${escapeHtml(error.message)}
                </p>
                <details style="margin-top: 12px;">
                    <summary style="cursor: pointer; color: #888; font-size: 12px;">
                        点击查看原始内容
                    </summary>
                    <pre style="
                        background: #1a1a1a;
                        color: #e5e5e5;
                        padding: 12px;
                        border-radius: 4px;
                        margin-top: 8px;
                        white-space: pre-wrap;
                        font-size: 12px;
                    ">${escapeHtml(streamContent.textContent)}</pre>
                </details>
                <div style="margin-top: 12px;">
                    <button onclick="retryMarkdownProcessing('${messageId}')" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">
                        重试处理
                    </button>
                </div>
            </div>
        `;

            streamContent.innerHTML = errorContent;
        }

        // 记录错误
        console.error('📊 Markdown处理统计:', {
            messageId,
            error: error.message,
            contentLength: streamContent?.textContent?.length || 0,
            currentPage,
            timestamp: new Date().toISOString()
        });
    }

    /**
     * 重试Markdown处理
     */
    window.retryMarkdownProcessing = async function(messageId) {
        console.log('🔄 重试Markdown处理:', messageId);

        // 重置处理状态
        messageProcessingStates.delete(messageId);

        // 重新处理
        await finalizeStreamMessage(messageId);
    };

    /**
     * 平滑滚动到底部
     */
    function scrollToBottom() {
        requestAnimationFrame(() => {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        });
    }

    /**
     * 处理特殊JSON响应（如模型增强）
     */
    async function handleSpecialJsonResponse(streamContent, rawContent, messageId) {
        try {
            console.log('🔍 处理特殊JSON响应');

            const enhanceResult = parseModelEnhanceResult(rawContent);
            if (!enhanceResult) {
                throw new Error('无法解析JSON响应');
            }

            const formattedContent = formatModelEnhanceResponse(enhanceResult);
            const markdownContent = marked.parse(formattedContent);

            streamContent.innerHTML = markdownContent;

            console.log('✅ 特殊JSON响应处理完成');

        } catch (error) {
            console.error('❌ 特殊JSON响应处理失败，回退到标准处理:', error);
            // 回退到标准Markdown处理
            await handleStandardMarkdownResponse(streamContent, rawContent, messageId);
        }
    }

    /**
     * 处理标准Markdown响应
     */
    async function handleStandardMarkdownResponse(streamContent, rawContent, messageId) {
        try {
            // 确保marked库可用
            if (typeof marked === 'undefined') {
                throw new Error('Marked库未加载，无法处理Markdown格式');
            }

            // 重新配置marked，确保设置正确
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && typeof hljs !== 'undefined' && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {
                            console.warn('代码高亮失败:', err);
                        }
                    }
                    return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
                },
                breaks: true,
                gfm: true,
                tables: true,
                sanitize: false,
                pedantic: false,
                smartLists: true,
                smartypants: false
            });

            // 预处理内容
            const preprocessedContent = preprocessMarkdownContent(rawContent);

            // 执行Markdown转换
            const markdownContent = marked.parse(preprocessedContent);

            // 安全地替换内容
            streamContent.innerHTML = markdownContent;

            console.log('✅ 标准Markdown转换完成');

        } catch (error) {
            console.error('❌ 标准Markdown转换失败:', error);

            // 降级处理：显示格式化的纯文本
            const fallbackContent = `
            <div class="markdown-fallback" style="
                padding: 12px;
                border-left: 4px solid #f59e0b;
                background: rgba(245, 158, 11, 0.1);
                border-radius: 6px;
                margin: 8px 0;
            ">
                <p><strong>⚠️ 内容格式化部分失败</strong></p>
                <div style="white-space: pre-wrap; font-family: monospace; font-size: 13px; margin-top: 8px;">
                    ${escapeHtml(rawContent)}
                </div>
                <small style="color: #888; margin-top: 8px; display: block;">
                    内容已显示为纯文本格式 • ${error.message}
                </small>
            </div>
        `;
            streamContent.innerHTML = fallbackContent;

            throw error; // 重新抛出以记录日志
        }
    }

    /**
     * 修复常见的Markdown问题
     */
    function fixCommonMarkdownIssues(content) {
        // 确保代码块正确闭合
        const codeBlockMatches = content.match(/```/g);
        if (codeBlockMatches && codeBlockMatches.length % 2 !== 0) {
            content += '\n```'; // 添加缺失的代码块结束标记
        }

        // 确保列表项前有空行（某些markdown解析器需要）
        content = content.replace(/\n(\d+\.|[-*+])\s/g, '\n\n$1 ');

        // 修复表格格式
        content = content.replace(/\|(?!\s)/g, '| ').replace(/(?<!\s)\|/g, ' |');

        return content;
    }

    /**
     * 内容预处理
     */
    function preprocessMarkdownContent(content) {
        // 清理内容
        content = content.trim();

        // 统一换行符
        content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

        // 修复常见的markdown问题
        content = fixCommonMarkdownIssues(content);

        return content;
    }

    function finalizeStreamMessageWithContent(messageId, content) {
        const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);
        if (streamContent && streamContent.closest('[data-stream-isolated="true"]')) {
            console.log('🔄 正在直接设置markdown内容 (工作区模式: ' + (currentPage === 'workspace') + '):', content.substring(0, 100) + '...');

            // 确保markdown处理正确执行
            const markdownContent = marked.parse(content);
            streamContent.innerHTML = markdownContent;

            // 处理当前隔离消息的代码块
            const messageDiv = streamContent.closest('.message[data-stream-isolated="true"]');
            if (messageDiv) {
                processCodeBlocksInMessage(messageDiv);

                // 工作区模式下确保markdown样式正确应用
                if (currentPage === 'workspace') {
                    ensureWorkspaceMarkdownStyles(messageDiv);
                }
            }

            // 确保工作区模式下的滚动
            if (currentPage === 'workspace') {
                requestAnimationFrame(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }
        }
    }

    function ensureWorkspaceMarkdownStyles(messageDiv) {
        if (!messageDiv || currentPage !== 'workspace') return;

        // 确保工作区模式下的markdown元素有正确的样式类
        const messageContent = messageDiv.querySelector('.message-content');
        if (messageContent) {
            messageContent.classList.add('workspace-markdown');

            // 确保所有markdown元素在工作区模式下正确显示
            const headers = messageContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headers.forEach(header => {
                header.classList.add('workspace-header');
            });

            const codeBlocks = messageContent.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                block.classList.add('workspace-code-block');
            });

            const lists = messageContent.querySelectorAll('ul, ol');
            lists.forEach(list => {
                list.classList.add('workspace-list');
            });

            const paragraphs = messageContent.querySelectorAll('p');
            paragraphs.forEach(p => {
                p.classList.add('workspace-paragraph');
            });

            const blockquotes = messageContent.querySelectorAll('blockquote');
            blockquotes.forEach(quote => {
                quote.classList.add('workspace-blockquote');
            });

            const tables = messageContent.querySelectorAll('table');
            tables.forEach(table => {
                table.classList.add('workspace-table');
            });
        }

        console.log('✅ 工作区markdown样式已应用');
    }

    function processCodeBlocksInMessage(messageDiv) {
        // 只处理指定消息内的代码块，完全避免影响其他消息
        if (!messageDiv || messageDiv.hasAttribute('data-code-processed')) {
            return;
        }

        // 获取该消息内的所有代码块
        const codeBlocks = messageDiv.querySelectorAll('pre code');

        codeBlocks.forEach((block) => {
            const pre = block.parentElement;

            // 避免重复添加header
            if (pre.querySelector('.code-header')) {
                return;
            }

            const lang = block.className.match(/language-(\w+)/)?.[1] || 'plaintext';

            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
            <span class="code-lang">${lang}</span>
            <button class="copy-btn" onclick="copyCode(this)">复制</button>
        `;

            pre.insertBefore(header, block);

            // 在工作区模式下确保代码块样式正确
            if (currentPage === 'workspace') {
                pre.classList.add('workspace-code-block');
                block.classList.add('workspace-code');
            }
        });

        // 标记为已处理，避免重复处理
        messageDiv.setAttribute('data-code-processed', 'true');

        console.log('✅ 代码块处理完成，工作区模式:', currentPage === 'workspace');
    }

    // ===== Agent消息处理（强保护版本）=====
    function addAgentMessage(type, icon, title, message) {
        const messagesContainer = document.getElementById('chatMessages');

        if (!messagesContainer) {
            console.warn('⚠️ 消息容器不存在');
            return;
        }

        // 生成消息唯一ID
        const messageId = `agent-msg-${type}-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message agent ${type}`;
        messageDiv.id = messageId;
        messageDiv.setAttribute('data-message-type', 'agent');
        messageDiv.setAttribute('data-agent-type', type);
        messageDiv.setAttribute('data-agent-protected', 'true');

        // 使用!important样式内联，确保优先级
        messageDiv.style.cssText = `
        position: relative !important;
        margin: 16px 24px !important;
        border-radius: 12px !important;
        overflow: hidden !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        animation: slideInAgent 0.4s ease-out !important;
        isolation: isolate !important;
        contain: layout style !important;
        z-index: 10 !important;
    `;

        // 根据类型设置背景色，使用内联样式确保优先级
        const backgroundColors = {
            'page-switch': 'linear-gradient(135deg, #4f46e5, #6366f1)',
            'agent-handoff': 'linear-gradient(135deg, #7c3aed, #8b5cf6)',
            'tool-start': 'linear-gradient(135deg, #0891b2, #06b6d4)',
            'tool-end': 'linear-gradient(135deg, #059669, #10b981)',
            'code-found': 'linear-gradient(135deg, #dc2626, #ef4444)',
            'code-error': 'linear-gradient(135deg, #ea580c, #f97316)',
            'code-update': 'linear-gradient(135deg, #7c3aed, #a855f7)',
            'agent-end': 'linear-gradient(135deg, #16a34a, #22c55e)'
        };

        const bgColor = backgroundColors[type] || 'linear-gradient(135deg, #4f46e5, #6366f1)';
        messageDiv.style.background = bgColor;
        messageDiv.style.color = 'white';

        messageDiv.innerHTML = `
        <div class="agent-message-header" style="
            padding: 12px 16px !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            min-height: 44px !important;
            box-sizing: border-box !important;
        ">
            <div class="agent-icon" style="
                font-size: 16px !important;
                width: 24px !important;
                height: 24px !important;
                border-radius: 50% !important;
                background: rgba(255, 255, 255, 0.2) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            ">${icon}</div>
            <span class="agent-title" style="
                flex: 1 !important;
                min-width: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            ">${title}</span>
            <span class="agent-time" style="
                margin-left: auto !important;
                font-size: 11px !important;
                opacity: 0.8 !important;
                flex-shrink: 0 !important;
            ">
                ${new Date().toLocaleTimeString()}
            </span>
        </div>
        <div class="agent-message-content" style="
            padding: 14px 16px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        ">${message}</div>
    `;

        // 工作区模式下的特殊处理
        if (currentPage === 'workspace') {
            messageDiv.style.margin = '12px 0 !important';
            messageDiv.style.borderRadius = '10px !important';
            messageDiv.style.maxWidth = '95% !important';
            messageDiv.style.alignSelf = 'flex-start !important';
        }

        // 注册到保护注册表
        agentMessageRegistry.set(messageId, {
            element: messageDiv.cloneNode(true),
            type: type,
            timestamp: Date.now()
        });

        messagesContainer.appendChild(messageDiv);

        // 使用更平滑的滚动，避免跳跃
        requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        console.log(`✨ 添加保护Agent消息: ${type} - ${title} (ID: ${messageId})`);
        return messageId;
    }

    // ===== 修复版本的Agent消息保护系统 =====
    function protectAgentMessages() {
        // 更强的消息保护机制
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;

        const existingAgentMessages = messagesContainer.querySelectorAll('.message.agent[data-agent-protected="true"]');

        // 检查每个注册的Agent消息是否还在DOM中
        agentMessageRegistry.forEach((protectedMsg, messageId) => {
            const existingMsg = document.getElementById(messageId);
            if (!existingMsg) {
                console.log(`🛡️ 恢复丢失的Agent消息: ${messageId}`);

                // 更精确的插入位置计算
                let insertPosition = null;
                let bestPositionFound = false;

                // 尝试根据时间戳找到最佳插入位置
                Array.from(messagesContainer.children).forEach((child, index) => {
                    if (child.getAttribute('data-message-type') === 'agent') {
                        const childId = child.id;
                        const childProtected = agentMessageRegistry.get(childId);
                        if (childProtected && childProtected.timestamp > protectedMsg.timestamp && !bestPositionFound) {
                            insertPosition = child;
                            bestPositionFound = true;
                        }
                    }
                });

                // 克隆并恢复消息
                const restoredElement = protectedMsg.element.cloneNode(true);

                // 确保恢复的消息也有正确的样式
                if (currentPage === 'workspace') {
                    restoredElement.style.margin = '12px 0 !important';
                    restoredElement.style.borderRadius = '10px !important';
                    restoredElement.style.maxWidth = '95% !important';
                }

                if (insertPosition) {
                    messagesContainer.insertBefore(restoredElement, insertPosition);
                } else {
                    messagesContainer.appendChild(restoredElement);
                }
            }
        });
    }

    // 定期检查Agent消息完整性
    function startAgentMessageProtection() {
        setInterval(protectAgentMessages, 2000); // 每2秒检查一次
    }

    // ===== 主要事件处理 =====
    function handleSearch() {
        const input = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const query = input.value.trim();

        if (!query || isProcessing) return;

        // 设置处理状态
        isProcessing = true;
        searchBtn.disabled = true;

        // 保存用户输入
        pendingUserInput = query;

        console.log('🔍 用户搜索:', pendingUserInput);
        
        // 清理消息去重记录，确保新对话不受影响
        processedMessages.clear();
        console.log('🧹 清理消息去重记录，开始新搜索');

        // 重置思考框状态
        console.log('🧹 搜索前重置思考框状态');
        if (thinkingBoxVisible) {
            hideThinkingBox();
        }
        thinkingBoxVisible = false;
        thinkingSteps.clear();
        currentThinkingMessageId = null;
        console.log('✅ 搜索-思考框状态已完全重置');

        // 发送消息时隐藏首页建议
        hideSuggestions();

        // 进入聊天模式
        switchToChatMode();

        setTimeout(async () => {
            // 添加用户消息
            addMessage(query, 'user');

            // 添加处理中指示器
            addProcessingIndicator();

            // 处理流式回复
            await handleStreamChat(query);

            // 清理状态
            pendingUserInput = '';
            isProcessing = false;
        }, 100);

        // 清空搜索框
        input.value = '';
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const message = input.value.trim();

        console.log('🎯 sendMessage 被调用');
        console.log('📊 当前状态:', {
            currentPage: currentPage,
            isProcessing: isProcessing,
            inputDisabled: input?.disabled,
            messageLength: message?.length || 0,
            socketConnected: socketConnected
        });

        if (!message || isProcessing || input.disabled) {
            console.log('❌ 发送条件检查失败:', {
                hasMessage: !!message,
                isProcessing: isProcessing,
                inputDisabled: input.disabled
            });
            return;
        }

        // 🔧 修复：如果当前在主页状态，自动切换到聊天模式
        if (currentPage === 'homepage') {
            console.log('🔄 检测到在主页状态下发送消息，自动切换到聊天模式');
            switchToChatMode();
        }

        console.log('💬 发送消息:', message);
        
        // 清理消息去重记录，确保新对话不受影响
        processedMessages.clear();
        console.log('🧹 清理消息去重记录，开始新对话');
        
        // 重置思考框状态，准备显示新的思考过程
        console.log('🧹 发送消息前重置思考框状态');
        if (thinkingBoxVisible) {
            console.log('🔄 隐藏之前的思考框');
            hideThinkingBox();
        }
        // 注意：不要在这里设置thinkingBoxVisible = false
        // 让hideThinkingBox处理，或者在handleStreamChat中立即显示新的
        console.log('✅ 准备显示新的思考框');
        
        // 检查是否在等待中断响应
        if (window.waitingForInterruptResponse) {
            console.log('📝 这是对中断的响应:', message);
            console.log('🔍 中断响应时的session_id:', currentSessionId);
            console.log('🔍 中断节点:', window.currentInterruptNode);
            window.waitingForInterruptResponse = false;
            
            // 恢复输入框提示
            input.placeholder = '请输入您的问题或需求...';
        }

        // 设置处理状态
        isProcessing = true;
        input.disabled = true;
        sendBtn.disabled = true;
        
        // 永久隐藏聊天建议（发送消息后不再显示）
        chatSuggestionsPermanentlyHidden = true;
        hideChatSuggestions();

        // 添加用户消息
        addMessage(message, 'user');

        // 添加处理中指示器
        addProcessingIndicator();

        // 清空输入框
        input.value = '';

        // 处理流式回复
        handleStreamChat(message);
    }

    // ===== 优化版流式聊天处理（实时Markdown渲染）=====
    async function handleStreamChat(message) {
        console.log('🎯 开始流式聊天:', message);
        console.log('📋 handleStreamChat 当前状态:', {
            currentPage: currentPage,
            currentSessionId: currentSessionId,
            socketConnected: socketConnected,
            messageLength: message?.length || 0
        });
        
        // 生成新的session ID（如果需要）
        if (!currentSessionId) {
            currentSessionId = `session-${currentPage}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
            console.log('🆔 生成新session_id:', currentSessionId);
        }
        
        // 🎯 使用消息管理器显示思考框
        console.log('🔍 检查是否需要显示思考框', {
            thinkingVisible: messageManager.thinkingState.visible,
            waitingForInterruptResponse: window.waitingForInterruptResponse,
            currentSessionId: currentSessionId
        });
        
        // 🎯 关键修复：在中断恢复时强制显示新的思考框
        if (window.waitingForInterruptResponse) {
            console.log('💭 这是中断恢复，强制重置并显示新思考框');
            // 强制结束之前的思考框
            messageManager.endThinking(true);
            // 清理DOM中可能存在的旧思考框
            const oldThinkingBoxes = document.querySelectorAll('.thinking-steps-content');
            oldThinkingBoxes.forEach(box => box.remove());
        }
        
        // 使用消息管理器开始思考框
        console.log('🧠 使用消息管理器显示思考框');
        messageManager.startThinking(currentSessionId);

        try {
            // 确保有session_id - 如果在等待中断响应，不要重新生成session_id
            if (!currentSessionId) {
                currentSessionId = `session-${currentPage}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
                console.log('🆔 生成新session_id:', currentSessionId);
            } else if (window.waitingForInterruptResponse) {
                // 🎯 关键：在中断响应期间保持session_id不变
                console.log('💭 中断响应期间保持现有session_id:', currentSessionId);
            }

            // SocketIO连接 - 确保在HTTP请求前正确加入会话
            if (socket && socketConnected) {
                console.log('🔗 加入SocketIO会话房间:', currentSessionId);
                joinSession(currentSessionId);
                // 等待100ms确保Socket会话加入完成
                await new Promise(resolve => setTimeout(resolve, 100));
                console.log('✅ Socket会话加入完成，准备发送HTTP请求');
            } else {
                console.log('⚠️ Socket未连接:', { socket: !!socket, socketConnected });
                console.log('🔄 尝试重新初始化SocketIO...');
                if (typeof io !== 'undefined') {
                    initializeSocketIO();
                    // 等待连接建立
                    await new Promise(resolve => setTimeout(resolve, 200));
                    if (socket && socketConnected) {
                        console.log('🔗 重新连接成功，加入会话房间');
                        joinSession(currentSessionId);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
            }

            console.log('📡 准备发起HTTP请求');
            console.log('📋 请求参数:', {
                url: 'http://localhost:5000/api/chat/stream',
                method: 'POST',
                message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                session_id: currentSessionId
            });

            console.log('🚀 正在发送fetch请求...');
            
            const response = await fetch('http://localhost:5000/api/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    session_id: currentSessionId
                })
            });

            console.log('📡 收到HTTP响应:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                url: response.url,
                headers: Object.fromEntries(response.headers.entries())
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 从响应头获取session_id - 但在中断响应期间保持session_id不变
            const sessionId = response.headers.get('X-Session-ID');
            if (sessionId && !window.waitingForInterruptResponse) {
                // 只有不在中断响应期间才更新session_id
                currentSessionId = sessionId;
                console.log('🔄 更新session_id:', currentSessionId);
                if (socket && socketConnected) {
                    joinSession(currentSessionId);
                }
            } else if (sessionId && window.waitingForInterruptResponse) {
                console.log('💭 中断响应期间，保持现有session_id不变:', currentSessionId);
            }

            // 移除处理中指示器
            removeProcessingIndicator();

            // 添加思考完成步骤，但不隐藏思考框，让用户看到完整思考过程
            if (thinkingBoxVisible) {
                updateThinkingStep('final', 'processing', '正在生成回复...');
                console.log('🧠 保持思考框显示，直到stream响应完成');
            } else {
                // 额外保护：如果此时思考框不可见，可能是因为workflow_start消息还未到达
                console.log('⚠️ 注意：此时思考框不可见，等待workflow_start消息显示');
            }

            // 创建隔离的AI消息容器
            const aiMessageId = addStreamMessage('', 'ai');

            if (!aiMessageId) {
                console.error('❌ 无法创建AI消息容器');
                return;
            }

            // 标记流式状态
            const streamMessage = document.getElementById(aiMessageId);
            if (streamMessage) {
                streamMessage.classList.add('streaming');
            }

            // 处理流式响应
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let receivedData = false;
            let fullResponse = ''; // 收集完整回复

            // 实时Markdown渲染相关变量
            let renderTimeout = null;
            let lastRenderTime = 0;
            const renderDelay = 50; // 渲染防抖延迟 (ms)
            let isMarkdownMode = false; // 是否启用markdown模式

            console.log('📊 开始处理流式数据');

            // 实时Markdown渲染函数
            function renderMarkdownRealtime(content, force = false) {
                const now = Date.now();

                // 防抖：避免过于频繁的渲染
                if (!force && now - lastRenderTime < renderDelay) {
                    if (renderTimeout) clearTimeout(renderTimeout);

                    renderTimeout = setTimeout(() => {
                        renderMarkdownRealtime(content, true);
                    }, renderDelay);
                    return;
                }

                lastRenderTime = now;

                try {
                    const streamContent = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
                    if (!streamContent) return;

                    // 检测是否应该启用markdown模式
                    if (!isMarkdownMode) {
                        isMarkdownMode = shouldEnableMarkdown(content);
                    }

                    if (isMarkdownMode) {
                        // 尝试渲染Markdown
                        const processed = preprocessStreamContent(content);
                        const markdownContent = marked.parse(processed);
                        streamContent.innerHTML = markdownContent;

                        // 立即处理代码块
                        const messageDiv = streamContent.closest('.message');
                        if (messageDiv) {
                            processCodeBlocksInMessage(messageDiv);

                            // 工作区模式样式
                            if (currentPage === 'workspace') {
                                ensureWorkspaceMarkdownStyles(messageDiv);
                            }
                        }
                    } else {
                        // 纯文本模式
                        streamContent.textContent = content;
                    }

                    // 平滑滚动
                    scrollToBottomSmooth();

                } catch (error) {
                    console.warn('⚠️ 实时Markdown渲染失败，回退到纯文本:', error.message);

                    // 渲染失败时显示纯文本
                    const streamContent = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
                    if (streamContent) {
                        streamContent.textContent = content;
                    }
                }
            }

            // 检测是否应该启用Markdown模式
            function shouldEnableMarkdown(content) {
                // 检测markdown特征
                const markdownPatterns = [
                    /^#+\s/m,           // 标题
                    /```[\s\S]*?```/,   // 代码块
                    /\*\*[\s\S]*?\*\*/, // 粗体
                    /^\s*[-\*\+]\s/m,   // 列表
                    /^\s*\d+\.\s/m,     // 有序列表
                    /\[.*?\]\(.*?\)/,   // 链接
                    /^\s*>/m,           // 引用
                    /\|.*?\|/,          // 表格
                ];

                return markdownPatterns.some(pattern => pattern.test(content));
            }

            // 预处理流式内容，修复常见的不完整问题
            function preprocessStreamContent(content) {
                let processed = content.trim();

                // 修复不完整的代码块
                const codeBlockMatches = processed.match(/```/g);
                if (codeBlockMatches && codeBlockMatches.length % 2 !== 0) {
                    // 检查最后是否有未完成的代码块
                    const lastCodeBlockStart = processed.lastIndexOf('```');
                    const contentAfterLastBlock = processed.substring(lastCodeBlockStart + 3);

                    // 如果代码块后面还有内容，说明可能是未完成的
                    if (contentAfterLastBlock.trim().length > 0 && !contentAfterLastBlock.includes('\n```')) {
                        processed += '\n```'; // 暂时闭合代码块
                    }
                }

                // 修复不完整的列表项
                processed = processed.replace(/\n(\d+\.|[-\*\+])\s*$/g, '\n$1 ...');

                return processed;
            }

            // 移除，已移至全局作用域

            // 主要的流式数据处理循环
            while (true) {
                const { done, value } = await reader.read();

                if (done) {
                    console.log('✅ 流式数据读取完成');

                    // 移除流式状态标记
                    if (streamMessage) {
                        streamMessage.classList.remove('streaming');
                    }

                    // 清理渲染定时器
                    if (renderTimeout) {
                        clearTimeout(renderTimeout);
                    }

                    // 最终渲染 - 确保完整性
                    try {
                        // 检查是否是特殊JSON回复
                        if (isModelEnhanceJsonResponse(fullResponse)) {
                            console.log('🔍 检测到模型增强JSON回复，进行最终格式化');
                            const enhanceResult = parseModelEnhanceResult(fullResponse);
                            if (enhanceResult) {
                                const formattedContent = formatModelEnhanceResponse(enhanceResult);
                                finalizeStreamMessageWithContent(aiMessageId, formattedContent);
                            } else {
                                // 最后一次渲染完整内容
                                renderMarkdownRealtime(fullResponse, true);
                            }
                        } else {
                            // 最后一次渲染完整内容
                            renderMarkdownRealtime(fullResponse, true);
                        }
                    } catch (finalError) {
                        console.error('❌ 最终渲染失败:', finalError);
                        // 确保内容可见
                        const streamContent = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
                        if (streamContent) {
                            streamContent.textContent = fullResponse;
                        }
                    }

                    // 在stream响应完全结束时隐藏思考框（但不要在等待中断响应时隐藏）
                    if (messageManager.isCurrentStreamThinking(currentSessionId) && !window.waitingForInterruptResponse) {
                        console.log('✅ Stream响应完成，现在隐藏思考框');
                        messageManager.endThinking();
                    } else if (window.waitingForInterruptResponse) {
                        console.log('💭 等待中断响应，保持思考框显示');
                    }

                    // 检查是否有待处理的增强信息（当流式读取完成时）
                    setTimeout(() => {
                        checkPendingEnhanceInfo();
                    }, 1000); // 延迟1秒检查，确保用户能看到完成状态

                    break;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            console.log('📦 流式数据块:', data.type, data.content ? data.content.substring(0, 30) + '...' : '');
                            receivedData = true;

                            if (data.type === 'content') {
                                fullResponse += data.content; // 收集完整回复

                                // 实时渲染当前累积的内容
                                renderMarkdownRealtime(fullResponse);

                            } else if (data.type === 'progress') {
                                // EDW进度更新
                                console.log('📊 进度更新:', data.step, data.progress + '%');
                                showProgressIndicator(data.step, data.progress);
                                
                            } else if (data.type === 'enhanced_code') {
                                // 增强后的代码
                                console.log('🚀 收到增强代码:', data);
                                displayEnhancedCode(data);
                                
                            } else if (data.type === 'refined_code') {
                                // 微调后的代码
                                console.log('✨ 收到微调代码 (第' + data.round + '轮)');
                                displayRefinedCode(data.content, data.round);
                                
                            } else if (data.type === 'interrupt') {
                                // 中断询问
                                console.log('💭 工作流中断，需要用户输入');
                                handleInterruptPrompt(data.prompt, data.node);
                                
                            } else if (data.type === 'task_classified') {
                                // 任务分类结果
                                console.log('🧭 任务分类:', data.task_type);
                                fullResponse += '\n\n' + data.message;
                                renderMarkdownRealtime(fullResponse);
                                
                            } else if (data.type === 'node_update') {
                                // 节点状态更新
                                console.log('⚙️ 节点更新:', data.node, data.status);
                                updateNodeStatus(data.node, data.status, data.message);
                                
                            } else if (data.type === 'github_push') {
                                // GitHub推送结果
                                console.log('📤 GitHub推送:', data.status);
                                if (data.pr_url) {
                                    fullResponse += `\n\n✅ **GitHub PR创建成功**\n[查看PR](${data.pr_url})`;
                                    renderMarkdownRealtime(fullResponse);
                                }
                                
                            } else if (data.type === 'adb_update') {
                                // ADB更新结果
                                console.log('🔄 ADB更新:', data.status);
                                fullResponse += '\n\n🔄 ' + data.message;
                                renderMarkdownRealtime(fullResponse);
                                
                            } else if (data.type === 'confluence_update') {
                                // Confluence文档更新
                                console.log('📝 Confluence更新:', data.status);
                                if (data.page_url) {
                                    fullResponse += `\n\n📝 **文档已生成**\n[查看文档](${data.page_url})`;
                                    renderMarkdownRealtime(fullResponse);
                                }
                                
                            } else if (data.type === 'done') {
                                console.log('🏁 流式回复完成');

                                if (data.session_id && data.message_count) {
                                    updateSessionInfo(data.message_count);
                                }

                                // 检查是否有待处理的增强信息
                                setTimeout(() => {
                                    checkPendingEnhanceInfo();
                                }, 1000); // 延迟1秒检查，确保用户能看到完成状态

                                console.log('✅ 流式处理完全完成');
                                return;

                            } else if (data.type === 'error') {
                                console.error('❌ 收到错误响应:', data.error);
                                const errorContent = `❌ **AI服务错误**\n\n${data.error}`;
                                finalizeStreamMessageWithContent(aiMessageId, errorContent);
                                return;
                            }
                        } catch (e) {
                            console.error('❌ 解析流式数据失败:', e, '原始行:', line);
                        }
                    }
                }
            }

            if (!receivedData) {
                console.warn('⚠️ 未收到任何流式数据');
                const warningContent = '⚠️ **未收到响应**\n\n服务器没有返回数据，请检查网络连接或重试。';
                finalizeStreamMessageWithContent(aiMessageId, warningContent);
            }

        } catch (error) {
            console.error('❌ 流式聊天失败:', error);

            // 移除处理中指示器
            removeProcessingIndicator();
            
            // 隐藏思考框
            if (messageManager.thinkingState.visible) {
                messageManager.endThinking();
            }

            // 添加错误消息
            addMessage(`❌ **连接失败**\n\n无法连接到AI服务: ${error.message}`, 'ai');
            showError(`AI回复失败: ${error.message}`);

        } finally {
            // 恢复输入状态
            isProcessing = false;
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const searchBtn = document.getElementById('searchBtn');

            input.disabled = false;
            sendBtn.disabled = false;
            searchBtn.disabled = false;

            input.focus();

            // 确保Agent消息完整性
            protectAgentMessages();
        }
    }

    // ===== 模型增强回复处理辅助函数 =====
    function isModelEnhanceJsonResponse(response) {
        const trimmed = response.trim();
        try {
            // 检查是否为JSON格式，且包含模型增强相关字段
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                const parsed = JSON.parse(trimmed);
                return parsed.hasOwnProperty('enhanced_code') &&
                    parsed.hasOwnProperty('explanation') &&
                    parsed.hasOwnProperty('improvements');
            }
        } catch (e) {
            // 不是有效JSON
        }
        return false;
    }

    function parseModelEnhanceResult(response) {
        try {
            const trimmed = response.trim();

            // 清理可能的markdown格式
            let cleanedResult = trimmed;
            if (cleanedResult.startsWith('```json')) {
                cleanedResult = cleanedResult.slice(7);
            }
            if (cleanedResult.endsWith('```')) {
                cleanedResult = cleanedResult.slice(0, -3);
            }
            cleanedResult = cleanedResult.trim();

            const parsed = JSON.parse(cleanedResult);
            console.log('✅ 成功解析模型增强结果:', parsed);
            return parsed;
        } catch (e) {
            console.error('❌ 解析模型增强结果失败:', e);
            return null;
        }
    }

    function formatModelEnhanceResponse(result) {
        const improvements = result.improvements && Array.isArray(result.improvements)
            ? result.improvements.map(item => `• ${item}`).join('\n')
            : '• 代码优化和性能提升';

        const enhancedCode = result.enhanced_code || '';
        const codeSection = enhancedCode ? `\n\n**增强后的代码：**\n\`\`\`sql\n${enhancedCode}\n\`\`\`` : '';

        return `## 🎉 模型增强完成！

**优化说明：**
${result.explanation || '代码已优化'}

**主要改进：**
${improvements}

**新增字段：** ${result.add_new || '无'}${codeSection}

> 💡 增强后的代码已自动更新到右侧编辑器，您可以继续编辑和保存。`;
    }

    // ===== 实时消息处理 =====
    function handleRealtimeAgentMessage(data) {
        console.log('🔄 处理实时Agent消息:', data.type);

        // 生成消息唯一ID - 包含更多标识信息避免误判重复
        let messageId = `${data.type}-${data.timestamp}-${data.session_id}`;
        
        // 对于node_progress类型，添加节点名称和状态来确保唯一性
        if (data.type === 'node_progress' && data.data) {
            const node = data.data.node || 'unknown';
            const status = data.data.status || 'unknown';
            messageId = `${data.type}-${node}-${status}-${data.timestamp}-${data.session_id}`;
        }

        // 防止重复处理同一条消息 - 但允许不同状态的进度消息
        if (processedMessages.has(messageId)) {
            console.log('⚠️ 跳过重复消息:', messageId);
            return;
        }
        processedMessages.add(messageId);

        // 更新当前会话ID
        if (data.session_id && !currentSessionId) {
            currentSessionId = data.session_id;
            updateSessionInfo();
        }

        // 根据消息类型进行处理
        switch (data.type) {
            case 'page_switch':
                console.log('🔄 收到页面切换消息:', data.data);
                addAgentMessage('page-switch', '🔄', '页面切换', data.data.message || '正在切换页面...');
                handleRealtimePageSwitch(data.data);
                break;

            case 'agent_handoff':
                console.log('🔄 收到Agent切换消息:', data.data);
                addAgentMessage('agent-handoff', '🤖', 'Agent切换',
                    data.data.message || `从${data.data.from_agent}切换到${data.data.to_agent}`);
                handleRealtimeAgentHandoff(data.data);
                break;

            case 'node_progress':
                console.log('🔄 收到节点进度消息:', data.data);
                const progressData = data.data;
                updateNodeStatus(progressData.node, progressData.status, progressData.message);
                break;

            case 'validation_progress':
                console.log('✅ 收到验证进度消息:', data.data);
                const validationData = data.data;
                updateNodeStatus(validationData.node, validationData.status, validationData.message);
                break;

            case 'workflow_start':
                console.log('🚀 收到工作流开始消息:', data.data);
                // 工作流开始时确认思考框已显示（通常在handleStreamChat中已经显示）
                if (!messageManager.thinkingState.visible) {
                    console.log('🎬 工作流开始，补充显示思考框');
                    messageManager.startThinking(data.session_id || currentSessionId);
                }
                if (data.data && data.data.message) {
                    messageManager.updateThinkingProgress('workflow', 'started', data.data.message);
                }
                break;

            case 'workflow_resume':
                console.log('🔄 收到工作流恢复消息:', data.data);
                // 🎯 工作流恢复时立即显示思考框（中断恢复的第二轮对话）
                if (!messageManager.thinkingState.visible) {
                    console.log('🎬 工作流恢复，重新显示思考框');
                    messageManager.startThinking(data.session_id || currentSessionId);
                }
                if (data.data && data.data.message) {
                    messageManager.updateThinkingProgress('workflow_resume', 'resumed', data.data.message);
                }
                break;

            case 'node_status':
                console.log('📊 收到节点状态消息:', data.data);
                const nodeStatusData = data.data;
                updateNodeStatus(nodeStatusData.node || nodeStatusData.node_name, 
                                nodeStatusData.status, 
                                nodeStatusData.message || nodeStatusData.description || '节点执行中');
                break;

            case 'original_code':
                console.log('📄 收到原始代码消息:', data.data);
                displayOriginalCode(data.data);
                break;
            
            case 'enhanced_code':
                console.log('🚀 收到增强代码消息:', data.data);
                displayEnhancedCode(data.data);
                break;

            case 'tool_progress':
                console.log('🔧 收到工具调用进度消息:', data.data);
                handleToolProgressMessage(data.data);
                break;

            case 'agent_decision':
                console.log('🤖 收到Agent决策消息:', data.data);
                handleAgentDecisionMessage(data.data);
                break;

            case 'agent_complete':
                console.log('✅ 收到Agent完成消息:', data.data);
                handleAgentCompleteMessage(data.data);
                break;

            default:
                console.warn('⚠️ 未知的实时消息类型:', data.type);
        }
    }

    // ===== 工具监控消息处理 =====
    function handleToolProgressMessage(data) {
        console.log('🔧 处理工具调用进度:', data);
        
        // 根据工具调用动作类型处理
        if (data.action === 'start') {
            // 工具开始调用
            const message = data.message || `🔧 正在使用工具: ${data.tool_name}`;
            messageManager.updateThinkingProgress(`tool_${data.tool_name}`, 'started', message);
            
        } else if (data.action === 'complete') {
            // 工具调用完成
            const message = data.message || `✅ 工具执行完成 (${data.duration}秒)`;
            messageManager.updateThinkingProgress(`tool_${data.tool_name}`, 'completed', message);
            
        } else if (data.action === 'error') {
            // 工具调用出错
            const message = `❌ 工具执行失败: ${data.error}`;
            messageManager.updateThinkingProgress(`tool_${data.tool_name}`, 'error', message);
        }
    }

    function handleAgentDecisionMessage(data) {
        console.log('🤖 处理Agent决策:', data);
        
        // 根据决策动作类型处理
        if (data.action === 'thinking') {
            // Agent开始思考
            messageManager.updateThinkingProgress(`${data.agent_type}_thinking`, 'started', data.message);
            
        } else if (data.action === 'tool_selected') {
            // Agent选择了工具
            const message = data.message || `🎯 选择工具: ${data.tool_name}`;
            messageManager.updateThinkingProgress(`${data.agent_type}_decision`, 'processing', message);
        }
    }

    function handleAgentCompleteMessage(data) {
        console.log('✅ 处理Agent完成:', data);
        
        // Agent任务完成
        if (data.action === 'finished') {
            const message = data.message || `✅ ${data.agent_type}智能体任务完成`;
            messageManager.updateThinkingProgress(`${data.agent_type}_complete`, 'completed', message);
        }
    }

    // ===== 实时页面切换处理 =====
    function handleRealtimePageSwitch(data) {
        console.log('⚡ 实时页面切换处理:', data);

        if (data.target_page === 'workspace' && data.module_type === 'enhance') {
            console.log('⚡ 切换到模型增强工作区');
            switchToWorkspaceMode('enhance');

        } else if (data.target_page === 'workspace' && data.module_type === 'new') {
            console.log('⚡ 切换到新增模型工作区');
            switchToWorkspaceMode('new');
        } else {
            console.log('⚠️ 未处理的页面切换类型:', data);
        }
    }

    // ===== 其他实时消息处理函数 =====
    function handleRealtimeAgentHandoff(data) {
        console.log('⚡ 实时Agent切换处理:', data);
    }

    function handleRealtimeToolStart(data) {
        console.log('⚡ 实时工具开始处理:', data);

        if (data.tool_name === 'search_table_cd') {
            const fileName = document.getElementById('fileName');
            const codeEditor = document.getElementById('codeEditor');

            if (fileName) {
                fileName.textContent = '🔍 正在查找代码...';
            }

            if (codeEditor) {
                codeEditor.style.opacity = '0.6';
                codeEditor.placeholder = '正在搜索表的源代码，请稍候...';
            }

            showToolLoadingState(true);
        }
    }

    function handleRealtimeToolEnd(data) {
        console.log('⚡ 实时工具结束处理:', data);

        showToolLoadingState(false);

        const codeEditor = document.getElementById('codeEditor');
        if (codeEditor) {
            codeEditor.style.opacity = '1';
        }
    }

    function handleRealtimeCodeFound(data) {
        console.log('⚡ 实时代码找到处理:', data);

        if (data.code_info) {
            console.log('⚡ 立即更新代码编辑器:', data.code_info.table_name);
            updateCodeFromAgentImmediate(data.code_info);
        }
    }

    function handleRealtimeCodeError(data) {
        console.log('⚡ 实时代码错误处理:', data);

        const fileName = document.getElementById('fileName');
        const codeEditor = document.getElementById('codeEditor');

        if (fileName) {
            fileName.textContent = '❌ 代码加载失败';
        }

        if (codeEditor) {
            codeEditor.style.opacity = '1';
            codeEditor.placeholder = '代码加载失败，请重试或检查表名';
        }

        showToolLoadingState(false);
    }

    function handleRealtimeCodeUpdate(data) {
        console.log('⚡ 实时代码更新处理:', data);

        try {
            if (data.code_info && data.action === 'enhance_complete') {
                console.log('⚡ 处理模型增强完成，更新代码编辑器');

                const codeEditor = document.getElementById('codeEditor');
                const languageTag = document.getElementById('languageTag');
                const fileName = document.getElementById('fileName');

                if (!codeEditor || !languageTag || !fileName) {
                    console.error('❌ 代码编辑器DOM元素未找到');
                    showError('代码编辑器元素未找到');
                    return;
                }

                // 更新代码内容
                const enhancedCode = data.code_info.enhanced_code || '';
                codeEditor.value = enhancedCode;
                codeEditor.style.opacity = '1';
                originalCode = enhancedCode;

                // 更新文件信息 - 使用currentFile中的准确信息
                const language = currentFile?.language || 'sql';
                // 使用search_table_cd工具返回的准确文件名
                const fileNameText = currentFile?.name || 'enhanced_model.sql';

                // 更新语言标签
                if (language === 'sql') {
                    languageTag.textContent = 'SQL';
                    languageTag.style.background = '#f29111';
                    languageTag.style.borderColor = '#f29111';
                } else if (language === 'python') {
                    languageTag.textContent = 'Python';
                    languageTag.style.background = '#3776ab';
                    languageTag.style.borderColor = '#3776ab';
                } else {
                    languageTag.textContent = language.toUpperCase();
                    languageTag.style.background = '#238636';
                    languageTag.style.borderColor = '#238636';
                }

                // 显示来自search_table_cd的准确文件名
                fileName.textContent = fileNameText;
                console.log('📝 更新文件名显示:', fileNameText, '(来源: currentFile准确信息)');

                // 重置修改状态
                isCodeModified = false;
                const modifiedIndicator = document.getElementById('modifiedIndicator');
                const saveBtn = document.getElementById('saveBtn');

                if (modifiedIndicator) modifiedIndicator.classList.remove('show');
                if (saveBtn) saveBtn.classList.remove('show');

                // 更新当前文件信息 - 保留原始路径和表名信息
                if (currentFile) {
                    // 如果已有文件信息，保留原始信息并标记为已增强
                    currentFile.enhanced = true;
                    currentFile.language = language;
                    // 只在没有原始文件名时才使用fallback
                    if (!currentFile.name) {
                        currentFile.name = fileNameText;
                    }
                } else {
                    // 没有原始文件信息时创建新对象
                    currentFile = {
                        name: fileNameText,
                        language: language,
                        enhanced: true
                    };
                }

                // 停止工具加载状态
                showToolLoadingState(false);

                // 显示成功通知（仅在右下角显示）
                showSuccess(`模型增强完成: ${fileNameText}`, 3000);

                console.log('✅ 代码更新完成:', fileNameText);

                // === 功能点1：保存增强信息，等待流式响应完成后处理 ===
                savePendingEnhanceInfo(data.code_info);
            }

        } catch (error) {
            console.error('❌ 处理代码更新失败:', error);
            showError('更新代码失败: ' + error.message);
        }
    }

    function handleRealtimeAgentEnd(data) {
        console.log('⚡ 实时Agent结束处理:', data);
    }

    // ===== 工具加载状态管理 =====
    function showToolLoadingState(show) {
        const codeActions = document.querySelector('.code-actions');

        if (show) {
            if (codeActions && !codeActions.querySelector('.tool-loading')) {
                const loadingEl = document.createElement('div');
                loadingEl.className = 'tool-loading';
                loadingEl.innerHTML = '<span style="color: #4f46e5;">🔍 查找中...</span>';
                loadingEl.style.fontSize = '12px';
                loadingEl.style.marginRight = '10px';
                codeActions.insertBefore(loadingEl, codeActions.firstChild);
            }
        } else {
            const loadingEl = codeActions?.querySelector('.tool-loading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }
    }

    // ===== 代码编辑器管理 =====
    function updateCodeFromAgentImmediate(codeInfo) {
        try {
            console.log('⚡ 立即更新代码编辑器:', codeInfo);

            const codeEditor = document.getElementById('codeEditor');
            const languageTag = document.getElementById('languageTag');
            const fileName = document.getElementById('fileName');

            if (!codeEditor || !languageTag || !fileName) {
                console.error('❌ 代码编辑器DOM元素未找到');
                showError('代码编辑器元素未找到');
                return;
            }

            // 立即更新代码内容
            codeEditor.value = codeInfo.code || '';
            codeEditor.style.opacity = '1';
            originalCode = codeEditor.value;

            // 立即更新文件信息
            const language = codeInfo.language || 'unknown';

            if (language === 'sql') {
                languageTag.textContent = 'SQL';
                languageTag.style.background = '#f29111';
                languageTag.style.borderColor = '#f29111';
            } else if (language === 'python') {
                languageTag.textContent = 'Python';
                languageTag.style.background = '#3776ab';
                languageTag.style.borderColor = '#3776ab';
            } else {
                languageTag.textContent = language.toUpperCase();
                languageTag.style.background = '#238636';
                languageTag.style.borderColor = '#238636';
            }

            fileName.textContent = codeInfo.file_name || 'unknown.file';
            console.log('📝 更新文件名显示:', codeInfo.file_name, '(来源: search_table_cd结果)');

            // 重置修改状态
            isCodeModified = false;
            const modifiedIndicator = document.getElementById('modifiedIndicator');
            const saveBtn = document.getElementById('saveBtn');

            if (modifiedIndicator) modifiedIndicator.classList.remove('show');
            if (saveBtn) saveBtn.classList.remove('show');

            // 更新当前文件信息
            currentFile = {
                name: codeInfo.file_name,
                language: codeInfo.language,
                path: codeInfo.file_path,
                table_name: codeInfo.table_name
            };

            console.log('✅ 代码编辑器立即更新完成:', codeInfo.table_name);
            showSuccess(`代码加载成功: ${codeInfo.table_name}`, 2000);

        } catch (error) {
            console.error('❌ 立即更新代码编辑器失败:', error);
            showError('更新代码失败: ' + error.message);
        }
    }

    function initializeWorkspace(mode) {
        const codeEditor = document.getElementById('codeEditor');
        const chatInput = document.getElementById('chatInput');

        // 设置输入框占位符
        if (mode === 'new') {
            chatInput.placeholder = '请详细描述你的新模型需求，例如：我需要创建一个用户行为预测模型...';
            updateCodeExample('new');
        } else if (mode === 'enhance') {
            chatInput.placeholder = '请描述你的代码优化需求，或者直接贴上你的代码让我帮你分析...';
            updateCodeExample('enhance');
        }

        console.log('⚙️ 工作区初始化完成:', mode);
    }

    function updateCodeExample(moduleType = 'enhance') {
        const example = {
            code: `# 数据开发助手 - 代码优化和数据处理
# 请在左侧描述你的需求或贴上你的代码

import pandas as pd
import numpy as np
from sklearn.metrics import accuracy_score

def optimize_data_processing():
    '''数据处理优化示例'''

    # 示例：这是一个可以优化的数据处理函数
    # 你可以贴上你的代码，我会帮你分析和优化

    data = []
    for i in range(1000):
        data.append(i * 2)  # 这里可以优化

    return data

# 常见优化方向：
# 1. 性能优化 - 提升运行速度和内存使用
# 2. 代码重构 - 提高可读性和可维护性
# 3. 错误处理 - 增加异常处理和边界检查
# 4. 最佳实践 - 遵循Python/SQL编程规范
# 5. 功能增强 - 添加新功能或改进现有逻辑

# 请在左侧描述你的数据开发需求...`,
            fileInfo: { language: 'python', name: 'data_optimization.py' }
        };

        const codeEditor = document.getElementById('codeEditor');
        codeEditor.value = example.code;
        originalCode = example.code;
        updateFileInfo(example.fileInfo);
        currentFile = example.fileInfo;

        isCodeModified = false;
        document.getElementById('modifiedIndicator').classList.remove('show');
        document.getElementById('saveBtn').classList.remove('show');
    }

    function updateFileInfo(fileInfo) {
        const languageTag = document.getElementById('languageTag');
        const fileName = document.getElementById('fileName');

        const language = fileInfo.language || 'code';
        const name = fileInfo.name || 'unknown';

        if (language === 'python') {
            languageTag.textContent = 'Python';
            languageTag.style.background = '#3776ab';
        } else if (language === 'sql') {
            languageTag.textContent = 'SQL';
            languageTag.style.background = '#f29111';
        } else {
            languageTag.textContent = '代码';
            languageTag.style.background = '#238636';
        }

        fileName.textContent = name;
        console.log('📝 更新文件名显示:', name, '(来源: updateFileInfo函数)');
    }

    function handleCodeChange() {
        const codeEditor = document.getElementById('codeEditor');
        const currentCode = codeEditor.value;

        if (currentCode !== originalCode) {
            if (!isCodeModified) {
                isCodeModified = true;
                document.getElementById('modifiedIndicator').classList.add('show');
                document.getElementById('saveBtn').classList.add('show');
            }
        } else {
            if (isCodeModified) {
                isCodeModified = false;
                document.getElementById('modifiedIndicator').classList.remove('show');
                document.getElementById('saveBtn').classList.remove('show');
            }
        }
    }

    async function saveCode() {
        if (!currentFile || !isCodeModified) return;

        const saveBtn = document.getElementById('saveBtn');
        const codeEditor = document.getElementById('codeEditor');

        try {
            saveBtn.disabled = true;
            saveBtn.textContent = '💾 保存中...';

            // 模拟保存延迟
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 更新原始代码内容
            originalCode = codeEditor.value;
            isCodeModified = false;
            document.getElementById('modifiedIndicator').classList.remove('show');
            document.getElementById('saveBtn').classList.remove('show');

            addMessage(`✅ **保存成功！**\n\n代码已成功保存到 ${currentFile.name}`, 'ai');
            showNotification('代码保存成功！', 'success');

        } catch (error) {
            addMessage(`❌ **保存失败**\n\n${error.message}`, 'ai');
            showNotification('代码保存失败: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '💾 保存';
        }
    }

    // ===== 辅助函数 =====
    function autoResizeTextarea(element) {
        element.style.height = 'auto';
        element.style.height = Math.min(element.scrollHeight, 200) + 'px';
    }

    function uploadFiles() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = '.py,.sql,.txt,.json,.csv';
        input.onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                addMessage(`📎 **已选择 ${files.length} 个文件**\n\n${files.map(f => `• ${f.name}`).join('\n')}`, 'ai');
            }
        };
        input.click();
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function copyCode(button) {
        const code = button.parentElement.nextElementSibling.textContent;
        navigator.clipboard.writeText(code).then(() => {
            button.textContent = '已复制';
            button.classList.add('copied');
            setTimeout(() => {
                button.textContent = '复制';
                button.classList.remove('copied');
            }, 2000);
        });
    }

    // ===== 聊天框内确认卡片管理 =====
    
    /**
     * 添加确认卡片到聊天框
     * @param {Object} options - 卡片配置
     */
    function addConfirmCard(options) {
        const {
            type,           // 'update_code' 或 'run_code'
            icon,           // 图标 emoji
            title,          // 标题
            subtitle,       // 副标题
            message,        // 描述消息
            primaryText,    // 主按钮文字
            secondaryText,  // 次按钮文字
            primaryAction,  // 主按钮动作
            secondaryAction // 次按钮动作
        } = options;

        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) {
            console.error('❌ 未找到消息容器');
            return;
        }

        // 生成唯一ID
        const cardId = `confirm-card-${type}-${Date.now()}`;
        
        // 创建确认卡片消息
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai confirm-card';
        messageDiv.id = cardId;
        messageDiv.setAttribute('data-message-type', 'confirm-card');
        messageDiv.setAttribute('data-card-type', type);

        messageDiv.innerHTML = `
            <div class="avatar">🤖</div>
            <div class="confirm-card-content">
                <div class="confirm-card-header">
                    <span class="confirm-card-icon">${icon}</span>
                    <h3 class="confirm-card-title">${title}</h3>
                    <p class="confirm-card-subtitle">${subtitle}</p>
                </div>
                <div class="confirm-card-body">
                    <div class="confirm-card-message">${message}</div>
                    <div class="confirm-card-actions">
                        <button class="confirm-btn confirm-btn-secondary" onclick="handleConfirmCard('${cardId}', 'secondary')">
                            ${secondaryText}
                        </button>
                        <button class="confirm-btn confirm-btn-primary" onclick="handleConfirmCard('${cardId}', 'primary')">
                            ${primaryText}
                        </button>
                    </div>
                </div>
            </div>
        `;

        // 存储回调函数
        messageDiv.confirmCardCallbacks = {
            primary: primaryAction,
            secondary: secondaryAction
        };

        // 添加到消息容器
        messagesContainer.appendChild(messageDiv);

        // 平滑滚动到底部
        requestAnimationFrame(() => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        });

        console.log('✅ 添加确认卡片到聊天框:', type, title);
        return cardId;
    }

    /**
     * 处理确认卡片按钮点击
     */
    window.handleConfirmCard = function(cardId, action) {
        const cardElement = document.getElementById(cardId);
        if (!cardElement) {
            console.error('❌ 未找到确认卡片:', cardId);
            return;
        }

        const callbacks = cardElement.confirmCardCallbacks;
        if (!callbacks) {
            console.error('❌ 未找到确认卡片回调函数:', cardId);
            return;
        }

        // 设置按钮为加载状态
        const clickedBtn = cardElement.querySelector(action === 'primary' ? '.confirm-btn-primary' : '.confirm-btn-secondary');
        const otherBtn = cardElement.querySelector(action === 'primary' ? '.confirm-btn-secondary' : '.confirm-btn-primary');
        
        if (clickedBtn) {
            clickedBtn.classList.add('confirm-btn-loading');
            clickedBtn.disabled = true;
            if (otherBtn) otherBtn.disabled = true;
        }

        // 执行对应的回调函数
        const callback = callbacks[action];
        if (typeof callback === 'function') {
            try {
                callback(cardId);
            } catch (error) {
                console.error('❌ 执行确认卡片回调失败:', error);
                showError('操作执行失败: ' + error.message);
                
                // 恢复按钮状态
                if (clickedBtn) {
                    clickedBtn.classList.remove('confirm-btn-loading');
                    clickedBtn.disabled = false;
                    if (otherBtn) otherBtn.disabled = false;
                }
            }
        }
    };

    /**
     * 移除确认卡片
     */
    function removeConfirmCard(cardId) {
        const cardElement = document.getElementById(cardId);
        if (cardElement) {
            // 添加淡出动画
            cardElement.style.transition = 'all 0.3s ease-out';
            cardElement.style.opacity = '0';
            cardElement.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                if (cardElement.parentNode) {
                    cardElement.parentNode.removeChild(cardElement);
                }
            }, 300);
            
            console.log('✅ 移除确认卡片:', cardId);
        }
    }

    /**
     * 显示更新代码确认卡片
     */
    function showUpdateCodeCard() {
        if (isUpdateCodeCardVisible) {
            console.log('⚠️ 更新代码卡片已显示，跳过重复显示');
            return;
        }

        isUpdateCodeCardVisible = true;

        // 构建文件信息显示
        let fileInfoText = '';
        if (currentFile) {
            const fileName = currentFile.name || '模型代码';
            const tableName = currentFile.table_name || '';
            const filePath = currentFile.path || '';
            
            fileInfoText = `<div class="file-info">📄 <strong>${fileName}</strong>`;
            if (tableName) {
                fileInfoText += `<br>📊 表名: ${tableName}`;
            }
            if (filePath) {
                fileInfoText += `<br>📂 路径: ${filePath}`;
            }
            fileInfoText += '</div><br>';
        }

        const cardId = addConfirmCard({
            type: 'update_code',
            icon: '🚀',
            title: '模型增强完成',
            subtitle: '代码已优化，是否立即更新到Databricks？',
            message: fileInfoText + '系统已完成模型增强，生成了优化后的代码。<br>您可以选择立即将新代码更新到Databricks工作区。',
            primaryText: '立即更新',
            secondaryText: '稍后更新',
            primaryAction: confirmUpdateCode,
            secondaryAction: () => {
                isUpdateCodeCardVisible = false;
                removeConfirmCard(cardId);
                showInfo('您可以稍后手动更新代码到Databricks', 2000);
            }
        });

        // 保存卡片ID以便后续操作
        window.currentUpdateCardId = cardId;
        
        console.log('✅ 显示更新代码确认卡片');
        showInfo('模型增强完成，等待您的确认', 2000);
    }

    /**
     * 确认更新代码到Databricks
     */
    function confirmUpdateCode() {
        console.log('🚀 用户确认更新代码到Databricks');

        // 发送消息到后端
        const updateMessage = "更新最新代码到Databricks工作区";
        
        // 设置pending action用于跟踪
        pendingUpdateAction = {
            type: 'update_code',
            message: updateMessage,
            timestamp: Date.now()
        };

        // 移除确认卡片
        if (window.currentUpdateCardId) {
            removeConfirmCard(window.currentUpdateCardId);
            isUpdateCodeCardVisible = false;
        }

        // 添加用户消息
        addUserMessage(updateMessage, {
            showTyping: true,
            showTimestamp: true,
            highlight: true
        });

        // 添加处理中指示器
        addProcessingIndicator();

        // 调用现有的流式聊天处理
        handleStreamChat(updateMessage)
            .then(() => {
                console.log('✅ 更新代码指令处理完成');
                // 处理完成后，监听Databricks更新完成事件
                setupDatabricksUpdateListener();
            })
            .catch((error) => {
                console.error('❌ 更新代码指令处理失败:', error);
                showError('更新代码请求失败: ' + error.message);
            });
    }

    /**
     * 显示运行代码确认卡片
     */
    function showRunCodeCard() {
        if (isRunCodeCardVisible) {
            console.log('⚠️ 运行代码卡片已显示，跳过重复显示');
            return;
        }

        isRunCodeCardVisible = true;

        // 构建文件信息显示
        let fileInfoText = '';
        if (currentFile) {
            const fileName = currentFile.name || '模型代码';
            const tableName = currentFile.table_name || '';
            const filePath = currentFile.path || '';
            
            fileInfoText = `<div class="file-info">📄 <strong>${fileName}</strong>`;
            if (tableName) {
                fileInfoText += `<br>📊 表名: ${tableName}`;
            }
            if (filePath) {
                fileInfoText += `<br>📂 路径: ${filePath}`;
            }
            fileInfoText += '</div><br>';
        }

        const cardId = addConfirmCard({
            type: 'run_code',
            icon: '⚡',
            title: '代码更新成功',
            subtitle: '是否立即运行刚更新的代码？',
            message: fileInfoText + '代码已成功更新到Databricks工作区。<br>您可以选择立即运行代码查看执行结果。',
            primaryText: '立即运行',
            secondaryText: '稍后运行',
            primaryAction: confirmRunCode,
            secondaryAction: () => {
                isRunCodeCardVisible = false;
                removeConfirmCard(cardId);
                showInfo('您可以稍后手动运行代码', 2000);
            }
        });

        // 保存卡片ID以便后续操作
        window.currentRunCardId = cardId;
        
        console.log('✅ 显示运行代码确认卡片');
        showInfo('代码更新完成，等待您的确认', 2000);
    }

    /**
     * 确认立即运行代码
     */
    function confirmRunCode() {
        console.log('⚡ 用户确认立即运行代码');

        // 发送消息到后端
        const runMessage = "立即运行刚更新的代码";
        
        // 设置pending action用于跟踪
        pendingRunAction = {
            type: 'run_code',
            message: runMessage,
            timestamp: Date.now()
        };

        // 移除确认卡片
        if (window.currentRunCardId) {
            removeConfirmCard(window.currentRunCardId);
            isRunCodeCardVisible = false;
        }

        // 添加用户消息
        addUserMessage(runMessage, {
            showTyping: true,
            showTimestamp: true,
            highlight: true
        });

        // 添加处理中指示器
        addProcessingIndicator();

        // 调用现有的流式聊天处理
        handleStreamChat(runMessage)
            .then(() => {
                console.log('✅ 运行代码指令处理完成');
            })
            .catch((error) => {
                console.error('❌ 运行代码指令处理失败:', error);
                showError('运行代码请求失败: ' + error.message);
            });
    }

    /**
     * 基于add_new字段检测并显示更新工作流
     * @param {Object} codeInfo - 代码信息对象，包含add_new等字段
     */
    function checkAndShowUpdateWorkflow(codeInfo) {
        try {
            // 只在工作区模式下检测
            if (currentPage !== 'workspace') {
                console.log('ℹ️ 非工作区模式，跳过更新工作流检测');
                return;
            }

            // 防止重复显示卡片
            if (isUpdateCodeCardVisible) {
                console.log('⚠️ 更新卡片已显示，跳过重复检测');
                return;
            }

            if (!codeInfo) {
                console.log('⚠️ 代码信息为空，无法检测更新工作流');
                return;
            }

            // 核心判断：检查add_new字段
            const addNew = codeInfo.add_new;
            const hasFieldUpdates = addNew && addNew.trim() !== '' && addNew !== '无';

            console.log('🔍 检测更新工作流条件:', {
                add_new: addNew,
                hasFieldUpdates: hasFieldUpdates,
                enhanced_code: codeInfo.enhanced_code ? '存在' : '不存在',
                file_name: codeInfo.file_name
            });

            if (hasFieldUpdates) {
                console.log('🎉 检测到字段更新，启用更新工作流:', addNew);
                
                // 延迟2秒显示确认卡片，让用户看到成功通知
                setTimeout(() => {
                    // 再次检查状态，防止用户在等待期间进行了其他操作
                    if (!isUpdateCodeCardVisible && currentPage === 'workspace') {
                        showUpdateCodeCardWithDetails(codeInfo);
                    }
                }, 2000);
            } else {
                console.log('ℹ️ 没有检测到字段更新，跳过更新工作流:', addNew);
            }
            
        } catch (error) {
            console.error('❌ 检测更新工作流失败:', error);
        }
    }

    /**
     * 显示带详细信息的更新代码确认卡片
     * @param {Object} codeInfo - 代码信息，包含add_new等详细信息
     */
    function showUpdateCodeCardWithDetails(codeInfo) {
        if (isUpdateCodeCardVisible) {
            console.log('⚠️ 更新代码卡片已显示，跳过重复显示');
            return;
        }

        isUpdateCodeCardVisible = true;

        // 使用currentFile中保存的正确文件信息（来自search code工具）
        const fileName = currentFile ? currentFile.name : '模型代码';
        const tableName = currentFile ? currentFile.table_name : '';
        
        const detailMessage = `系统已完成模型增强，生成了优化后的代码。<br><br>
            <strong>文件：</strong> ${fileName}<br>
            ${tableName ? `<strong>表名：</strong> ${tableName}<br>` : ''}
            您可以选择立即将新代码更新到Databricks工作区。`;

        const cardId = addConfirmCard({
            type: 'update_code',
            icon: '🚀',
            title: '模型增强完成',
            subtitle: '是否立即同步到Databricks？',
            message: detailMessage,
            primaryText: '立即更新',
            secondaryText: '稍后更新',
            primaryAction: () => confirmUpdateCodeWithDetails(codeInfo),
            secondaryAction: () => {
                isUpdateCodeCardVisible = false;
                removeConfirmCard(cardId);
                showInfo('您可以稍后手动更新代码到Databricks', 2000);
            }
        });

        // 保存卡片ID和代码信息以便后续操作
        window.currentUpdateCardId = cardId;
        window.currentCodeInfo = codeInfo;
        
        console.log('✅ 显示更新代码确认卡片:', fileName);
        showInfo('模型增强完成，等待您的确认', 2000);
    }

    /**
     * 确认更新代码到Databricks（带详细信息）
     * @param {Object} codeInfo - 代码信息
     */
    function confirmUpdateCodeWithDetails(codeInfo) {
        console.log('🚀 用户确认更新代码到Databricks');

        // 使用正确的文件信息构建更新消息
        const fileName = currentFile ? currentFile.name : '模型代码';
        const updateMessage = `更新最新代码到Databricks工作区：${fileName}`;
        
        // 设置pending action用于跟踪
        pendingUpdateAction = {
            type: 'update_code',
            message: updateMessage,
            codeInfo: codeInfo,
            timestamp: Date.now()
        };

        // 移除确认卡片
        if (window.currentUpdateCardId) {
            removeConfirmCard(window.currentUpdateCardId);
            isUpdateCodeCardVisible = false;
        }

        // 添加用户消息
        addUserMessage(updateMessage, {
            showTyping: true,
            showTimestamp: true,
            highlight: true
        });

        // 添加处理中指示器
        addProcessingIndicator();

        // 调用现有的流式聊天处理
        handleStreamChat(updateMessage)
            .then(() => {
                console.log('✅ 更新代码指令处理完成');
                // 处理完成后，监听Databricks更新完成事件
                setupDatabricksUpdateListener();
            })
            .catch((error) => {
                console.error('❌ 更新代码指令处理失败:', error);
                showError('更新代码请求失败: ' + error.message);
            });
    }

    /**
     * 监听Databricks更新完成事件
     */
    function setupDatabricksUpdateListener() {
        console.log('🔄 设置Databricks更新完成监听器');
        
        // 创建一个更全面的监听器
        let listenerActive = true;
        let updateCompleteDetected = false;
        
        // 保存原始函数
        const originalHandleRealtimeAgentMessage = handleRealtimeAgentMessage;
        const originalHandleStreamChat = handleStreamChat;
        
        function databricksUpdateListener(data) {
            // 调用原始处理函数
            originalHandleRealtimeAgentMessage(data);
            
            if (!listenerActive || updateCompleteDetected) return;
            
            console.log('🔍 监听器检查消息:', data.type, data.data?.tool_name, data.data?.message);
            
            // 检查是否是Databricks更新完成事件
            const isUpdateComplete = (
                // 工具结束事件
                (data.type === 'tool_end' && data.data && (
                    data.data.tool_name === 'upload_code_to_databricks' ||
                    data.data.tool_name === 'sync_code_to_databricks' ||
                    data.data.message?.includes('代码更新完成') ||
                    data.data.message?.includes('同步完成') ||
                    data.data.message?.includes('更新成功') ||
                    data.data.message?.includes('上传完成')
                )) ||
                // Agent完成事件
                (data.type === 'agent_end' && data.data?.message?.includes('代码') && 
                 (data.data.message?.includes('更新') || data.data.message?.includes('同步')))
            );
            
            if (isUpdateComplete) {
                console.log('🎉 检测到Databricks更新完成事件:', data);
                updateCompleteDetected = true;
                
                // 延迟显示运行确认卡片，让用户看到更新完成消息
                setTimeout(() => {
                    if (listenerActive) {
                        showRunCodeCard();
                        // 恢复原始处理函数
                        handleRealtimeAgentMessage = originalHandleRealtimeAgentMessage;
                        listenerActive = false;
                    }
                }, 2000);
            }
        }
        
        // 增强的流式消息监听器
        async function enhancedStreamHandler(message) {
            try {
                const result = await originalHandleStreamChat(message);
                
                // 如果监听器仍然活跃，检查流式回复是否包含更新完成信息
                if (listenerActive && !updateCompleteDetected) {
                    // 检查最后的AI消息是否包含成功信息
                    setTimeout(() => {
                        const lastAiMessage = document.querySelector('.message.ai[data-message-type="stream"]:last-child .message-content');
                        if (lastAiMessage) {
                            const content = lastAiMessage.textContent || lastAiMessage.innerText;
                            const containsSuccess = (
                                content.includes('更新完成') ||
                                content.includes('同步成功') ||
                                content.includes('上传成功') ||
                                content.includes('代码已更新') ||
                                (content.includes('成功') && content.includes('Databricks'))
                            );
                            
                            if (containsSuccess && !updateCompleteDetected) {
                                console.log('🎉 从流式回复中检测到Databricks更新完成');
                                updateCompleteDetected = true;
                                
                                setTimeout(() => {
                                    if (listenerActive) {
                                        showRunCodeCard();
                                        handleRealtimeAgentMessage = originalHandleRealtimeAgentMessage;
                                        handleStreamChat = originalHandleStreamChat;
                                        listenerActive = false;
                                    }
                                }, 2000);
                            }
                        }
                    }, 1000);
                }
                
                return result;
            } catch (error) {
                console.error('增强流式处理器错误:', error);
                throw error;
            }
        }
        
        // 临时替换处理函数
        handleRealtimeAgentMessage = databricksUpdateListener;
        handleStreamChat = enhancedStreamHandler;
        
        // 15秒后恢复原始函数（防止长时间替换）
        setTimeout(() => {
            if (listenerActive) {
                handleRealtimeAgentMessage = originalHandleRealtimeAgentMessage;
                handleStreamChat = originalHandleStreamChat;
                listenerActive = false;
                console.log('⏰ Databricks更新监听器超时，已恢复原始处理函数');
            }
        }, 15000);
    }

    // ===== 滚动功能 =====
    
    /**
     * 平滑滚动到底部
     */
    function scrollToBottomSmooth() {
        requestAnimationFrame(() => {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        });
    }
    
    // ===== 思考框管理系统 =====
    
    /**
     * 智能消息插入函数 - 确保思考框始终在底部
     * @param {Element} messageElement - 要插入的消息元素
     * @param {Element} messagesContainer - 消息容器
     */
    function insertMessageBeforeThinking(messageElement, messagesContainer) {
        // 使用消息管理器的插入方法
        return messageManager.insertBeforeThinking(messageElement, messagesContainer);
    }
    
    /**
     * 显示思考框
     */
    function showThinkingBox() {
        console.log('🎯 showThinkingBox 被调用 (使用消息管理器)');
        
        // 使用消息管理器启动思考框
        const messageId = messageManager.startThinking(currentSessionId);
        
        console.log('✅ 思考框已通过消息管理器创建', messageId);
        
        return messageId;
    }
    
    /**
     * 隐藏思考框
     */
    function hideThinkingBox() {
        console.log('🔄 hideThinkingBox 被调用 (使用消息管理器)');
        
        // 使用消息管理器结束思考框
        messageManager.endThinking();
        
        console.log('✅ 思考框已通过消息管理器隐藏');
    }
    
    /**
     * 添加或更新思考步骤
     */
    function updateThinkingStep(nodeName, status, message) {
        console.log(`🔄 updateThinkingStep 调用:`, {
            nodeName,
            status,
            message,
            thinkingVisible: messageManager.thinkingState.visible
        });
        
        // 使用消息管理器更新思考进度
        messageManager.updateThinkingProgress(nodeName, status, message);
        
        // 兼容旧代码：同时更新全局变量中的思考步骤
        if (messageManager.thinkingState.visible && messageManager.thinkingState.messageId) {
            thinkingSteps.set(nodeName, { status, message, timestamp: Date.now() });
        }
    }
    
    /**
     * 处理思考步骤更新的核心逻辑 - 替换式显示
     */
    function processThinkingStep(thinkingContent, nodeName, status, message) {
        console.log(`🎯 processThinkingStep 执行:`, { nodeName, status, message });
        
        // 根据状态设置图标和样式
        let icon = '';
        let statusClass = '';
        let detail = '';
        
        switch(status) {
            case 'started':
                icon = '🔄';
                statusClass = 'current';
                detail = '正在执行...';
                break;
            case 'processing':
                icon = '⚙️';
                statusClass = 'current';
                detail = '处理中...';
                break;
            case 'completed':
                icon = '✅';
                statusClass = 'completed';
                detail = '完成';
                break;
            case 'failed':
                icon = '❌';
                statusClass = 'failed';
                detail = '失败';
                break;
            default:
                icon = 'ℹ️';
                statusClass = 'current';
                detail = '进行中...';
        }
        
        // 检查是否有现有的当前步骤
        let currentStep = thinkingContent.querySelector('.thinking-step.current');
        
        if (currentStep && status !== 'completed' && status !== 'failed') {
            // 如果有当前步骤且新状态不是完成状态，则替换内容
            console.log(`🔄 替换当前步骤内容: ${message}`);
            currentStep.innerHTML = `
                <div class="thinking-step-text">${message || nodeName}</div>
                <div class="thinking-step-detail">${detail}</div>
            `;
        } else {
            // 如果没有当前步骤，或者状态是完成/失败，创建新步骤
            console.log(`✨ 创建新的思考步骤: ${nodeName} -> ${status}`);
            
            // 将之前的current步骤标记为完成
            if (currentStep && (status === 'completed' || status === 'failed')) {
                currentStep.classList.remove('current');
                currentStep.classList.add('completed');
                const detailEl = currentStep.querySelector('.thinking-step-detail');
                if (detailEl) {
                    detailEl.textContent = '完成';
                }
            }
            
            // 创建新步骤
            const stepElement = document.createElement('div');
            stepElement.className = `thinking-step ${statusClass}`;
            stepElement.innerHTML = `
                <div class="thinking-step-text">${message || nodeName}</div>
                <div class="thinking-step-detail">${detail}</div>
            `;
            
            // 替换所有内容为新步骤（单一显示）
            thinkingContent.innerHTML = '';
            thinkingContent.appendChild(stepElement);
            console.log(`✅ 思考框内容已替换为新步骤: ${message}`);
        }
        
        // 滚动到底部以显示最新步骤
        scrollToBottomSmooth();
        
        console.log(`🤔 思考步骤处理完成: ${nodeName} - ${status} - ${message}`);
    }
    
    /**
     * 添加思考完成步骤
     */
    function addThinkingCompleteStep() {
        if (!thinkingBoxVisible) return;
        
        updateThinkingStep('final', 'completed', '分析完成，正在生成回复');
        
        // 不再自动隐藏，让思考框持续显示直到stream响应完成
        console.log('🧠 思考分析完成，保持显示直到回复完成');
    }

    // ===== 通知系统 =====
    function showNotification(message, type = 'info', duration = 3000) {
        let notification = document.getElementById('statusNotification');
        let messageEl = document.getElementById('notificationMessage');

        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'statusNotification';
            notification.className = 'status-notification';

            messageEl = document.createElement('span');
            messageEl.id = 'notificationMessage';

            notification.appendChild(messageEl);
            document.body.appendChild(notification);
        }

        if (!messageEl) {
            messageEl = document.getElementById('notificationMessage');
        }

        messageEl.textContent = message;
        notification.className = `status-notification ${type} show`;

        setTimeout(() => {
            notification.classList.remove('show');
        }, duration);

        console.log(`📢 通知: [${type.toUpperCase()}] ${message}`);
    }

    function showSuccess(message, duration = 2000) {
        showNotification(`✅ ${message}`, 'success', duration);
    }

    function showError(message, duration = 4000) {
        showNotification(`❌ ${message}`, 'error', duration);
    }

    function showWarning(message, duration = 3000) {
        showNotification(`⚠️ ${message}`, 'warning', duration);
    }

    function showInfo(message, duration = 2000) {
        showNotification(`ℹ️ ${message}`, 'info', duration);
    }
    
    // ===== EDW相关辅助函数 =====
    
    /**
     * 显示进度指示器
     */
    function showProgressIndicator(step, progress) {
        // 创建或更新进度条
        let progressBar = document.getElementById('edw-progress-bar');
        if (!progressBar) {
            const messagesContainer = document.getElementById('chatMessages');
            const progressDiv = document.createElement('div');
            progressDiv.id = 'edw-progress-container';
            progressDiv.className = 'progress-container';
            progressDiv.innerHTML = `
                <div class="progress-header">
                    <span class="progress-step">${step}</span>
                    <span class="progress-percent">${progress}%</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div id="edw-progress-bar" class="progress-bar" style="width: ${progress}%"></div>
                </div>
            `;
            messagesContainer.appendChild(progressDiv);
        } else {
            // 更新进度
            progressBar.style.width = progress + '%';
            const container = document.getElementById('edw-progress-container');
            container.querySelector('.progress-step').textContent = step;
            container.querySelector('.progress-percent').textContent = progress + '%';
        }
        
        // 完成后自动移除
        if (progress >= 100) {
            setTimeout(() => {
                const container = document.getElementById('edw-progress-container');
                if (container) {
                    container.remove();
                }
            }, 1000);
        }
    }
    
    /**
     * 显示原始源代码
     */
    function displayOriginalCode(codeData) {
        // 提取代码数据
        const {
            table_name = '未知',
            branch_name = '未知',
            source_code = '',
            file_name = '',
            file_path = '',
            language = 'sql',
            base_tables = []
        } = codeData;
        
        // 🎯 自动切换到工作区模式并加载代码
        console.log('🔄 自动切换到工作区模式显示代码');
        
        // 切换到workspace模式
        if (currentPage !== 'workspace') {
            switchToWorkspaceMode('enhance');
            
            // 等待页面切换完成再设置代码
            setTimeout(() => {
                loadCodeToEditorWithMeta(source_code, table_name, language, codeData);
                // 自动切换到增强代码标签页
                switchCodeTab('enhanced-code');
            }, 300);
        } else {
            // 已经在workspace模式，直接加载代码
            loadCodeToEditorWithMeta(source_code, table_name, language, codeData);
            // 自动切换到增强代码标签页
            switchCodeTab('enhanced-code');
        }
        
        // 清空CREATE TABLE和ALTER TABLE标签页（因为这是原始代码，还没有增强）
        const createTableContent = document.getElementById('createTableContent');
        const alterTableContent = document.getElementById('alterTableContent');
        if (createTableContent) {
            createTableContent.textContent = '-- 等待生成CREATE TABLE语句...';
        }
        if (alterTableContent) {
            alterTableContent.textContent = '-- 等待生成ALTER TABLE语句...';
        }
        
        // 只显示简单的成功消息，不显示绿色代码框
        addMessage(`✅ **代码获取成功**\n\n已获取表 ${table_name} 的原始代码，已更新到右侧编辑器。`, 'ai');
        showInfo(`已获取表 ${table_name} 的源代码`, 2000);
    }
    
    /**
     * 加载代码到编辑器
     */
    function loadCodeToEditor(code, tableName, language) {
        const codeEditor = document.getElementById('codeEditor');
        const fileName = document.getElementById('fileName');
        
        if (codeEditor) {
            codeEditor.value = code;
            originalCode = code;
            codeEditor.style.opacity = '1';
            
            // 设置语言类型class
            codeEditor.className = `code-editor ${language === 'python' ? 'language-python' : 'language-sql'}`;
        }
        
        if (fileName) {
            fileName.textContent = `${tableName} - 原始代码`;
        }
        
        // 显示代码面板
        const codePanel = document.querySelector('.code-panel');
        if (codePanel) {
            codePanel.classList.add('active');
        }
        
        // 显示加载成功提示
        showInfo(`代码已自动加载到编辑器 - ${tableName}`, 2000);
    }
    
    /**
     * 加载代码到编辑器并显示元数据信息
     */
    function loadCodeToEditorWithMeta(code, tableName, language, codeData) {
        // 更新新的三标签页代码编辑器
        const enhancedCodeContent = document.getElementById('enhancedCodeContent');
        const codeEditor = document.getElementById('codeEditor');
        const languageTag = document.getElementById('languageTag');
        const fileName = document.getElementById('fileName');
        const branchInfo = document.getElementById('branchInfo');
        const branchName = document.getElementById('branchName');
        
        if (!languageTag || !fileName) {
            console.error('❌ 代码编辑器DOM元素未找到');
            showError('代码编辑器元素未找到');
            return;
        }
        
        // 更新增强代码标签页（用于显示GitHub获取的原始代码）
        if (enhancedCodeContent && code) {
            enhancedCodeContent.textContent = code;
            // 应用语法高亮
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(enhancedCodeContent);
            }
        }
        
        // 同时更新隐藏的textarea（用于编辑模式）
        if (codeEditor) {
            codeEditor.value = code;
            codeEditor.style.opacity = '1';
            originalCode = code;
        }
        
        // 更新语言标签和文件名
        const languageDisplay = language === 'python' ? 'PYTHON' : 'SQL';
        languageTag.textContent = languageDisplay;
        
        // 修复语言标签样式
        if (language === 'sql') {
            languageTag.style.background = '#f29111';
            languageTag.style.borderColor = '#f29111';
            languageTag.style.color = 'white';
        } else if (language === 'python') {
            languageTag.style.background = '#306998';
            languageTag.style.borderColor = '#306998';
            languageTag.style.color = 'white';
        }
        
        // 根据代码数据类型更新文件名显示
        if (codeData && codeData.file_name) {
            fileName.textContent = codeData.file_name;
        } else {
            fileName.textContent = `${tableName} - 原始代码`;
        }
        
        // 更新元数据信息面板
        if (codeData) {
            const {
                file_name = '',
                branch_name = '未知',
                base_tables = []
            } = codeData;
            
            // 显示分支信息在header中
            if (branch_name && branchName && branchInfo) {
                branchName.textContent = branch_name;
                branchInfo.style.display = 'flex';
            } else if (branchInfo) {
                branchInfo.style.display = 'none';
            }
        }
        
        // 显示代码面板
        const codePanel = document.querySelector('.code-panel');
        if (codePanel) {
            codePanel.classList.add('active');
        }
        
        // 更新全局变量
        currentFile = {
            name: codeData?.file_name || `${tableName}.${language === 'python' ? 'py' : 'sql'}`,
            language: language,
            path: codeData?.file_path || '',
            table_name: tableName
        };
        
        // 显示加载成功提示
        showInfo(`代码已自动加载到编辑器 - ${tableName}`, 2000);
    }
    
    /**
     * 在编辑器中显示代码
     */
    function showCodeInEditor(code, tableName) {
        // 如果当前不在workspace模式，切换到workspace模式
        if (currentPage !== 'workspace') {
            switchToWorkspaceMode('enhance');
            
            // 等待页面切换完成再设置代码
            setTimeout(() => {
                const codeEditor = document.getElementById('codeEditor');
                const fileName = document.getElementById('fileName');
                
                if (codeEditor) {
                    codeEditor.value = code;
                    originalCode = code;
                    codeEditor.style.opacity = '1';
                }
                
                if (fileName) {
                    fileName.textContent = `${tableName} - 原始代码`;
                }
                
                // 显示代码面板
                const codePanel = document.querySelector('.code-panel');
                if (codePanel) {
                    codePanel.classList.add('active');
                }
                
                showInfo('代码已加载到编辑器', 1500);
            }, 300);
        } else {
            // 已经在workspace模式，直接设置代码
            const codeEditor = document.getElementById('codeEditor');
            const fileName = document.getElementById('fileName');
            
            if (codeEditor) {
                codeEditor.value = code;
                originalCode = code;
                codeEditor.style.opacity = '1';
            }
            
            if (fileName) {
                fileName.textContent = `${tableName} - 原始代码`;
            }
            
            // 显示代码面板
            const codePanel = document.querySelector('.code-panel');
            if (codePanel) {
                codePanel.classList.add('active');
            }
            
            showInfo('代码已加载到编辑器', 1500);
        }
    }
    
    /**
     * 显示增强后的代码
     */
    function displayEnhancedCode(data) {
        const code = data.content || '';
        const tableName = data.table_name || '未知';
        const filePath = data.file_path || data.adb_path || '';
        const enhancementMode = data.enhancement_mode || 'initial_enhancement';
        const fieldsCount = data.fields_count || 0;
        
        // 🎯 只更新右侧代码编辑器（所有三个标签页）
        const enhancedCodeContent = document.getElementById('enhancedCodeContent');
        const createTableContent = document.getElementById('createTableContent');
        const alterTableContent = document.getElementById('alterTableContent');
        const codeEditor = document.getElementById('codeEditor');
        const createTableEditor = document.getElementById('createTableEditor');
        const alterTableEditor = document.getElementById('alterTableEditor');
        const languageTag = document.getElementById('languageTag');
        const fileName = document.getElementById('fileName');
        
        // 更新增强代码标签页
        if (enhancedCodeContent && code) {
            enhancedCodeContent.textContent = code;
            // 同时更新隐藏的textarea（用于编辑模式）
            if (codeEditor) {
                codeEditor.value = code;
            }
            // 应用语法高亮
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(enhancedCodeContent);
            }
        }
        
        // 更新CREATE TABLE标签页
        if (createTableContent && data.create_table_sql) {
            createTableContent.textContent = data.create_table_sql;
            if (createTableEditor) {
                createTableEditor.value = data.create_table_sql;
            }
            // 应用语法高亮
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(createTableContent);
            }
        }
        
        // 更新ALTER TABLE标签页
        if (alterTableContent && data.alter_table_sql) {
            alterTableContent.textContent = data.alter_table_sql;
            if (alterTableEditor) {
                alterTableEditor.value = data.alter_table_sql;
            }
            // 应用语法高亮
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(alterTableContent);
            }
        }
        
        // 更新文件名和语言标签
        if (fileName && filePath) {
            const fileNameOnly = filePath.split('/').pop() || filePath.split('\\').pop() || 'enhanced_code.sql';
            fileName.textContent = fileNameOnly;
            fileName.title = filePath;
        }
        
        if (languageTag) {
            const language = filePath.endsWith('.py') ? 'PYTHON' : 'SQL';
            languageTag.textContent = language;
            languageTag.className = `language-tag ${language.toLowerCase()}`;
        }
        
        // 自动切换到增强代码标签页
        switchCodeTab('enhanced-code');
        
        console.log('✅ 右侧代码编辑器已更新（包含所有标签页）');
        console.log('  - 增强代码:', code ? code.length + ' 字符' : '无');
        console.log('  - CREATE TABLE:', data.create_table_sql ? data.create_table_sql.length + ' 字符' : '无');
        console.log('  - ALTER TABLE:', data.alter_table_sql ? data.alter_table_sql.length + ' 字符' : '无');
    }
    
    /**
     * 显示微调后的代码
     */
    function displayRefinedCode(code, round) {
        const messagesContainer = document.getElementById('chatMessages');
        const codeDiv = document.createElement('div');
        codeDiv.className = 'message ai refined-code';
        codeDiv.innerHTML = `
            <div class="refined-code-header">
                ✨ <strong>代码微调完成</strong> - 第${round}轮
            </div>
            <pre><code class="language-sql">${escapeHtml(code)}</code></pre>
            <div class="code-actions">
                <button onclick="copyToClipboard('${escapeHtml(code).replace(/'/g, "\\'")}')">📋 复制代码</button>
            </div>
        `;
        messagesContainer.appendChild(codeDiv);
        
        // 应用语法高亮
        if (typeof Prism !== 'undefined') {
            Prism.highlightAllUnder(codeDiv);
        }
        
        // 滚动到底部
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
    
    /**
     * 处理中断提示
     */
    function handleInterruptPrompt(prompt, nodeName) {
        // 添加中断提示消息，使用普通AI消息样式
        const messagesContainer = document.getElementById('chatMessages');
        const interruptDiv = document.createElement('div');
        interruptDiv.className = 'message ai';
        
        try {
            // 检查是否为markdown格式（包含markdown特征）
            const isMarkdownFormat = /^#+\s|```[\s\S]*?```|\*\*[\s\S]*?\*\*|^\s*[-\*\+]|\[.*?\]\(.*?\)|^\s*\d+\./m.test(prompt);
            
            let processedContent;
            if (isMarkdownFormat) {
                // 使用markdown渲染
                console.log('🔄 检测到markdown格式的中断提示，进行渲染');
                processedContent = marked.parse(prompt);
            } else {
                // 普通文本处理
                const naturalPrompt = `💭 ${escapeHtml(prompt)}\n\n请您在下方输入框中提供您的反馈或建议，然后点击发送。`;
                processedContent = naturalPrompt.replace(/\n/g, '<br>');
            }
            
            interruptDiv.innerHTML = `
                <div class="avatar">🤖</div>
                <div class="message-content">${processedContent}</div>
            `;
            
        } catch (error) {
            console.error('❌ 处理中断提示markdown失败，回退到纯文本:', error);
            // 降级处理
            const naturalPrompt = `💭 ${escapeHtml(prompt)}\n\n请您在下方输入框中提供您的反馈或建议，然后点击发送。`;
            interruptDiv.innerHTML = `
                <div class="avatar">🤖</div>
                <div class="message-content">${naturalPrompt.replace(/\n/g, '<br>')}</div>
            `;
        }
        
        messagesContainer.appendChild(interruptDiv);
        
        // 处理代码块（如果有）
        setTimeout(() => {
            processCodeBlocksInMessage(interruptDiv);
        }, 50);
        
        // 标记等待中断响应
        window.waitingForInterruptResponse = true;
        window.currentInterruptNode = nodeName;
        
        // 聚焦输入框
        document.getElementById('chatInput').focus();
        
        // 更新输入框提示 - 使用更自然的提示
        document.getElementById('chatInput').placeholder = '请回复上面的问题...';
        
        // 滚动到底部
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
    
    /**
     * 更新节点状态
     */
    function updateNodeStatus(nodeName, status, message) {
        console.log(`📊 节点 ${nodeName} 状态: ${status} - ${message}`);
        
        // 收到任何节点状态时，如果思考框不可见就显示它
        if (!messageManager.thinkingState.visible) {
            console.log('🤔 首次收到节点状态，显示思考框');
            messageManager.startThinking(currentSessionId);
        }
        
        // 更新思考步骤
        if (messageManager.thinkingState.visible) {
            console.log(`🔄 更新思考步骤: ${nodeName} -> ${status}`);
            updateThinkingStep(nodeName, status, message);
        } else {
            console.log('⚠️ 思考框不可见，跳过步骤更新');
        }
        
        // 错误状态额外显示错误提示
        if (status === 'failed' || status === 'error') {
            showError(`节点 ${nodeName} 执行失败: ${message}`, 5000);
        }
    }
    
    /**
     * 切换代码标签页
     */
    function switchCodeTab(tabName) {
        // 更新标签样式
        document.querySelectorAll('.code-tab').forEach(tab => {
            if (tab.dataset.tab === tabName) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // 更新内容面板
        document.querySelectorAll('.tab-pane').forEach(pane => {
            if (pane.dataset.pane === tabName) {
                pane.classList.add('active');
            } else {
                pane.classList.remove('active');
            }
        });
    }
    
    /**
     * 复制代码内容
     */
    function copyCodeContent(type) {
        let content = '';
        if (type === 'enhanced') {
            const codeElement = document.getElementById('enhancedCodeContent');
            const textarea = document.getElementById('codeEditor');
            content = codeElement ? codeElement.textContent : (textarea ? textarea.value : '');
        } else if (type === 'create') {
            const codeElement = document.getElementById('createTableContent');
            content = codeElement ? codeElement.textContent : '';
        } else if (type === 'alter') {
            const codeElement = document.getElementById('alterTableContent');
            content = codeElement ? codeElement.textContent : '';
        }
        
        if (content) {
            navigator.clipboard.writeText(content).then(() => {
                showSuccess('代码已复制到剪贴板', 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                showError('复制失败，请手动复制', 3000);
            });
        }
    }
    
    /**
     * 切换全屏模式
     */
    function toggleFullscreen(type) {
        let displayElement = null;
        if (type === 'enhanced') {
            displayElement = document.getElementById('enhancedCodeDisplay');
        } else if (type === 'create') {
            displayElement = document.getElementById('createTableDisplay');
        } else if (type === 'alter') {
            displayElement = document.getElementById('alterTableDisplay');
        }
        
        if (displayElement) {
            if (!document.fullscreenElement) {
                displayElement.requestFullscreen().catch(err => {
                    console.error('无法进入全屏模式:', err);
                    showError('全屏模式不可用', 2000);
                });
            } else {
                document.exitFullscreen();
            }
        }
    }
    
    /**
     * 切换编辑模式
     */
    function toggleEditMode(type) {
        if (type !== 'enhanced') return; // 只有增强代码支持编辑
        
        const displayElement = document.getElementById('enhancedCodeDisplay');
        const editorElement = document.getElementById('codeEditor');
        const button = event.target;
        
        if (displayElement && editorElement) {
            if (displayElement.style.display === 'none') {
                // 切换回查看模式
                displayElement.style.display = 'block';
                editorElement.style.display = 'none';
                button.textContent = '✏️ 编辑';
                
                // 更新显示内容
                const codeContent = document.getElementById('enhancedCodeContent');
                if (codeContent) {
                    codeContent.textContent = editorElement.value;
                    // 重新应用语法高亮
                    if (typeof hljs !== 'undefined') {
                        hljs.highlightElement(codeContent);
                    }
                }
            } else {
                // 切换到编辑模式
                displayElement.style.display = 'none';
                editorElement.style.display = 'block';
                button.textContent = '👁️ 查看';
                editorElement.focus();
            }
        }
    }
    
    /**
     * 复制到剪贴板
     */
    function copyToClipboard(text) {
        // 解码转义的文本
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        const decodedText = textarea.value;
        
        navigator.clipboard.writeText(decodedText).then(() => {
            showSuccess('代码已复制到剪贴板', 2000);
        }).catch(err => {
            console.error('复制失败:', err);
            showError('复制失败，请手动复制', 3000);
        });
    }

    /**
     * 显示CREATE TABLE语句
     */
    function showCreateTableSQL(sql) {
        // 解码转义的文本
        const textarea = document.createElement('textarea');
        textarea.innerHTML = sql;
        const decodedSQL = textarea.value;
        
        // 创建模态框显示SQL
        const modal = document.createElement('div');
        modal.className = 'sql-modal';
        modal.innerHTML = `
            <div class="sql-modal-content">
                <div class="sql-modal-header">
                    <h3>📝 CREATE TABLE 语句</h3>
                    <button class="modal-close" onclick="this.closest('.sql-modal').remove()">✕</button>
                </div>
                <div class="sql-modal-body">
                    <pre><code class="language-sql">${escapeHtml(decodedSQL)}</code></pre>
                </div>
                <div class="sql-modal-footer">
                    <button onclick="copyToClipboard('${escapeHtml(decodedSQL).replace(/'/g, "\\'")}')">📋 复制</button>
                    <button onclick="this.closest('.sql-modal').remove()">关闭</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // 应用语法高亮
        if (typeof Prism !== 'undefined') {
            Prism.highlightAllUnder(modal);
        }
    }

    /**
     * 显示ALTER TABLE语句
     */
    function showAlterTableSQL(sql) {
        // 解码转义的文本
        const textarea = document.createElement('textarea');
        textarea.innerHTML = sql;
        const decodedSQL = textarea.value;
        
        // 创建模态框显示SQL
        const modal = document.createElement('div');
        modal.className = 'sql-modal';
        modal.innerHTML = `
            <div class="sql-modal-content">
                <div class="sql-modal-header">
                    <h3>🔧 ALTER TABLE 语句</h3>
                    <button class="modal-close" onclick="this.closest('.sql-modal').remove()">✕</button>
                </div>
                <div class="sql-modal-body">
                    <pre><code class="language-sql">${escapeHtml(decodedSQL)}</code></pre>
                </div>
                <div class="sql-modal-footer">
                    <button onclick="copyToClipboard('${escapeHtml(decodedSQL).replace(/'/g, "\\'")}')">📋 复制</button>
                    <button onclick="this.closest('.sql-modal').remove()">关闭</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // 应用语法高亮
        if (typeof Prism !== 'undefined') {
            Prism.highlightAllUnder(modal);
        }
    }

    // ===== SocketIO管理 =====
    function initializeSocketIO() {
        try {
            socket = io('http://localhost:5000', {
                transports: ['websocket', 'polling'],
                autoConnect: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });

            socket.on('connect', function() {
                console.log('🔗 SocketIO连接成功:', socket.id);
                socketConnected = true;
                // 已移除实时通信连接成功提示

                if (currentSessionId) {
                    joinSession(currentSessionId);
                }
            });

            socket.on('disconnect', function() {
                console.log('🔌 SocketIO连接断开');
                socketConnected = false;
                // 已移除实时通信连接断开提示
            });

            socket.on('connect_error', function(error) {
                console.error('❌ SocketIO连接错误:', error);
                socketConnected = false;
                // 已移除实时通信连接失败提示
            });

            socket.on('reconnect', function() {
                console.log('🔄 SocketIO重连成功');
                socketConnected = true;
                // 已移除实时通信已恢复提示

                if (currentSessionId) {
                    joinSession(currentSessionId);
                }
            });

            socket.on('agent_message', function(data) {
                console.log('📨 收到Agent实时消息:', data.type, data);
                handleRealtimeAgentMessage(data);
            });

            socket.on('session_joined', function(data) {
                console.log('🏠 已加入会话:', data.session_id);
                showInfo(`已加入会话 ${data.session_id.slice(-8)}`, 1500);
            });

            socket.on('session_left', function(data) {
                console.log('🚪 已离开会话:', data.session_id);
            });

        } catch (error) {
            console.error('❌ 初始化SocketIO失败:', error);
            // 已移除实时通信初始化失败提示
        }
    }

    function joinSession(sessionId) {
        if (socket && socketConnected) {
            socket.emit('join_session', { session_id: sessionId });
            console.log('🏠 加入会话房间:', sessionId);
        }
    }

    function leaveSession(sessionId) {
        if (socket && socketConnected) {
            socket.emit('leave_session', { session_id: sessionId });
            console.log('🚪 离开会话房间:', sessionId);
        }
    }

    // ===== 会话管理 =====
    function updateSessionInfo(messageCount = null) {
        const sessionInfoElement = document.getElementById('sessionMessageCount');
        if (sessionInfoElement && currentSessionId) {
            if (messageCount) {
                sessionInfoElement.textContent = `${messageCount} 条消息`;
            } else {
                sessionInfoElement.textContent = '会话中...';
            }
        }
    }

    async function loadSessionHistory() {
        try {
            const response = await fetch('http://localhost:5000/api/sessions');
            const result = await response.json();

            if (result.success) {
                displaySessionList(result.data.sessions);
            }
        } catch (error) {
            console.error('加载会话历史失败:', error);
        }
    }

    function displaySessionList(sessions) {
        const sessionList = document.getElementById('sessionList');

        if (!sessions || sessions.length === 0) {
            sessionList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">暂无会话历史</div>';
            return;
        }

        sessionList.innerHTML = sessions.map(session => {
            const isActive = session.session_id === currentSessionId;
            const lastActivity = new Date(session.last_activity).toLocaleString();

            return `
                <div class="session-item ${isActive ? 'active' : ''}" data-session-id="${session.session_id}">
                    <div class="session-item-header">
                        <div class="session-id">${session.session_id.slice(-8)}...</div>
                        <div class="session-message-count">${session.message_count}</div>
                    </div>
                    <div class="session-last-activity">${lastActivity}</div>
                    <div class="session-actions">
                        <button class="session-load-btn" onclick="loadSession('${session.session_id}')">加载</button>
                        <button class="session-clear-btn" onclick="clearSession('${session.session_id}')">清除</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadSession(sessionId) {
        try {
            const response = await fetch(`http://localhost:5000/api/sessions/${sessionId}`);
            const result = await response.json();

            if (result.success) {
                currentSessionId = sessionId;

                // 清空当前消息（保留欢迎消息）
                const messagesContainer = document.getElementById('chatMessages');
                const welcomeMessage = messagesContainer.querySelector('.message.ai[data-stable="true"]');
                messagesContainer.innerHTML = '';
                if (welcomeMessage) {
                    messagesContainer.appendChild(welcomeMessage);
                }

                // 清理注册表
                agentMessageRegistry.clear();

                // 加载历史消息
                const messages = result.data.messages;
                messages.forEach(message => {
                    addMessage(message.content, message.role === 'user' ? 'user' : 'ai');
                });

                // 更新会话信息
                updateSessionInfo(result.data.session_info.message_count);

                // 更新会话列表显示
                loadSessionHistory();

                // 关闭会话面板
                toggleSessionPanel();
            }
        } catch (error) {
            console.error('加载会话失败:', error);
        }
    }

    async function clearSession(sessionId) {
        if (!confirm('确定要清除这个会话的历史记录吗？')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:5000/api/sessions/${sessionId}`, {
                method: 'DELETE'
            });
            const result = await response.json();

            if (result.success) {
                // 如果清除的是当前会话，重置当前会话
                if (sessionId === currentSessionId) {
                    currentSessionId = null;
                    updateSessionInfo();
                    agentMessageRegistry.clear();
                }

                // 重新加载会话列表
                loadSessionHistory();
            }
        } catch (error) {
            console.error('清除会话失败:', error);
        }
    }

    function toggleSessionPanel() {
        const sessionPanel = document.getElementById('sessionPanel');
        sessionPanelOpen = !sessionPanelOpen;

        if (sessionPanelOpen) {
            sessionPanel.classList.add('open');
            loadSessionHistory();
        } else {
            sessionPanel.classList.remove('open');
        }
    }

    // ===== 定期清理函数 =====
    // 定期清理处理状态
    setInterval(() => {
        const now = Date.now();
        const oneHourAgo = now - (60 * 60 * 1000);

        messageProcessingStates.forEach((state, messageId) => {
            if (state.completedAt && state.completedAt < oneHourAgo) {
                messageProcessingStates.delete(messageId);
            }
        });

        console.log('🧹 清理Markdown处理状态，当前数量:', messageProcessingStates.size);
    }, 300000); // 每5分钟清理一次

    // ===== 初始化 =====
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
        tables: true,
        sanitize: false
    });

    // ===== 首页输入框功能 =====
    
    /**
     * 自动调整textarea高度
     */
    function autoResizeSearchInput(element) {
        element.style.height = 'auto';
        element.style.height = Math.min(element.scrollHeight, 200) + 'px';
        
        // 根据内容调整border-radius
        if (element.scrollHeight > 60) {
            element.style.borderRadius = '20px';
        } else {
            element.style.borderRadius = '30px';
        }
    }

    /**
     * 应用输入建议 - 全局函数
     */
    window.applySuggestion = function(suggestionElement) {
        const suggestionText = suggestionElement.querySelector('.suggestion-text').textContent;
        const searchInput = document.getElementById('searchInput');
        
        // 设置输入框内容
        searchInput.value = suggestionText;
        
        // 调整高度
        autoResizeSearchInput(searchInput);
        
        // 聚焦输入框
        searchInput.focus();
        
        // 不再在点击建议时隐藏，保持建议可见直到发送消息
        
        // 添加一个小的视觉反馈
        suggestionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            suggestionElement.style.transform = 'translateY(-2px)';
        }, 150);
        
        console.log('🎯 应用建议:', suggestionText);
    };

    // ===== 聊天输入框功能 =====
    
    /**
     * 自动调整聊天输入框高度
     */
    function autoResizeChatInput(element) {
        element.style.height = 'auto';
        element.style.height = Math.min(element.scrollHeight, 200) + 'px';
    }

    /**
     * 应用聊天输入建议 - 全局函数
     */
    window.applyChatSuggestion = function(suggestionElement) {
        const suggestionText = suggestionElement.querySelector('.suggestion-text').textContent;
        const chatInput = document.getElementById('chatInput');
        
        // 设置输入框内容
        chatInput.value = suggestionText;
        
        // 调整高度
        autoResizeChatInput(chatInput);
        
        // 聚焦输入框
        chatInput.focus();
        
        // 隐藏建议
        hideChatSuggestions();
        
        // 添加一个小的视觉反馈
        suggestionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            suggestionElement.style.transform = 'translateY(-1px)';
        }, 150);
        
        console.log('💬 应用聊天建议:', suggestionText);
    };

    /**
     * 隐藏输入建议
     */
    function hideSuggestions() {
        const suggestions = document.getElementById('inputSuggestions');
        if (suggestions) {
            suggestions.classList.add('hidden');
        }
    }

    /**
     * 显示输入建议
     */
    function showSuggestions() {
        const suggestions = document.getElementById('inputSuggestions');
        if (suggestions) {
            suggestions.classList.remove('hidden');
        }
    }

    /**
     * 隐藏聊天输入建议
     */
    function hideChatSuggestions() {
        const suggestions = document.getElementById('chatInputSuggestions');
        if (suggestions) {
            suggestions.classList.add('hidden');
        }
    }

    /**
     * 显示聊天输入建议
     */
    function showChatSuggestions() {
        const suggestions = document.getElementById('chatInputSuggestions');
        if (suggestions) {
            suggestions.classList.remove('hidden');
        }
    }

    // 记录聊天建议是否应该永久隐藏（发送消息后）
    let chatSuggestionsPermanentlyHidden = false;

    /**
     * 检查聊天输入建议可见性
     */
    function checkChatSuggestionsVisibility() {
        const chatInput = document.getElementById('chatInput');
        const suggestions = document.getElementById('chatInputSuggestions');
        
        if (!chatInput || !suggestions) return;
        
        // 如果建议被永久隐藏，不再显示
        if (chatSuggestionsPermanentlyHidden) {
            hideChatSuggestions();
            return;
        }
        
        // 只在输入框有内容或获得焦点时隐藏建议，不主动显示建议
        if (chatInput.value.trim() || document.activeElement === chatInput) {
            hideChatSuggestions();
        }
        // 移除else分支，不再主动显示建议，避免点击空白处重新显示
    }

    /**
     * 检查是否应该显示建议 - 首页建议保持一直可见
     */
    function checkSuggestionsVisibility() {
        const suggestions = document.getElementById('inputSuggestions');
        
        if (!suggestions) return;
        
        // 首页建议保持一直显示，只有在发送消息时才隐藏
        if (currentPage === 'homepage') {
            showSuggestions();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 设置初始页面状态
        currentPage = 'homepage';
        
        // 初始化聊天建议状态
        chatSuggestionsPermanentlyHidden = false;
        
        // 初始化首页输入框功能
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            // 自动调整高度
            searchInput.addEventListener('input', function() {
                autoResizeSearchInput(this);
                // 不再在输入时检查建议可见性，保持一直显示
            });
            
            // 键盘事件处理
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('searchBtn').click();
                }
            });
            
            // 初始化时确保建议可见
            checkSuggestionsVisibility();
        }

        const codeEditor = document.getElementById('codeEditor');
        originalCode = codeEditor.value;

        // 监听代码编辑器变化
        codeEditor.addEventListener('input', handleCodeChange);

        // 监听回车键和点击事件
        document.getElementById('searchBtn').addEventListener('click', handleSearch);
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleSearch();
        });

        // 聊天输入框事件
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', function() {
                autoResizeChatInput(this);
                checkChatSuggestionsVisibility();
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = this.value.trim() === '' || isProcessing;
            });
            
            // 焦点事件 - 只保留focus事件，移除blur事件避免点击空白处重新显示建议
            chatInput.addEventListener('focus', function() {
                checkChatSuggestionsVisibility();
            });
            
            // 初始化时检查建议可见性
            checkChatSuggestionsVisibility();
        }

        // 聚焦搜索框
        document.getElementById('searchInput').focus();


        // 初始化SocketIO连接
        if (typeof io !== 'undefined') {
            initializeSocketIO();
        } else {
            console.log('ℹ️ SocketIO库未加载，使用基础通知系统');
            // 已移除实时通信库未加载提示
        }

        // 启动Agent消息保护
        startAgentMessageProtection();

        // 通知系统初始化完成（已移除系统准备就绪提示）

        // 定期清理消息去重记录和消息管理器
        setInterval(() => {
            if (processedMessages.size > 1000) {
                processedMessages.clear();
                console.log('🧹 清理消息去重记录');
            }
            
            // 清理消息管理器中的过期消息
            messageManager.cleanupOldMessages();
        }, 300000);

        // 定期清理Agent注册表（保留最近的消息）
        setInterval(() => {
            const now = Date.now();
            const oneHourAgo = now - (60 * 60 * 1000);

            agentMessageRegistry.forEach((value, key) => {
                if (value.timestamp < oneHourAgo) {
                    agentMessageRegistry.delete(key);
                }
            });

            if (agentMessageRegistry.size > 100) {
                const entries = Array.from(agentMessageRegistry.entries());
                entries.sort((a, b) => b[1].timestamp - a[1].timestamp);
                agentMessageRegistry.clear();
                entries.slice(0, 50).forEach(([key, value]) => {
                    agentMessageRegistry.set(key, value);
                });
            }

            console.log('🧹 清理Agent注册表，当前大小:', agentMessageRegistry.size);
        }, 600000); // 每10分钟清理一次
    });
</script>
</body>
</html>