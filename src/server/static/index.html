<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDW æ™ºèƒ½åŠ©æ‰‹</title>
    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --bg-message-ai: #1e1e1e;
            --bg-message-user: linear-gradient(135deg, #4f46e5, #7c3aed);
            --bg-message-agent: linear-gradient(135deg, #059669, #0d9488);
            --border-color: #333333;
            --text-primary: #e5e5e5;
            --text-secondary: #888888;
            --accent-primary: #4f46e5;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --code-bg: #0d1117;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 15px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== ä¸»é¡µå®¹å™¨ ===== */
        .homepage-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            padding: 40px;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .homepage-container.slide-out {
            transform: translateY(-100%);
            opacity: 0;
        }

        .homepage-container.hidden {
            display: none;
        }

        .logo {
            font-size: 64px;
            font-weight: 300;
            color: #ffffff;
            letter-spacing: 8px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoGlow 3s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            0% { filter: drop-shadow(0 0 10px rgba(79, 70, 229, 0.3)); }
            100% { filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.6)); }
        }

        .search-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            margin-bottom: 40px;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 18px 70px 18px 28px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 30px;
            font-size: 18px;
            font-family: inherit;
            color: var(--text-primary);
            outline: none;
            resize: none;
            overflow-y: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 1.5;
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15), 0 8px 32px rgba(0, 0, 0, 0.4);
            text-align: left;
            border-radius: 20px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            text-align: center;
        }

        .search-input:focus::placeholder {
            text-align: left;
        }

        /* è¾“å…¥å»ºè®®æ ·å¼ */
        .input-suggestions {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }

        .input-suggestions.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .suggestions-header {
            text-align: center;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            max-width: 100%;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }

        .suggestion-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.15);
        }

        .suggestion-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ä¸ºæ¯ä¸ªå»ºè®®é¡¹æ·»åŠ å»¶è¿ŸåŠ¨ç”» */
        .suggestion-item:nth-child(1) { animation-delay: 0.1s; }
        .suggestion-item:nth-child(2) { animation-delay: 0.2s; }
        .suggestion-item:nth-child(3) { animation-delay: 0.3s; }
        .suggestion-item:nth-child(4) { animation-delay: 0.4s; }
        .suggestion-item:nth-child(5) { animation-delay: 0.5s; }
        .suggestion-item:nth-child(6) { animation-delay: 0.6s; }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }

        .search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(-50%);
        }

        /* ===== èŠå¤©å®¹å™¨ç³»ç»Ÿ ===== */
        .chat-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: none;
            flex-direction: column;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-container.slide-in {
            animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInFromBottom {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* å·¥ä½œåŒºæ¨¡å¼ï¼šèŠå¤©å®¹å™¨å˜ä¸ºå·¦ä¾§50% */
        .chat-container.workspace-mode {
            width: 50%;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-container.workspace-transition {
            animation: shrinkToLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes shrinkToLeft {
            from {
                width: 100%;
                background: var(--bg-primary);
            }
            to {
                width: 50%;
                background: var(--bg-secondary);
            }
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .chat-container.workspace-mode .chat-header {
            background: #252525;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn, .session-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .back-btn:hover, .session-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .chat-container.workspace-mode .chat-messages {
            padding: 20px;
            gap: 20px;
            background: var(--bg-secondary);
        }

        /* ===== ä¼˜åŒ–çš„ç”¨æˆ·æ¶ˆæ¯æ ·å¼ ===== */

        /* ç”¨æˆ·æ¶ˆæ¯å®¹å™¨åŸºç¡€æ ·å¼ */
        .message.user {
            flex-direction: row-reverse;
            margin-bottom: 24px;
            animation: slideInFromRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            justify-content: flex-start;
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ç”¨æˆ·å¤´åƒä¼˜åŒ– */
        .message.user .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .message.user .avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message.user .avatar:hover::before {
            opacity: 1;
        }

        .message.user .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* ç”¨æˆ·æ¶ˆæ¯å†…å®¹å®¹å™¨ */
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 20px 20px 4px 20px;
            max-width: 70%;
            position: relative;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.5;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .message.user .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: inherit;
            pointer-events: none;
        }

        .message.user .message-content:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4),
                        0 0 0 1px rgba(102, 126, 234, 0.5),
                        0 0 25px rgba(102, 126, 234, 0.2);
        }

        /* ç”¨æˆ·æ¶ˆæ¯è¾¹æ¡†é«˜äº®æ•ˆæœ */
        .message.user .message-content::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, 
                rgba(102, 126, 234, 0.6), 
                rgba(118, 75, 162, 0.6),
                rgba(245, 87, 108, 0.6),
                rgba(102, 126, 234, 0.6)
            );
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            filter: blur(8px);
            animation: userBorderFlow 4s ease-in-out infinite;
        }

        .message.user .message-content:hover::after {
            opacity: 1;
        }

        @keyframes userBorderFlow {
            0%, 100% { 
                background-position: 0% 50%;
                filter: blur(8px);
            }
            50% { 
                background-position: 100% 50%;
                filter: blur(12px);
            }
        }

        /* ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬æ ·å¼ */
        .message.user .message-content p {
            margin: 0;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ä»£ç æ ·å¼ */
        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
            color: #e8f4fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„é“¾æ¥æ ·å¼ */
        .message.user .message-content a {
            color: #e8f4fd;
            text-decoration: underline;
            text-decoration-color: rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
        }

        .message.user .message-content a:hover {
            text-decoration-color: white;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        /* ===== å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„ç”¨æˆ·æ¶ˆæ¯ä¼˜åŒ– ===== */

        .chat-container.workspace-mode .message.user {
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            margin-bottom: 0; /* ä½¿ç”¨ç»Ÿä¸€çš„message margin-bottom */
            padding: 0;
            background: transparent;
            border: none;
        }

        .chat-container.workspace-mode .message.user .avatar {
            display: none;
        }

        .chat-container.workspace-mode .message.user .message-content.user-message {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 14px 18px;
            border-radius: 18px 18px 4px 18px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 3px 12px rgba(79, 70, 229, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            margin-right: 12px; /* ä¸ºå°å°¾å·´ç•™å‡ºç©ºé—´ */
        }

        /* ç”¨æˆ·æ¶ˆæ¯å³ä¾§å°å°¾å·´ */
        .chat-container.workspace-mode .message.user .message-content.user-message::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid #6366f1;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 2;
        }

        /* ç§»é™¤åŸæœ‰çš„beforeï¼Œç”¨äºè¾¹æ¡†é«˜äº® */

        .chat-container.workspace-mode .message.user .message-content.user-message:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.5),
                        0 0 0 1px rgba(79, 70, 229, 0.6),
                        0 0 20px rgba(79, 70, 229, 0.3);
        }

        /* å·¥ä½œåŒºæ¨¡å¼ç”¨æˆ·æ¶ˆæ¯è¾¹æ¡†é«˜äº®ï¼ˆæ”¹ä¸ºbeforeé¿å…ä¸å°å°¾å·´å†²çªï¼‰ */
        .chat-container.workspace-mode .message.user .message-content.user-message:hover::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, 
                rgba(79, 70, 229, 0.7), 
                rgba(124, 58, 237, 0.7),
                rgba(139, 92, 246, 0.7),
                rgba(79, 70, 229, 0.7)
            );
            border-radius: inherit;
            opacity: 1;
            z-index: -1;
            filter: blur(6px);
            animation: workspaceUserBorderGlow 3s ease-in-out infinite;
        }

        @keyframes workspaceUserBorderGlow {
            0%, 100% { 
                filter: blur(6px);
                transform: scale(1);
            }
            50% { 
                filter: blur(10px);
                transform: scale(1.02);
            }
        }

        /* å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„ä»£ç æ ·å¼ */
        .chat-container.workspace-mode .message.user .message-content.user-message code {
            background: rgba(255, 255, 255, 0.2);
            color: #ddd6fe;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* ===== æ¶ˆæ¯æ—¶é—´æˆ³æ ·å¼ ===== */
        .message.user .message-timestamp {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            text-align: right;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message.user:hover .message-timestamp {
            opacity: 1;
        }

        /* ===== æ¶ˆæ¯çŠ¶æ€æŒ‡ç¤ºå™¨ ===== */
        .message.user .status-indicator {
            position: absolute;
            bottom: 6px;
            right: 12px;
            font-size: 10px;
            opacity: 0.8;
        }

        .message.user .status-indicator.sent {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.user .status-indicator.delivered {
            color: #10b981;
        }

        .message.user .status-indicator.read {
            color: #3b82f6;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            display: flex;
            padding: 0 24px;
            gap: 12px;
            margin-bottom: 20px; /* ç»Ÿä¸€æ¶ˆæ¯é—´è· */
        }

        .chat-container.workspace-mode .message {
            padding: 0;
            margin-bottom: 18px; /* å·¥ä½œåŒºæ¨¡å¼ä¸‹ç¨å°çš„é—´è· */
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.ai .avatar {
            background: #2a2a2a;
        }

        /* å·¥ä½œåŒºæ¨¡å¼çš„AIæ¶ˆæ¯æ ·å¼ */
        .chat-container.workspace-mode .message.ai {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--accent-primary);
            position: relative;
            margin-left: 12px; /* ä¸ºå°å°¾å·´ç•™å‡ºç©ºé—´ */
        }

        /* AIæ¶ˆæ¯å·¦ä¾§å°å°¾å·´ */
        .chat-container.workspace-mode .message.ai::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-right: 8px solid var(--bg-tertiary);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 1;
        }

        .chat-container.workspace-mode .message.ai .avatar {
            display: none;
        }

        /* Agentæ¶ˆæ¯æ ·å¼ - æ·»åŠ å¼ºä¿æŠ¤æœºåˆ¶ */
        .message.agent {
            position: relative !important;
            margin: 16px 24px !important;
            border-radius: 12px !important;
            overflow: hidden !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            animation: slideInAgent 0.4s ease-out !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            /* å¼ºåˆ¶éš”ç¦»ï¼Œç¡®ä¿ä¸è¢«å…¶ä»–æ ·å¼å½±å“ */
            isolation: isolate !important;
            contain: layout style !important;
            z-index: 10 !important;
        }
        
        /* ä¸ºåŒ…å«tooltipçš„agentæ¶ˆæ¯åˆ›å»ºoverflowä¾‹å¤– */
        .message.agent.has-tooltip-container {
            overflow: visible !important;
        }

        /* Agentæ¶ˆæ¯æ‚¬åœæ•ˆæœ */
        .message.agent:hover {
            transform: translateY(-2px) scale(1.01) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4) !important;
        }

        /* Agentæ¶ˆæ¯è¾¹æ¡†é«˜äº® */
        .message.agent::before {
            content: '' !important;
            position: absolute !important;
            inset: -1px !important;
            border-radius: inherit !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
            z-index: -1 !important;
            filter: blur(6px) !important;
        }

        .message.agent:hover::before {
            opacity: 1 !important;
        }

        /* ä¸åŒç±»å‹Agentæ¶ˆæ¯çš„è¾¹æ¡†é«˜äº®é¢œè‰² */
        .message.agent.page-switch::before {
            background: linear-gradient(45deg, rgba(79, 70, 229, 0.8), rgba(99, 102, 241, 0.8)) !important;
        }

        .message.agent.agent-handoff::before {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.8), rgba(139, 92, 246, 0.8)) !important;
        }

        .message.agent.tool-start::before {
            background: linear-gradient(45deg, rgba(8, 145, 178, 0.8), rgba(6, 182, 212, 0.8)) !important;
        }

        .message.agent.tool-end::before {
            background: linear-gradient(45deg, rgba(5, 150, 105, 0.8), rgba(16, 185, 129, 0.8)) !important;
        }

        .message.agent.code-found::before {
            background: linear-gradient(45deg, rgba(220, 38, 38, 0.8), rgba(239, 68, 68, 0.8)) !important;
        }

        .message.agent.code-error::before {
            background: linear-gradient(45deg, rgba(234, 88, 12, 0.8), rgba(249, 115, 22, 0.8)) !important;
        }

        .message.agent.code-update::before {
            background: linear-gradient(45deg, rgba(124, 58, 237, 0.8), rgba(168, 85, 247, 0.8)) !important;
        }

        .message.agent.agent-end::before {
            background: linear-gradient(45deg, rgba(22, 163, 74, 0.8), rgba(34, 197, 94, 0.8)) !important;
        }

        .chat-container.workspace-mode .message.agent {
            margin: 12px 0 12px 12px !important; /* ä¸ºå°å°¾å·´ç•™å‡ºç©ºé—´ */
            border-radius: 10px !important;
            max-width: 95% !important;
            align-self: flex-start !important;
            /* å·¥ä½œåŒºæ¨¡å¼ä¸‹ä¹Ÿä¿æŒç¨³å®š */
            isolation: isolate !important;
            contain: layout style !important;
        }

        /* Agentæ¶ˆæ¯å·¦ä¾§å°å°¾å·´ï¼ˆä½¿ç”¨afteré¿å…ä¸beforeå†²çªï¼‰ */
        .chat-container.workspace-mode .message.agent::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-right: 8px solid;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            z-index: 2;
        }

        /* ä¸åŒç±»å‹Agentæ¶ˆæ¯çš„å°å°¾å·´é¢œè‰² */
        .chat-container.workspace-mode .message.agent.page-switch::after {
            border-right-color: #4f46e5;
        }

        .chat-container.workspace-mode .message.agent.agent-handoff::after {
            border-right-color: #7c3aed;
        }

        .chat-container.workspace-mode .message.agent.tool-start::after {
            border-right-color: #0891b2;
        }

        .chat-container.workspace-mode .message.agent.tool-end::after {
            border-right-color: #059669;
        }

        .chat-container.workspace-mode .message.agent.code-found::after {
            border-right-color: #dc2626;
        }

        .chat-container.workspace-mode .message.agent.code-error::after {
            border-right-color: #ea580c;
        }

        .chat-container.workspace-mode .message.agent.code-update::after {
            border-right-color: #7c3aed;
        }

        .chat-container.workspace-mode .message.agent.agent-end::after {
            border-right-color: #16a34a;
        }

        @keyframes slideInAgent {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .agent-message-header {
            padding: 12px 16px !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            /* é˜²æ­¢å†…å®¹æº¢å‡º */
            min-height: 44px !important;
            box-sizing: border-box !important;
        }

        .agent-message-content {
            padding: 14px 16px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            /* é˜²æ­¢å†…å®¹å½±å“å¸ƒå±€ */
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }

        .agent-title {
            flex: 1 !important;
            /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼© */
            min-width: 0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .agent-time {
            margin-left: auto !important;
            font-size: 11px !important;
            opacity: 0.8 !important;
            /* å›ºå®šæ—¶é—´æ˜¾ç¤ºä½ç½® */
            flex-shrink: 0 !important;
        }

        /* ä¸åŒç±»å‹çš„Agentæ¶ˆæ¯æ ·å¼ - ä½¿ç”¨!importantç¡®ä¿ä¼˜å…ˆçº§ */
        .message.agent.page-switch {
            background: linear-gradient(135deg, #4f46e5, #6366f1) !important;
            color: white !important;
        }

        .message.agent.agent-handoff {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important;
            color: white !important;
        }

        .message.agent.tool-start {
            background: linear-gradient(135deg, #0891b2, #06b6d4) !important;
            color: white !important;
        }

        .message.agent.tool-end {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            color: white !important;
        }

        .message.agent.code-found {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            color: white !important;
        }

        .message.agent.code-error {
            background: linear-gradient(135deg, #ea580c, #f97316) !important;
            color: white !important;
        }

        .message.agent.code-update {
            background: linear-gradient(135deg, #7c3aed, #a855f7) !important;
            color: white !important;
        }

        .message.agent.agent-end {
            background: linear-gradient(135deg, #16a34a, #22c55e) !important;
            color: white !important;
        }

        .agent-icon {
            font-size: 16px !important;
            width: 24px !important;
            height: 24px !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* æµå¼æ¶ˆæ¯ç‰¹æ®Šæ ·å¼ */
        .message[data-message-type="stream"] {
            position: relative;
        }

        .message[data-message-type="stream"]::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: rgba(79, 70, 229, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message[data-message-type="stream"].streaming::before {
            opacity: 1;
        }

        /* æ¶ˆæ¯å†…å®¹ */
        .message-content {
            max-width: 620px; /* å¢åŠ å®½åº¦ */
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.7;
            position: relative;
            padding: 16px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
        }

        .chat-container.workspace-mode .message-content {
            line-height: 1.6;
            color: #e5e5e5;
            flex: 1;
            max-width: 100%;
            background: rgba(42, 42, 42, 0.7);
        }

        /* AIæ¶ˆæ¯å†…å®¹æ‚¬åœæ•ˆæœ - ç²¾ç¡®å®šä½ */
        .message.ai .message-content {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .message.ai .message-content:hover {
            transform: translateY(-2px) translateX(3px) scale(1.01);
            background: rgba(30, 30, 30, 0.9);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25),
                        0 0 0 1px rgba(79, 70, 229, 0.4),
                        0 0 25px rgba(79, 70, 229, 0.15);
        }

        /* AIæ¶ˆæ¯å†…å®¹è¾¹æ¡†é«˜äº®æ•ˆæœ */
        .message.ai .message-content::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(45deg, 
                rgba(79, 70, 229, 0.6), 
                rgba(124, 58, 237, 0.6),
                rgba(59, 130, 246, 0.6),
                rgba(79, 70, 229, 0.6)
            );
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: -1;
            filter: blur(8px);
            animation: aiBorderFlow 4s ease-in-out infinite;
        }

        .message.ai .message-content:hover::after {
            opacity: 1;
        }

        @keyframes aiBorderFlow {
            0%, 100% { 
                filter: blur(8px);
                background-position: 0% 50%;
            }
            50% { 
                filter: blur(12px);
                background-position: 100% 50%;
            }
        }

        /* å¤„ç†ä¸­çŠ¶æ€ */
        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            margin: 0 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        .chat-container.workspace-mode .processing-indicator {
            margin: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .processing-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-primary);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            color: var(--accent-primary);
            font-weight: 500;
        }

        /* ===== æ€è€ƒæ¡†æ ·å¼ï¼ˆåªä½¿ç”¨thinking-steps-contentï¼‰ ===== */
        .thinking-steps-content {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(79, 70, 229, 0.15));
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            margin: 20px auto; /* å±…ä¸­æ˜¾ç¤º */
            width: 85%; /* é€‚ä¸­å®½åº¦ */
            max-width: 800px; /* åˆé€‚çš„æœ€å¤§å®½åº¦ */
            min-width: 320px;
            padding: 16px 24px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.15);
            position: relative;
            z-index: 10;
            animation: thinkingFadeIn 0.4s ease-out;
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.5;
        }

        @keyframes thinkingFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .thinking-status-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0 8px 0;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
            margin-bottom: 12px;
            gap: 12px;
        }

        .thinking-status-text {
            font-weight: 600;
            color: #a855f7;
            font-size: 14px;
            flex: 1;
            margin-right: 12px;
        }

        .thinking-detail-text {
            font-size: 14px;
            color: #e2e8f0;
            line-height: 1.5;
            min-height: 20px;
            margin-top: 8px;
            padding-left: 4px;
            position: relative;  /* ä¸ºtooltipå®šä½æä¾›å‚è€ƒ */
            max-height: 200px;   /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto;    /* å†…å®¹è¿‡å¤šæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }
        
        /* ğŸ¯ å½“åŒ…å«tooltipæ—¶ï¼Œå…è®¸å‚ç›´æº¢å‡ºä»¥æ˜¾ç¤ºtooltip */
        .thinking-detail-text.has-tooltip-content {
            overflow-y: visible !important;
            max-height: none !important;
        }

        /* ğŸ—‘ï¸ åˆ é™¤è¿‡æ—¶çš„tooltipæ ·å¼ï¼Œä½¿ç”¨æ–°çš„fixedå®šä½æ ·å¼ */
        
        .thinking-step-entry {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 13px;
            color: #e2e8f0;
            opacity: 0.9;
            position: relative;
            cursor: default;
            transition: all 0.2s ease;
        }
        
        .thinking-step-entry:hover {
            opacity: 1;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 4px;
            padding-left: 4px;
            padding-right: 4px;
        }
        
        /* ğŸ—‘ï¸ åˆ é™¤è¿‡æ—¶çš„CSS hoverè§„åˆ™ï¼Œä½¿ç”¨JavaScriptæ§åˆ¶tooltip */

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .thinking-steps-content {
                width: 95%;
                min-width: 280px;
                margin: 16px auto;
                padding: 12px 16px;
            }
            
            .thinking-status-text {
                font-size: 13px;
            }
            
            .thinking-detail-text {
                font-size: 13px;
            }
        }

        .thinking-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #a855f7;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1.5s linear infinite;
        }

        /* å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„æ€è€ƒæ¡†æ ·å¼ */
        .chat-container.workspace-mode .thinking-steps-content {
            margin: 16px auto;
            width: 92%;
            max-width: 100%;
            z-index: 15; /* ç¡®ä¿åœ¨å·¥ä½œåŒºæ¨¡å¼ä¸‹ä¸è¢«é®æŒ¡ */
        }

        .thinking-step {
            display: block; /* æ”¹ä¸ºflexå¸ƒå±€ */
            padding: 16px 24px; /* å¢åŠ å†…è¾¹è· */
            margin: 12px 0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05); /* ç¨å¾®åŠ æ·±èƒŒæ™¯ */
            border-left: 4px solid rgba(124, 58, 237, 0.5); /* åŠ ç²—å·¦è¾¹æ¡† */
            transition: all 0.3s ease;
            opacity: 0.9; /* æé«˜é€æ˜åº¦ */
            backdrop-filter: blur(8px);
        }

        .thinking-step:last-child {
            border-bottom: none;
        }

        .thinking-step.current {
            opacity: 1;
            background: rgba(124, 58, 237, 0.12);
            border-left-color: rgba(124, 58, 237, 0.8);
            border-left-width: 5px;
            transform: scale(1.01);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.3);
            animation: thinkingGlow 2s ease-in-out infinite alternate;
        }

        .thinking-step.completed {
            opacity: 0.9;
            background: rgba(16, 185, 129, 0.06);
            border-left-color: #10b981;
            color: #10b981;
        }

        .thinking-step.failed {
            opacity: 0.9;
            background: rgba(239, 68, 68, 0.06);
            border-left-color: #ef4444;
            color: #ef4444;
        }

        @keyframes thinkingGlow {
            from {
                box-shadow: 0 0 8px rgba(124, 58, 237, 0.2);
            }
            to {
                box-shadow: 0 0 16px rgba(124, 58, 237, 0.4);
            }
        }

        .thinking-step-icon {
            display: none; /* éšè—å·¦ä¾§å›¾æ ‡ */
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .thinking-step-text {
            font-size: 16px; /* æ”¾å¤§å­—ä½“ */
            line-height: 1.6;
            font-weight: 600; /* åŠ ç²—å­—ä½“ */
            color: #ffffff; /* é«˜äº®æ˜¾ç¤º */
            margin-bottom: 8px;
        }

        .thinking-step-detail {
            font-size: 14px; /* æ”¾å¤§å­—ä½“ */
            color: #e2e8f0; /* æ›´æ˜äº®çš„é¢œè‰² */
            margin-top: 6px;
            line-height: 1.5;
            opacity: 0.85;
        }

        .thinking-step.current .thinking-step-icon {
            animation: iconPulse 1s ease-in-out infinite;
        }

        .thinking-step.completed .thinking-step-icon {
            animation: none;
        }

        .thinking-step.failed .thinking-step-icon {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* éšè—æ€è€ƒè¿‡ç¨‹æ¶ˆæ¯çš„åŠ¨ç”» */
        .thinking-steps-content.hiding {
            animation: thinkingFadeOut 0.5s ease-in forwards;
        }

        @keyframes thinkingFadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px) scale(0.98);
                margin-top: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
                max-height: 0;
            }
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-container.workspace-mode .chat-input-area {
            padding: 20px;
            background: var(--bg-secondary);
        }

        .input-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .input-wrapper:focus-within {
            border-color: #404040;
        }

        .chat-container.workspace-mode .input-wrapper {
            background: var(--bg-tertiary);
            border-radius: 25px;
            padding: 8px 16px;
            border: 1px solid #404040;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            max-height: 200px;
            font-family: inherit;
        }

        .chat-container.workspace-mode .chat-input {
            padding: 8px 12px;
            font-size: 14px;
        }

        .chat-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .send-button {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: var(--accent-primary);
            color: white;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-container.workspace-mode .send-button {
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
        }

        .chat-container.workspace-mode .send-button:hover {
            background: #4338ca;
        }
        
        /* èŠå¤©è¾“å…¥å»ºè®®æ ·å¼ */
        .chat-input-suggestions {
            margin-top: 16px;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }
        
        .chat-input-suggestions.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        
        .chat-input-suggestions .suggestions-header {
            text-align: left;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        .chat-input-suggestions .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 8px;
        }
        
        .chat-input-suggestions .suggestion-item {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 13px;
        }
        
        .chat-input-suggestions .suggestion-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        
        .chat-input-suggestions .suggestion-icon {
            font-size: 14px;
        }
        
        /* å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„å»ºè®®æ ·å¼ */
        .chat-container.workspace-mode .chat-input-suggestions {
            margin-top: 12px;
        }
        
        .chat-container.workspace-mode .chat-input-suggestions .suggestion-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
        }

        .workspace-actions {
            display: none;
            gap: 8px;
            margin-left: 10px;
        }

        .chat-container.workspace-mode .workspace-actions {
            display: flex;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #888888;
        }

        .action-btn:hover {
            background: #404040;
        }

        .model-info {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #888888;
            margin-top: 8px;
        }

        .chat-container.workspace-mode .model-info {
            display: flex;
        }

        /* ===== ä»£ç é¢æ¿ ===== */
        .code-panel {
            position: absolute;
            top: 0;
            right: -50%;
            width: 50%;
            height: 100%;
            background: var(--code-bg);
            display: none;
            flex-direction: column;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 40;
        }

        .code-panel.active {
            display: flex;
            right: 0;
            animation: slideInFromRight 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInFromRight {
            from {
                right: -50%;
                opacity: 0;
            }
            to {
                right: 0;
                opacity: 1;
            }
        }

        .code-panel-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 14px 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .language-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: #ffffff;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
        }

        .file-name {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        /* æ–°å¢ï¼šåˆ†æ”¯ä¿¡æ¯æ ·å¼ */
        .branch-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(59, 130, 246, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .branch-icon {
            color: #3b82f6;
            font-size: 14px;
        }

        .branch-name {
            color: #3b82f6;
            font-size: 12px;
            font-weight: 500;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        .code-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modified-indicator {
            color: #f59e0b;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modified-indicator.show {
            opacity: 1;
        }

        .save-btn {
            padding: 6px 12px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .save-btn.show {
            opacity: 1;
        }

        .save-btn:hover {
            background: #2ea043;
        }

        .save-btn:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        .code-editor {
            flex: 1;
            background: var(--code-bg);
            color: #e6edf3;
            font-family: 'SFMono-Regular', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 20px;
            overflow-y: auto;
            border: none;
            outline: none;
            resize: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* ===== Markdownæ ·å¼ï¼ˆå…¨æ¨¡å¼é€šç”¨ï¼‰===== */
        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin: 20px 0 12px 0;
            font-weight: 600;
            color: #ffffff;
        }

        .message-content h1 {
            font-size: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content h2 {
            font-size: 20px;
        }

        .message-content h3 {
            font-size: 18px;
        }

        .message-content p {
            margin: 12px 0;
        }

        .message-content ul,
        .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 6px 0;
        }

        .message-content li::marker {
            color: var(--accent-primary);
        }

        /* å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„Markdownæ ·å¼ä¼˜åŒ– */
        .chat-container.workspace-mode .message-content h1,
        .chat-container.workspace-mode .message-content h2,
        .chat-container.workspace-mode .message-content h3 {
            margin: 16px 0 10px 0;
            font-weight: 600;
            color: #ffffff;
        }

        .chat-container.workspace-mode .message-content h1 {
            font-size: 20px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-container.workspace-mode .message-content h2 {
            font-size: 18px;
        }

        .chat-container.workspace-mode .message-content h3 {
            font-size: 16px;
        }

        .chat-container.workspace-mode .message-content p {
            margin: 10px 0;
            line-height: 1.5;
        }

        .chat-container.workspace-mode .message-content ul,
        .chat-container.workspace-mode .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .chat-container.workspace-mode .message-content li {
            margin: 4px 0;
        }

        /* ä»£ç å—æ ·å¼ */
        .message-content pre {
            background: var(--code-bg);
            border: 1px solid #30363d;
            border-radius: 8px;
            margin: 16px 0;
            overflow: hidden;
            font-size: 14px;
        }

        .chat-container.workspace-mode .message-content pre {
            background: var(--code-bg);
            border: 1px solid #404040;
            border-radius: 6px;
            margin: 12px 0;
            overflow: hidden;
            font-size: 13px;
        }

        .code-header {
            background: #161b22;
            padding: 8px 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .code-lang {
            color: var(--accent-primary);
            font-weight: 500;
        }

        .copy-btn {
            background: transparent;
            border: 1px solid #30363d;
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .message-content pre code {
            display: block;
            padding: 16px;
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e6edf3;
        }

        .chat-container.workspace-mode .message-content pre code {
            display: block;
            padding: 12px;
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #e6edf3;
        }

        .message-content code:not(pre code) {
            background: rgba(110, 118, 129, 0.2);
            color: #79c0ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 13px;
        }

        .chat-container.workspace-mode .message-content code:not(pre code) {
            background: rgba(110, 118, 129, 0.3);
            color: #79c0ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 12px;
        }

        /* å¼ºè°ƒæ–‡æœ¬ */
        .message-content strong {
            color: #ffffff;
            font-weight: 600;
        }

        .chat-container.workspace-mode .message-content strong {
            color: #ffffff;
            font-weight: 600;
        }

        .message-content em {
            font-style: italic;
            color: var(--text-secondary);
        }

        /* é“¾æ¥æ ·å¼ */
        .message-content a {
            color: #58a6ff;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .message-content a:hover {
            border-bottom-color: #58a6ff;
        }

        /* å¼•ç”¨å—æ ·å¼ */
        .message-content blockquote {
            border-left: 4px solid var(--accent-primary);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .chat-container.workspace-mode .message-content blockquote {
            border-left: 3px solid var(--accent-primary);
            padding-left: 12px;
            margin: 12px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content th,
        .message-content td {
            padding: 10px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .message-content tr:last-child td {
            border-bottom: none;
        }

        .message-content tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* åˆ†éš”çº¿ */
        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 24px 0;
        }

        /* å›¾ç‰‡æ ·å¼ */
        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }

        /* ===== ä¼šè¯å†å²é¢æ¿ ===== */
        .session-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .session-panel.open {
            right: 0;
        }

        .session-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }

        .session-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-session-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 18px;
        }

        .close-session-panel:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .session-item {
            background: var(--bg-tertiary);
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .session-item:hover {
            border-color: var(--accent-primary);
        }

        .session-item.active {
            border-color: var(--accent-primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .session-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .session-id {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .session-message-count {
            font-size: 11px;
            background: var(--accent-primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .session-last-activity {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .session-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .session-clear-btn {
            flex: 1;
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .session-clear-btn:hover {
            background: #b91c1c;
        }

        .session-load-btn {
            flex: 1;
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .session-load-btn:hover {
            background: #4338ca;
        }


        /* ===== çŠ¶æ€é€šçŸ¥æ ·å¼ ===== */
        .status-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }

        .status-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .status-notification.success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-notification.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-notification.warning {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .status-notification.info {
            border-color: var(--accent-primary);
            background: rgba(79, 70, 229, 0.1);
            color: var(--accent-primary);
        }

        .status-notification.loading {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
            color: #06b6d4;
        }

        /* åŠ è½½åŠ¨ç”» */
        .status-notification.loading #notificationMessage::before {
            content: "";
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* ===== æ»šåŠ¨æ¡æ ·å¼ ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }

        .code-panel ::-webkit-scrollbar-track {
            background: #161b22;
        }

        .code-panel ::-webkit-scrollbar-thumb {
            background: #30363d;
        }

        .code-panel ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        
        /* å¤§å±å¹•ä¼˜åŒ– (1200pxä»¥ä¸Š) */
        @media (min-width: 1200px) {
            .message.thinking {
                max-width: min(80vw, 1000px); /* å¤§å±å¹•å¯ä»¥æ›´å®½ */
                margin: 24px auto;
            }

            .thinking-content {
                padding: 28px 36px;
                overflow: visible;
            }

            .thinking-step {
                padding: 18px 28px;
                margin: 14px 0;
                border-radius: 14px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 17px;
                margin-bottom: 10px;
            }

            .thinking-step-detail {
                font-size: 15px;
                margin-top: 8px;
            }
        }

        /* ä¸­ç­‰å±å¹•ä¼˜åŒ– (769px - 1199px) */
        @media (min-width: 769px) and (max-width: 1199px) {
            .message.thinking {
                max-width: min(85vw, 900px);
                margin: 22px auto;
            }

            .thinking-content {
                padding: 26px 32px;
                overflow: visible;
            }

            .thinking-step {
                padding: 16px 24px;
                margin: 12px 0;
                border-radius: 13px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .thinking-step-detail {
                font-size: 14px;
                margin-top: 6px;
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 48px;
                margin-bottom: 30px;
            }

            .search-container {
                max-width: 100%;
                margin-bottom: 30px;
            }

            .search-input {
                font-size: 16px;
                padding: 16px 60px 16px 24px;
                min-height: 52px;
            }

            .suggestions-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .suggestion-item {
                padding: 14px 16px;
            }

            .suggestion-text {
                font-size: 13px;
            }

            .search-btn {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }

            .chat-container.workspace-mode,
            .code-panel.active {
                width: 100%;
                height: 50%;
            }

            .chat-container.workspace-mode {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .code-panel.active {
                top: 50%;
                right: 0;
                height: 50%;
            }

            .chat-messages {
                padding: 24px 0;
            }

            .message {
                padding: 0 16px;
            }

            .message-content {
                font-size: 14px;
            }

            .session-panel {
                width: 100%;
                right: -100%;
            }

            .status-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-100%);
            }

            .status-notification.show {
                transform: translateY(0);
            }

            .message.user .message-content {
                max-width: 85%;
                padding: 14px 16px;
                font-size: 14px;
                border-radius: 18px 18px 4px 18px;
            }

            .message.user .avatar {
                width: 32px;
                height: 32px;
                font-size: 16px;
                margin-left: 8px;
            }

            .chat-container.workspace-mode .message.user .user-message {
                max-width: 90%;
                padding: 12px 14px;
                font-size: 13px;
                border-radius: 16px 16px 4px 16px;
                margin-right: 10px;
            }

            .chat-container.workspace-mode .message.user .user-message::after {
                right: -7px;
                border-left-width: 7px;
                border-top-width: 5px;
                border-bottom-width: 5px;
            }

            /* ç§»åŠ¨ç«¯æ€è€ƒæ¡†ä¼˜åŒ– */
            .message.thinking {
                max-width: min(95vw, 900px); /* ç§»åŠ¨ç«¯ä½¿ç”¨æ›´å¤§çš„å®½åº¦ */
                margin: 16px auto;
                border-radius: 12px;
            }

            .thinking-header {
                padding: 12px 16px 10px;
            }

            .thinking-title {
                font-size: 13px;
            }

            .thinking-content {
                padding: 20px 24px;
                overflow: visible;
                min-height: 60px;
            }

            .thinking-step {
                padding: 14px 20px;
                margin: 10px 0;
                border-radius: 10px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 15px;
                line-height: 1.5;
                margin-bottom: 6px;
            }

            .thinking-step-detail {
                font-size: 13px;
                margin-top: 5px;
            }
        }

        @media (max-width: 480px) {
            .message.user .message-content {
                max-width: 90%;
                padding: 12px 14px;
                border-radius: 16px 16px 4px 16px;
            }

            .chat-container.workspace-mode .message.user .user-message {
                max-width: 95%;
                padding: 10px 12px;
                border-radius: 14px 14px 4px 14px;
                margin-right: 8px;
            }

            .chat-container.workspace-mode .message.user .user-message::after {
                right: -6px;
                border-left-width: 6px;
                border-top-width: 4px;
                border-bottom-width: 4px;
            }

            /* å°å±å¹•æ€è€ƒæ¡†è¿›ä¸€æ­¥ä¼˜åŒ– */
            .message.thinking {
                max-width: 98vw; /* å°å±å¹•å‡ ä¹å…¨å®½ */
                margin: 12px auto;
                border-radius: 10px;
            }

            .thinking-header {
                padding: 10px 12px 8px;
            }

            .thinking-title {
                font-size: 12px;
                gap: 6px;
            }

            .thinking-spinner {
                width: 14px;
                height: 14px;
            }

            .thinking-content {
                padding: 18px 22px;
                overflow: visible;
                min-height: 50px;
            }

            .thinking-step {
                padding: 12px 18px;
                margin: 8px 0;
                border-radius: 8px;
            }

            .thinking-step-icon {
                display: none;
            }

            .thinking-step-text {
                font-size: 14px;
                line-height: 1.4;
                margin-bottom: 5px;
            }

            .thinking-step-detail {
                font-size: 12px;
                margin-top: 4px;
                opacity: 0.85;
            }
        }

        /* hljsè¦†ç›– */
        .hljs {
            background: transparent !important;
            padding: 0 !important;
        }

        /* å·¥ä½œåŒºæµå¼æ¶ˆæ¯ç‰¹æ®Šå¤„ç† */
        .chat-container.workspace-mode .message[data-stream-isolated="true"] {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid var(--accent-primary);
            margin-bottom: 20px;
        }

        .chat-container.workspace-mode .message[data-stream-isolated="true"] .avatar {
            display: none;
        }

        .chat-container.workspace-mode .message[data-stream-isolated="true"] .message-content {
            flex: 1;
            max-width: 100%;
            line-height: 1.6;
            color: #e5e5e5;
        }

        /* ===== å¤åˆ¶åé¦ˆåŠ¨ç”» ===== */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* ===== åˆ é™¤åŠ¨ç”» ===== */
        @keyframes slideOutRight {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== èœå•é¡¹æ ·å¼ ===== */
        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .menu-item:hover {
            background: var(--bg-tertiary);
        }

        /* ===== èŠå¤©æ¡†å†…ç¡®è®¤å¡ç‰‡æ ·å¼ ===== */
        .message.confirm-card {
            padding: 0 24px !important;
            margin-bottom: 24px !important;
            animation: slideInFromLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .chat-container.workspace-mode .message.confirm-card {
            padding: 0 !important;
            margin-bottom: 20px !important;
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .confirm-card-content {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 480px;
            margin-left: 44px; /* ä¸ºAIå¤´åƒç•™å‡ºç©ºé—´ */
            position: relative;
        }

        .chat-container.workspace-mode .confirm-card-content {
            margin-left: 0;
            max-width: 100%;
        }

        .confirm-card-header {
            padding: 20px 20px 16px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .confirm-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .confirm-card-icon {
            font-size: 40px;
            margin-bottom: 8px;
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .confirm-card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 6px 0;
        }

        .confirm-card-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
        }

        .confirm-card-body {
            padding: 20px;
            text-align: center;
        }

        .confirm-card-message {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .file-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .confirm-card-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
            position: relative;
            overflow: hidden;
        }

        .confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .confirm-btn:hover::before {
            left: 100%;
        }

        .confirm-btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 3px 12px rgba(79, 70, 229, 0.3);
        }

        .confirm-btn-primary:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            transform: translateY(-1px);
        }

        .confirm-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .confirm-btn-secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .confirm-btn-loading {
            position: relative;
            color: transparent !important;
        }

        .confirm-btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 14px;
            height: 14px;
            margin: -7px 0 0 -7px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .confirm-card-content {
                margin-left: 36px;
            }
            
            .confirm-card-header {
                padding: 16px 16px 12px 16px;
            }
            
            .confirm-card-icon {
                font-size: 32px;
                margin-bottom: 6px;
            }
            
            .confirm-card-title {
                font-size: 16px;
            }
            
            .confirm-card-subtitle {
                font-size: 12px;
            }
            
            .confirm-card-body {
                padding: 16px;
            }
            
            .confirm-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .confirm-btn {
                min-width: auto;
                width: 100%;
            }
        }

        /* æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºæ ·å¼ */
        .file-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 14px;
            color: #495057;
            line-height: 1.5;
        }

        .file-info strong {
            color: #212529;
            font-weight: 600;
        }
        
        /* ===== EDWç›¸å…³æ ·å¼ ===== */
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 24px;
            border: 1px solid var(--border-color);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .progress-step {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .progress-percent {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .progress-bar-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--accent-color), #764ba2);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        
        /* å¢å¼ºä»£ç æ˜¾ç¤ºæ ·å¼ */
        .message.enhanced-code,
        .message.refined-code,
        .message.original-code {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-color);
            margin: 16px 24px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .enhanced-code-header,
        .refined-code-header,
        .original-code-header {
            background: linear-gradient(135deg, var(--accent-color), #764ba2);
            color: white;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
        }
        
        /* åŸå§‹ä»£ç ç‰¹æ®Šæ ·å¼ */
        .message.original-code {
            border-color: #10b981;
        }
        
        .original-code-header {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .code-meta-info {
            margin-top: 8px;
        }
        
        /* éšè—å…ƒæ•°æ®é¢æ¿ï¼Œä¿¡æ¯å·²ç§»åˆ°header */
        .code-meta-panel {
            display: none !important;
        }
        
        .message.enhanced-code pre,
        .message.refined-code pre,
        .message.original-code pre {
            margin: 0;
            padding: 16px;
            background: var(--bg-primary);
            overflow-x: auto;
        }
        
        .code-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .code-actions button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .code-actions button:hover {
            background: #5a52d5;
            transform: translateY(-1px);
        }
        
        
        /* èŠ‚ç‚¹çŠ¶æ€æ ·å¼ */
        .node-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 12px;
            margin: 4px;
        }
        
        .node-status.processing {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .node-status.success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .node-status.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        /* SQLæ¨¡æ€æ¡†æ ·å¼ */
        .sql-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }
        
        .sql-modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .sql-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sql-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .sql-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .sql-modal-body pre {
            margin: 0;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .sql-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .sql-modal-footer button {
            padding: 8px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .sql-modal-footer button:first-child {
            background: var(--accent-color);
            color: white;
        }
        
        .sql-modal-footer button:first-child:hover {
            background: #5a52d5;
            transform: translateY(-1px);
        }
        
        .sql-modal-footer button:last-child {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .sql-modal-footer button:last-child:hover {
            background: var(--border-color);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* ä»£ç æ ‡ç­¾é¡µæ ·å¼ */
        .code-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 16px;
            gap: 4px;
        }
        
        .code-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-size: 13px;
            position: relative;
            user-select: none;
        }
        
        .code-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        
        .code-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: var(--bg-primary);
        }
        
        .code-tab .tab-icon {
            font-size: 14px;
        }
        
        .code-tab .tab-text {
            font-weight: 500;
        }
        
        /* æ ‡ç­¾å†…å®¹åŒºåŸŸ */
        .code-tab-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .tab-pane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
        }
        
        .tab-pane.active {
            display: flex;
            flex-direction: column;
        }
        
        /* ä»£ç æ˜¾ç¤ºåŒ…è£…å™¨ */
        .code-display-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
        }
        
        /* ä»£ç å·¥å…·æ  */
        .code-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(139, 148, 158, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .code-tool-btn {
            padding: 6px 14px;
            background: rgba(139, 148, 158, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(139, 148, 158, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .code-tool-btn:hover {
            background: rgba(139, 148, 158, 0.2);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        
        /* ä»£ç æ˜¾ç¤ºåŒºåŸŸ */
        .code-display {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .code-display pre {
            margin: 0;
            padding: 20px;
            background: transparent;
            min-height: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .code-display pre code {
            display: block;
            background: transparent;
            color: #e6edf3;
            padding: 0;
            border-radius: 0;
            white-space: pre;
            word-wrap: normal;
            overflow-x: auto;
        }
        
        /* è¡Œå·æ ·å¼ */
        .code-display pre.line-numbers {
            counter-reset: line;
            padding-left: 60px;
            position: relative;
        }
        
        .code-display pre.line-numbers code {
            counter-increment: line;
        }
        
        .code-display pre.line-numbers::before {
            content: counter(line);
            display: inline-block;
            width: 40px;
            text-align: right;
            margin-right: 16px;
            color: rgba(139, 148, 158, 0.4);
            position: absolute;
            left: 16px;
        }
        
        /* ç¼–è¾‘æ¨¡å¼çš„textarea */
        .code-editor-raw {
            width: 100%;
            height: 100%;
            border: none;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: #0d1117;
            color: #e6edf3;
            resize: none;
            outline: none;
            overflow-y: auto;
        }
        
        /* è¯­æ³•é«˜äº®å¢å¼º */
        .hljs {
            background: transparent !important;
            padding: 0 !important;
        }
        
        .hljs-keyword {
            color: #ff79c6;
            font-weight: bold;
        }
        
        .hljs-string {
            color: #f1fa8c;
        }
        
        .hljs-comment {
            color: #6272a4;
            font-style: italic;
        }
        
        .hljs-number {
            color: #bd93f9;
        }
        
        .hljs-function {
            color: #50fa7b;
        }
        
        .hljs-variable {
            color: #8be9fd;
        }
        
        .hljs-type {
            color: #ff79c6;
        }
        
        /* è°ƒæ•´ä»£ç é¢æ¿å¸ƒå±€ä»¥é€‚åº”æ ‡ç­¾é¡µ */
        #codePanel {
            display: flex;
            flex-direction: column;
        }
        
        #codePanel .code-panel-header {
            flex-shrink: 0;
        }
        
        #codePanel .code-tabs {
            flex-shrink: 0;
        }
        
        #codePanel .code-tab-content {
            flex: 1;
            min-height: 0;
        }
        
        /* å·¥å…·å‚æ•°æ‚¬åœæ˜¾ç¤ºæ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        /* ç§»é™¤CSS hoveræ§åˆ¶ï¼Œæ”¹ç”¨JavaScriptæ§åˆ¶ */

        .thinking-step-entry.has-tooltip {
            position: relative;
        }

        .tool-params-tooltip {
            position: fixed;
            /* JavaScriptä¼šåŠ¨æ€è®¾ç½®top, left */
            min-width: 450px;
            max-width: 650px;
            background: rgba(15, 15, 25, 0.98);
            border: 2px solid rgba(124, 58, 237, 0.9);
            border-radius: 16px;
            padding: 20px;
            display: none;
            z-index: 999999; /* ğŸ¯ æé«˜z-indexï¼Œç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Š */
            max-height: 450px;
            overflow-y: auto;
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(124, 58, 237, 0.2);
            backdrop-filter: blur(20px);
            font-size: 13px;
            color: #e2e8f0;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            /* ç¡®ä¿é¼ æ ‡å¯ä»¥ç§»åˆ°tooltipä¸Šè€Œä¸ä¸¢å¤±hover */
            pointer-events: auto;
            /* é˜²æ­¢æº¢å‡ºå±å¹•è¾¹ç•Œ */
            max-width: calc(100vw - 50px); /* ğŸ¯ å¢åŠ è¾¹è· */
        }
        
        /* tooltipæ˜¾ç¤ºçŠ¶æ€ */
        .tool-params-tooltip.show {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
            display: block !important;
        }
        
        /* æå‡è§¦å‘åŒºåŸŸçš„ç¨³å®šæ€§ */
        .thinking-step-entry.has-tooltip {
            padding: 2px 0;
        }
        
        /* å‚æ•°æ ‡è®°æ ·å¼ï¼ˆç°åœ¨ç›´æ¥åœ¨HTMLä¸­ï¼‰ */
        .param-indicator {
            transition: all 0.2s ease;
        }
        
        .param-indicator:hover {
            color: #c084fc !important;
            transform: scale(1.1);
        }
    </style>
</head>
<body>

<!-- ä¸»é¡µ -->
<div class="homepage-container" id="homepage">
    <div class="logo">Turing</div>
    <div class="search-container">
        <div class="search-input-wrapper">
            <textarea class="search-input" id="searchInput" placeholder="å—¨ï¼æˆ‘æ˜¯ Turingï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ" rows="1"></textarea>
            <button class="search-btn" id="searchBtn">â¤</button>
        </div>
        
        <!-- è¾“å…¥å»ºè®® -->
        <div class="input-suggestions" id="inputSuggestions">
            <div class="suggestions-header">ğŸ’¡ è¯•è¯•è¿™äº›é—®é¢˜</div>
            <div class="suggestions-grid">
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">ğŸ“Š</span>
                    <span class="suggestion-text">å¢å¼ºè¡¨dwd_fi.fi_invoice_item</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">ğŸ”§</span>
                    <span class="suggestion-text">æŸ¥è¯¢ä¸€ä¸‹dwd_fi.fi_invoice_itemæ ·ä¾‹æ•°æ®</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">ğŸ“ˆ</span>
                    <span class="suggestion-text">æ ‡å‡†åŒ–å±æ€§åç§°ï¼šInvoice Document Number</span>
                </div>
                <div class="suggestion-item" onclick="applySuggestion(this)">
                    <span class="suggestion-icon">ğŸ¯</span>
                    <span class="suggestion-text">ä»€ä¹ˆæ˜¯ç¾Šç¾¤æ•ˆåº”</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- èŠå¤©å®¹å™¨ -->
<div class="chat-container" id="chatContainer">
    <!-- å¤´éƒ¨ -->
    <div class="chat-header">
        <div class="chat-title">
            <span id="chatTitle">ä¸ Turing å¯¹è¯</span>
            <div class="session-info" id="sessionInfo">
                <span>ğŸ’¬</span>
                <span id="sessionMessageCount">æ–°ä¼šè¯</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="session-btn" onclick="toggleSessionPanel()">
                ğŸ“š å†å²
            </button>
            <button class="back-btn" onclick="goBackToHomepage()">
                â† è¿”å›ä¸»é¡µ
            </button>
        </div>
    </div>

    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div class="chat-messages" id="chatMessages">
        <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
        <div class="message ai" data-message-type="static" data-stable="true">
            <div class="avatar">ğŸ¤–</div>
            <div class="message-content">
                <p>æ‚¨å¥½ï¼æˆ‘æ˜¯ <strong>Turing</strong>ï¼Œé—®ä½ æƒ³é—®ã€‚</p>
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input-area">
        <div class="input-wrapper">
            <textarea
                    class="chat-input"
                    id="chatInput"
                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                    rows="1"
            ></textarea>
            <div class="workspace-actions">
                <button class="action-btn" onclick="uploadFiles()">ğŸ“</button>
                <button class="action-btn">ğŸ”</button>
            </div>
            <button class="send-button" id="sendBtn" onclick="sendMessage()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
        
        <!-- èŠå¤©è¾“å…¥å»ºè®® -->
        <div class="chat-input-suggestions" id="chatInputSuggestions">
            <div class="suggestions-header">ğŸ’¡ å¿«é€Ÿè¾“å…¥</div>
            <div class="suggestions-grid">
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">ğŸ“Š</span>
                    <span class="suggestion-text">å¸®æˆ‘åˆ†æé”€å”®æ•°æ®è¡¨çš„å­—æ®µç»“æ„</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">ğŸ”§</span>
                    <span class="suggestion-text">ä¸ºç”¨æˆ·è¡¨æ·»åŠ æ–°çš„ä¸šåŠ¡å­—æ®µ</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">ğŸ“ˆ</span>
                    <span class="suggestion-text">ä¼˜åŒ–è®¢å•è¡¨çš„æŸ¥è¯¢æ€§èƒ½</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">ğŸ”</span>
                    <span class="suggestion-text">æ£€æŸ¥æ•°æ®è´¨é‡é—®é¢˜å¹¶ç”ŸæˆæŠ¥å‘Š</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">ğŸ—ï¸</span>
                    <span class="suggestion-text">è®¾è®¡ä¸€ä¸ªæ–°çš„æ•°æ®æ¨¡å‹</span>
                </div>
                <div class="suggestion-item" onclick="applyChatSuggestion(this)">
                    <span class="suggestion-icon">âš¡</span>
                    <span class="suggestion-text">æ‰¹é‡æ›´æ–°è¡¨å­—æ®µçš„ä¸šåŠ¡é€»è¾‘</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä»£ç é¢æ¿ -->
<div class="code-panel" id="codePanel">
    <div class="code-panel-header">
        <div class="file-info">
            <div class="language-tag" id="languageTag">ä»£ç </div>
            <div class="file-name" id="fileName">è¯·åœ¨å·¦ä¾§æè¿°ä½ çš„éœ€æ±‚...</div>
            <div class="branch-info" id="branchInfo" style="display: none;">
                <span class="branch-icon">ğŸŒ¿</span>
                <span class="branch-name" id="branchName">æœªçŸ¥åˆ†æ”¯</span>
            </div>
        </div>
        <div class="code-actions">
            <div class="modified-indicator" id="modifiedIndicator">å·²ä¿®æ”¹</div>
            <button class="save-btn" id="saveBtn" onclick="saveCode()">ğŸ’¾ ä¿å­˜</button>
        </div>
    </div>
    
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="code-tabs" id="codeTabs">
        <div class="code-tab active" data-tab="enhanced-code" onclick="switchCodeTab('enhanced-code')">
            <span class="tab-icon">ğŸ“</span>
            <span class="tab-text">å¢å¼ºä»£ç </span>
        </div>
        <div class="code-tab" data-tab="create-table" onclick="switchCodeTab('create-table')">
            <span class="tab-icon">ğŸ”¨</span>
            <span class="tab-text">CREATE TABLE</span>
        </div>
        <div class="code-tab" data-tab="alter-table" onclick="switchCodeTab('alter-table')">
            <span class="tab-icon">ğŸ”§</span>
            <span class="tab-text">ALTER TABLE</span>
        </div>
    </div>
    
    <!-- æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯åŒºåŸŸ -->
    <div class="code-meta-panel" id="codeMetaPanel" style="display: none;">
        <div class="meta-info-row">
            <span class="meta-label">ğŸ“ æ–‡ä»¶:</span>
            <span class="meta-value" id="metaFileName">æœªçŸ¥æ–‡ä»¶</span>
        </div>
        <div class="meta-info-row">
            <span class="meta-label">ğŸŒ¿ åˆ†æ”¯:</span>
            <span class="meta-value" id="metaBranch">æœªçŸ¥åˆ†æ”¯</span>
        </div>
        <div class="meta-info-row" id="metaBaseTablesRow" style="display: none;">
            <span class="meta-label">ğŸ“Š åº•è¡¨:</span>
            <span class="meta-value" id="metaBaseTables"></span>
        </div>
    </div>

    <!-- æ ‡ç­¾é¡µå†…å®¹åŒºåŸŸ -->
    <div class="code-tab-content" id="codeTabContent">
        <!-- å¢å¼ºä»£ç æ ‡ç­¾é¡µ -->
        <div class="tab-pane active" data-pane="enhanced-code">
            <div class="code-display-wrapper">
                <div class="code-toolbar">
                    <button class="code-tool-btn" onclick="copyCodeContent('enhanced')">ğŸ“‹ å¤åˆ¶</button>
                    <button class="code-tool-btn" onclick="toggleFullscreen('enhanced')">ğŸ” å…¨å±</button>
                    <button class="code-tool-btn" onclick="toggleEditMode('enhanced')">âœï¸ ç¼–è¾‘</button>
                </div>
                <div class="code-display" id="enhancedCodeDisplay">
                    <pre class="line-numbers"><code class="language-sql" id="enhancedCodeContent">-- æ¬¢è¿ä½¿ç”¨æ•°æ®å¼€å‘åŠ©æ‰‹ï¼
-- è¯·åœ¨å·¦ä¾§æè¿°ä½ çš„éœ€æ±‚ï¼Œæˆ‘å°†ä¸ºä½ ç”Ÿæˆç›¸åº”çš„ä»£ç 
-- å¢å¼ºä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</code></pre>
                </div>
                <textarea class="code-editor-raw" id="codeEditor" style="display:none;" placeholder="ç¼–è¾‘æ¨¡å¼ä¸‹å¯ä¿®æ”¹ä»£ç ..."></textarea>
            </div>
        </div>
        
        <!-- CREATE TABLEæ ‡ç­¾é¡µ -->
        <div class="tab-pane" data-pane="create-table">
            <div class="code-display-wrapper">
                <div class="code-toolbar">
                    <button class="code-tool-btn" onclick="copyCodeContent('create')">ğŸ“‹ å¤åˆ¶</button>
                    <button class="code-tool-btn" onclick="toggleFullscreen('create')">ğŸ” å…¨å±</button>
                </div>
                <div class="code-display" id="createTableDisplay">
                    <pre class="line-numbers"><code class="language-sql" id="createTableContent">-- CREATE TABLE è¯­å¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º
-- ç­‰å¾…ç”Ÿæˆå¢å¼ºä»£ç ...</code></pre>
                </div>
                <textarea class="code-editor-raw" id="createTableEditor" style="display:none;"></textarea>
            </div>
        </div>
        
        <!-- ALTER TABLEæ ‡ç­¾é¡µ -->
        <div class="tab-pane" data-pane="alter-table">
            <div class="code-display-wrapper">
                <div class="code-toolbar">
                    <button class="code-tool-btn" onclick="copyCodeContent('alter')">ğŸ“‹ å¤åˆ¶</button>
                    <button class="code-tool-btn" onclick="toggleFullscreen('alter')">ğŸ” å…¨å±</button>
                </div>
                <div class="code-display" id="alterTableDisplay">
                    <pre class="line-numbers"><code class="language-sql" id="alterTableContent">-- ALTER TABLE è¯­å¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º
-- ç­‰å¾…ç”Ÿæˆå¢å¼ºä»£ç ...</code></pre>
                </div>
                <textarea class="code-editor-raw" id="alterTableEditor" style="display:none;"></textarea>
            </div>
        </div>
    </div>
</div>

<!-- ä¼šè¯å†å²é¢æ¿ -->
<div class="session-panel" id="sessionPanel">
    <div class="session-panel-header">
        <div class="session-panel-title">ğŸ’¬ ä¼šè¯å†å²</div>
        <button class="close-session-panel" onclick="toggleSessionPanel()">Ã—</button>
    </div>
    <div class="session-list" id="sessionList">
        <!-- ä¼šè¯åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
    </div>
</div>


<!-- çŠ¶æ€é€šçŸ¥ -->
<div class="status-notification" id="statusNotification">
    <span id="notificationMessage"></span>
</div>


<script>
    // ===== å…¨å±€å˜é‡ =====
    let selectedModule = null;
    let currentFile = null;
    let originalCode = '';
    let isCodeModified = false;
    let currentPage = 'homepage'; // 'homepage', 'chat', 'workspace'
    let currentMode = 'chat';
    let currentSessionId = null;
    let sessionPanelOpen = false;
    let pendingUserInput = '';
    let isProcessing = false; // é˜²æ­¢é‡å¤å‘é€

    // SocketIOç›¸å…³å˜é‡
    let socket = null;
    let socketConnected = false;

    // æ¶ˆæ¯å»é‡å’Œä¿æŠ¤
    let processedMessages = new Set();
    let agentMessageRegistry = new Map(); // ä¿æŠ¤Agentæ¶ˆæ¯æ³¨å†Œè¡¨

    // æ·»åŠ å¤„ç†çŠ¶æ€ç®¡ç†
    const messageProcessingStates = new Map();

    // ç¡®è®¤å¡ç‰‡çŠ¶æ€ç®¡ç†
    let isUpdateCodeCardVisible = false;
    let isRunCodeCardVisible = false;
    let pendingUpdateAction = null;
    let pendingRunAction = null;
    
    // æ¨¡å‹å¢å¼ºå®Œæˆä¿¡æ¯ç¼“å­˜
    let pendingEnhanceInfo = null;
    
    // æ€è€ƒæ¡†çŠ¶æ€ç®¡ç†
    let thinkingBoxVisible = false;
    let thinkingSteps = new Map(); // å­˜å‚¨æ€è€ƒæ­¥éª¤çŠ¶æ€
    let currentThinkingMessageId = null; // å½“å‰æ€è€ƒæ¶ˆæ¯çš„ID
    
    // ===== ç»Ÿä¸€æ¶ˆæ¯ç®¡ç†ç³»ç»Ÿ =====
    /**
     * æ¶ˆæ¯ç±»å‹æšä¸¾
     */
    const MessageType = {
        USER: 'user',              // ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
        AI_STREAM: 'ai_stream',    // chat_stream APIå“åº”
        THINKING: 'thinking',      // æ€è€ƒæ¡†æ¶ˆæ¯
        SYSTEM: 'system',          // åç«¯ä¸»åŠ¨æ¨é€çš„ç³»ç»Ÿæ¶ˆæ¯
        AGENT: 'agent'             // Agentå®æ—¶æ¶ˆæ¯
    };
    
    /**
     * æ¶ˆæ¯ç®¡ç†å™¨ç±» - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¶ˆæ¯å’Œæ€è€ƒæ¡†ç”Ÿå‘½å‘¨æœŸ
     */
    class MessageManager {
        constructor() {
            this.messages = new Map();
            this.thinkingState = {
                visible: false,
                messageId: null,
                streamSessionId: null,  // å…³è”çš„streamä¼šè¯ID
                startTime: null,
                timeout: null
            };
            this.messageOrder = [];  // ç»´æŠ¤æ¶ˆæ¯é¡ºåº
        }
        
        /**
         * æ·»åŠ æ¶ˆæ¯åˆ°å®¹å™¨
         */
        addMessage(type, content, options = {}) {
            const messageId = this.generateMessageId(type);
            const messageData = {
                id: messageId,
                type: type,
                content: content,
                timestamp: Date.now(),
                ...options
            };
            
            this.messages.set(messageId, messageData);
            this.messageOrder.push(messageId);
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©æ¸²æŸ“æ–¹å¼
            switch(type) {
                case MessageType.USER:
                    return this.renderUserMessage(messageData);
                case MessageType.AI_STREAM:
                    return this.renderStreamMessage(messageData);
                case MessageType.THINKING:
                    return this.renderThinkingBox(messageData);
                case MessageType.SYSTEM:
                    return this.renderSystemMessage(messageData);
                case MessageType.AGENT:
                    return this.renderAgentMessage(messageData);
                default:
                    console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', type);
                    return null;
            }
        }
        
        /**
         * å¼€å§‹æ€è€ƒæ¡†æ˜¾ç¤º
         */
        startThinking(sessionId) {
            // å¦‚æœå·²æœ‰æ€è€ƒæ¡†åœ¨æ˜¾ç¤ºï¼Œå…ˆç»“æŸå®ƒ
            if (this.thinkingState.visible) {
                console.log('ğŸ”„ ç»“æŸä¹‹å‰çš„æ€è€ƒæ¡†ï¼Œå¼€å§‹æ–°çš„');
                this.endThinking();
            }
            
            console.log('ğŸ§  å¼€å§‹æ˜¾ç¤ºæ€è€ƒæ¡†ï¼ŒsessionId:', sessionId);
            
            const messageId = this.generateMessageId(MessageType.THINKING);
            
            this.thinkingState = {
                visible: true,
                messageId: messageId,
                streamSessionId: sessionId,
                startTime: Date.now(),
                timeout: setTimeout(() => {
                    console.warn('â° æ€è€ƒæ¡†è¶…æ—¶ï¼Œè‡ªåŠ¨éšè—');
                    this.endThinking();
                }, 300000)  // 5åˆ†é’Ÿè¶…æ—¶
            };
            
            // åˆ›å»ºæ€è€ƒæ¡†DOM
            const messagesContainer = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = messageId;
            thinkingDiv.className = 'thinking-steps-content';
            thinkingDiv.innerHTML = `
                <div class="thinking-status-line">
                    <div class="thinking-status-text">AIæ­£åœ¨æ€è€ƒ...</div>
                    <div class="thinking-spinner"></div>
                </div>
                <div class="thinking-detail-text"></div>
            `;
            
            // æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
            messagesContainer.appendChild(thinkingDiv);
            
            // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆä¸ºäº†å…¼å®¹æ—§ä»£ç ï¼‰
            thinkingBoxVisible = true;
            currentThinkingMessageId = messageId;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            this.scrollToBottom();
            
            return messageId;
        }
        
        /**
         * ç»“æŸæ€è€ƒæ¡†æ˜¾ç¤º
         */
        endThinking(force = false) {
            if (!this.thinkingState.visible && !force) {
                console.log('âš ï¸ æ€è€ƒæ¡†å·²ç»éšè—');
                return;
            }
            
            console.log('ğŸ§  ç»“æŸæ€è€ƒæ¡†æ˜¾ç¤º');
            
            // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
            if (this.thinkingState.timeout) {
                clearTimeout(this.thinkingState.timeout);
            }
            
            // æ¸…ç†æ‰€æœ‰ç›¸å…³çš„tooltip
            this.cleanupTooltips();
            
            // ç§»é™¤æ€è€ƒæ¡†DOM
            const thinkingBox = document.getElementById(this.thinkingState.messageId);
            if (thinkingBox) {
                thinkingBox.classList.add('hiding');
                setTimeout(() => {
                    thinkingBox.remove();
                }, 500);
            }
            
            // é‡ç½®çŠ¶æ€
            this.thinkingState = {
                visible: false,
                messageId: null,
                streamSessionId: null,
                startTime: null,
                timeout: null
            };
            
            // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆä¸ºäº†å…¼å®¹æ—§ä»£ç ï¼‰
            thinkingBoxVisible = false;
            currentThinkingMessageId = null;
            thinkingSteps.clear();
        }
        
        /**
         * æ¸…ç†æ‰€æœ‰tooltipå…ƒç´ 
         */
        cleanupTooltips() {
            const tooltips = document.querySelectorAll('.tool-params-tooltip');
            tooltips.forEach(tooltip => {
                tooltip.remove();
            });
            
            // ğŸ¯ æ¸…ç†has-tooltip-containeræ ‡è®°
            const containers = document.querySelectorAll('.message.agent.has-tooltip-container');
            containers.forEach(container => {
                container.classList.remove('has-tooltip-container');
            });
            
            // ğŸ¯ æ¸…ç†thinking-detail-textå®¹å™¨çš„has-tooltip-contentæ ‡è®°
            const detailContainers = document.querySelectorAll('.thinking-detail-text.has-tooltip-content');
            detailContainers.forEach(container => {
                container.classList.remove('has-tooltip-content');
            });
        }
        
        /**
         * æ›´æ–°æ€è€ƒæ¡†è¿›åº¦ï¼ˆå¸¦æ‚¬åœæ•°æ®ï¼‰ - å·¥å…·æ‰§è¡Œä¸“ç”¨
         */
        updateThinkingProgressWithHover(stepId, status, message, hoverData) {
            if (!this.thinkingState.visible || !this.thinkingState.messageId) {
                console.warn('âš ï¸ æ€è€ƒæ¡†ä¸å¯è§ï¼Œæ— æ³•æ›´æ–°è¿›åº¦');
                return;
            }
            
            const thinkingBox = document.getElementById(this.thinkingState.messageId);
            if (!thinkingBox) return;
            
            const statusText = thinkingBox.querySelector('.thinking-status-text');
            const detailText = thinkingBox.querySelector('.thinking-detail-text');
            
            // æ›´æ–°ä¸»çŠ¶æ€æ–‡æœ¬
            if (statusText) {
                statusText.textContent = message || 'AIæ­£åœ¨æ€è€ƒ...';
            }
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯ - æ·»åŠ å¸¦æ‚¬åœçš„æ¡ç›®
            if (detailText) {
                const timestamp = new Date().toLocaleTimeString('zh-CN');
                const statusIcon = this.getStatusIcon(status);
                
                // åˆ›å»ºæ–°çš„æ­¥éª¤æ¡ç›®
                const stepEntry = document.createElement('div');
                stepEntry.className = `thinking-step-entry status-${status}`;
                stepEntry.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 4px 0;
                    font-size: 13px;
                    color: #e2e8f0;
                    opacity: 0.9;
                    position: relative;
                    cursor: pointer;
                `;
                
                // åŸºç¡€å†…å®¹
                stepEntry.innerHTML = `
                    <span class="step-time" style="color: #94a3b8; margin-right: 8px;">[${timestamp}]</span>
                    <span class="step-icon" style="margin-right: 6px;">${statusIcon}</span>
                    <span class="step-text">${message || stepId}</span>
                    ${hoverData ? '<span class="param-indicator" style="margin-left: 6px; color: #a855f7; font-size: 11px; font-weight: bold; cursor: help; opacity: 0.9;">[å‚æ•°]</span>' : ''}
                `;
                
                // å¦‚æœæœ‰æ‚¬åœæ•°æ®ï¼Œæ·»åŠ æ‚¬åœæ˜¾ç¤ºé€»è¾‘
                if (hoverData) {
                    // ğŸ¯ ç­‰å¾…DOMæ›´æ–°åå†å¤„ç†äº‹ä»¶ç»‘å®š
                    setTimeout(() => {
                        const tooltipDiv = document.createElement('div');
                        tooltipDiv.className = 'tool-params-tooltip';
                        
                        
                        // æ ¼å¼åŒ–å‚æ•°æ˜¾ç¤º
                        let paramsHtml = '<div>';
                        paramsHtml += '<div style="margin-bottom: 12px; color: #a855f7; font-weight: 600; font-size: 14px; border-bottom: 1px solid rgba(124, 58, 237, 0.3); padding-bottom: 8px;">ğŸ”§ å·¥å…·å‚æ•°</div>';
                        
                        if (typeof hoverData === 'object') {
                            for (const [key, value] of Object.entries(hoverData)) {
                                const displayValue = typeof value === 'string' && value.length > 300 
                                    ? value.substring(0, 300) + '...' 
                                    : JSON.stringify(value, null, 2);
                                paramsHtml += `
                                    <div style="margin-bottom: 10px;">
                                        <div style="color: #60a5fa; font-weight: 500; margin-bottom: 4px;">${key}:</div>
                                        <pre style="margin: 0; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 6px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; font-size: 12px; border-left: 3px solid #a855f7;">${displayValue}</pre>
                                    </div>
                                `;
                            }
                        } else {
                            paramsHtml += `<pre style="white-space: pre-wrap; word-break: break-all; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 6px; border-left: 3px solid #a855f7;">${hoverData}</pre>`;
                        }
                        paramsHtml += '</div>';
                        
                        tooltipDiv.innerHTML = paramsHtml;
                        // æ·»åŠ åˆ°bodyï¼Œé¿å…å®¹å™¨é™åˆ¶
                        document.body.appendChild(tooltipDiv);
                        
                        
                        // ç›´æ¥åœ¨è¿™é‡Œè®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…thisä¸Šä¸‹æ–‡é—®é¢˜
                        let showTimeout;
                        let hideTimeout;
                        
                        // ğŸ¯ ç°åœ¨DOMåº”è¯¥å·²ç»æ›´æ–°ï¼Œé‡æ–°æŸ¥æ‰¾[å‚æ•°]æ ‡è®°å…ƒç´ 
                        const paramIndicator = stepEntry.querySelector('.param-indicator');
                        
                        const targetElement = paramIndicator || stepEntry; // ä¼˜å…ˆç»‘å®šåˆ°[å‚æ•°]æ ‡è®°
                    
                    // é¼ æ ‡è¿›å…¥æ—¶æ˜¾ç¤ºtooltip
                    targetElement.addEventListener('mouseenter', (e) => {
                        clearTimeout(hideTimeout);
                        showTimeout = setTimeout(() => {
                            
                            // è·å–å…ƒç´ ä½ç½®
                            const rect = targetElement.getBoundingClientRect();
                            
                            // å…ˆæ˜¾ç¤ºtooltipä»¥è·å–å°ºå¯¸
                            tooltipDiv.style.display = 'block';
                            // ğŸ¯ ä¸è®¾ç½®å†…è”opacityï¼Œè®©CSSç±»æ§åˆ¶é€æ˜åº¦
                            const tooltipRect = tooltipDiv.getBoundingClientRect();
                            
                            // ğŸ¯ æ™ºèƒ½å®šä½ç®—æ³•ï¼šæ ¹æ®å¯ç”¨ç©ºé—´é€‰æ‹©æœ€ä½³ä½ç½®
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 20; // è¾¹è·
                            
                            // è®¡ç®—å››ä¸ªæ–¹å‘çš„å¯ç”¨ç©ºé—´
                            const spaceAbove = rect.top;
                            const spaceBelow = windowHeight - rect.bottom;
                            const spaceLeft = rect.left;
                            const spaceRight = windowWidth - rect.right;
                            
                            
                            let top, left;
                            let position = 'above'; // é»˜è®¤ä½ç½®
                            
                            // ğŸ¯ å‚ç›´ä½ç½®é€‰æ‹©ï¼šä¼˜å…ˆä¸Šæ–¹ï¼Œç©ºé—´ä¸è¶³æ—¶é€‰ä¸‹æ–¹
                            if (spaceAbove >= tooltipRect.height + margin) {
                                // ä¸Šæ–¹æœ‰è¶³å¤Ÿç©ºé—´
                                top = rect.top - tooltipRect.height - margin;
                                position = 'above';
                            } else if (spaceBelow >= tooltipRect.height + margin) {
                                // ä¸‹æ–¹æœ‰è¶³å¤Ÿç©ºé—´
                                top = rect.bottom + margin;
                                position = 'below';
                            } else {
                                // ä¸¤è¾¹éƒ½ä¸å¤Ÿï¼Œé€‰æ‹©ç©ºé—´æ›´å¤§çš„ä¸€æ–¹
                                if (spaceAbove > spaceBelow) {
                                    top = margin; // è´´é¡¶æ˜¾ç¤º
                                    position = 'above-constrained';
                                } else {
                                    top = windowHeight - tooltipRect.height - margin; // è´´åº•æ˜¾ç¤º
                                    position = 'below-constrained';
                                }
                            }
                            
                            // ğŸ¯ æ°´å¹³ä½ç½®é€‰æ‹©ï¼šå°è¯•å±…ä¸­å¯¹é½ï¼Œè¶…å‡ºæ—¶è°ƒæ•´
                            const preferredLeft = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                            
                            if (preferredLeft >= margin && preferredLeft + tooltipRect.width <= windowWidth - margin) {
                                // å±…ä¸­å¯¹é½ä¸”ä¸è¶…å‡ºè¾¹ç•Œ
                                left = preferredLeft;
                            } else if (preferredLeft < margin) {
                                // å·¦è¾¹ç•Œè¶…å‡ºï¼Œè´´å·¦æ˜¾ç¤º
                                left = margin;
                            } else {
                                // å³è¾¹ç•Œè¶…å‡ºï¼Œè´´å³æ˜¾ç¤º
                                left = windowWidth - tooltipRect.width - margin;
                            }
                            
                            // è®¾ç½®ä½ç½®
                            tooltipDiv.style.top = top + 'px';
                            tooltipDiv.style.left = left + 'px';
                            
                            
                            // æ˜¾ç¤ºåŠ¨ç”»
                            setTimeout(() => {
                                tooltipDiv.classList.add('show');
                            }, 10);
                            
                        }, 200);
                    });
                    
                    // é¼ æ ‡ç¦»å¼€æ—¶éšè—tooltip
                    targetElement.addEventListener('mouseleave', (e) => {
                        clearTimeout(showTimeout);
                        hideTimeout = setTimeout(() => {
                            tooltipDiv.classList.remove('show');
                            setTimeout(() => {
                                tooltipDiv.style.display = 'none';
                            }, 250);
                        }, 300);
                    });
                    
                    // é¼ æ ‡è¿›å…¥tooltipæ—¶ä¿æŒæ˜¾ç¤º
                    tooltipDiv.addEventListener('mouseenter', () => {
                        clearTimeout(hideTimeout);
                    });
                    
                        // é¼ æ ‡ç¦»å¼€tooltipæ—¶éšè—
                        tooltipDiv.addEventListener('mouseleave', () => {
                            tooltipDiv.classList.remove('show');
                            setTimeout(() => tooltipDiv.style.display = 'none', 250);
                        });
                        
                        // ğŸ¯ æ ‡è®°æ‰€æœ‰ç›¸å…³å®¹å™¨åŒ…å«tooltipï¼Œè§¦å‘overflowä¾‹å¤–
                        const agentMessage = stepEntry.closest('.message.agent');
                        if (agentMessage) {
                            agentMessage.classList.add('has-tooltip-container');
                        }
                        
                        // ğŸ¯ æ ‡è®°thinking-detail-textå®¹å™¨å…è®¸æº¢å‡º
                        const detailContainer = stepEntry.closest('.thinking-detail-text');
                        if (detailContainer) {
                            detailContainer.classList.add('has-tooltip-content');
                        }
                        
                        stepEntry.classList.add('has-tooltip');
                        
                        
                        
                    }, 0); // ğŸ¯ setTimeoutç»“æŸ
                }
                
                // æ·»åŠ åˆ°è¯¦ç»†ä¿¡æ¯åŒºåŸŸ
                detailText.appendChild(stepEntry);
                
                // é™åˆ¶æ˜¾ç¤ºçš„æ­¥éª¤æ•°é‡
                const entries = detailText.querySelectorAll('.thinking-step-entry');
                if (entries.length > 5) {
                    entries[0].remove();
                }
                
                // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
                detailText.scrollTop = detailText.scrollHeight;
            }
        }
        
        /**
         * æ›´æ–°æ€è€ƒæ¡†è¿›åº¦ - å¢å¼ºç‰ˆ
         */
        updateThinkingProgress(stepId, status, message) {
            if (!this.thinkingState.visible || !this.thinkingState.messageId) {
                console.warn('âš ï¸ æ€è€ƒæ¡†ä¸å¯è§ï¼Œæ— æ³•æ›´æ–°è¿›åº¦');
                return;
            }
            
            const thinkingBox = document.getElementById(this.thinkingState.messageId);
            if (!thinkingBox) return;
            
            const statusText = thinkingBox.querySelector('.thinking-status-text');
            const detailText = thinkingBox.querySelector('.thinking-detail-text');
            
            // æ›´æ–°ä¸»çŠ¶æ€æ–‡æœ¬
            if (statusText) {
                statusText.textContent = message || 'AIæ­£åœ¨æ€è€ƒ...';
            }
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯ - æ·»åŠ è€Œä¸æ˜¯æ›¿æ¢
            if (detailText) {
                const timestamp = new Date().toLocaleTimeString('zh-CN');
                const statusIcon = this.getStatusIcon(status);
                
                // åˆ›å»ºæ–°çš„æ­¥éª¤æ¡ç›®
                const stepEntry = document.createElement('div');
                stepEntry.className = `thinking-step-entry status-${status}`;
                stepEntry.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 4px 0;
                    font-size: 13px;
                    color: #e2e8f0;
                    opacity: 0.9;
                `;
                stepEntry.innerHTML = `
                    <span class="step-time" style="color: #94a3b8; margin-right: 8px;">[${timestamp}]</span>
                    <span class="step-icon" style="margin-right: 6px;">${statusIcon}</span>
                    <span class="step-text">${message || stepId}</span>
                `;
                
                // æ·»åŠ åˆ°è¯¦ç»†ä¿¡æ¯åŒºåŸŸ
                detailText.appendChild(stepEntry);
                
                // é™åˆ¶æ˜¾ç¤ºçš„æ­¥éª¤æ•°é‡
                const entries = detailText.querySelectorAll('.thinking-step-entry');
                if (entries.length > 5) {
                    entries[0].remove();
                }
                
                // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
                detailText.scrollTop = detailText.scrollHeight;
            }
        }
        
        /**
         * è·å–çŠ¶æ€å›¾æ ‡
         */
        getStatusIcon(status) {
            const icons = {
                'started': 'ğŸ”„',
                'processing': 'âš™ï¸',
                'completed': 'âœ…',
                'failed': 'âŒ',
                'tool_call': 'ğŸ”§',
                'llm_invoke': 'ğŸ¤–',
                'searching': 'ğŸ”',
                'writing': 'âœï¸',
                'reading': 'ğŸ“–',
                'validating': 'âœ”ï¸',
                'generating': 'ğŸš€'
            };
            return icons[status] || 'â„¹ï¸';
        }
        
        /**
         * ç”Ÿæˆæ¶ˆæ¯ID
         */
        generateMessageId(type) {
            return `${type}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
        }
        
        /**
         * æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
         */
        renderUserMessage(messageData) {
            return addUserMessage(messageData.content, messageData);
        }
        
        /**
         * æ¸²æŸ“æµå¼æ¶ˆæ¯
         */
        renderStreamMessage(messageData) {
            return addStreamMessage(messageData.content, 'ai');
        }
        
        /**
         * æ¸²æŸ“ç³»ç»Ÿæ¶ˆæ¯
         */
        renderSystemMessage(messageData) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.setAttribute('data-message-type', 'system');
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="system-message-content">${messageData.content}</div>
                </div>
            `;
            
            // æ’å…¥åˆ°æ€è€ƒæ¡†å‰é¢
            this.insertBeforeThinking(messageDiv, messagesContainer);
            this.scrollToBottom();
            
            return messageData.id;
        }
        
        /**
         * æ¸²æŸ“Agentæ¶ˆæ¯
         */
        renderAgentMessage(messageData) {
            // ä½¿ç”¨ç°æœ‰çš„Agentæ¶ˆæ¯å¤„ç†é€»è¾‘
            return this.renderSystemMessage(messageData);
        }
        
        /**
         * åœ¨æ€è€ƒæ¡†å‰æ’å…¥æ¶ˆæ¯
         */
        insertBeforeThinking(element, container) {
            if (this.thinkingState.visible && this.thinkingState.messageId) {
                const thinkingBox = document.getElementById(this.thinkingState.messageId);
                if (thinkingBox && thinkingBox.parentNode === container) {
                    container.insertBefore(element, thinkingBox);
                    console.log('ğŸ“ æ¶ˆæ¯æ’å…¥åˆ°æ€è€ƒæ¡†å‰é¢');
                    return true;
                }
            }
            
            // æ€è€ƒæ¡†ä¸å­˜åœ¨ï¼Œæ­£å¸¸æ·»åŠ åˆ°æœ«å°¾
            container.appendChild(element);
            return false;
        }
        
        /**
         * æ»šåŠ¨åˆ°åº•éƒ¨
         */
        scrollToBottom() {
            requestAnimationFrame(() => {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTo({
                        top: messagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            });
        }
        
        /**
         * æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰streamä¼šè¯çš„æ€è€ƒæ¡†
         */
        isCurrentStreamThinking(sessionId) {
            return this.thinkingState.visible && 
                   this.thinkingState.streamSessionId === sessionId;
        }
        
        /**
         * æ¸…ç†è¿‡æœŸæ¶ˆæ¯
         */
        cleanupOldMessages() {
            const maxMessages = 1000;
            if (this.messageOrder.length > maxMessages) {
                const toRemove = this.messageOrder.splice(0, this.messageOrder.length - maxMessages);
                toRemove.forEach(id => this.messages.delete(id));
                console.log('ğŸ§¹ æ¸…ç†äº†', toRemove.length, 'æ¡è¿‡æœŸæ¶ˆæ¯');
            }
        }
    }
    
    // åˆ›å»ºå…¨å±€æ¶ˆæ¯ç®¡ç†å™¨å®ä¾‹
    const messageManager = new MessageManager();
    
    /**
     * ä¿å­˜ç­‰å¾…ä¸­çš„å¢å¼ºä¿¡æ¯
     * @param {Object} codeInfo - ä»£ç ä¿¡æ¯
     */
    function savePendingEnhanceInfo(codeInfo) {
        console.log('ğŸ’¾ ä¿å­˜å¾…å¤„ç†å¢å¼ºä¿¡æ¯:', codeInfo);
        pendingEnhanceInfo = {
            ...codeInfo,
            timestamp: Date.now()
        };
    }
    
    /**
     * æ£€æŸ¥å¹¶å¤„ç†å¾…å¤„ç†çš„å¢å¼ºä¿¡æ¯
     */
    function checkPendingEnhanceInfo() {
        if (pendingEnhanceInfo) {
            console.log('ğŸ” æ£€æµ‹åˆ°å¾…å¤„ç†å¢å¼ºä¿¡æ¯ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå¡ç‰‡');
            checkAndShowUpdateWorkflow(pendingEnhanceInfo);
            // æ¸…ç†å·²å¤„ç†çš„ä¿¡æ¯
            pendingEnhanceInfo = null;
        }
    }

    // ===== é¡µé¢åˆ‡æ¢ç®¡ç† =====
    function switchToChatMode() {
        const homepage = document.getElementById('homepage');
        const chatContainer = document.getElementById('chatContainer');

        currentPage = 'chat';

        // éšè—ä¸»é¡µï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
        homepage.classList.add('slide-out');
        chatContainer.classList.add('active', 'slide-in');

        setTimeout(() => {
            homepage.classList.add('hidden');
        }, 600);

        // é‡ç½®èŠå¤©å»ºè®®çŠ¶æ€ï¼ˆåˆæ¬¡è¿›å…¥èŠå¤©æ—¶å¯ä»¥æ˜¾ç¤ºå»ºè®®ï¼‰
        if (chatSuggestionsPermanentlyHidden === undefined) {
            chatSuggestionsPermanentlyHidden = false;
        }

        // åŠ è½½ä¼šè¯å†å²
        loadSessionHistory();

        // èšç„¦è¾“å…¥æ¡†
        document.getElementById('chatInput').focus();

        console.log('ğŸ“± åˆ‡æ¢åˆ°èŠå¤©æ¨¡å¼');
    }

    function switchToWorkspaceMode(mode) {
        const chatContainer = document.getElementById('chatContainer');
        const codePanel = document.getElementById('codePanel');
        const chatTitle = document.getElementById('chatTitle');

        currentPage = 'workspace';
        currentMode = mode;

        // æ›´æ–°æ ‡é¢˜
        if (mode === 'enhance') {
            chatTitle.textContent = 'ğŸš€ å¢å¼ºæ¨¡å‹';
        } else if (mode === 'new') {
            chatTitle.textContent = 'âœ¨ æ–°å¢æ¨¡å‹';
        }

        // èŠå¤©å®¹å™¨å˜ä¸ºå·¥ä½œåŒºæ¨¡å¼
        chatContainer.classList.add('workspace-mode', 'workspace-transition');

        // æ˜¾ç¤ºä»£ç é¢æ¿
        codePanel.classList.add('active');

        // åˆå§‹åŒ–å·¥ä½œåŒº
        initializeWorkspace(mode);

        console.log('ğŸ“± åˆ‡æ¢åˆ°å·¥ä½œåŒºæ¨¡å¼:', mode);
        showSuccess(`å·²åˆ‡æ¢åˆ°${mode === 'enhance' ? 'æ¨¡å‹å¢å¼º' : 'æ–°å¢æ¨¡å‹'}å·¥ä½œåŒº`, 2000);
    }

    function goBackToHomepage() {
        // ç¦»å¼€SocketIOæˆ¿é—´
        if (currentSessionId && socket && socketConnected) {
            leaveSession(currentSessionId);
        }

        const homepage = document.getElementById('homepage');
        const chatContainer = document.getElementById('chatContainer');
        const codePanel = document.getElementById('codePanel');

        currentPage = 'homepage';

        // é‡ç½®èŠå¤©å®¹å™¨çŠ¶æ€
        chatContainer.classList.remove('active', 'slide-in', 'workspace-mode', 'workspace-transition');
        codePanel.classList.remove('active');

        // æ˜¾ç¤ºä¸»é¡µ
        homepage.classList.remove('slide-out', 'hidden');

        // æ¸…ç†çŠ¶æ€
        currentSessionId = null;
        pendingUserInput = '';
        isProcessing = false;

        // æ¸…ç†ç¡®è®¤å¡ç‰‡çŠ¶æ€
        isUpdateCodeCardVisible = false;
        isRunCodeCardVisible = false;
        pendingUpdateAction = null;
        pendingRunAction = null;
        pendingEnhanceInfo = null; // æ¸…ç†å¾…å¤„ç†å¢å¼ºä¿¡æ¯
        
        // éšè—æ€è€ƒæ¡†
        if (thinkingBoxVisible) {
            hideThinkingBox();
        }
        
        // æ¸…ç†å¡ç‰‡ID
        window.currentUpdateCardId = null;
        window.currentRunCardId = null;

        // æ¸…ç©ºæ¶ˆæ¯ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
        const messagesContainer = document.getElementById('chatMessages');
        const welcomeMessage = messagesContainer.querySelector('.message.ai[data-stable="true"]');
        messagesContainer.innerHTML = '';
        if (welcomeMessage) {
            messagesContainer.appendChild(welcomeMessage);
        }

        // æ¸…ç†æ³¨å†Œè¡¨
        agentMessageRegistry.clear();

        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('chatInput').value = '';
        document.getElementById('searchInput').value = '';

        // é‡ç½®ä¼šè¯çŠ¶æ€
        updateSessionInfo();

        // å…³é—­ä¼šè¯é¢æ¿
        if (sessionPanelOpen) {
            toggleSessionPanel();
        }

        // å¯ç”¨æœç´¢æŒ‰é’®
        const searchBtn = document.getElementById('searchBtn');
        searchBtn.disabled = false;

        // èšç„¦æœç´¢æ¡†
        document.getElementById('searchInput').focus();

        // é‡æ–°æ˜¾ç¤ºé¦–é¡µå»ºè®®
        checkSuggestionsVisibility();
        
        // é‡ç½®èŠå¤©å»ºè®®çŠ¶æ€ï¼Œä¸‹æ¬¡è¿›å…¥èŠå¤©æ—¶å¯ä»¥æ˜¾ç¤º
        chatSuggestionsPermanentlyHidden = false;

        console.log('ğŸ  å·²è¿”å›ä¸»é¡µ');
    }

    // ===== å¢å¼ºçš„ç”¨æˆ·æ¶ˆæ¯å¤„ç†å‡½æ•° =====

    /**
     * ä¼˜åŒ–çš„æ·»åŠ ç”¨æˆ·æ¶ˆæ¯å‡½æ•°
     * @param {string} content - æ¶ˆæ¯å†…å®¹
     * @param {Object} options - æ¶ˆæ¯é€‰é¡¹
     */
    function addUserMessage(content, options = {}) {
        const {
            showTyping = true,        // æ˜¯å¦æ˜¾ç¤ºæ‰“å­—åŠ¨ç”»
            showTimestamp = true,     // æ˜¯å¦æ˜¾ç¤ºæ—¶é—´æˆ³
            highlight = false,        // æ˜¯å¦é«˜äº®æ˜¾ç¤º
            messageType = 'normal'    // æ¶ˆæ¯ç±»å‹: normal, code, quote, long
        } = options;

        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');

        // ç”Ÿæˆå”¯ä¸€ID
        const messageId = `user-msg-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
        messageDiv.id = messageId;

        // è®¾ç½®åŸºç¡€ç±»å
        let className = 'message user';

        // æ ¹æ®æ¶ˆæ¯ç±»å‹æ·»åŠ ç‰¹æ®Šç±»
        if (content.length > 200) className += ' long-message';
        if (content.includes('```') || content.includes('`')) className += ' has-code';
        if (content.startsWith('>')) className += ' quote';
        if (highlight) className += ' highlight';
        if (showTyping) className += ' typing';

        messageDiv.className = className;
        messageDiv.setAttribute('data-message-type', 'user');
        messageDiv.setAttribute('data-timestamp', Date.now());

        // å¤„ç†æ¶ˆæ¯å†…å®¹
        const processedContent = preprocessUserMessage(content);

        // åˆ›å»ºæ¶ˆæ¯ç»“æ„
        if (currentPage === 'workspace') {
            messageDiv.innerHTML = createWorkspaceUserMessage(processedContent, showTimestamp);
        } else {
            messageDiv.innerHTML = createNormalUserMessage(processedContent, showTimestamp);
        }

        // ä½¿ç”¨æ™ºèƒ½æ’å…¥å‡½æ•°ï¼Œç¡®ä¿æ€è€ƒæ¡†å§‹ç»ˆåœ¨åº•éƒ¨
        insertMessageBeforeThinking(messageDiv, messagesContainer);

        // æ·»åŠ äº¤äº’æ•ˆæœ
        enhanceUserMessageInteractions(messageDiv);

        // å¹³æ»‘æ»šåŠ¨
        requestAnimationFrame(() => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        });

        // ç§»é™¤æ‰“å­—åŠ¨ç”»
        if (showTyping) {
            setTimeout(() => {
                messageDiv.classList.remove('typing');
            }, 500);
        }

        // ç§»é™¤é«˜äº®æ•ˆæœ
        if (highlight) {
            setTimeout(() => {
                messageDiv.classList.remove('highlight');
            }, 1500);
        }

        console.log('âœ¨ æ·»åŠ ä¼˜åŒ–ç”¨æˆ·æ¶ˆæ¯:', messageId);
        return messageId;
    }

    /**
     * é¢„å¤„ç†ç”¨æˆ·æ¶ˆæ¯å†…å®¹
     */
    function preprocessUserMessage(content) {
        // è½¬ä¹‰HTML
        let processed = escapeHtml(content);

        // å¤„ç†ä»£ç å—
        processed = processed.replace(/```([\s\S]*?)```/g, (match, code) => {
            return `<pre><code>${code.trim()}</code></pre>`;
        });

        // å¤„ç†è¡Œå†…ä»£ç 
        processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');

        // å¤„ç†é“¾æ¥
        processed = processed.replace(
            /(https?:\/\/[^\s]+)/g,
            '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
        );

        // å¤„ç†æ¢è¡Œ
        processed = processed.replace(/\n/g, '<br>');

        return processed;
    }

    /**
     * åˆ›å»ºæ™®é€šæ¨¡å¼ç”¨æˆ·æ¶ˆæ¯
     */
    function createNormalUserMessage(content, showTimestamp) {
        const timestamp = showTimestamp ?
            `<div class="message-timestamp">${new Date().toLocaleTimeString()}</div>` : '';

        return `
            <div class="avatar">
                <span style="
                    background: linear-gradient(45deg, #ffffff, #f0f0f0);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    font-weight: bold;
                ">ğŸ‘¤</span>
            </div>
            <div class="message-content">
                <p>${content}</p>
                ${timestamp}
                <div class="status-indicator sent">âœ“</div>
            </div>
        `;
    }

    /**
     * åˆ›å»ºå·¥ä½œåŒºæ¨¡å¼ç”¨æˆ·æ¶ˆæ¯
     */
    function createWorkspaceUserMessage(content, showTimestamp) {
        const timestamp = showTimestamp ?
            `<div class="message-timestamp">${new Date().toLocaleTimeString()}</div>` : '';

        return `
            <div class="message-content user-message">
                ${content}
                ${timestamp}
                <div class="status-indicator sent">âœ“</div>
            </div>
        `;
    }

    /**
     * å¢å¼ºç”¨æˆ·æ¶ˆæ¯äº¤äº’æ•ˆæœ
     */
    function enhanceUserMessageInteractions(messageDiv) {
        // æ·»åŠ æ‚¬åœæ•ˆæœ
        messageDiv.addEventListener('mouseenter', () => {
            const messageContent = messageDiv.querySelector('.message-content, .user-message');
            if (messageContent) {
                messageContent.style.transform = 'translateY(-2px)';
            }
        });

        messageDiv.addEventListener('mouseleave', () => {
            const messageContent = messageDiv.querySelector('.message-content, .user-message');
            if (messageContent) {
                messageContent.style.transform = 'translateY(0)';
            }
        });

        // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
        messageDiv.addEventListener('click', (e) => {
            if (e.detail === 2) { // åŒå‡»
                copyMessageContent(messageDiv);
            }
        });

        // æ·»åŠ é•¿æŒ‰èœå•ï¼ˆç§»åŠ¨ç«¯ï¼‰
        let pressTimer = null;

        messageDiv.addEventListener('touchstart', (e) => {
            pressTimer = setTimeout(() => {
                showMessageContextMenu(messageDiv, e.touches[0]);
            }, 500);
        });

        messageDiv.addEventListener('touchend', () => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        });

        messageDiv.addEventListener('touchmove', () => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        });
    }

    /**
     * å¤åˆ¶æ¶ˆæ¯å†…å®¹
     */
    function copyMessageContent(messageDiv) {
        const content = messageDiv.querySelector('.message-content p, .user-message');
        if (content) {
            const text = content.textContent || content.innerText;

            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(messageDiv);
                showSuccess('æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 1500);
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                showCopyFeedback(messageDiv);
                showSuccess('æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 1500);
            });
        }
    }

    /**
     * æ˜¾ç¤ºå¤åˆ¶åé¦ˆæ•ˆæœ
     */
    function showCopyFeedback(messageDiv) {
        const feedback = document.createElement('div');
        feedback.className = 'copy-feedback';
        feedback.textContent = 'å·²å¤åˆ¶';
        feedback.style.cssText = `
            position: absolute;
            top: -30px;
            right: 10px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        `;

        messageDiv.style.position = 'relative';
        messageDiv.appendChild(feedback);

        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 2000);
    }

    /**
     * æ˜¾ç¤ºæ¶ˆæ¯ä¸Šä¸‹æ–‡èœå•
     */
    function showMessageContextMenu(messageDiv, touch) {
        const menu = document.createElement('div');
        menu.className = 'message-context-menu';
        menu.style.cssText = `
            position: fixed;
            top: ${touch.clientY - 10}px;
            left: ${touch.clientX - 50}px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 120px;
        `;

        menu.innerHTML = `
            <div class="menu-item" onclick="copyMessageContent(document.getElementById('${messageDiv.id}'))">
                ğŸ“‹ å¤åˆ¶æ¶ˆæ¯
            </div>
            <div class="menu-item" onclick="editMessage('${messageDiv.id}')">
                âœï¸ ç¼–è¾‘æ¶ˆæ¯
            </div>
            <div class="menu-item" onclick="deleteMessage('${messageDiv.id}')">
                ğŸ—‘ï¸ åˆ é™¤æ¶ˆæ¯
            </div>
        `;

        document.body.appendChild(menu);

        // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                if (menu.parentNode) {
                    menu.parentNode.removeChild(menu);
                }
                document.removeEventListener('click', closeMenu);
            });
        }, 100);
    }

    /**
     * ç¼–è¾‘æ¶ˆæ¯åŠŸèƒ½
     */
    function editMessage(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const content = messageDiv.querySelector('.message-content p, .user-message');
        if (!content) return;

        const originalText = content.textContent || content.innerText;

        // åˆ›å»ºç¼–è¾‘è¾“å…¥æ¡†
        const editInput = document.createElement('textarea');
        editInput.value = originalText;
        editInput.className = 'edit-message-input';
        editInput.style.cssText = `
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        `;

        // åˆ›å»ºæ“ä½œæŒ‰é’®
        const actions = document.createElement('div');
        actions.style.cssText = 'margin-top: 8px; display: flex; gap: 8px; justify-content: flex-end;';
        actions.innerHTML = `
            <button onclick="cancelEdit('${messageId}')" style="
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
            ">å–æ¶ˆ</button>
            <button onclick="saveEdit('${messageId}')" style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
            ">ä¿å­˜</button>
        `;

        // ä¿å­˜åŸå§‹å†…å®¹
        content.setAttribute('data-original', originalText);

        // æ›¿æ¢å†…å®¹
        content.innerHTML = '';
        content.appendChild(editInput);
        content.appendChild(actions);

        // èšç„¦è¾“å…¥æ¡†
        editInput.focus();
        editInput.setSelectionRange(editInput.value.length, editInput.value.length);
    }

    /**
     * å–æ¶ˆç¼–è¾‘
     */
    window.cancelEdit = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const content = messageDiv.querySelector('.message-content p, .user-message');
        if (!content) return;

        const originalText = content.getAttribute('data-original');
        const processedContent = preprocessUserMessage(originalText);

        content.innerHTML = processedContent;
        content.removeAttribute('data-original');
    };

    /**
     * ä¿å­˜ç¼–è¾‘
     */
    window.saveEdit = function(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const content = messageDiv.querySelector('.message-content p, .user-message');
        const editInput = content?.querySelector('.edit-message-input');

        if (!content || !editInput) return;

        const newText = editInput.value.trim();
        if (!newText) return;

        const processedContent = preprocessUserMessage(newText);
        content.innerHTML = processedContent;
        content.removeAttribute('data-original');

        // æ·»åŠ ç¼–è¾‘æ ‡è®°
        const editMark = document.createElement('span');
        editMark.textContent = '(å·²ç¼–è¾‘)';
        editMark.style.cssText = 'font-size: 11px; opacity: 0.7; margin-left: 8px;';
        content.appendChild(editMark);

        showSuccess('æ¶ˆæ¯å·²æ›´æ–°', 1500);
    };

    /**
     * åˆ é™¤æ¶ˆæ¯
     */
    window.deleteMessage = function(messageId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;

        const messageDiv = document.getElementById(messageId);
        if (messageDiv) {
            messageDiv.style.animation = 'slideOutRight 0.3s ease-in-out';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);

            showInfo('æ¶ˆæ¯å·²åˆ é™¤', 1500);
        }
    };

    // ===== ä¿®å¤ç‰ˆæœ¬çš„æ¶ˆæ¯å¤„ç† =====
    function addMessage(content, type) {
        if (type === 'user') {
            // ä½¿ç”¨æ–°çš„ç”¨æˆ·æ¶ˆæ¯å‡½æ•°
            return addUserMessage(content, {
                showTyping: true,
                showTimestamp: true,
                highlight: false
            });
        } else {
            // AIæ¶ˆæ¯ä¿æŒåŸæœ‰é€»è¾‘
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.setAttribute('data-message-type', 'static');

            if (type === 'ai') {
                try {
                    const markdownContent = marked.parse(content);
                    messageDiv.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="message-content">
                        ${markdownContent}
                    </div>
                `;

                    setTimeout(() => {
                        processCodeBlocksInMessage(messageDiv);
                    }, 50);

                } catch (error) {
                    console.error('âŒ é™æ€æ¶ˆæ¯markdownè§£æå¤±è´¥:', error);
                    messageDiv.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <p style="white-space: pre-wrap;">${escapeHtml(content)}</p>
                    </div>
                `;
                }
            }

            // ä½¿ç”¨æ™ºèƒ½æ’å…¥å‡½æ•°ï¼Œç¡®ä¿æ€è€ƒæ¡†å§‹ç»ˆåœ¨åº•éƒ¨
            insertMessageBeforeThinking(messageDiv, messagesContainer);

            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);

            console.log('ğŸ“ æ·»åŠ é™æ€æ¶ˆæ¯:', type, content.substring(0, 50) + '...');
        }
    }

    function addProcessingIndicator() {
        // ä¸ç«‹å³æ˜¾ç¤ºæ€è€ƒæ¡†ï¼Œç­‰åç«¯é€šè¿‡å¯¼èˆªèŠ‚ç‚¹åˆ¤æ–­ä¸ºEDWä»»åŠ¡åå†æ˜¾ç¤º
        console.log('â³ å¼€å§‹å¤„ç† - ç­‰å¾…åç«¯è·¯ç”±åˆ¤æ–­');
    }

    function removeProcessingIndicator() {
        // ä¸ç«‹å³éšè—æ€è€ƒæ¡†ï¼Œè®©å®ƒåœ¨æ”¶åˆ°AIå›å¤æ—¶è‡ªç„¶æ¶ˆå¤±
        console.log('âœ… å¤„ç†å®Œæˆ - ä¿æŒæ€è€ƒæ¡†ç›´åˆ°å›å¤ç”Ÿæˆ');
    }

    // ===== æµå¼æ¶ˆæ¯å¤„ç†ï¼ˆéš”ç¦»ç‰ˆæœ¬ï¼‰=====
    function addStreamMessage(content, type) {
        const messageId = 'stream-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8);
        const messagesContainer = document.getElementById('chatMessages');

        console.log('ğŸ“ åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨ï¼ŒmessageId:', messageId);

        if (!messagesContainer) {
            console.error('âŒ æ‰¾ä¸åˆ°æ¶ˆæ¯å®¹å™¨');
            return null;
        }

        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = `message ${type}`;
        messageDiv.setAttribute('data-message-type', 'stream'); // æ ‡è®°ä¸ºæµå¼æ¶ˆæ¯
        messageDiv.setAttribute('data-stream-isolated', 'true'); // æ ‡è®°ä¸ºéš”ç¦»æ¶ˆæ¯

        if (type === 'ai') {
            // æ ¹æ®å½“å‰é¡µé¢æ¨¡å¼åˆ›å»ºä¸åŒçš„ç»“æ„
            if (currentPage === 'workspace') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="stream-content" data-stream-id="${messageId}">${content || ''}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="stream-content" data-stream-id="${messageId}">${content || ''}</div>
                    </div>
                `;
            }
        }

        // å¦‚æœæ˜¯ç©ºå†…å®¹çš„AIæ¶ˆæ¯ï¼Œå…ˆéšè—ç›´åˆ°æœ‰å®é™…å†…å®¹
        let isEmptyAI = false;
        if (type === 'ai' && (!content || content.trim() === '')) {
            messageDiv.style.display = 'none';
            messageDiv.setAttribute('data-empty-ai', 'true');
            isEmptyAI = true;
        }

        // ä½¿ç”¨æ™ºèƒ½æ’å…¥å‡½æ•°ï¼Œç¡®ä¿æ€è€ƒæ¡†å§‹ç»ˆåœ¨åº•éƒ¨
        insertMessageBeforeThinking(messageDiv, messagesContainer);
        
        // å¦‚æœä¸æ˜¯ç©ºçš„AIæ¶ˆæ¯ï¼Œç¡®ä¿æ¶ˆæ¯å¯è§
        if (!isEmptyAI) {
            messageDiv.style.display = 'flex';
            messageDiv.style.opacity = '1';
        }
        
        // éªŒè¯stream-contentå…ƒç´ 
        const verifyStreamContent = messageDiv.querySelector(`[data-stream-id="${messageId}"]`);
        if (verifyStreamContent) {
            console.log('âœ… stream-contentå…ƒç´ å·²åˆ›å»º');
            verifyStreamContent.style.minHeight = '20px'; // ç¡®ä¿æœ‰æœ€å°é«˜åº¦
        } else {
            console.error('âŒ stream-contentå…ƒç´ æœªæ‰¾åˆ°ï¼');
        }

        // å»¶è¿Ÿæ»šåŠ¨ï¼Œç¡®ä¿ä¸å½±å“Agentæ¶ˆæ¯
        requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        console.log('ğŸ“ åˆ›å»ºéš”ç¦»æµå¼æ¶ˆæ¯:', messageId, 'æ¨¡å¼:', currentPage);
        return messageId;
    }

    function appendStreamMessage(messageId, content) {
        // åªæ“ä½œæŒ‡å®šçš„æµå¼æ¶ˆæ¯ï¼Œå®Œå…¨éš”ç¦»
        const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);
        if (streamContent && streamContent.closest('[data-stream-isolated="true"]')) {
            streamContent.textContent += content;

            // å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ å†…å®¹åˆ°ç©ºçš„AIæ¶ˆæ¯ï¼Œæ˜¾ç¤ºå®ƒ
            const messageDiv = streamContent.closest('.message');
            if (messageDiv && messageDiv.getAttribute('data-empty-ai') === 'true' && content.trim()) {
                messageDiv.style.display = 'flex';  // ä½¿ç”¨flexè€Œä¸æ˜¯ç©ºå­—ç¬¦ä¸²
                messageDiv.removeAttribute('data-empty-ai');
                console.log('ğŸ“Œ æ˜¾ç¤ºä¹‹å‰éšè—çš„AIæ¶ˆæ¯');
            }

            // ç¡®ä¿å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„æ»šåŠ¨
            if (currentPage === 'workspace') {
                const messagesContainer = document.getElementById('chatMessages');
                requestAnimationFrame(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }
        } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ°éš”ç¦»çš„æµå¼å†…å®¹å®¹å™¨:', messageId);
        }
    }

    /**
     * ç­‰å¾…DOMæ›´æ–°å®Œæˆ
     */
    function waitForDOMUpdate() {
        return new Promise(resolve => {
            // ä½¿ç”¨MutationObserveræˆ–requestAnimationFrame
            if (typeof MutationObserver !== 'undefined') {
                const observer = new MutationObserver(() => {
                    observer.disconnect();
                    resolve();
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });

                // è¶…æ—¶ä¿æŠ¤
                setTimeout(() => {
                    observer.disconnect();
                    resolve();
                }, 200);
            } else {
                // é™çº§åˆ°å»¶è¿Ÿ
                setTimeout(resolve, 150);
            }
        });
    }

    /**
     * åå¤„ç†Markdownæ¶ˆæ¯
     */
    async function postProcessMarkdownMessage(messageId) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) {
            console.warn('âš ï¸ æœªæ‰¾åˆ°æ¶ˆæ¯å…ƒç´ :', messageId);
            return;
        }

        // ç­‰å¾…DOMæ›´æ–°å®Œæˆ
        await waitForDOMUpdate();

        try {
            // å¤„ç†ä»£ç å—
            processCodeBlocksInMessage(messageDiv);

            // å·¥ä½œåŒºæ¨¡å¼ç‰¹æ®Šæ ·å¼
            if (currentPage === 'workspace') {
                ensureWorkspaceMarkdownStyles(messageDiv);
            }

            // å¤„ç†é“¾æ¥ï¼ˆæ·»åŠ target="_blank"ç­‰ï¼‰
            processLinks(messageDiv);

            // å¤„ç†è¡¨æ ¼ï¼ˆæ·»åŠ å“åº”å¼æ ·å¼ï¼‰
            processTables(messageDiv);

            // æœ€ç»ˆæ»šåŠ¨
            scrollToBottom();

            console.log('âœ… æ¶ˆæ¯åå¤„ç†å®Œæˆ:', messageId);

        } catch (error) {
            console.error('âŒ æ¶ˆæ¯åå¤„ç†å¤±è´¥:', error);
        }
    }

    /**
     * å¤„ç†é“¾æ¥
     */
    function processLinks(messageDiv) {
        const links = messageDiv.querySelectorAll('a[href]');
        links.forEach(link => {
            // å¤–éƒ¨é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€
            if (link.href.startsWith('http') && !link.href.includes(window.location.hostname)) {
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
            }

            // æ·»åŠ æ ·å¼ç±»
            link.classList.add('markdown-link');
        });
    }

    /**
     * å¤„ç†è¡¨æ ¼
     */
    function processTables(messageDiv) {
        const tables = messageDiv.querySelectorAll('table');
        tables.forEach(table => {
            // æ·»åŠ å“åº”å¼åŒ…è£…å™¨
            if (!table.parentElement.classList.contains('table-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                wrapper.style.cssText = 'overflow-x: auto; margin: 16px 0;';

                table.parentElement.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            }

            // æ·»åŠ æ ·å¼ç±»
            table.classList.add('markdown-table');
        });
    }

    /**
     * ä¼˜åŒ–ç‰ˆæµå¼æ¶ˆæ¯å®Œæˆå¤„ç†å‡½æ•°
     * æ”¹è¿›: æ·»åŠ çŠ¶æ€ç®¡ç†ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–
     */
    async function finalizeStreamMessage(messageId) {
        // é˜²æ­¢é‡å¤å¤„ç†
        if (messageProcessingStates.get(messageId)?.isProcessing) {
            console.log('âš ï¸ æ¶ˆæ¯æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨:', messageId);
            return;
        }

        // è®¾ç½®å¤„ç†çŠ¶æ€
        messageProcessingStates.set(messageId, {
            isProcessing: true,
            startTime: Date.now()
        });

        try {
            const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);

            if (!streamContent || !streamContent.closest('[data-stream-isolated="true"]')) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°éš”ç¦»çš„æµå¼å†…å®¹å®¹å™¨:', messageId);
                return;
            }

            const rawContent = streamContent.textContent;
            console.log('ğŸ”„ å¼€å§‹Markdownå¤„ç† (é•¿åº¦: ' + rawContent.length + ', å·¥ä½œåŒº: ' + (currentPage === 'workspace') + ')');

            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Šå“åº”æ ¼å¼
            if (isModelEnhanceJsonResponse(rawContent)) {
                await handleSpecialJsonResponse(streamContent, rawContent, messageId);
            } else {
                await handleStandardMarkdownResponse(streamContent, rawContent, messageId);
            }

            // åå¤„ç†ï¼ˆä»£ç å—ã€æ ·å¼ç­‰ï¼‰
            await postProcessMarkdownMessage(messageId);

            console.log('âœ… Markdownå¤„ç†å®Œæˆ:', messageId);

        } catch (error) {
            console.error('âŒ Markdownå¤„ç†å¤±è´¥:', error);
            await handleMarkdownProcessingError(messageId, error);
        } finally {
            // æ›´æ–°å¤„ç†çŠ¶æ€
            messageProcessingStates.set(messageId, {
                isProcessing: false,
                completed: true,
                completedAt: Date.now()
            });
        }
    }

    /**
     * é”™è¯¯å¤„ç†
     */
    async function handleMarkdownProcessingError(messageId, error) {
        const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);

        if (streamContent) {
            const errorContent = `
            <div class="markdown-error" style="
                color: #ef4444;
                padding: 16px;
                border-left: 4px solid #ef4444;
                background: rgba(239, 68, 68, 0.1);
                border-radius: 8px;
                margin: 12px 0;
            ">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">âŒ</span>
                    <strong>å†…å®¹å¤„ç†å¤±è´¥</strong>
                </div>
                <p style="margin: 4px 0; font-size: 14px;">
                    ${escapeHtml(error.message)}
                </p>
                <details style="margin-top: 12px;">
                    <summary style="cursor: pointer; color: #888; font-size: 12px;">
                        ç‚¹å‡»æŸ¥çœ‹åŸå§‹å†…å®¹
                    </summary>
                    <pre style="
                        background: #1a1a1a;
                        color: #e5e5e5;
                        padding: 12px;
                        border-radius: 4px;
                        margin-top: 8px;
                        white-space: pre-wrap;
                        font-size: 12px;
                    ">${escapeHtml(streamContent.textContent)}</pre>
                </details>
                <div style="margin-top: 12px;">
                    <button onclick="retryMarkdownProcessing('${messageId}')" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 6px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">
                        é‡è¯•å¤„ç†
                    </button>
                </div>
            </div>
        `;

            streamContent.innerHTML = errorContent;
        }

        // è®°å½•é”™è¯¯
        console.error('ğŸ“Š Markdownå¤„ç†ç»Ÿè®¡:', {
            messageId,
            error: error.message,
            contentLength: streamContent?.textContent?.length || 0,
            currentPage,
            timestamp: new Date().toISOString()
        });
    }

    /**
     * é‡è¯•Markdownå¤„ç†
     */
    window.retryMarkdownProcessing = async function(messageId) {
        console.log('ğŸ”„ é‡è¯•Markdownå¤„ç†:', messageId);

        // é‡ç½®å¤„ç†çŠ¶æ€
        messageProcessingStates.delete(messageId);

        // é‡æ–°å¤„ç†
        await finalizeStreamMessage(messageId);
    };

    /**
     * å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
     */
    function scrollToBottom() {
        requestAnimationFrame(() => {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        });
    }

    /**
     * å¤„ç†ç‰¹æ®ŠJSONå“åº”ï¼ˆå¦‚æ¨¡å‹å¢å¼ºï¼‰
     */
    async function handleSpecialJsonResponse(streamContent, rawContent, messageId) {
        try {
            console.log('ğŸ” å¤„ç†ç‰¹æ®ŠJSONå“åº”');

            const enhanceResult = parseModelEnhanceResult(rawContent);
            if (!enhanceResult) {
                throw new Error('æ— æ³•è§£æJSONå“åº”');
            }

            const formattedContent = formatModelEnhanceResponse(enhanceResult);
            const markdownContent = marked.parse(formattedContent);

            streamContent.innerHTML = markdownContent;

            console.log('âœ… ç‰¹æ®ŠJSONå“åº”å¤„ç†å®Œæˆ');

        } catch (error) {
            console.error('âŒ ç‰¹æ®ŠJSONå“åº”å¤„ç†å¤±è´¥ï¼Œå›é€€åˆ°æ ‡å‡†å¤„ç†:', error);
            // å›é€€åˆ°æ ‡å‡†Markdownå¤„ç†
            await handleStandardMarkdownResponse(streamContent, rawContent, messageId);
        }
    }

    /**
     * å¤„ç†æ ‡å‡†Markdownå“åº”
     */
    async function handleStandardMarkdownResponse(streamContent, rawContent, messageId) {
        try {
            // ç¡®ä¿markedåº“å¯ç”¨
            if (typeof marked === 'undefined') {
                throw new Error('Markedåº“æœªåŠ è½½ï¼Œæ— æ³•å¤„ç†Markdownæ ¼å¼');
            }

            // é‡æ–°é…ç½®markedï¼Œç¡®ä¿è®¾ç½®æ­£ç¡®
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && typeof hljs !== 'undefined' && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {
                            console.warn('ä»£ç é«˜äº®å¤±è´¥:', err);
                        }
                    }
                    return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
                },
                breaks: true,
                gfm: true,
                tables: true,
                sanitize: false,
                pedantic: false,
                smartLists: true,
                smartypants: false
            });

            // é¢„å¤„ç†å†…å®¹
            const preprocessedContent = preprocessMarkdownContent(rawContent);

            // æ‰§è¡ŒMarkdownè½¬æ¢
            const markdownContent = marked.parse(preprocessedContent);

            // å®‰å…¨åœ°æ›¿æ¢å†…å®¹
            streamContent.innerHTML = markdownContent;

            console.log('âœ… æ ‡å‡†Markdownè½¬æ¢å®Œæˆ');

        } catch (error) {
            console.error('âŒ æ ‡å‡†Markdownè½¬æ¢å¤±è´¥:', error);

            // é™çº§å¤„ç†ï¼šæ˜¾ç¤ºæ ¼å¼åŒ–çš„çº¯æ–‡æœ¬
            const fallbackContent = `
            <div class="markdown-fallback" style="
                padding: 12px;
                border-left: 4px solid #f59e0b;
                background: rgba(245, 158, 11, 0.1);
                border-radius: 6px;
                margin: 8px 0;
            ">
                <p><strong>âš ï¸ å†…å®¹æ ¼å¼åŒ–éƒ¨åˆ†å¤±è´¥</strong></p>
                <div style="white-space: pre-wrap; font-family: monospace; font-size: 13px; margin-top: 8px;">
                    ${escapeHtml(rawContent)}
                </div>
                <small style="color: #888; margin-top: 8px; display: block;">
                    å†…å®¹å·²æ˜¾ç¤ºä¸ºçº¯æ–‡æœ¬æ ¼å¼ â€¢ ${error.message}
                </small>
            </div>
        `;
            streamContent.innerHTML = fallbackContent;

            throw error; // é‡æ–°æŠ›å‡ºä»¥è®°å½•æ—¥å¿—
        }
    }

    /**
     * ä¿®å¤å¸¸è§çš„Markdowné—®é¢˜
     */
    function fixCommonMarkdownIssues(content) {
        // ç¡®ä¿ä»£ç å—æ­£ç¡®é—­åˆ
        const codeBlockMatches = content.match(/```/g);
        if (codeBlockMatches && codeBlockMatches.length % 2 !== 0) {
            content += '\n```'; // æ·»åŠ ç¼ºå¤±çš„ä»£ç å—ç»“æŸæ ‡è®°
        }

        // ç¡®ä¿åˆ—è¡¨é¡¹å‰æœ‰ç©ºè¡Œï¼ˆæŸäº›markdownè§£æå™¨éœ€è¦ï¼‰
        content = content.replace(/\n(\d+\.|[-*+])\s/g, '\n\n$1 ');

        // ä¿®å¤è¡¨æ ¼æ ¼å¼
        content = content.replace(/\|(?!\s)/g, '| ').replace(/(?<!\s)\|/g, ' |');

        return content;
    }

    /**
     * å†…å®¹é¢„å¤„ç†
     */
    function preprocessMarkdownContent(content) {
        // æ¸…ç†å†…å®¹
        content = content.trim();

        // ç»Ÿä¸€æ¢è¡Œç¬¦
        content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

        // ä¿®å¤å¸¸è§çš„markdowné—®é¢˜
        content = fixCommonMarkdownIssues(content);

        return content;
    }

    function finalizeStreamMessageWithContent(messageId, content) {
        const streamContent = document.querySelector(`[data-stream-id="${messageId}"]`);
        if (streamContent && streamContent.closest('[data-stream-isolated="true"]')) {
            console.log('ğŸ”„ æ­£åœ¨ç›´æ¥è®¾ç½®markdownå†…å®¹ (å·¥ä½œåŒºæ¨¡å¼: ' + (currentPage === 'workspace') + '):', content.substring(0, 100) + '...');

            // ç¡®ä¿markdownå¤„ç†æ­£ç¡®æ‰§è¡Œ
            const markdownContent = marked.parse(content);
            streamContent.innerHTML = markdownContent;

            // å¤„ç†å½“å‰éš”ç¦»æ¶ˆæ¯çš„ä»£ç å—
            const messageDiv = streamContent.closest('.message[data-stream-isolated="true"]');
            if (messageDiv) {
                processCodeBlocksInMessage(messageDiv);

                // å·¥ä½œåŒºæ¨¡å¼ä¸‹ç¡®ä¿markdownæ ·å¼æ­£ç¡®åº”ç”¨
                if (currentPage === 'workspace') {
                    ensureWorkspaceMarkdownStyles(messageDiv);
                }
            }

            // ç¡®ä¿å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„æ»šåŠ¨
            if (currentPage === 'workspace') {
                requestAnimationFrame(() => {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }
        }
    }

    function ensureWorkspaceMarkdownStyles(messageDiv) {
        if (!messageDiv || currentPage !== 'workspace') return;

        // ç¡®ä¿å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„markdownå…ƒç´ æœ‰æ­£ç¡®çš„æ ·å¼ç±»
        const messageContent = messageDiv.querySelector('.message-content');
        if (messageContent) {
            messageContent.classList.add('workspace-markdown');

            // ç¡®ä¿æ‰€æœ‰markdownå…ƒç´ åœ¨å·¥ä½œåŒºæ¨¡å¼ä¸‹æ­£ç¡®æ˜¾ç¤º
            const headers = messageContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headers.forEach(header => {
                header.classList.add('workspace-header');
            });

            const codeBlocks = messageContent.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                block.classList.add('workspace-code-block');
            });

            const lists = messageContent.querySelectorAll('ul, ol');
            lists.forEach(list => {
                list.classList.add('workspace-list');
            });

            const paragraphs = messageContent.querySelectorAll('p');
            paragraphs.forEach(p => {
                p.classList.add('workspace-paragraph');
            });

            const blockquotes = messageContent.querySelectorAll('blockquote');
            blockquotes.forEach(quote => {
                quote.classList.add('workspace-blockquote');
            });

            const tables = messageContent.querySelectorAll('table');
            tables.forEach(table => {
                table.classList.add('workspace-table');
            });
        }

        console.log('âœ… å·¥ä½œåŒºmarkdownæ ·å¼å·²åº”ç”¨');
    }

    function processCodeBlocksInMessage(messageDiv) {
        // åªå¤„ç†æŒ‡å®šæ¶ˆæ¯å†…çš„ä»£ç å—ï¼Œå®Œå…¨é¿å…å½±å“å…¶ä»–æ¶ˆæ¯
        if (!messageDiv || messageDiv.hasAttribute('data-code-processed')) {
            return;
        }

        // è·å–è¯¥æ¶ˆæ¯å†…çš„æ‰€æœ‰ä»£ç å—
        const codeBlocks = messageDiv.querySelectorAll('pre code');

        codeBlocks.forEach((block) => {
            const pre = block.parentElement;

            // é¿å…é‡å¤æ·»åŠ header
            if (pre.querySelector('.code-header')) {
                return;
            }

            const lang = block.className.match(/language-(\w+)/)?.[1] || 'plaintext';

            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
            <span class="code-lang">${lang}</span>
            <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>
        `;

            pre.insertBefore(header, block);

            // åœ¨å·¥ä½œåŒºæ¨¡å¼ä¸‹ç¡®ä¿ä»£ç å—æ ·å¼æ­£ç¡®
            if (currentPage === 'workspace') {
                pre.classList.add('workspace-code-block');
                block.classList.add('workspace-code');
            }
        });

        // æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…é‡å¤å¤„ç†
        messageDiv.setAttribute('data-code-processed', 'true');

        console.log('âœ… ä»£ç å—å¤„ç†å®Œæˆï¼Œå·¥ä½œåŒºæ¨¡å¼:', currentPage === 'workspace');
    }

    // ===== Agentæ¶ˆæ¯å¤„ç†ï¼ˆå¼ºä¿æŠ¤ç‰ˆæœ¬ï¼‰=====
    function addAgentMessage(type, icon, title, message) {
        const messagesContainer = document.getElementById('chatMessages');

        if (!messagesContainer) {
            console.warn('âš ï¸ æ¶ˆæ¯å®¹å™¨ä¸å­˜åœ¨');
            return;
        }

        // ç”Ÿæˆæ¶ˆæ¯å”¯ä¸€ID
        const messageId = `agent-msg-${type}-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message agent ${type}`;
        messageDiv.id = messageId;
        messageDiv.setAttribute('data-message-type', 'agent');
        messageDiv.setAttribute('data-agent-type', type);
        messageDiv.setAttribute('data-agent-protected', 'true');

        // ä½¿ç”¨!importantæ ·å¼å†…è”ï¼Œç¡®ä¿ä¼˜å…ˆçº§
        messageDiv.style.cssText = `
        position: relative !important;
        margin: 16px 24px !important;
        border-radius: 12px !important;
        overflow: hidden !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        animation: slideInAgent 0.4s ease-out !important;
        isolation: isolate !important;
        contain: layout style !important;
        z-index: 10 !important;
    `;

        // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²ï¼Œä½¿ç”¨å†…è”æ ·å¼ç¡®ä¿ä¼˜å…ˆçº§
        const backgroundColors = {
            'page-switch': 'linear-gradient(135deg, #4f46e5, #6366f1)',
            'agent-handoff': 'linear-gradient(135deg, #7c3aed, #8b5cf6)',
            'tool-start': 'linear-gradient(135deg, #0891b2, #06b6d4)',
            'tool-end': 'linear-gradient(135deg, #059669, #10b981)',
            'code-found': 'linear-gradient(135deg, #dc2626, #ef4444)',
            'code-error': 'linear-gradient(135deg, #ea580c, #f97316)',
            'code-update': 'linear-gradient(135deg, #7c3aed, #a855f7)',
            'agent-end': 'linear-gradient(135deg, #16a34a, #22c55e)'
        };

        const bgColor = backgroundColors[type] || 'linear-gradient(135deg, #4f46e5, #6366f1)';
        messageDiv.style.background = bgColor;
        messageDiv.style.color = 'white';

        messageDiv.innerHTML = `
        <div class="agent-message-header" style="
            padding: 12px 16px !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            min-height: 44px !important;
            box-sizing: border-box !important;
        ">
            <div class="agent-icon" style="
                font-size: 16px !important;
                width: 24px !important;
                height: 24px !important;
                border-radius: 50% !important;
                background: rgba(255, 255, 255, 0.2) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            ">${icon}</div>
            <span class="agent-title" style="
                flex: 1 !important;
                min-width: 0 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            ">${title}</span>
            <span class="agent-time" style="
                margin-left: auto !important;
                font-size: 11px !important;
                opacity: 0.8 !important;
                flex-shrink: 0 !important;
            ">
                ${new Date().toLocaleTimeString()}
            </span>
        </div>
        <div class="agent-message-content" style="
            padding: 14px 16px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        ">${message}</div>
    `;

        // å·¥ä½œåŒºæ¨¡å¼ä¸‹çš„ç‰¹æ®Šå¤„ç†
        if (currentPage === 'workspace') {
            messageDiv.style.margin = '12px 0 !important';
            messageDiv.style.borderRadius = '10px !important';
            messageDiv.style.maxWidth = '95% !important';
            messageDiv.style.alignSelf = 'flex-start !important';
        }

        // æ³¨å†Œåˆ°ä¿æŠ¤æ³¨å†Œè¡¨
        agentMessageRegistry.set(messageId, {
            element: messageDiv.cloneNode(true),
            type: type,
            timestamp: Date.now()
        });

        // ä½¿ç”¨æ™ºèƒ½æ’å…¥å‡½æ•°ï¼Œç¡®ä¿æ€è€ƒæ¡†å§‹ç»ˆåœ¨åº•éƒ¨
        insertMessageBeforeThinking(messageDiv, messagesContainer);

        // ä½¿ç”¨æ›´å¹³æ»‘çš„æ»šåŠ¨ï¼Œé¿å…è·³è·ƒ
        requestAnimationFrame(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        console.log(`âœ¨ æ·»åŠ ä¿æŠ¤Agentæ¶ˆæ¯: ${type} - ${title} (ID: ${messageId})`);
        return messageId;
    }

    // ===== ä¿®å¤ç‰ˆæœ¬çš„Agentæ¶ˆæ¯ä¿æŠ¤ç³»ç»Ÿ =====
    function protectAgentMessages() {
        // æ›´å¼ºçš„æ¶ˆæ¯ä¿æŠ¤æœºåˆ¶
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;

        const existingAgentMessages = messagesContainer.querySelectorAll('.message.agent[data-agent-protected="true"]');

        // æ£€æŸ¥æ¯ä¸ªæ³¨å†Œçš„Agentæ¶ˆæ¯æ˜¯å¦è¿˜åœ¨DOMä¸­
        agentMessageRegistry.forEach((protectedMsg, messageId) => {
            const existingMsg = document.getElementById(messageId);
            if (!existingMsg) {
                console.log(`ğŸ›¡ï¸ æ¢å¤ä¸¢å¤±çš„Agentæ¶ˆæ¯: ${messageId}`);

                // æ›´ç²¾ç¡®çš„æ’å…¥ä½ç½®è®¡ç®—
                let insertPosition = null;
                let bestPositionFound = false;

                // å°è¯•æ ¹æ®æ—¶é—´æˆ³æ‰¾åˆ°æœ€ä½³æ’å…¥ä½ç½®
                Array.from(messagesContainer.children).forEach((child, index) => {
                    if (child.getAttribute('data-message-type') === 'agent') {
                        const childId = child.id;
                        const childProtected = agentMessageRegistry.get(childId);
                        if (childProtected && childProtected.timestamp > protectedMsg.timestamp && !bestPositionFound) {
                            insertPosition = child;
                            bestPositionFound = true;
                        }
                    }
                });

                // å…‹éš†å¹¶æ¢å¤æ¶ˆæ¯
                const restoredElement = protectedMsg.element.cloneNode(true);

                // ç¡®ä¿æ¢å¤çš„æ¶ˆæ¯ä¹Ÿæœ‰æ­£ç¡®çš„æ ·å¼
                if (currentPage === 'workspace') {
                    restoredElement.style.margin = '12px 0 !important';
                    restoredElement.style.borderRadius = '10px !important';
                    restoredElement.style.maxWidth = '95% !important';
                }

                if (insertPosition) {
                    messagesContainer.insertBefore(restoredElement, insertPosition);
                } else {
                    messagesContainer.appendChild(restoredElement);
                }
            }
        });
    }

    // å®šæœŸæ£€æŸ¥Agentæ¶ˆæ¯å®Œæ•´æ€§
    function startAgentMessageProtection() {
        setInterval(protectAgentMessages, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
    }

    // ===== ä¸»è¦äº‹ä»¶å¤„ç† =====
    function handleSearch() {
        const input = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const query = input.value.trim();

        if (!query || isProcessing) return;

        // è®¾ç½®å¤„ç†çŠ¶æ€
        isProcessing = true;
        searchBtn.disabled = true;

        // ä¿å­˜ç”¨æˆ·è¾“å…¥
        pendingUserInput = query;

        console.log('ğŸ” ç”¨æˆ·æœç´¢:', pendingUserInput);
        
        // æ¸…ç†æ¶ˆæ¯å»é‡è®°å½•ï¼Œç¡®ä¿æ–°å¯¹è¯ä¸å—å½±å“
        processedMessages.clear();
        console.log('ğŸ§¹ æ¸…ç†æ¶ˆæ¯å»é‡è®°å½•ï¼Œå¼€å§‹æ–°æœç´¢');

        // é‡ç½®æ€è€ƒæ¡†çŠ¶æ€
        console.log('ğŸ§¹ æœç´¢å‰é‡ç½®æ€è€ƒæ¡†çŠ¶æ€');
        if (thinkingBoxVisible) {
            hideThinkingBox();
        }
        thinkingBoxVisible = false;
        thinkingSteps.clear();
        currentThinkingMessageId = null;
        console.log('âœ… æœç´¢-æ€è€ƒæ¡†çŠ¶æ€å·²å®Œå…¨é‡ç½®');

        // å‘é€æ¶ˆæ¯æ—¶éšè—é¦–é¡µå»ºè®®
        hideSuggestions();

        // è¿›å…¥èŠå¤©æ¨¡å¼
        switchToChatMode();

        setTimeout(async () => {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(query, 'user');

            // æ·»åŠ å¤„ç†ä¸­æŒ‡ç¤ºå™¨
            addProcessingIndicator();

            // å¤„ç†æµå¼å›å¤
            await handleStreamChat(query);

            // æ¸…ç†çŠ¶æ€
            pendingUserInput = '';
            isProcessing = false;
        }, 100);

        // æ¸…ç©ºæœç´¢æ¡†
        input.value = '';
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const message = input.value.trim();

        console.log('ğŸ¯ sendMessage è¢«è°ƒç”¨');
        console.log('ğŸ“Š å½“å‰çŠ¶æ€:', {
            currentPage: currentPage,
            isProcessing: isProcessing,
            inputDisabled: input?.disabled,
            messageLength: message?.length || 0,
            socketConnected: socketConnected
        });

        if (!message || isProcessing || input.disabled) {
            console.log('âŒ å‘é€æ¡ä»¶æ£€æŸ¥å¤±è´¥:', {
                hasMessage: !!message,
                isProcessing: isProcessing,
                inputDisabled: input.disabled
            });
            return;
        }

        // ğŸ”§ ä¿®å¤ï¼šå¦‚æœå½“å‰åœ¨ä¸»é¡µçŠ¶æ€ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°èŠå¤©æ¨¡å¼
        if (currentPage === 'homepage') {
            console.log('ğŸ”„ æ£€æµ‹åˆ°åœ¨ä¸»é¡µçŠ¶æ€ä¸‹å‘é€æ¶ˆæ¯ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°èŠå¤©æ¨¡å¼');
            switchToChatMode();
        }

        console.log('ğŸ’¬ å‘é€æ¶ˆæ¯:', message);
        
        // æ¸…ç†æ¶ˆæ¯å»é‡è®°å½•ï¼Œç¡®ä¿æ–°å¯¹è¯ä¸å—å½±å“
        processedMessages.clear();
        console.log('ğŸ§¹ æ¸…ç†æ¶ˆæ¯å»é‡è®°å½•ï¼Œå¼€å§‹æ–°å¯¹è¯');
        
        // é‡ç½®æ€è€ƒæ¡†çŠ¶æ€ï¼Œå‡†å¤‡æ˜¾ç¤ºæ–°çš„æ€è€ƒè¿‡ç¨‹
        console.log('ğŸ§¹ å‘é€æ¶ˆæ¯å‰é‡ç½®æ€è€ƒæ¡†çŠ¶æ€');
        if (thinkingBoxVisible) {
            console.log('ğŸ”„ éšè—ä¹‹å‰çš„æ€è€ƒæ¡†');
            hideThinkingBox();
        }
        // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè®¾ç½®thinkingBoxVisible = false
        // è®©hideThinkingBoxå¤„ç†ï¼Œæˆ–è€…åœ¨handleStreamChatä¸­ç«‹å³æ˜¾ç¤ºæ–°çš„
        console.log('âœ… å‡†å¤‡æ˜¾ç¤ºæ–°çš„æ€è€ƒæ¡†');
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ç­‰å¾…ä¸­æ–­å“åº”
        if (window.waitingForInterruptResponse) {
            console.log('ğŸ“ è¿™æ˜¯å¯¹ä¸­æ–­çš„å“åº”:', message);
            console.log('ğŸ” ä¸­æ–­å“åº”æ—¶çš„session_id:', currentSessionId);
            console.log('ğŸ” ä¸­æ–­èŠ‚ç‚¹:', window.currentInterruptNode);
            window.waitingForInterruptResponse = false;
            
            // æ¢å¤è¾“å…¥æ¡†æç¤º
            input.placeholder = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚...';
        }

        // è®¾ç½®å¤„ç†çŠ¶æ€
        isProcessing = true;
        input.disabled = true;
        sendBtn.disabled = true;
        
        // æ°¸ä¹…éšè—èŠå¤©å»ºè®®ï¼ˆå‘é€æ¶ˆæ¯åä¸å†æ˜¾ç¤ºï¼‰
        chatSuggestionsPermanentlyHidden = true;
        hideChatSuggestions();

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage(message, 'user');

        // æ·»åŠ å¤„ç†ä¸­æŒ‡ç¤ºå™¨
        addProcessingIndicator();

        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';

        // å¤„ç†æµå¼å›å¤
        handleStreamChat(message);
    }

    // ===== ä¼˜åŒ–ç‰ˆæµå¼èŠå¤©å¤„ç†ï¼ˆå®æ—¶Markdownæ¸²æŸ“ï¼‰=====
    async function handleStreamChat(message) {
        console.log('ğŸ¯ å¼€å§‹æµå¼èŠå¤©:', message);
        console.log('ğŸ“‹ handleStreamChat å½“å‰çŠ¶æ€:', {
            currentPage: currentPage,
            currentSessionId: currentSessionId,
            socketConnected: socketConnected,
            messageLength: message?.length || 0
        });
        
        // ç”Ÿæˆæ–°çš„session IDï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (!currentSessionId) {
            currentSessionId = `session-${currentPage}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
            console.log('ğŸ†” ç”Ÿæˆæ–°session_id:', currentSessionId);
        }
        
        // ğŸ¯ ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨æ˜¾ç¤ºæ€è€ƒæ¡†
        console.log('ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ€è€ƒæ¡†', {
            thinkingVisible: messageManager.thinkingState.visible,
            waitingForInterruptResponse: window.waitingForInterruptResponse,
            currentSessionId: currentSessionId
        });
        
        // ğŸ¯ å…³é”®ä¿®å¤ï¼šåœ¨ä¸­æ–­æ¢å¤æ—¶å¼ºåˆ¶æ˜¾ç¤ºæ–°çš„æ€è€ƒæ¡†
        if (window.waitingForInterruptResponse) {
            console.log('ğŸ’­ è¿™æ˜¯ä¸­æ–­æ¢å¤ï¼Œå¼ºåˆ¶é‡ç½®å¹¶æ˜¾ç¤ºæ–°æ€è€ƒæ¡†');
            // å¼ºåˆ¶ç»“æŸä¹‹å‰çš„æ€è€ƒæ¡†
            messageManager.endThinking(true);
            // æ¸…ç†DOMä¸­å¯èƒ½å­˜åœ¨çš„æ—§æ€è€ƒæ¡†
            const oldThinkingBoxes = document.querySelectorAll('.thinking-steps-content');
            oldThinkingBoxes.forEach(box => box.remove());
        }
        
        // ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨å¼€å§‹æ€è€ƒæ¡†
        console.log('ğŸ§  ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨æ˜¾ç¤ºæ€è€ƒæ¡†');
        messageManager.startThinking(currentSessionId);

        try {
            // ç¡®ä¿æœ‰session_id - å¦‚æœåœ¨ç­‰å¾…ä¸­æ–­å“åº”ï¼Œä¸è¦é‡æ–°ç”Ÿæˆsession_id
            if (!currentSessionId) {
                currentSessionId = `session-${currentPage}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
                console.log('ğŸ†” ç”Ÿæˆæ–°session_id:', currentSessionId);
            } else if (window.waitingForInterruptResponse) {
                // ğŸ¯ å…³é”®ï¼šåœ¨ä¸­æ–­å“åº”æœŸé—´ä¿æŒsession_idä¸å˜
                console.log('ğŸ’­ ä¸­æ–­å“åº”æœŸé—´ä¿æŒç°æœ‰session_id:', currentSessionId);
            }

            // SocketIOè¿æ¥ - ç¡®ä¿åœ¨HTTPè¯·æ±‚å‰æ­£ç¡®åŠ å…¥ä¼šè¯
            if (socket && socketConnected) {
                console.log('ğŸ”— åŠ å…¥SocketIOä¼šè¯æˆ¿é—´:', currentSessionId);
                joinSession(currentSessionId);
                // ç­‰å¾…100msç¡®ä¿Socketä¼šè¯åŠ å…¥å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 100));
                console.log('âœ… Socketä¼šè¯åŠ å…¥å®Œæˆï¼Œå‡†å¤‡å‘é€HTTPè¯·æ±‚');
            } else {
                console.log('âš ï¸ Socketæœªè¿æ¥:', { socket: !!socket, socketConnected });
                console.log('ğŸ”„ å°è¯•é‡æ–°åˆå§‹åŒ–SocketIO...');
                if (typeof io !== 'undefined') {
                    initializeSocketIO();
                    // ç­‰å¾…è¿æ¥å»ºç«‹
                    await new Promise(resolve => setTimeout(resolve, 200));
                    if (socket && socketConnected) {
                        console.log('ğŸ”— é‡æ–°è¿æ¥æˆåŠŸï¼ŒåŠ å…¥ä¼šè¯æˆ¿é—´');
                        joinSession(currentSessionId);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
            }

            console.log('ğŸ“¡ å‡†å¤‡å‘èµ·HTTPè¯·æ±‚');
            console.log('ğŸ“‹ è¯·æ±‚å‚æ•°:', {
                url: 'http://localhost:5000/api/chat/stream',
                method: 'POST',
                message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                session_id: currentSessionId
            });

            console.log('ğŸš€ æ­£åœ¨å‘é€fetchè¯·æ±‚...');
            
            const response = await fetch('http://localhost:5000/api/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    session_id: currentSessionId
                })
            });

            console.log('ğŸ“¡ æ”¶åˆ°HTTPå“åº”:', {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                url: response.url,
                headers: Object.fromEntries(response.headers.entries())
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // ä»å“åº”å¤´è·å–session_id - ä½†åœ¨ä¸­æ–­å“åº”æœŸé—´ä¿æŒsession_idä¸å˜
            const sessionId = response.headers.get('X-Session-ID');
            if (sessionId && !window.waitingForInterruptResponse) {
                // åªæœ‰ä¸åœ¨ä¸­æ–­å“åº”æœŸé—´æ‰æ›´æ–°session_id
                currentSessionId = sessionId;
                console.log('ğŸ”„ æ›´æ–°session_id:', currentSessionId);
                if (socket && socketConnected) {
                    joinSession(currentSessionId);
                }
            } else if (sessionId && window.waitingForInterruptResponse) {
                console.log('ğŸ’­ ä¸­æ–­å“åº”æœŸé—´ï¼Œä¿æŒç°æœ‰session_idä¸å˜:', currentSessionId);
            }

            // ç§»é™¤å¤„ç†ä¸­æŒ‡ç¤ºå™¨
            removeProcessingIndicator();

            // æ·»åŠ æ€è€ƒå®Œæˆæ­¥éª¤ï¼Œä½†ä¸éšè—æ€è€ƒæ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´æ€è€ƒè¿‡ç¨‹
            if (thinkingBoxVisible) {
                // updateThinkingStep('final', 'processing', 'æ­£åœ¨ç”Ÿæˆå›å¤...');
                console.log('ğŸ§  ä¿æŒæ€è€ƒæ¡†æ˜¾ç¤ºï¼Œç›´åˆ°streamå“åº”å®Œæˆ');
            } else {
                // é¢å¤–ä¿æŠ¤ï¼šå¦‚æœæ­¤æ—¶æ€è€ƒæ¡†ä¸å¯è§ï¼Œå¯èƒ½æ˜¯å› ä¸ºworkflow_startæ¶ˆæ¯è¿˜æœªåˆ°è¾¾
                console.log('âš ï¸ æ³¨æ„ï¼šæ­¤æ—¶æ€è€ƒæ¡†ä¸å¯è§ï¼Œç­‰å¾…workflow_startæ¶ˆæ¯æ˜¾ç¤º');
            }

            // æš‚æ—¶ä¸åˆ›å»ºç©ºçš„AIæ¶ˆæ¯å®¹å™¨ï¼Œç­‰å¾…å®é™…å†…å®¹åˆ°è¾¾
            let aiMessageId = null;
            
            console.log('ğŸ“ ç­‰å¾…å®é™…å†…å®¹åˆ°è¾¾åå†åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨');
            
            // éªŒè¯DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
            const createdElement = document.getElementById(aiMessageId);
            const streamElement = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
            console.log('ğŸ” éªŒè¯DOMå…ƒç´ :', {
                byId: !!createdElement,
                byStreamId: !!streamElement,
                aiMessageId: aiMessageId
            });

            // æ ‡è®°æµå¼çŠ¶æ€
            const streamMessage = document.getElementById(aiMessageId);
            if (streamMessage) {
                streamMessage.classList.add('streaming');
            }

            // å¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let receivedData = false;
            let fullResponse = ''; // æ”¶é›†å®Œæ•´å›å¤

            // å®æ—¶Markdownæ¸²æŸ“ç›¸å…³å˜é‡
            let renderTimeout = null;
            let lastRenderTime = 0;
            const renderDelay = 50; // æ¸²æŸ“é˜²æŠ–å»¶è¿Ÿ (ms)
            let isMarkdownMode = false; // æ˜¯å¦å¯ç”¨markdownæ¨¡å¼

            console.log('ğŸ“Š å¼€å§‹å¤„ç†æµå¼æ•°æ®');

            // å®æ—¶Markdownæ¸²æŸ“å‡½æ•°
            function renderMarkdownRealtime(content, force = false) {
                // å¦‚æœæ²¡æœ‰aiMessageIdï¼Œè¯´æ˜è¿˜æ²¡æœ‰åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼Œç›´æ¥è¿”å›
                if (!aiMessageId) {
                    console.log('âš ï¸ aiMessageIdä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸²æŸ“');
                    return;
                }
                
                const now = Date.now();

                // é˜²æŠ–ï¼šé¿å…è¿‡äºé¢‘ç¹çš„æ¸²æŸ“
                if (!force && now - lastRenderTime < renderDelay) {
                    if (renderTimeout) clearTimeout(renderTimeout);

                    renderTimeout = setTimeout(() => {
                        renderMarkdownRealtime(content, true);
                    }, renderDelay);
                    return;
                }

                lastRenderTime = now;

                try {
                    const streamContent = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
                    if (!streamContent) {
                        console.error(`âŒ æ‰¾ä¸åˆ°æµå¼å†…å®¹å®¹å™¨ï¼ŒaiMessageId: ${aiMessageId}`);
                        // å°è¯•æŸ¥æ‰¾æ‰€æœ‰çš„æµå¼å†…å®¹å®¹å™¨
                        const allStreamContents = document.querySelectorAll('[data-stream-id]');
                        console.log('ğŸ” å½“å‰å­˜åœ¨çš„æµå¼å®¹å™¨:', allStreamContents.length, Array.from(allStreamContents).map(el => el.getAttribute('data-stream-id')));
                        return;
                    }
                    
                    // ç¡®ä¿çˆ¶æ¶ˆæ¯å®¹å™¨å¯è§
                    const messageDiv = streamContent.closest('.message');
                    if (messageDiv && messageDiv.style.display === 'none') {
                        messageDiv.style.display = 'flex';
                        messageDiv.removeAttribute('data-empty-ai');
                        console.log('ğŸ“Œ åœ¨æ¸²æŸ“æ—¶æ˜¾ç¤ºä¹‹å‰éšè—çš„AIæ¶ˆæ¯');
                    }

                    // æ£€æµ‹æ˜¯å¦åº”è¯¥å¯ç”¨markdownæ¨¡å¼
                    if (!isMarkdownMode) {
                        isMarkdownMode = shouldEnableMarkdown(content);
                    }

                    if (isMarkdownMode) {
                        // å°è¯•æ¸²æŸ“Markdown
                        const processed = preprocessStreamContent(content);
                        const markdownContent = marked.parse(processed);
                        console.log('ğŸ¨ è®¾ç½®Markdownå†…å®¹ï¼Œé•¿åº¦:', markdownContent.length);
                        streamContent.innerHTML = markdownContent;

                        // ç«‹å³å¤„ç†ä»£ç å—
                        const messageDiv = streamContent.closest('.message');
                        if (messageDiv) {
                            processCodeBlocksInMessage(messageDiv);

                            // å·¥ä½œåŒºæ¨¡å¼æ ·å¼
                            if (currentPage === 'workspace') {
                                ensureWorkspaceMarkdownStyles(messageDiv);
                            }
                        }
                    } else {
                        // çº¯æ–‡æœ¬æ¨¡å¼
                        console.log('ğŸ“ è®¾ç½®çº¯æ–‡æœ¬å†…å®¹ï¼Œé•¿åº¦:', content.length);
                        streamContent.textContent = content;
                    }

                    // å¹³æ»‘æ»šåŠ¨
                    scrollToBottomSmooth();

                } catch (error) {
                    console.warn('âš ï¸ å®æ—¶Markdownæ¸²æŸ“å¤±è´¥ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬:', error.message);

                    // æ¸²æŸ“å¤±è´¥æ—¶æ˜¾ç¤ºçº¯æ–‡æœ¬
                    const streamContent = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
                    if (streamContent) {
                        streamContent.textContent = content;
                    }
                }
            }

            // æ£€æµ‹æ˜¯å¦åº”è¯¥å¯ç”¨Markdownæ¨¡å¼
            function shouldEnableMarkdown(content) {
                // æ£€æµ‹markdownç‰¹å¾
                const markdownPatterns = [
                    /^#+\s/m,           // æ ‡é¢˜
                    /```[\s\S]*?```/,   // ä»£ç å—
                    /\*\*[\s\S]*?\*\*/, // ç²—ä½“
                    /^\s*[-\*\+]\s/m,   // åˆ—è¡¨
                    /^\s*\d+\.\s/m,     // æœ‰åºåˆ—è¡¨
                    /\[.*?\]\(.*?\)/,   // é“¾æ¥
                    /^\s*>/m,           // å¼•ç”¨
                    /\|.*?\|/,          // è¡¨æ ¼
                ];

                return markdownPatterns.some(pattern => pattern.test(content));
            }

            // é¢„å¤„ç†æµå¼å†…å®¹ï¼Œä¿®å¤å¸¸è§çš„ä¸å®Œæ•´é—®é¢˜
            function preprocessStreamContent(content) {
                let processed = content.trim();

                // ä¿®å¤ä¸å®Œæ•´çš„ä»£ç å—
                const codeBlockMatches = processed.match(/```/g);
                if (codeBlockMatches && codeBlockMatches.length % 2 !== 0) {
                    // æ£€æŸ¥æœ€åæ˜¯å¦æœ‰æœªå®Œæˆçš„ä»£ç å—
                    const lastCodeBlockStart = processed.lastIndexOf('```');
                    const contentAfterLastBlock = processed.substring(lastCodeBlockStart + 3);

                    // å¦‚æœä»£ç å—åé¢è¿˜æœ‰å†…å®¹ï¼Œè¯´æ˜å¯èƒ½æ˜¯æœªå®Œæˆçš„
                    if (contentAfterLastBlock.trim().length > 0 && !contentAfterLastBlock.includes('\n```')) {
                        processed += '\n```'; // æš‚æ—¶é—­åˆä»£ç å—
                    }
                }

                // ä¿®å¤ä¸å®Œæ•´çš„åˆ—è¡¨é¡¹
                processed = processed.replace(/\n(\d+\.|[-\*\+])\s*$/g, '\n$1 ...');

                return processed;
            }

            // ç§»é™¤ï¼Œå·²ç§»è‡³å…¨å±€ä½œç”¨åŸŸ

            // ä¸»è¦çš„æµå¼æ•°æ®å¤„ç†å¾ªç¯
            while (true) {
                const { done, value } = await reader.read();

                if (done) {
                    console.log('âœ… æµå¼æ•°æ®è¯»å–å®Œæˆ');

                    // ç§»é™¤æµå¼çŠ¶æ€æ ‡è®°
                    if (streamMessage) {
                        streamMessage.classList.remove('streaming');
                    }

                    // æ¸…ç†æ¸²æŸ“å®šæ—¶å™¨
                    if (renderTimeout) {
                        clearTimeout(renderTimeout);
                    }

                    // æœ€ç»ˆæ¸²æŸ“ - ç¡®ä¿å®Œæ•´æ€§ï¼ˆåªæœ‰åœ¨æœ‰å†…å®¹å’ŒaiMessageIdæ—¶æ‰æ¸²æŸ“ï¼‰
                    if (aiMessageId && fullResponse) {
                        try {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®ŠJSONå›å¤
                            if (isModelEnhanceJsonResponse(fullResponse)) {
                                console.log('ğŸ” æ£€æµ‹åˆ°æ¨¡å‹å¢å¼ºJSONå›å¤ï¼Œè¿›è¡Œæœ€ç»ˆæ ¼å¼åŒ–');
                                const enhanceResult = parseModelEnhanceResult(fullResponse);
                                if (enhanceResult) {
                                    const formattedContent = formatModelEnhanceResponse(enhanceResult);
                                    finalizeStreamMessageWithContent(aiMessageId, formattedContent);
                                } else {
                                    // æœ€åä¸€æ¬¡æ¸²æŸ“å®Œæ•´å†…å®¹
                                    renderMarkdownRealtime(fullResponse, true);
                                }
                            } else {
                                // æœ€åä¸€æ¬¡æ¸²æŸ“å®Œæ•´å†…å®¹
                                renderMarkdownRealtime(fullResponse, true);
                            }
                        } catch (finalError) {
                            console.error('âŒ æœ€ç»ˆæ¸²æŸ“å¤±è´¥:', finalError);
                            // ç¡®ä¿å†…å®¹å¯è§
                            const streamContent = document.querySelector(`[data-stream-id="${aiMessageId}"]`);
                            if (streamContent) {
                                streamContent.textContent = fullResponse;
                            }
                        }
                    } else if (!fullResponse) {
                        console.log('â„¹ï¸ æ²¡æœ‰æ”¶åˆ°ä»»ä½•å“åº”å†…å®¹ï¼Œè·³è¿‡æ¸²æŸ“');
                    }

                    // åœ¨streamå“åº”å®Œå…¨ç»“æŸæ—¶éšè—æ€è€ƒæ¡†ï¼ˆä½†ä¸è¦åœ¨ç­‰å¾…ä¸­æ–­å“åº”æ—¶éšè—ï¼‰
                    console.log('ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦éšè—æ€è€ƒæ¡†:', {
                        currentSessionId: currentSessionId,
                        thinkingState: messageManager.thinkingState,
                        isCurrentStreamThinking: messageManager.isCurrentStreamThinking(currentSessionId),
                        waitingForInterruptResponse: window.waitingForInterruptResponse
                    });
                    
                    // ç®€åŒ–æ¡ä»¶ï¼šåªè¦æ€è€ƒæ¡†å¯è§ä¸”ä¸æ˜¯åœ¨ç­‰å¾…ä¸­æ–­å“åº”ï¼Œå°±éšè—å®ƒ
                    if (messageManager.thinkingState.visible && !window.waitingForInterruptResponse) {
                        console.log('âœ… Streamå“åº”å®Œæˆï¼Œç°åœ¨éšè—æ€è€ƒæ¡†');
                        messageManager.endThinking();
                    } else if (window.waitingForInterruptResponse) {
                        console.log('ğŸ’­ ç­‰å¾…ä¸­æ–­å“åº”ï¼Œä¿æŒæ€è€ƒæ¡†æ˜¾ç¤º');
                    } else if (!messageManager.thinkingState.visible) {
                        console.log('â„¹ï¸ æ€è€ƒæ¡†å·²ç»éšè—');
                    }

                    // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„å¢å¼ºä¿¡æ¯ï¼ˆå½“æµå¼è¯»å–å®Œæˆæ—¶ï¼‰
                    setTimeout(() => {
                        checkPendingEnhanceInfo();
                    }, 1000); // å»¶è¿Ÿ1ç§’æ£€æŸ¥ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°å®ŒæˆçŠ¶æ€

                    break;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            console.log('ğŸ“¦ æµå¼æ•°æ®å—:', data.type, data.content ? data.content.substring(0, 30) + '...' : '');
                            receivedData = true;

                            if (data.type === 'content') {
                                fullResponse += data.content; // æ”¶é›†å®Œæ•´å›å¤
                                
                                // åªåœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ªå®é™…å†…å®¹æ—¶åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
                                if (!aiMessageId && data.content && data.content.trim()) {
                                    console.log('ğŸ“ æ”¶åˆ°ç¬¬ä¸€ä¸ªå†…å®¹ï¼Œç°åœ¨åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨');
                                    aiMessageId = addStreamMessage('', 'ai');
                                    if (!aiMessageId) {
                                        console.error('âŒ æ— æ³•åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨');
                                        return;
                                    }
                                    console.log('âœ… AIæ¶ˆæ¯å®¹å™¨åˆ›å»ºæˆåŠŸï¼ŒaiMessageId:', aiMessageId);
                                }
                                
                                console.log(`ğŸ“ å‡†å¤‡æ¸²æŸ“å†…å®¹ï¼ŒaiMessageId: ${aiMessageId}, å†…å®¹é•¿åº¦: ${fullResponse.length}`);
                                
                                // æ”¶åˆ°ç¬¬ä¸€ä¸ªcontentå°±éšè—æ€è€ƒæ¡†
                                if (fullResponse.length > 0 && messageManager.thinkingState.visible && !window.waitingForInterruptResponse) {
                                    console.log('ğŸ“ æ”¶åˆ°AIå›å¤å†…å®¹ï¼Œéšè—æ€è€ƒæ¡†');
                                    messageManager.endThinking();
                                }

                                // åªæœ‰åœ¨aiMessageIdå­˜åœ¨æ—¶æ‰æ¸²æŸ“å†…å®¹
                                if (aiMessageId) {
                                    // å®æ—¶æ¸²æŸ“å½“å‰ç´¯ç§¯çš„å†…å®¹
                                    renderMarkdownRealtime(fullResponse);
                                }

                            } else if (data.type === 'progress') {
                                // EDWè¿›åº¦æ›´æ–°
                                console.log('ğŸ“Š è¿›åº¦æ›´æ–°:', data.step, data.progress + '%');
                                showProgressIndicator(data.step, data.progress);
                                
                            } else if (data.type === 'enhanced_code') {
                                // å¢å¼ºåçš„ä»£ç 
                                console.log('ğŸš€ æ”¶åˆ°å¢å¼ºä»£ç :', data);
                                displayEnhancedCode(data);
                                
                            } else if (data.type === 'refined_code') {
                                // å¾®è°ƒåçš„ä»£ç 
                                console.log('âœ¨ æ”¶åˆ°å¾®è°ƒä»£ç  (ç¬¬' + data.round + 'è½®)');
                                displayRefinedCode(data.content, data.round);
                                
                            } else if (data.type === 'interrupt') {
                                // ä¸­æ–­è¯¢é—®
                                console.log('ğŸ’­ å·¥ä½œæµä¸­æ–­ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥');
                                handleInterruptPrompt(data.prompt, data.node);
                                
                            } else if (data.type === 'task_classified') {
                                // ä»»åŠ¡åˆ†ç±»ç»“æœ
                                console.log('ğŸ§­ ä»»åŠ¡åˆ†ç±»:', data.task_type);
                                fullResponse += '\n\n' + data.message;
                                renderMarkdownRealtime(fullResponse);
                                
                            } else if (data.type === 'node_update') {
                                // èŠ‚ç‚¹çŠ¶æ€æ›´æ–°
                                console.log('âš™ï¸ èŠ‚ç‚¹æ›´æ–°:', data.node, data.status);
                                updateNodeStatus(data.node, data.status, data.message);
                                
                            } else if (data.type === 'github_push') {
                                // GitHubæ¨é€ç»“æœ
                                console.log('ğŸ“¤ GitHubæ¨é€:', data.status);
                                if (data.pr_url) {
                                    fullResponse += `\n\nâœ… **GitHub PRåˆ›å»ºæˆåŠŸ**\n[æŸ¥çœ‹PR](${data.pr_url})`;
                                    renderMarkdownRealtime(fullResponse);
                                }
                                
                            } else if (data.type === 'adb_update') {
                                // ADBæ›´æ–°ç»“æœ
                                console.log('ğŸ”„ ADBæ›´æ–°:', data.status);
                                fullResponse += '\n\nğŸ”„ ' + data.message;
                                renderMarkdownRealtime(fullResponse);
                                
                            } else if (data.type === 'confluence_update') {
                                // Confluenceæ–‡æ¡£æ›´æ–°
                                console.log('ğŸ“ Confluenceæ›´æ–°:', data.status);
                                if (data.page_url) {
                                    fullResponse += `\n\nğŸ“ **æ–‡æ¡£å·²ç”Ÿæˆ**\n[æŸ¥çœ‹æ–‡æ¡£](${data.page_url})`;
                                    renderMarkdownRealtime(fullResponse);
                                }
                                
                            } else if (data.type === 'done') {
                                console.log('ğŸ æµå¼å›å¤å®Œæˆ');

                                if (data.session_id && data.message_count) {
                                    updateSessionInfo(data.message_count);
                                }

                                // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„å¢å¼ºä¿¡æ¯
                                setTimeout(() => {
                                    checkPendingEnhanceInfo();
                                }, 1000); // å»¶è¿Ÿ1ç§’æ£€æŸ¥ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°å®ŒæˆçŠ¶æ€

                                console.log('âœ… æµå¼å¤„ç†å®Œå…¨å®Œæˆ');
                                return;

                            } else if (data.type === 'error') {
                                console.error('âŒ æ”¶åˆ°é”™è¯¯å“åº”:', data.error);
                                const errorContent = `âŒ **AIæœåŠ¡é”™è¯¯**\n\n${data.error}`;
                                finalizeStreamMessageWithContent(aiMessageId, errorContent);
                                return;
                            }
                        } catch (e) {
                            console.error('âŒ è§£ææµå¼æ•°æ®å¤±è´¥:', e, 'åŸå§‹è¡Œ:', line);
                        }
                    }
                }
            }

            if (!receivedData) {
                console.warn('âš ï¸ æœªæ”¶åˆ°ä»»ä½•æµå¼æ•°æ®');
                const warningContent = 'âš ï¸ **æœªæ”¶åˆ°å“åº”**\n\næœåŠ¡å™¨æ²¡æœ‰è¿”å›æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•ã€‚';
                finalizeStreamMessageWithContent(aiMessageId, warningContent);
            }

        } catch (error) {
            console.error('âŒ æµå¼èŠå¤©å¤±è´¥:', error);

            // ç§»é™¤å¤„ç†ä¸­æŒ‡ç¤ºå™¨
            removeProcessingIndicator();
            
            // éšè—æ€è€ƒæ¡†
            if (messageManager.thinkingState.visible) {
                messageManager.endThinking();
            }

            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            addMessage(`âŒ **è¿æ¥å¤±è´¥**\n\næ— æ³•è¿æ¥åˆ°AIæœåŠ¡: ${error.message}`, 'ai');
            showError(`AIå›å¤å¤±è´¥: ${error.message}`);

        } finally {
            // æ¢å¤è¾“å…¥çŠ¶æ€
            isProcessing = false;
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const searchBtn = document.getElementById('searchBtn');

            input.disabled = false;
            sendBtn.disabled = false;
            searchBtn.disabled = false;

            input.focus();

            // ç¡®ä¿Agentæ¶ˆæ¯å®Œæ•´æ€§
            protectAgentMessages();
        }
    }

    // ===== æ¨¡å‹å¢å¼ºå›å¤å¤„ç†è¾…åŠ©å‡½æ•° =====
    function isModelEnhanceJsonResponse(response) {
        const trimmed = response.trim();
        try {
            // æ£€æŸ¥æ˜¯å¦ä¸ºJSONæ ¼å¼ï¼Œä¸”åŒ…å«æ¨¡å‹å¢å¼ºç›¸å…³å­—æ®µ
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                const parsed = JSON.parse(trimmed);
                return parsed.hasOwnProperty('enhanced_code') &&
                    parsed.hasOwnProperty('explanation') &&
                    parsed.hasOwnProperty('improvements');
            }
        } catch (e) {
            // ä¸æ˜¯æœ‰æ•ˆJSON
        }
        return false;
    }

    function parseModelEnhanceResult(response) {
        try {
            const trimmed = response.trim();

            // æ¸…ç†å¯èƒ½çš„markdownæ ¼å¼
            let cleanedResult = trimmed;
            if (cleanedResult.startsWith('```json')) {
                cleanedResult = cleanedResult.slice(7);
            }
            if (cleanedResult.endsWith('```')) {
                cleanedResult = cleanedResult.slice(0, -3);
            }
            cleanedResult = cleanedResult.trim();

            const parsed = JSON.parse(cleanedResult);
            console.log('âœ… æˆåŠŸè§£ææ¨¡å‹å¢å¼ºç»“æœ:', parsed);
            return parsed;
        } catch (e) {
            console.error('âŒ è§£ææ¨¡å‹å¢å¼ºç»“æœå¤±è´¥:', e);
            return null;
        }
    }

    function formatModelEnhanceResponse(result) {
        const improvements = result.improvements && Array.isArray(result.improvements)
            ? result.improvements.map(item => `â€¢ ${item}`).join('\n')
            : 'â€¢ ä»£ç ä¼˜åŒ–å’Œæ€§èƒ½æå‡';

        const enhancedCode = result.enhanced_code || '';
        const codeSection = enhancedCode ? `\n\n**å¢å¼ºåçš„ä»£ç ï¼š**\n\`\`\`sql\n${enhancedCode}\n\`\`\`` : '';

        return `## ğŸ‰ æ¨¡å‹å¢å¼ºå®Œæˆï¼

**ä¼˜åŒ–è¯´æ˜ï¼š**
${result.explanation || 'ä»£ç å·²ä¼˜åŒ–'}

**ä¸»è¦æ”¹è¿›ï¼š**
${improvements}

**æ–°å¢å­—æ®µï¼š** ${result.add_new || 'æ— '}${codeSection}

> ğŸ’¡ å¢å¼ºåçš„ä»£ç å·²è‡ªåŠ¨æ›´æ–°åˆ°å³ä¾§ç¼–è¾‘å™¨ï¼Œæ‚¨å¯ä»¥ç»§ç»­ç¼–è¾‘å’Œä¿å­˜ã€‚`;
    }

    // ===== å®æ—¶æ¶ˆæ¯å¤„ç† =====
    function handleRealtimeAgentMessage(data) {
        console.log('ğŸ”„ å¤„ç†å®æ—¶Agentæ¶ˆæ¯:', data.type);

        // ç”Ÿæˆæ¶ˆæ¯å”¯ä¸€ID - åŒ…å«æ›´å¤šæ ‡è¯†ä¿¡æ¯é¿å…è¯¯åˆ¤é‡å¤
        let messageId = `${data.type}-${data.timestamp}-${data.session_id}`;
        
        // å¯¹äºnode_progressç±»å‹ï¼Œæ·»åŠ èŠ‚ç‚¹åç§°å’ŒçŠ¶æ€æ¥ç¡®ä¿å”¯ä¸€æ€§
        if (data.type === 'node_progress' && data.data) {
            const node = data.data.node || 'unknown';
            const status = data.data.status || 'unknown';
            messageId = `${data.type}-${node}-${status}-${data.timestamp}-${data.session_id}`;
        }

        // é˜²æ­¢é‡å¤å¤„ç†åŒä¸€æ¡æ¶ˆæ¯ - ä½†å…è®¸ä¸åŒçŠ¶æ€çš„è¿›åº¦æ¶ˆæ¯
        if (processedMessages.has(messageId)) {
            console.log('âš ï¸ è·³è¿‡é‡å¤æ¶ˆæ¯:', messageId);
            return;
        }
        processedMessages.add(messageId);

        // æ›´æ–°å½“å‰ä¼šè¯ID
        if (data.session_id && !currentSessionId) {
            currentSessionId = data.session_id;
            updateSessionInfo();
        }

        // ğŸ” æ·»åŠ é€šç”¨è°ƒè¯•æ—¥å¿—éªŒè¯æ¶ˆæ¯ç»“æ„
        console.log('ğŸ” å®Œæ•´æ¶ˆæ¯ç»“æ„:', {
            type: data.type,
            hasData: !!data.data,
            dataKeys: data.data ? Object.keys(data.data) : [],
            dataPreview: data.data ? JSON.stringify(data.data).substring(0, 200) + '...' : 'null'
        });

        // æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œå¤„ç†
        switch (data.type) {
            // æ–°çš„ç»Ÿä¸€æ¶ˆæ¯ç±»å‹å¤„ç†
            case 'TOOL_MESSAGE':
                console.log('ğŸ› ï¸ æ”¶åˆ°å·¥å…·æ¶ˆæ¯:', data);
                console.log('ğŸ” TOOL_MESSAGE data.data:', data.data); // è°ƒè¯•æ—¥å¿—
                // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ‚¬åœåŠŸèƒ½
                if (data.data.show_on_hover && data.data.tool_input) {
                    updateNodeStatusWithHoverData(data.data.tool_name, data.data.action, data.data.message, data.data.tool_input);
                } else {
                    updateNodeStatus(data.data.tool_name, data.data.action, data.data.message);
                }
                break;
                
            case 'NODE_MESSAGE':
                console.log('ğŸ“ æ”¶åˆ°èŠ‚ç‚¹æ¶ˆæ¯:', data);
                console.log('ğŸ” NODE_MESSAGE data.data:', data.data); // è°ƒè¯•æ—¥å¿—
                updateNodeStatus(data.data.node, data.data.status, data.data.message);
                break;
                
            case 'CODE_MESSAGE':
                console.log('ğŸ’¾ æ”¶åˆ°ä»£ç æ¶ˆæ¯:', data);
                console.log('ğŸ” CODE_MESSAGE data.data:', data.data); // è°ƒè¯•æ—¥å¿—
                if (data.data.code_type === 'enhanced') {
                    handleEnhancedCodeMessage(data.data);
                } else if (data.data.code_type === 'review_report') {
                    handleReviewReportMessage(data.data);
                } else if (data.data.code_type === 'original') {
                    handleOriginalCodeMessage(data.data);
                }
                break;
            
            case 'page_switch':
                console.log('ğŸ”„ æ”¶åˆ°é¡µé¢åˆ‡æ¢æ¶ˆæ¯:', data.data);
                addAgentMessage('page-switch', 'ğŸ”„', 'é¡µé¢åˆ‡æ¢', data.data.message || 'æ­£åœ¨åˆ‡æ¢é¡µé¢...');
                handleRealtimePageSwitch(data.data);
                break;

            case 'agent_handoff':
                console.log('ğŸ”„ æ”¶åˆ°Agentåˆ‡æ¢æ¶ˆæ¯:', data.data);
                addAgentMessage('agent-handoff', 'ğŸ¤–', 'Agentåˆ‡æ¢',
                    data.data.message || `ä»${data.data.from_agent}åˆ‡æ¢åˆ°${data.data.to_agent}`);
                handleRealtimeAgentHandoff(data.data);
                break;

            case 'node_progress':
                console.log('ğŸ”„ æ”¶åˆ°èŠ‚ç‚¹è¿›åº¦æ¶ˆæ¯:', data.data);
                
                // è°ƒè¯•ï¼šç¡®è®¤æ•°æ®ç»“æ„
                console.log('ğŸ” data.data.data:', data.data.data);
                console.log('ğŸ” data.data keys:', Object.keys(data.data));
                
                // æ ¹æ®å®é™…æ—¥å¿—ï¼Œæ•°æ®åœ¨ data.data.data ä¸­
                const actualData = data.data.data || {};
                console.log('ğŸ” å®é™…æ•°æ®:', actualData);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·æ‰§è¡Œæ¶ˆæ¯ï¼ˆå¸¦æ‚¬åœå‚æ•°ï¼‰
                if (actualData.action === 'tool_executing' && actualData.show_on_hover) {
                    console.log('ğŸ› ï¸ æ£€æµ‹åˆ°å·¥å…·æ‰§è¡Œæ¶ˆæ¯ï¼Œä½¿ç”¨æ‚¬åœæ˜¾ç¤ºå‚æ•°');
                    updateNodeStatusWithHoverData(actualData.node, actualData.status, actualData.message, actualData.tool_input);
                } else {
                    // æ™®é€šèŠ‚ç‚¹è¿›åº¦æ¶ˆæ¯
                    console.log('ğŸ” ä¼ é€’ç»™updateNodeStatusçš„å‚æ•°:', {
                        node: actualData.node,
                        status: actualData.status, 
                        message: actualData.message
                    });
                    updateNodeStatus(actualData.node, actualData.status, actualData.message);
                }
                break;

            case 'validation_progress':
                console.log('âœ… æ”¶åˆ°éªŒè¯è¿›åº¦æ¶ˆæ¯:', data.data);
                const validationData = data.data;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·æ‰§è¡Œæ¶ˆæ¯
                if (validationData.extra && validationData.extra.action === 'tool_executing' && validationData.extra.show_on_hover) {
                    // å¤„ç†å·¥å…·æ‰§è¡Œæ¶ˆæ¯ï¼Œå¸¦æ‚¬åœå‚æ•°æ˜¾ç¤º
                    const toolMessage = validationData.message;
                    const toolInput = validationData.extra.tool_input;
                    updateNodeStatusWithHoverData(validationData.node, validationData.status, toolMessage, toolInput);
                } else {
                    // æ™®é€šæ¶ˆæ¯
                    updateNodeStatus(validationData.node, validationData.status, validationData.message);
                }
                break;

            case 'workflow_start':
                console.log('ğŸš€ æ”¶åˆ°å·¥ä½œæµå¼€å§‹æ¶ˆæ¯:', data.data);
                // å·¥ä½œæµå¼€å§‹æ—¶åªæ›´æ–°æ€è€ƒæ¡†å†…å®¹ï¼Œä¸é‡æ–°åˆ›å»ºï¼ˆé€šå¸¸åœ¨handleStreamChatä¸­å·²ç»åˆ›å»ºï¼‰
                if (data.data && data.data.message) {
                    // å¦‚æœæ€è€ƒæ¡†å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹ï¼›å¦åˆ™åˆ›å»º
                    if (messageManager.thinkingState.visible) {
                        messageManager.updateThinkingProgress('workflow', 'started', data.data.message);
                    } else {
                        console.log('ğŸ¬ å·¥ä½œæµå¼€å§‹ï¼Œåˆ›å»ºæ€è€ƒæ¡†');
                        messageManager.startThinking(data.session_id || currentSessionId);
                        messageManager.updateThinkingProgress('workflow', 'started', data.data.message);
                    }
                }
                break;

            case 'workflow_resume':
                console.log('ğŸ”„ æ”¶åˆ°å·¥ä½œæµæ¢å¤æ¶ˆæ¯:', data.data);
                // ğŸ¯ å·¥ä½œæµæ¢å¤æ—¶åªæ›´æ–°æ€è€ƒæ¡†å†…å®¹ï¼ˆä¸­æ–­æ¢å¤çš„ç¬¬äºŒè½®å¯¹è¯ï¼‰
                if (data.data && data.data.message) {
                    // å¦‚æœæ€è€ƒæ¡†å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹ï¼›å¦åˆ™åˆ›å»º
                    if (messageManager.thinkingState.visible) {
                        messageManager.updateThinkingProgress('workflow_resume', 'resumed', data.data.message);
                    } else {
                        console.log('ğŸ¬ å·¥ä½œæµæ¢å¤ï¼Œåˆ›å»ºæ€è€ƒæ¡†');
                        messageManager.startThinking(data.session_id || currentSessionId);
                        messageManager.updateThinkingProgress('workflow_resume', 'resumed', data.data.message);
                    }
                }
                break;

            case 'node_status':
                console.log('ğŸ“Š æ”¶åˆ°èŠ‚ç‚¹çŠ¶æ€æ¶ˆæ¯:', data.data);
                const nodeStatusData = data.data;
                updateNodeStatus(nodeStatusData.node || nodeStatusData.node_name, 
                                nodeStatusData.status, 
                                nodeStatusData.message || nodeStatusData.description || 'èŠ‚ç‚¹æ‰§è¡Œä¸­');
                break;

            case 'original_code':
                console.log('ğŸ“„ æ”¶åˆ°åŸå§‹ä»£ç æ¶ˆæ¯:', data.data);
                displayOriginalCode(data.data);
                break;
            
            case 'enhanced_code':
                console.log('ğŸš€ æ”¶åˆ°å¢å¼ºä»£ç æ¶ˆæ¯:', data.data);
                displayEnhancedCode(data.data);
                break;

            case 'tool_progress':
                console.log('ğŸ”§ æ”¶åˆ°å·¥å…·è°ƒç”¨è¿›åº¦æ¶ˆæ¯:', data.data);
                handleToolProgressMessage(data.data);
                break;

            case 'agent_decision':
                console.log('ğŸ¤– æ”¶åˆ°Agentå†³ç­–æ¶ˆæ¯:', data.data);
                handleAgentDecisionMessage(data.data);
                break;

            case 'agent_complete':
                console.log('âœ… æ”¶åˆ°Agentå®Œæˆæ¶ˆæ¯:', data.data);
                handleAgentCompleteMessage(data.data);
                break;

            default:
                console.warn('âš ï¸ æœªçŸ¥çš„å®æ—¶æ¶ˆæ¯ç±»å‹:', data.type);
        }
    }

    // ===== æ–°çš„ç»Ÿä¸€æ¶ˆæ¯å¤„ç†å‡½æ•° =====
    function handleEnhancedCodeMessage(data) {
        console.log('ğŸš€ å¤„ç†å¢å¼ºä»£ç æ¶ˆæ¯:', data);
        // è°ƒç”¨ç°æœ‰çš„displayEnhancedCodeå‡½æ•°
        displayEnhancedCode(data);
    }
    
    function handleReviewReportMessage(data) {
        console.log('ğŸ“‹ å¤„ç†è¯„å®¡æŠ¥å‘Šæ¶ˆæ¯:', data);
        // å¯ä»¥æ‰©å±•ä¸ºä¸“é—¨çš„è¯„å®¡æŠ¥å‘Šæ˜¾ç¤ºé€»è¾‘
        // ç›®å‰å…ˆä½¿ç”¨é€šç”¨çš„è¿›åº¦æ›´æ–°
        updateNodeStatus('code_review', 'completed', `ä»£ç è¯„å®¡å®Œæˆï¼Œè¯„åˆ†: ${data.score}åˆ†`);
    }
    
    function handleOriginalCodeMessage(data) {
        console.log('ğŸ“„ å¤„ç†åŸå§‹ä»£ç æ¶ˆæ¯:', data);
        // è°ƒç”¨ç°æœ‰çš„displayOriginalCodeå‡½æ•°
        displayOriginalCode(data);
    }

    // ===== å·¥å…·ç›‘æ§æ¶ˆæ¯å¤„ç† =====
    function handleToolProgressMessage(data) {
        console.log('ğŸ”§ å¤„ç†å·¥å…·è°ƒç”¨è¿›åº¦:', data);
        
        // æ ¹æ®å·¥å…·è°ƒç”¨åŠ¨ä½œç±»å‹å¤„ç†
        if (data.action === 'start') {
            // å·¥å…·å¼€å§‹è°ƒç”¨
            const message = data.message || `ğŸ”§ æ­£åœ¨ä½¿ç”¨å·¥å…·: ${data.tool_name}`;
            messageManager.updateThinkingProgress(`tool_${data.tool_name}`, 'started', message);
            
        } else if (data.action === 'complete') {
            // å·¥å…·è°ƒç”¨å®Œæˆ
            const message = data.message || `âœ… å·¥å…·æ‰§è¡Œå®Œæˆ (${data.duration}ç§’)`;
            messageManager.updateThinkingProgress(`tool_${data.tool_name}`, 'completed', message);
            
        } else if (data.action === 'error') {
            // å·¥å…·è°ƒç”¨å‡ºé”™
            const message = `âŒ å·¥å…·æ‰§è¡Œå¤±è´¥: ${data.error}`;
            messageManager.updateThinkingProgress(`tool_${data.tool_name}`, 'error', message);
        }
    }

    function handleAgentDecisionMessage(data) {
        console.log('ğŸ¤– å¤„ç†Agentå†³ç­–:', data);
        
        // æ ¹æ®å†³ç­–åŠ¨ä½œç±»å‹å¤„ç†
        if (data.action === 'thinking') {
            // Agentå¼€å§‹æ€è€ƒ
            messageManager.updateThinkingProgress(`${data.agent_type}_thinking`, 'started', data.message);
            
        } else if (data.action === 'tool_selected') {
            // Agenté€‰æ‹©äº†å·¥å…·
            const message = data.message || `ğŸ¯ é€‰æ‹©å·¥å…·: ${data.tool_name}`;
            messageManager.updateThinkingProgress(`${data.agent_type}_decision`, 'processing', message);
        }
    }

    function handleAgentCompleteMessage(data) {
        console.log('âœ… å¤„ç†Agentå®Œæˆ:', data);
        
        // Agentä»»åŠ¡å®Œæˆ
        if (data.action === 'finished') {
            const message = data.message || `âœ… ${data.agent_type}æ™ºèƒ½ä½“ä»»åŠ¡å®Œæˆ`;
            messageManager.updateThinkingProgress(`${data.agent_type}_complete`, 'completed', message);
        }
    }

    // ===== å®æ—¶é¡µé¢åˆ‡æ¢å¤„ç† =====
    function handleRealtimePageSwitch(data) {
        console.log('âš¡ å®æ—¶é¡µé¢åˆ‡æ¢å¤„ç†:', data);

        if (data.target_page === 'workspace' && data.module_type === 'enhance') {
            console.log('âš¡ åˆ‡æ¢åˆ°æ¨¡å‹å¢å¼ºå·¥ä½œåŒº');
            switchToWorkspaceMode('enhance');

        } else if (data.target_page === 'workspace' && data.module_type === 'new') {
            console.log('âš¡ åˆ‡æ¢åˆ°æ–°å¢æ¨¡å‹å·¥ä½œåŒº');
            switchToWorkspaceMode('new');
        } else {
            console.log('âš ï¸ æœªå¤„ç†çš„é¡µé¢åˆ‡æ¢ç±»å‹:', data);
        }
    }

    // ===== å…¶ä»–å®æ—¶æ¶ˆæ¯å¤„ç†å‡½æ•° =====
    function handleRealtimeAgentHandoff(data) {
        console.log('âš¡ å®æ—¶Agentåˆ‡æ¢å¤„ç†:', data);
    }

    function handleRealtimeToolStart(data) {
        console.log('âš¡ å®æ—¶å·¥å…·å¼€å§‹å¤„ç†:', data);

        if (data.tool_name === 'search_table_cd') {
            const fileName = document.getElementById('fileName');
            const codeEditor = document.getElementById('codeEditor');

            if (fileName) {
                fileName.textContent = 'ğŸ” æ­£åœ¨æŸ¥æ‰¾ä»£ç ...';
            }

            if (codeEditor) {
                codeEditor.style.opacity = '0.6';
                codeEditor.placeholder = 'æ­£åœ¨æœç´¢è¡¨çš„æºä»£ç ï¼Œè¯·ç¨å€™...';
            }

            showToolLoadingState(true);
        }
    }

    function handleRealtimeToolEnd(data) {
        console.log('âš¡ å®æ—¶å·¥å…·ç»“æŸå¤„ç†:', data);

        showToolLoadingState(false);

        const codeEditor = document.getElementById('codeEditor');
        if (codeEditor) {
            codeEditor.style.opacity = '1';
        }
    }

    function handleRealtimeCodeFound(data) {
        console.log('âš¡ å®æ—¶ä»£ç æ‰¾åˆ°å¤„ç†:', data);

        if (data.code_info) {
            console.log('âš¡ ç«‹å³æ›´æ–°ä»£ç ç¼–è¾‘å™¨:', data.code_info.table_name);
            updateCodeFromAgentImmediate(data.code_info);
        }
    }

    function handleRealtimeCodeError(data) {
        console.log('âš¡ å®æ—¶ä»£ç é”™è¯¯å¤„ç†:', data);

        const fileName = document.getElementById('fileName');
        const codeEditor = document.getElementById('codeEditor');

        if (fileName) {
            fileName.textContent = 'âŒ ä»£ç åŠ è½½å¤±è´¥';
        }

        if (codeEditor) {
            codeEditor.style.opacity = '1';
            codeEditor.placeholder = 'ä»£ç åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥è¡¨å';
        }

        showToolLoadingState(false);
    }

    function handleRealtimeCodeUpdate(data) {
        console.log('âš¡ å®æ—¶ä»£ç æ›´æ–°å¤„ç†:', data);

        try {
            if (data.code_info && data.action === 'enhance_complete') {
                console.log('âš¡ å¤„ç†æ¨¡å‹å¢å¼ºå®Œæˆï¼Œæ›´æ–°ä»£ç ç¼–è¾‘å™¨');

                const codeEditor = document.getElementById('codeEditor');
                const languageTag = document.getElementById('languageTag');
                const fileName = document.getElementById('fileName');

                if (!codeEditor || !languageTag || !fileName) {
                    console.error('âŒ ä»£ç ç¼–è¾‘å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
                    showError('ä»£ç ç¼–è¾‘å™¨å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // æ›´æ–°ä»£ç å†…å®¹
                const enhancedCode = data.code_info.enhanced_code || '';
                codeEditor.value = enhancedCode;
                codeEditor.style.opacity = '1';
                originalCode = enhancedCode;

                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯ - ä½¿ç”¨currentFileä¸­çš„å‡†ç¡®ä¿¡æ¯
                const language = currentFile?.language || 'sql';
                // ä½¿ç”¨search_table_cdå·¥å…·è¿”å›çš„å‡†ç¡®æ–‡ä»¶å
                const fileNameText = currentFile?.name || 'enhanced_model.sql';

                // æ›´æ–°è¯­è¨€æ ‡ç­¾
                if (language === 'sql') {
                    languageTag.textContent = 'SQL';
                    languageTag.style.background = '#f29111';
                    languageTag.style.borderColor = '#f29111';
                } else if (language === 'python') {
                    languageTag.textContent = 'Python';
                    languageTag.style.background = '#3776ab';
                    languageTag.style.borderColor = '#3776ab';
                } else {
                    languageTag.textContent = language.toUpperCase();
                    languageTag.style.background = '#238636';
                    languageTag.style.borderColor = '#238636';
                }

                // æ˜¾ç¤ºæ¥è‡ªsearch_table_cdçš„å‡†ç¡®æ–‡ä»¶å
                fileName.textContent = fileNameText;
                console.log('ğŸ“ æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º:', fileNameText, '(æ¥æº: currentFileå‡†ç¡®ä¿¡æ¯)');

                // é‡ç½®ä¿®æ”¹çŠ¶æ€
                isCodeModified = false;
                const modifiedIndicator = document.getElementById('modifiedIndicator');
                const saveBtn = document.getElementById('saveBtn');

                if (modifiedIndicator) modifiedIndicator.classList.remove('show');
                if (saveBtn) saveBtn.classList.remove('show');

                // æ›´æ–°å½“å‰æ–‡ä»¶ä¿¡æ¯ - ä¿ç•™åŸå§‹è·¯å¾„å’Œè¡¨åä¿¡æ¯
                if (currentFile) {
                    // å¦‚æœå·²æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œä¿ç•™åŸå§‹ä¿¡æ¯å¹¶æ ‡è®°ä¸ºå·²å¢å¼º
                    currentFile.enhanced = true;
                    currentFile.language = language;
                    // åªåœ¨æ²¡æœ‰åŸå§‹æ–‡ä»¶åæ—¶æ‰ä½¿ç”¨fallback
                    if (!currentFile.name) {
                        currentFile.name = fileNameText;
                    }
                } else {
                    // æ²¡æœ‰åŸå§‹æ–‡ä»¶ä¿¡æ¯æ—¶åˆ›å»ºæ–°å¯¹è±¡
                    currentFile = {
                        name: fileNameText,
                        language: language,
                        enhanced: true
                    };
                }

                // åœæ­¢å·¥å…·åŠ è½½çŠ¶æ€
                showToolLoadingState(false);

                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥ï¼ˆä»…åœ¨å³ä¸‹è§’æ˜¾ç¤ºï¼‰
                showSuccess(`æ¨¡å‹å¢å¼ºå®Œæˆ: ${fileNameText}`, 3000);

                console.log('âœ… ä»£ç æ›´æ–°å®Œæˆ:', fileNameText);

                // === åŠŸèƒ½ç‚¹1ï¼šä¿å­˜å¢å¼ºä¿¡æ¯ï¼Œç­‰å¾…æµå¼å“åº”å®Œæˆåå¤„ç† ===
                savePendingEnhanceInfo(data.code_info);
            }

        } catch (error) {
            console.error('âŒ å¤„ç†ä»£ç æ›´æ–°å¤±è´¥:', error);
            showError('æ›´æ–°ä»£ç å¤±è´¥: ' + error.message);
        }
    }

    function handleRealtimeAgentEnd(data) {
        console.log('âš¡ å®æ—¶Agentç»“æŸå¤„ç†:', data);
    }

    // ===== å·¥å…·åŠ è½½çŠ¶æ€ç®¡ç† =====
    function showToolLoadingState(show) {
        const codeActions = document.querySelector('.code-actions');

        if (show) {
            if (codeActions && !codeActions.querySelector('.tool-loading')) {
                const loadingEl = document.createElement('div');
                loadingEl.className = 'tool-loading';
                loadingEl.innerHTML = '<span style="color: #4f46e5;">ğŸ” æŸ¥æ‰¾ä¸­...</span>';
                loadingEl.style.fontSize = '12px';
                loadingEl.style.marginRight = '10px';
                codeActions.insertBefore(loadingEl, codeActions.firstChild);
            }
        } else {
            const loadingEl = codeActions?.querySelector('.tool-loading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }
    }

    // ===== ä»£ç ç¼–è¾‘å™¨ç®¡ç† =====
    function updateCodeFromAgentImmediate(codeInfo) {
        try {
            console.log('âš¡ ç«‹å³æ›´æ–°ä»£ç ç¼–è¾‘å™¨:', codeInfo);

            const codeEditor = document.getElementById('codeEditor');
            const languageTag = document.getElementById('languageTag');
            const fileName = document.getElementById('fileName');

            if (!codeEditor || !languageTag || !fileName) {
                console.error('âŒ ä»£ç ç¼–è¾‘å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
                showError('ä»£ç ç¼–è¾‘å™¨å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // ç«‹å³æ›´æ–°ä»£ç å†…å®¹
            codeEditor.value = codeInfo.code || '';
            codeEditor.style.opacity = '1';
            originalCode = codeEditor.value;

            // ç«‹å³æ›´æ–°æ–‡ä»¶ä¿¡æ¯
            const language = codeInfo.language || 'unknown';

            if (language === 'sql') {
                languageTag.textContent = 'SQL';
                languageTag.style.background = '#f29111';
                languageTag.style.borderColor = '#f29111';
            } else if (language === 'python') {
                languageTag.textContent = 'Python';
                languageTag.style.background = '#3776ab';
                languageTag.style.borderColor = '#3776ab';
            } else {
                languageTag.textContent = language.toUpperCase();
                languageTag.style.background = '#238636';
                languageTag.style.borderColor = '#238636';
            }

            fileName.textContent = codeInfo.file_name || 'unknown.file';
            console.log('ğŸ“ æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º:', codeInfo.file_name, '(æ¥æº: search_table_cdç»“æœ)');

            // é‡ç½®ä¿®æ”¹çŠ¶æ€
            isCodeModified = false;
            const modifiedIndicator = document.getElementById('modifiedIndicator');
            const saveBtn = document.getElementById('saveBtn');

            if (modifiedIndicator) modifiedIndicator.classList.remove('show');
            if (saveBtn) saveBtn.classList.remove('show');

            // æ›´æ–°å½“å‰æ–‡ä»¶ä¿¡æ¯
            currentFile = {
                name: codeInfo.file_name,
                language: codeInfo.language,
                path: codeInfo.file_path,
                table_name: codeInfo.table_name
            };

            console.log('âœ… ä»£ç ç¼–è¾‘å™¨ç«‹å³æ›´æ–°å®Œæˆ:', codeInfo.table_name);
            showSuccess(`ä»£ç åŠ è½½æˆåŠŸ: ${codeInfo.table_name}`, 2000);

        } catch (error) {
            console.error('âŒ ç«‹å³æ›´æ–°ä»£ç ç¼–è¾‘å™¨å¤±è´¥:', error);
            showError('æ›´æ–°ä»£ç å¤±è´¥: ' + error.message);
        }
    }

    function initializeWorkspace(mode) {
        const codeEditor = document.getElementById('codeEditor');
        const chatInput = document.getElementById('chatInput');

        // è®¾ç½®è¾“å…¥æ¡†å ä½ç¬¦
        if (mode === 'new') {
            chatInput.placeholder = 'è¯·è¯¦ç»†æè¿°ä½ çš„æ–°æ¨¡å‹éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·è¡Œä¸ºé¢„æµ‹æ¨¡å‹...';
            updateCodeExample('new');
        } else if (mode === 'enhance') {
            chatInput.placeholder = 'è¯·æè¿°ä½ çš„ä»£ç ä¼˜åŒ–éœ€æ±‚ï¼Œæˆ–è€…ç›´æ¥è´´ä¸Šä½ çš„ä»£ç è®©æˆ‘å¸®ä½ åˆ†æ...';
            updateCodeExample('enhance');
        }

        console.log('âš™ï¸ å·¥ä½œåŒºåˆå§‹åŒ–å®Œæˆ:', mode);
    }

    function updateCodeExample(moduleType = 'enhance') {
        const example = {
            code: `# æ•°æ®å¼€å‘åŠ©æ‰‹ - ä»£ç ä¼˜åŒ–å’Œæ•°æ®å¤„ç†
# è¯·åœ¨å·¦ä¾§æè¿°ä½ çš„éœ€æ±‚æˆ–è´´ä¸Šä½ çš„ä»£ç 

import pandas as pd
import numpy as np
from sklearn.metrics import accuracy_score

def optimize_data_processing():
    '''æ•°æ®å¤„ç†ä¼˜åŒ–ç¤ºä¾‹'''

    # ç¤ºä¾‹ï¼šè¿™æ˜¯ä¸€ä¸ªå¯ä»¥ä¼˜åŒ–çš„æ•°æ®å¤„ç†å‡½æ•°
    # ä½ å¯ä»¥è´´ä¸Šä½ çš„ä»£ç ï¼Œæˆ‘ä¼šå¸®ä½ åˆ†æå’Œä¼˜åŒ–

    data = []
    for i in range(1000):
        data.append(i * 2)  # è¿™é‡Œå¯ä»¥ä¼˜åŒ–

    return data

# å¸¸è§ä¼˜åŒ–æ–¹å‘ï¼š
# 1. æ€§èƒ½ä¼˜åŒ– - æå‡è¿è¡Œé€Ÿåº¦å’Œå†…å­˜ä½¿ç”¨
# 2. ä»£ç é‡æ„ - æé«˜å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
# 3. é”™è¯¯å¤„ç† - å¢åŠ å¼‚å¸¸å¤„ç†å’Œè¾¹ç•Œæ£€æŸ¥
# 4. æœ€ä½³å®è·µ - éµå¾ªPython/SQLç¼–ç¨‹è§„èŒƒ
# 5. åŠŸèƒ½å¢å¼º - æ·»åŠ æ–°åŠŸèƒ½æˆ–æ”¹è¿›ç°æœ‰é€»è¾‘

# è¯·åœ¨å·¦ä¾§æè¿°ä½ çš„æ•°æ®å¼€å‘éœ€æ±‚...`,
            fileInfo: { language: 'python', name: 'data_optimization.py' }
        };

        const codeEditor = document.getElementById('codeEditor');
        codeEditor.value = example.code;
        originalCode = example.code;
        updateFileInfo(example.fileInfo);
        currentFile = example.fileInfo;

        isCodeModified = false;
        document.getElementById('modifiedIndicator').classList.remove('show');
        document.getElementById('saveBtn').classList.remove('show');
    }

    function updateFileInfo(fileInfo) {
        const languageTag = document.getElementById('languageTag');
        const fileName = document.getElementById('fileName');

        const language = fileInfo.language || 'code';
        const name = fileInfo.name || 'unknown';

        if (language === 'python') {
            languageTag.textContent = 'Python';
            languageTag.style.background = '#3776ab';
        } else if (language === 'sql') {
            languageTag.textContent = 'SQL';
            languageTag.style.background = '#f29111';
        } else {
            languageTag.textContent = 'ä»£ç ';
            languageTag.style.background = '#238636';
        }

        fileName.textContent = name;
        console.log('ğŸ“ æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º:', name, '(æ¥æº: updateFileInfoå‡½æ•°)');
    }

    function handleCodeChange() {
        const codeEditor = document.getElementById('codeEditor');
        const currentCode = codeEditor.value;

        if (currentCode !== originalCode) {
            if (!isCodeModified) {
                isCodeModified = true;
                document.getElementById('modifiedIndicator').classList.add('show');
                document.getElementById('saveBtn').classList.add('show');
            }
        } else {
            if (isCodeModified) {
                isCodeModified = false;
                document.getElementById('modifiedIndicator').classList.remove('show');
                document.getElementById('saveBtn').classList.remove('show');
            }
        }
    }

    async function saveCode() {
        if (!currentFile || !isCodeModified) return;

        const saveBtn = document.getElementById('saveBtn');
        const codeEditor = document.getElementById('codeEditor');

        try {
            saveBtn.disabled = true;
            saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';

            // æ¨¡æ‹Ÿä¿å­˜å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 1000));

            // æ›´æ–°åŸå§‹ä»£ç å†…å®¹
            originalCode = codeEditor.value;
            isCodeModified = false;
            document.getElementById('modifiedIndicator').classList.remove('show');
            document.getElementById('saveBtn').classList.remove('show');

            addMessage(`âœ… **ä¿å­˜æˆåŠŸï¼**\n\nä»£ç å·²æˆåŠŸä¿å­˜åˆ° ${currentFile.name}`, 'ai');
            showNotification('ä»£ç ä¿å­˜æˆåŠŸï¼', 'success');

        } catch (error) {
            addMessage(`âŒ **ä¿å­˜å¤±è´¥**\n\n${error.message}`, 'ai');
            showNotification('ä»£ç ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ğŸ’¾ ä¿å­˜';
        }
    }

    // ===== è¾…åŠ©å‡½æ•° =====
    function autoResizeTextarea(element) {
        element.style.height = 'auto';
        element.style.height = Math.min(element.scrollHeight, 200) + 'px';
    }

    function uploadFiles() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = '.py,.sql,.txt,.json,.csv';
        input.onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                addMessage(`ğŸ“ **å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶**\n\n${files.map(f => `â€¢ ${f.name}`).join('\n')}`, 'ai');
            }
        };
        input.click();
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function copyCode(button) {
        const code = button.parentElement.nextElementSibling.textContent;
        navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'å·²å¤åˆ¶';
            button.classList.add('copied');
            setTimeout(() => {
                button.textContent = 'å¤åˆ¶';
                button.classList.remove('copied');
            }, 2000);
        });
    }

    // ===== èŠå¤©æ¡†å†…ç¡®è®¤å¡ç‰‡ç®¡ç† =====
    
    /**
     * æ·»åŠ ç¡®è®¤å¡ç‰‡åˆ°èŠå¤©æ¡†
     * @param {Object} options - å¡ç‰‡é…ç½®
     */
    function addConfirmCard(options) {
        const {
            type,           // 'update_code' æˆ– 'run_code'
            icon,           // å›¾æ ‡ emoji
            title,          // æ ‡é¢˜
            subtitle,       // å‰¯æ ‡é¢˜
            message,        // æè¿°æ¶ˆæ¯
            primaryText,    // ä¸»æŒ‰é’®æ–‡å­—
            secondaryText,  // æ¬¡æŒ‰é’®æ–‡å­—
            primaryAction,  // ä¸»æŒ‰é’®åŠ¨ä½œ
            secondaryAction // æ¬¡æŒ‰é’®åŠ¨ä½œ
        } = options;

        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) {
            console.error('âŒ æœªæ‰¾åˆ°æ¶ˆæ¯å®¹å™¨');
            return;
        }

        // ç”Ÿæˆå”¯ä¸€ID
        const cardId = `confirm-card-${type}-${Date.now()}`;
        
        // åˆ›å»ºç¡®è®¤å¡ç‰‡æ¶ˆæ¯
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai confirm-card';
        messageDiv.id = cardId;
        messageDiv.setAttribute('data-message-type', 'confirm-card');
        messageDiv.setAttribute('data-card-type', type);

        messageDiv.innerHTML = `
            <div class="avatar">ğŸ¤–</div>
            <div class="confirm-card-content">
                <div class="confirm-card-header">
                    <span class="confirm-card-icon">${icon}</span>
                    <h3 class="confirm-card-title">${title}</h3>
                    <p class="confirm-card-subtitle">${subtitle}</p>
                </div>
                <div class="confirm-card-body">
                    <div class="confirm-card-message">${message}</div>
                    <div class="confirm-card-actions">
                        <button class="confirm-btn confirm-btn-secondary" onclick="handleConfirmCard('${cardId}', 'secondary')">
                            ${secondaryText}
                        </button>
                        <button class="confirm-btn confirm-btn-primary" onclick="handleConfirmCard('${cardId}', 'primary')">
                            ${primaryText}
                        </button>
                    </div>
                </div>
            </div>
        `;

        // å­˜å‚¨å›è°ƒå‡½æ•°
        messageDiv.confirmCardCallbacks = {
            primary: primaryAction,
            secondary: secondaryAction
        };

        // ä½¿ç”¨æ™ºèƒ½æ’å…¥å‡½æ•°ï¼Œç¡®ä¿æ€è€ƒæ¡†å§‹ç»ˆåœ¨åº•éƒ¨
        insertMessageBeforeThinking(messageDiv, messagesContainer);

        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        requestAnimationFrame(() => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        });

        console.log('âœ… æ·»åŠ ç¡®è®¤å¡ç‰‡åˆ°èŠå¤©æ¡†:', type, title);
        return cardId;
    }

    /**
     * å¤„ç†ç¡®è®¤å¡ç‰‡æŒ‰é’®ç‚¹å‡»
     */
    window.handleConfirmCard = function(cardId, action) {
        const cardElement = document.getElementById(cardId);
        if (!cardElement) {
            console.error('âŒ æœªæ‰¾åˆ°ç¡®è®¤å¡ç‰‡:', cardId);
            return;
        }

        const callbacks = cardElement.confirmCardCallbacks;
        if (!callbacks) {
            console.error('âŒ æœªæ‰¾åˆ°ç¡®è®¤å¡ç‰‡å›è°ƒå‡½æ•°:', cardId);
            return;
        }

        // è®¾ç½®æŒ‰é’®ä¸ºåŠ è½½çŠ¶æ€
        const clickedBtn = cardElement.querySelector(action === 'primary' ? '.confirm-btn-primary' : '.confirm-btn-secondary');
        const otherBtn = cardElement.querySelector(action === 'primary' ? '.confirm-btn-secondary' : '.confirm-btn-primary');
        
        if (clickedBtn) {
            clickedBtn.classList.add('confirm-btn-loading');
            clickedBtn.disabled = true;
            if (otherBtn) otherBtn.disabled = true;
        }

        // æ‰§è¡Œå¯¹åº”çš„å›è°ƒå‡½æ•°
        const callback = callbacks[action];
        if (typeof callback === 'function') {
            try {
                callback(cardId);
            } catch (error) {
                console.error('âŒ æ‰§è¡Œç¡®è®¤å¡ç‰‡å›è°ƒå¤±è´¥:', error);
                showError('æ“ä½œæ‰§è¡Œå¤±è´¥: ' + error.message);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (clickedBtn) {
                    clickedBtn.classList.remove('confirm-btn-loading');
                    clickedBtn.disabled = false;
                    if (otherBtn) otherBtn.disabled = false;
                }
            }
        }
    };

    /**
     * ç§»é™¤ç¡®è®¤å¡ç‰‡
     */
    function removeConfirmCard(cardId) {
        const cardElement = document.getElementById(cardId);
        if (cardElement) {
            // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
            cardElement.style.transition = 'all 0.3s ease-out';
            cardElement.style.opacity = '0';
            cardElement.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                if (cardElement.parentNode) {
                    cardElement.parentNode.removeChild(cardElement);
                }
            }, 300);
            
            console.log('âœ… ç§»é™¤ç¡®è®¤å¡ç‰‡:', cardId);
        }
    }

    /**
     * æ˜¾ç¤ºæ›´æ–°ä»£ç ç¡®è®¤å¡ç‰‡
     */
    function showUpdateCodeCard() {
        if (isUpdateCodeCardVisible) {
            console.log('âš ï¸ æ›´æ–°ä»£ç å¡ç‰‡å·²æ˜¾ç¤ºï¼Œè·³è¿‡é‡å¤æ˜¾ç¤º');
            return;
        }

        isUpdateCodeCardVisible = true;

        // æ„å»ºæ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
        let fileInfoText = '';
        if (currentFile) {
            const fileName = currentFile.name || 'æ¨¡å‹ä»£ç ';
            const tableName = currentFile.table_name || '';
            const filePath = currentFile.path || '';
            
            fileInfoText = `<div class="file-info">ğŸ“„ <strong>${fileName}</strong>`;
            if (tableName) {
                fileInfoText += `<br>ğŸ“Š è¡¨å: ${tableName}`;
            }
            if (filePath) {
                fileInfoText += `<br>ğŸ“‚ è·¯å¾„: ${filePath}`;
            }
            fileInfoText += '</div><br>';
        }

        const cardId = addConfirmCard({
            type: 'update_code',
            icon: 'ğŸš€',
            title: 'æ¨¡å‹å¢å¼ºå®Œæˆ',
            subtitle: 'ä»£ç å·²ä¼˜åŒ–ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°åˆ°Databricksï¼Ÿ',
            message: fileInfoText + 'ç³»ç»Ÿå·²å®Œæˆæ¨¡å‹å¢å¼ºï¼Œç”Ÿæˆäº†ä¼˜åŒ–åçš„ä»£ç ã€‚<br>æ‚¨å¯ä»¥é€‰æ‹©ç«‹å³å°†æ–°ä»£ç æ›´æ–°åˆ°Databrickså·¥ä½œåŒºã€‚',
            primaryText: 'ç«‹å³æ›´æ–°',
            secondaryText: 'ç¨åæ›´æ–°',
            primaryAction: confirmUpdateCode,
            secondaryAction: () => {
                isUpdateCodeCardVisible = false;
                removeConfirmCard(cardId);
                showInfo('æ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨æ›´æ–°ä»£ç åˆ°Databricks', 2000);
            }
        });

        // ä¿å­˜å¡ç‰‡IDä»¥ä¾¿åç»­æ“ä½œ
        window.currentUpdateCardId = cardId;
        
        console.log('âœ… æ˜¾ç¤ºæ›´æ–°ä»£ç ç¡®è®¤å¡ç‰‡');
        showInfo('æ¨¡å‹å¢å¼ºå®Œæˆï¼Œç­‰å¾…æ‚¨çš„ç¡®è®¤', 2000);
    }

    /**
     * ç¡®è®¤æ›´æ–°ä»£ç åˆ°Databricks
     */
    function confirmUpdateCode() {
        console.log('ğŸš€ ç”¨æˆ·ç¡®è®¤æ›´æ–°ä»£ç åˆ°Databricks');

        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        const updateMessage = "æ›´æ–°æœ€æ–°ä»£ç åˆ°Databrickså·¥ä½œåŒº";
        
        // è®¾ç½®pending actionç”¨äºè·Ÿè¸ª
        pendingUpdateAction = {
            type: 'update_code',
            message: updateMessage,
            timestamp: Date.now()
        };

        // ç§»é™¤ç¡®è®¤å¡ç‰‡
        if (window.currentUpdateCardId) {
            removeConfirmCard(window.currentUpdateCardId);
            isUpdateCodeCardVisible = false;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addUserMessage(updateMessage, {
            showTyping: true,
            showTimestamp: true,
            highlight: true
        });

        // æ·»åŠ å¤„ç†ä¸­æŒ‡ç¤ºå™¨
        addProcessingIndicator();

        // è°ƒç”¨ç°æœ‰çš„æµå¼èŠå¤©å¤„ç†
        handleStreamChat(updateMessage)
            .then(() => {
                console.log('âœ… æ›´æ–°ä»£ç æŒ‡ä»¤å¤„ç†å®Œæˆ');
                // å¤„ç†å®Œæˆåï¼Œç›‘å¬Databricksæ›´æ–°å®Œæˆäº‹ä»¶
                setupDatabricksUpdateListener();
            })
            .catch((error) => {
                console.error('âŒ æ›´æ–°ä»£ç æŒ‡ä»¤å¤„ç†å¤±è´¥:', error);
                showError('æ›´æ–°ä»£ç è¯·æ±‚å¤±è´¥: ' + error.message);
            });
    }

    /**
     * æ˜¾ç¤ºè¿è¡Œä»£ç ç¡®è®¤å¡ç‰‡
     */
    function showRunCodeCard() {
        if (isRunCodeCardVisible) {
            console.log('âš ï¸ è¿è¡Œä»£ç å¡ç‰‡å·²æ˜¾ç¤ºï¼Œè·³è¿‡é‡å¤æ˜¾ç¤º');
            return;
        }

        isRunCodeCardVisible = true;

        // æ„å»ºæ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
        let fileInfoText = '';
        if (currentFile) {
            const fileName = currentFile.name || 'æ¨¡å‹ä»£ç ';
            const tableName = currentFile.table_name || '';
            const filePath = currentFile.path || '';
            
            fileInfoText = `<div class="file-info">ğŸ“„ <strong>${fileName}</strong>`;
            if (tableName) {
                fileInfoText += `<br>ğŸ“Š è¡¨å: ${tableName}`;
            }
            if (filePath) {
                fileInfoText += `<br>ğŸ“‚ è·¯å¾„: ${filePath}`;
            }
            fileInfoText += '</div><br>';
        }

        const cardId = addConfirmCard({
            type: 'run_code',
            icon: 'âš¡',
            title: 'ä»£ç æ›´æ–°æˆåŠŸ',
            subtitle: 'æ˜¯å¦ç«‹å³è¿è¡Œåˆšæ›´æ–°çš„ä»£ç ï¼Ÿ',
            message: fileInfoText + 'ä»£ç å·²æˆåŠŸæ›´æ–°åˆ°Databrickså·¥ä½œåŒºã€‚<br>æ‚¨å¯ä»¥é€‰æ‹©ç«‹å³è¿è¡Œä»£ç æŸ¥çœ‹æ‰§è¡Œç»“æœã€‚',
            primaryText: 'ç«‹å³è¿è¡Œ',
            secondaryText: 'ç¨åè¿è¡Œ',
            primaryAction: confirmRunCode,
            secondaryAction: () => {
                isRunCodeCardVisible = false;
                removeConfirmCard(cardId);
                showInfo('æ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨è¿è¡Œä»£ç ', 2000);
            }
        });

        // ä¿å­˜å¡ç‰‡IDä»¥ä¾¿åç»­æ“ä½œ
        window.currentRunCardId = cardId;
        
        console.log('âœ… æ˜¾ç¤ºè¿è¡Œä»£ç ç¡®è®¤å¡ç‰‡');
        showInfo('ä»£ç æ›´æ–°å®Œæˆï¼Œç­‰å¾…æ‚¨çš„ç¡®è®¤', 2000);
    }

    /**
     * ç¡®è®¤ç«‹å³è¿è¡Œä»£ç 
     */
    function confirmRunCode() {
        console.log('âš¡ ç”¨æˆ·ç¡®è®¤ç«‹å³è¿è¡Œä»£ç ');

        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        const runMessage = "ç«‹å³è¿è¡Œåˆšæ›´æ–°çš„ä»£ç ";
        
        // è®¾ç½®pending actionç”¨äºè·Ÿè¸ª
        pendingRunAction = {
            type: 'run_code',
            message: runMessage,
            timestamp: Date.now()
        };

        // ç§»é™¤ç¡®è®¤å¡ç‰‡
        if (window.currentRunCardId) {
            removeConfirmCard(window.currentRunCardId);
            isRunCodeCardVisible = false;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addUserMessage(runMessage, {
            showTyping: true,
            showTimestamp: true,
            highlight: true
        });

        // æ·»åŠ å¤„ç†ä¸­æŒ‡ç¤ºå™¨
        addProcessingIndicator();

        // è°ƒç”¨ç°æœ‰çš„æµå¼èŠå¤©å¤„ç†
        handleStreamChat(runMessage)
            .then(() => {
                console.log('âœ… è¿è¡Œä»£ç æŒ‡ä»¤å¤„ç†å®Œæˆ');
            })
            .catch((error) => {
                console.error('âŒ è¿è¡Œä»£ç æŒ‡ä»¤å¤„ç†å¤±è´¥:', error);
                showError('è¿è¡Œä»£ç è¯·æ±‚å¤±è´¥: ' + error.message);
            });
    }

    /**
     * åŸºäºadd_newå­—æ®µæ£€æµ‹å¹¶æ˜¾ç¤ºæ›´æ–°å·¥ä½œæµ
     * @param {Object} codeInfo - ä»£ç ä¿¡æ¯å¯¹è±¡ï¼ŒåŒ…å«add_newç­‰å­—æ®µ
     */
    function checkAndShowUpdateWorkflow(codeInfo) {
        try {
            // åªåœ¨å·¥ä½œåŒºæ¨¡å¼ä¸‹æ£€æµ‹
            if (currentPage !== 'workspace') {
                console.log('â„¹ï¸ éå·¥ä½œåŒºæ¨¡å¼ï¼Œè·³è¿‡æ›´æ–°å·¥ä½œæµæ£€æµ‹');
                return;
            }

            // é˜²æ­¢é‡å¤æ˜¾ç¤ºå¡ç‰‡
            if (isUpdateCodeCardVisible) {
                console.log('âš ï¸ æ›´æ–°å¡ç‰‡å·²æ˜¾ç¤ºï¼Œè·³è¿‡é‡å¤æ£€æµ‹');
                return;
            }

            if (!codeInfo) {
                console.log('âš ï¸ ä»£ç ä¿¡æ¯ä¸ºç©ºï¼Œæ— æ³•æ£€æµ‹æ›´æ–°å·¥ä½œæµ');
                return;
            }

            // æ ¸å¿ƒåˆ¤æ–­ï¼šæ£€æŸ¥add_newå­—æ®µ
            const addNew = codeInfo.add_new;
            const hasFieldUpdates = addNew && addNew.trim() !== '' && addNew !== 'æ— ';

            console.log('ğŸ” æ£€æµ‹æ›´æ–°å·¥ä½œæµæ¡ä»¶:', {
                add_new: addNew,
                hasFieldUpdates: hasFieldUpdates,
                enhanced_code: codeInfo.enhanced_code ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                file_name: codeInfo.file_name
            });

            if (hasFieldUpdates) {
                console.log('ğŸ‰ æ£€æµ‹åˆ°å­—æ®µæ›´æ–°ï¼Œå¯ç”¨æ›´æ–°å·¥ä½œæµ:', addNew);
                
                // å»¶è¿Ÿ2ç§’æ˜¾ç¤ºç¡®è®¤å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸé€šçŸ¥
                setTimeout(() => {
                    // å†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨ç­‰å¾…æœŸé—´è¿›è¡Œäº†å…¶ä»–æ“ä½œ
                    if (!isUpdateCodeCardVisible && currentPage === 'workspace') {
                        showUpdateCodeCardWithDetails(codeInfo);
                    }
                }, 2000);
            } else {
                console.log('â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å­—æ®µæ›´æ–°ï¼Œè·³è¿‡æ›´æ–°å·¥ä½œæµ:', addNew);
            }
            
        } catch (error) {
            console.error('âŒ æ£€æµ‹æ›´æ–°å·¥ä½œæµå¤±è´¥:', error);
        }
    }

    /**
     * æ˜¾ç¤ºå¸¦è¯¦ç»†ä¿¡æ¯çš„æ›´æ–°ä»£ç ç¡®è®¤å¡ç‰‡
     * @param {Object} codeInfo - ä»£ç ä¿¡æ¯ï¼ŒåŒ…å«add_newç­‰è¯¦ç»†ä¿¡æ¯
     */
    function showUpdateCodeCardWithDetails(codeInfo) {
        if (isUpdateCodeCardVisible) {
            console.log('âš ï¸ æ›´æ–°ä»£ç å¡ç‰‡å·²æ˜¾ç¤ºï¼Œè·³è¿‡é‡å¤æ˜¾ç¤º');
            return;
        }

        isUpdateCodeCardVisible = true;

        // ä½¿ç”¨currentFileä¸­ä¿å­˜çš„æ­£ç¡®æ–‡ä»¶ä¿¡æ¯ï¼ˆæ¥è‡ªsearch codeå·¥å…·ï¼‰
        const fileName = currentFile ? currentFile.name : 'æ¨¡å‹ä»£ç ';
        const tableName = currentFile ? currentFile.table_name : '';
        
        const detailMessage = `ç³»ç»Ÿå·²å®Œæˆæ¨¡å‹å¢å¼ºï¼Œç”Ÿæˆäº†ä¼˜åŒ–åçš„ä»£ç ã€‚<br><br>
            <strong>æ–‡ä»¶ï¼š</strong> ${fileName}<br>
            ${tableName ? `<strong>è¡¨åï¼š</strong> ${tableName}<br>` : ''}
            æ‚¨å¯ä»¥é€‰æ‹©ç«‹å³å°†æ–°ä»£ç æ›´æ–°åˆ°Databrickså·¥ä½œåŒºã€‚`;

        const cardId = addConfirmCard({
            type: 'update_code',
            icon: 'ğŸš€',
            title: 'æ¨¡å‹å¢å¼ºå®Œæˆ',
            subtitle: 'æ˜¯å¦ç«‹å³åŒæ­¥åˆ°Databricksï¼Ÿ',
            message: detailMessage,
            primaryText: 'ç«‹å³æ›´æ–°',
            secondaryText: 'ç¨åæ›´æ–°',
            primaryAction: () => confirmUpdateCodeWithDetails(codeInfo),
            secondaryAction: () => {
                isUpdateCodeCardVisible = false;
                removeConfirmCard(cardId);
                showInfo('æ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨æ›´æ–°ä»£ç åˆ°Databricks', 2000);
            }
        });

        // ä¿å­˜å¡ç‰‡IDå’Œä»£ç ä¿¡æ¯ä»¥ä¾¿åç»­æ“ä½œ
        window.currentUpdateCardId = cardId;
        window.currentCodeInfo = codeInfo;
        
        console.log('âœ… æ˜¾ç¤ºæ›´æ–°ä»£ç ç¡®è®¤å¡ç‰‡:', fileName);
        showInfo('æ¨¡å‹å¢å¼ºå®Œæˆï¼Œç­‰å¾…æ‚¨çš„ç¡®è®¤', 2000);
    }

    /**
     * ç¡®è®¤æ›´æ–°ä»£ç åˆ°Databricksï¼ˆå¸¦è¯¦ç»†ä¿¡æ¯ï¼‰
     * @param {Object} codeInfo - ä»£ç ä¿¡æ¯
     */
    function confirmUpdateCodeWithDetails(codeInfo) {
        console.log('ğŸš€ ç”¨æˆ·ç¡®è®¤æ›´æ–°ä»£ç åˆ°Databricks');

        // ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶ä¿¡æ¯æ„å»ºæ›´æ–°æ¶ˆæ¯
        const fileName = currentFile ? currentFile.name : 'æ¨¡å‹ä»£ç ';
        const updateMessage = `æ›´æ–°æœ€æ–°ä»£ç åˆ°Databrickså·¥ä½œåŒºï¼š${fileName}`;
        
        // è®¾ç½®pending actionç”¨äºè·Ÿè¸ª
        pendingUpdateAction = {
            type: 'update_code',
            message: updateMessage,
            codeInfo: codeInfo,
            timestamp: Date.now()
        };

        // ç§»é™¤ç¡®è®¤å¡ç‰‡
        if (window.currentUpdateCardId) {
            removeConfirmCard(window.currentUpdateCardId);
            isUpdateCodeCardVisible = false;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addUserMessage(updateMessage, {
            showTyping: true,
            showTimestamp: true,
            highlight: true
        });

        // æ·»åŠ å¤„ç†ä¸­æŒ‡ç¤ºå™¨
        addProcessingIndicator();

        // è°ƒç”¨ç°æœ‰çš„æµå¼èŠå¤©å¤„ç†
        handleStreamChat(updateMessage)
            .then(() => {
                console.log('âœ… æ›´æ–°ä»£ç æŒ‡ä»¤å¤„ç†å®Œæˆ');
                // å¤„ç†å®Œæˆåï¼Œç›‘å¬Databricksæ›´æ–°å®Œæˆäº‹ä»¶
                setupDatabricksUpdateListener();
            })
            .catch((error) => {
                console.error('âŒ æ›´æ–°ä»£ç æŒ‡ä»¤å¤„ç†å¤±è´¥:', error);
                showError('æ›´æ–°ä»£ç è¯·æ±‚å¤±è´¥: ' + error.message);
            });
    }

    /**
     * ç›‘å¬Databricksæ›´æ–°å®Œæˆäº‹ä»¶
     */
    function setupDatabricksUpdateListener() {
        console.log('ğŸ”„ è®¾ç½®Databricksæ›´æ–°å®Œæˆç›‘å¬å™¨');
        
        // åˆ›å»ºä¸€ä¸ªæ›´å…¨é¢çš„ç›‘å¬å™¨
        let listenerActive = true;
        let updateCompleteDetected = false;
        
        // ä¿å­˜åŸå§‹å‡½æ•°
        const originalHandleRealtimeAgentMessage = handleRealtimeAgentMessage;
        const originalHandleStreamChat = handleStreamChat;
        
        function databricksUpdateListener(data) {
            // è°ƒç”¨åŸå§‹å¤„ç†å‡½æ•°
            originalHandleRealtimeAgentMessage(data);
            
            if (!listenerActive || updateCompleteDetected) return;
            
            console.log('ğŸ” ç›‘å¬å™¨æ£€æŸ¥æ¶ˆæ¯:', data.type, data.data?.tool_name, data.data?.message);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯Databricksæ›´æ–°å®Œæˆäº‹ä»¶
            const isUpdateComplete = (
                // å·¥å…·ç»“æŸäº‹ä»¶
                (data.type === 'tool_end' && data.data && (
                    data.data.tool_name === 'upload_code_to_databricks' ||
                    data.data.tool_name === 'sync_code_to_databricks' ||
                    data.data.message?.includes('ä»£ç æ›´æ–°å®Œæˆ') ||
                    data.data.message?.includes('åŒæ­¥å®Œæˆ') ||
                    data.data.message?.includes('æ›´æ–°æˆåŠŸ') ||
                    data.data.message?.includes('ä¸Šä¼ å®Œæˆ')
                )) ||
                // Agentå®Œæˆäº‹ä»¶
                (data.type === 'agent_end' && data.data?.message?.includes('ä»£ç ') && 
                 (data.data.message?.includes('æ›´æ–°') || data.data.message?.includes('åŒæ­¥')))
            );
            
            if (isUpdateComplete) {
                console.log('ğŸ‰ æ£€æµ‹åˆ°Databricksæ›´æ–°å®Œæˆäº‹ä»¶:', data);
                updateCompleteDetected = true;
                
                // å»¶è¿Ÿæ˜¾ç¤ºè¿è¡Œç¡®è®¤å¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ›´æ–°å®Œæˆæ¶ˆæ¯
                setTimeout(() => {
                    if (listenerActive) {
                        showRunCodeCard();
                        // æ¢å¤åŸå§‹å¤„ç†å‡½æ•°
                        handleRealtimeAgentMessage = originalHandleRealtimeAgentMessage;
                        listenerActive = false;
                    }
                }, 2000);
            }
        }
        
        // å¢å¼ºçš„æµå¼æ¶ˆæ¯ç›‘å¬å™¨
        async function enhancedStreamHandler(message) {
            try {
                const result = await originalHandleStreamChat(message);
                
                // å¦‚æœç›‘å¬å™¨ä»ç„¶æ´»è·ƒï¼Œæ£€æŸ¥æµå¼å›å¤æ˜¯å¦åŒ…å«æ›´æ–°å®Œæˆä¿¡æ¯
                if (listenerActive && !updateCompleteDetected) {
                    // æ£€æŸ¥æœ€åçš„AIæ¶ˆæ¯æ˜¯å¦åŒ…å«æˆåŠŸä¿¡æ¯
                    setTimeout(() => {
                        const lastAiMessage = document.querySelector('.message.ai[data-message-type="stream"]:last-child .message-content');
                        if (lastAiMessage) {
                            const content = lastAiMessage.textContent || lastAiMessage.innerText;
                            const containsSuccess = (
                                content.includes('æ›´æ–°å®Œæˆ') ||
                                content.includes('åŒæ­¥æˆåŠŸ') ||
                                content.includes('ä¸Šä¼ æˆåŠŸ') ||
                                content.includes('ä»£ç å·²æ›´æ–°') ||
                                (content.includes('æˆåŠŸ') && content.includes('Databricks'))
                            );
                            
                            if (containsSuccess && !updateCompleteDetected) {
                                console.log('ğŸ‰ ä»æµå¼å›å¤ä¸­æ£€æµ‹åˆ°Databricksæ›´æ–°å®Œæˆ');
                                updateCompleteDetected = true;
                                
                                setTimeout(() => {
                                    if (listenerActive) {
                                        showRunCodeCard();
                                        handleRealtimeAgentMessage = originalHandleRealtimeAgentMessage;
                                        handleStreamChat = originalHandleStreamChat;
                                        listenerActive = false;
                                    }
                                }, 2000);
                            }
                        }
                    }, 1000);
                }
                
                return result;
            } catch (error) {
                console.error('å¢å¼ºæµå¼å¤„ç†å™¨é”™è¯¯:', error);
                throw error;
            }
        }
        
        // ä¸´æ—¶æ›¿æ¢å¤„ç†å‡½æ•°
        handleRealtimeAgentMessage = databricksUpdateListener;
        handleStreamChat = enhancedStreamHandler;
        
        // 15ç§’åæ¢å¤åŸå§‹å‡½æ•°ï¼ˆé˜²æ­¢é•¿æ—¶é—´æ›¿æ¢ï¼‰
        setTimeout(() => {
            if (listenerActive) {
                handleRealtimeAgentMessage = originalHandleRealtimeAgentMessage;
                handleStreamChat = originalHandleStreamChat;
                listenerActive = false;
                console.log('â° Databricksæ›´æ–°ç›‘å¬å™¨è¶…æ—¶ï¼Œå·²æ¢å¤åŸå§‹å¤„ç†å‡½æ•°');
            }
        }, 15000);
    }

    // ===== æ»šåŠ¨åŠŸèƒ½ =====
    
    /**
     * å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
     */
    function scrollToBottomSmooth() {
        requestAnimationFrame(() => {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        });
    }
    
    // ===== æ€è€ƒæ¡†ç®¡ç†ç³»ç»Ÿ =====
    
    /**
     * æ™ºèƒ½æ¶ˆæ¯æ’å…¥å‡½æ•° - ç¡®ä¿æ€è€ƒæ¡†å§‹ç»ˆåœ¨åº•éƒ¨
     * @param {Element} messageElement - è¦æ’å…¥çš„æ¶ˆæ¯å…ƒç´ 
     * @param {Element} messagesContainer - æ¶ˆæ¯å®¹å™¨
     */
    function insertMessageBeforeThinking(messageElement, messagesContainer) {
        // ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨çš„æ’å…¥æ–¹æ³•
        return messageManager.insertBeforeThinking(messageElement, messagesContainer);
    }
    
    /**
     * æ˜¾ç¤ºæ€è€ƒæ¡†
     */
    function showThinkingBox() {
        console.log('ğŸ¯ showThinkingBox è¢«è°ƒç”¨ (ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨)');
        
        // ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨å¯åŠ¨æ€è€ƒæ¡†
        const messageId = messageManager.startThinking(currentSessionId);
        
        console.log('âœ… æ€è€ƒæ¡†å·²é€šè¿‡æ¶ˆæ¯ç®¡ç†å™¨åˆ›å»º', messageId);
        
        return messageId;
    }
    
    /**
     * éšè—æ€è€ƒæ¡†
     */
    function hideThinkingBox() {
        console.log('ğŸ”„ hideThinkingBox è¢«è°ƒç”¨ (ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨)');
        
        // ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨ç»“æŸæ€è€ƒæ¡†
        messageManager.endThinking();
        
        console.log('âœ… æ€è€ƒæ¡†å·²é€šè¿‡æ¶ˆæ¯ç®¡ç†å™¨éšè—');
    }
    
    /**
     * æ·»åŠ æˆ–æ›´æ–°æ€è€ƒæ­¥éª¤
     */
    function updateThinkingStep(nodeName, status, message) {
        console.log(`ğŸ”„ updateThinkingStep è°ƒç”¨:`, {
            nodeName,
            status,
            message,
            thinkingVisible: messageManager.thinkingState.visible
        });
        
        // ä½¿ç”¨æ¶ˆæ¯ç®¡ç†å™¨æ›´æ–°æ€è€ƒè¿›åº¦
        messageManager.updateThinkingProgress(nodeName, status, message);
        
        // å…¼å®¹æ—§ä»£ç ï¼šåŒæ—¶æ›´æ–°å…¨å±€å˜é‡ä¸­çš„æ€è€ƒæ­¥éª¤
        if (messageManager.thinkingState.visible && messageManager.thinkingState.messageId) {
            thinkingSteps.set(nodeName, { status, message, timestamp: Date.now() });
        }
    }
    
    /**
     * å¤„ç†æ€è€ƒæ­¥éª¤æ›´æ–°çš„æ ¸å¿ƒé€»è¾‘ - æ›¿æ¢å¼æ˜¾ç¤º
     */
    function processThinkingStep(thinkingContent, nodeName, status, message) {
        console.log(`ğŸ¯ processThinkingStep æ‰§è¡Œ:`, { nodeName, status, message });
        
        // æ ¹æ®çŠ¶æ€è®¾ç½®å›¾æ ‡å’Œæ ·å¼
        let icon = '';
        let statusClass = '';
        let detail = '';
        
        switch(status) {
            case 'started':
                icon = 'ğŸ”„';
                statusClass = 'current';
                detail = 'æ­£åœ¨æ‰§è¡Œ...';
                break;
            case 'processing':
                icon = 'âš™ï¸';
                statusClass = 'current';
                detail = 'å¤„ç†ä¸­...';
                break;
            case 'completed':
                icon = 'âœ…';
                statusClass = 'completed';
                detail = 'å®Œæˆ';
                break;
            case 'failed':
                icon = 'âŒ';
                statusClass = 'failed';
                detail = 'å¤±è´¥';
                break;
            default:
                icon = 'â„¹ï¸';
                statusClass = 'current';
                detail = 'è¿›è¡Œä¸­...';
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰çš„å½“å‰æ­¥éª¤
        let currentStep = thinkingContent.querySelector('.thinking-step.current');
        
        if (currentStep && status !== 'completed' && status !== 'failed') {
            // å¦‚æœæœ‰å½“å‰æ­¥éª¤ä¸”æ–°çŠ¶æ€ä¸æ˜¯å®ŒæˆçŠ¶æ€ï¼Œåˆ™æ›¿æ¢å†…å®¹
            console.log(`ğŸ”„ æ›¿æ¢å½“å‰æ­¥éª¤å†…å®¹: ${message}`);
            currentStep.innerHTML = `
                <div class="thinking-step-text">${message || nodeName}</div>
                <div class="thinking-step-detail">${detail}</div>
            `;
        } else {
            // å¦‚æœæ²¡æœ‰å½“å‰æ­¥éª¤ï¼Œæˆ–è€…çŠ¶æ€æ˜¯å®Œæˆ/å¤±è´¥ï¼Œåˆ›å»ºæ–°æ­¥éª¤
            console.log(`âœ¨ åˆ›å»ºæ–°çš„æ€è€ƒæ­¥éª¤: ${nodeName} -> ${status}`);
            
            // å°†ä¹‹å‰çš„currentæ­¥éª¤æ ‡è®°ä¸ºå®Œæˆ
            if (currentStep && (status === 'completed' || status === 'failed')) {
                currentStep.classList.remove('current');
                currentStep.classList.add('completed');
                const detailEl = currentStep.querySelector('.thinking-step-detail');
                if (detailEl) {
                    detailEl.textContent = 'å®Œæˆ';
                }
            }
            
            // åˆ›å»ºæ–°æ­¥éª¤
            const stepElement = document.createElement('div');
            stepElement.className = `thinking-step ${statusClass}`;
            stepElement.innerHTML = `
                <div class="thinking-step-text">${message || nodeName}</div>
                <div class="thinking-step-detail">${detail}</div>
            `;
            
            // æ›¿æ¢æ‰€æœ‰å†…å®¹ä¸ºæ–°æ­¥éª¤ï¼ˆå•ä¸€æ˜¾ç¤ºï¼‰
            thinkingContent.innerHTML = '';
            thinkingContent.appendChild(stepElement);
            console.log(`âœ… æ€è€ƒæ¡†å†…å®¹å·²æ›¿æ¢ä¸ºæ–°æ­¥éª¤: ${message}`);
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨ä»¥æ˜¾ç¤ºæœ€æ–°æ­¥éª¤
        scrollToBottomSmooth();
        
        console.log(`ğŸ¤” æ€è€ƒæ­¥éª¤å¤„ç†å®Œæˆ: ${nodeName} - ${status} - ${message}`);
    }
    
    /**
     * æ·»åŠ æ€è€ƒå®Œæˆæ­¥éª¤
     */
    function addThinkingCompleteStep() {
        if (!thinkingBoxVisible) return;
        
        // updateThinkingStep('final', 'completed', 'åˆ†æå®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆå›å¤');
        
        // ä¸å†è‡ªåŠ¨éšè—ï¼Œè®©æ€è€ƒæ¡†æŒç»­æ˜¾ç¤ºç›´åˆ°streamå“åº”å®Œæˆ
        console.log('ğŸ§  æ€è€ƒåˆ†æå®Œæˆï¼Œä¿æŒæ˜¾ç¤ºç›´åˆ°å›å¤å®Œæˆ');
    }

    // ===== é€šçŸ¥ç³»ç»Ÿ =====
    function showNotification(message, type = 'info', duration = 3000) {
        let notification = document.getElementById('statusNotification');
        let messageEl = document.getElementById('notificationMessage');

        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'statusNotification';
            notification.className = 'status-notification';

            messageEl = document.createElement('span');
            messageEl.id = 'notificationMessage';

            notification.appendChild(messageEl);
            document.body.appendChild(notification);
        }

        if (!messageEl) {
            messageEl = document.getElementById('notificationMessage');
        }

        messageEl.textContent = message;
        notification.className = `status-notification ${type} show`;

        setTimeout(() => {
            notification.classList.remove('show');
        }, duration);

        console.log(`ğŸ“¢ é€šçŸ¥: [${type.toUpperCase()}] ${message}`);
    }

    function showSuccess(message, duration = 2000) {
        showNotification(`âœ… ${message}`, 'success', duration);
    }

    function showError(message, duration = 4000) {
        showNotification(`âŒ ${message}`, 'error', duration);
    }

    function showWarning(message, duration = 3000) {
        showNotification(`âš ï¸ ${message}`, 'warning', duration);
    }

    function showInfo(message, duration = 2000) {
        showNotification(`â„¹ï¸ ${message}`, 'info', duration);
    }
    
    // ===== EDWç›¸å…³è¾…åŠ©å‡½æ•° =====
    
    /**
     * æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨
     */
    function showProgressIndicator(step, progress) {
        // åˆ›å»ºæˆ–æ›´æ–°è¿›åº¦æ¡
        let progressBar = document.getElementById('edw-progress-bar');
        if (!progressBar) {
            const messagesContainer = document.getElementById('chatMessages');
            const progressDiv = document.createElement('div');
            progressDiv.id = 'edw-progress-container';
            progressDiv.className = 'progress-container';
            progressDiv.innerHTML = `
                <div class="progress-header">
                    <span class="progress-step">${step}</span>
                    <span class="progress-percent">${progress}%</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div id="edw-progress-bar" class="progress-bar" style="width: ${progress}%"></div>
                </div>
            `;
            messagesContainer.appendChild(progressDiv);
        } else {
            // æ›´æ–°è¿›åº¦
            progressBar.style.width = progress + '%';
            const container = document.getElementById('edw-progress-container');
            container.querySelector('.progress-step').textContent = step;
            container.querySelector('.progress-percent').textContent = progress + '%';
        }
        
        // å®Œæˆåè‡ªåŠ¨ç§»é™¤
        if (progress >= 100) {
            setTimeout(() => {
                const container = document.getElementById('edw-progress-container');
                if (container) {
                    container.remove();
                }
            }, 1000);
        }
    }
    
    /**
     * æ˜¾ç¤ºåŸå§‹æºä»£ç 
     */
    function displayOriginalCode(codeData) {
        // æå–ä»£ç æ•°æ®
        const {
            table_name = 'æœªçŸ¥',
            branch_name = 'æœªçŸ¥',
            source_code = '',
            file_name = '',
            file_path = '',
            language = 'sql',
            base_tables = []
        } = codeData;
        
        // ğŸ¯ è‡ªåŠ¨åˆ‡æ¢åˆ°å·¥ä½œåŒºæ¨¡å¼å¹¶åŠ è½½ä»£ç 
        console.log('ğŸ”„ è‡ªåŠ¨åˆ‡æ¢åˆ°å·¥ä½œåŒºæ¨¡å¼æ˜¾ç¤ºä»£ç ');
        
        // åˆ‡æ¢åˆ°workspaceæ¨¡å¼
        if (currentPage !== 'workspace') {
            switchToWorkspaceMode('enhance');
            
            // ç­‰å¾…é¡µé¢åˆ‡æ¢å®Œæˆå†è®¾ç½®ä»£ç 
            setTimeout(() => {
                loadCodeToEditorWithMeta(source_code, table_name, language, codeData);
                // è‡ªåŠ¨åˆ‡æ¢åˆ°å¢å¼ºä»£ç æ ‡ç­¾é¡µ
                switchCodeTab('enhanced-code');
            }, 300);
        } else {
            // å·²ç»åœ¨workspaceæ¨¡å¼ï¼Œç›´æ¥åŠ è½½ä»£ç 
            loadCodeToEditorWithMeta(source_code, table_name, language, codeData);
            // è‡ªåŠ¨åˆ‡æ¢åˆ°å¢å¼ºä»£ç æ ‡ç­¾é¡µ
            switchCodeTab('enhanced-code');
        }
        
        // æ¸…ç©ºCREATE TABLEå’ŒALTER TABLEæ ‡ç­¾é¡µï¼ˆå› ä¸ºè¿™æ˜¯åŸå§‹ä»£ç ï¼Œè¿˜æ²¡æœ‰å¢å¼ºï¼‰
        const createTableContent = document.getElementById('createTableContent');
        const alterTableContent = document.getElementById('alterTableContent');
        if (createTableContent) {
            createTableContent.textContent = '-- ç­‰å¾…ç”ŸæˆCREATE TABLEè¯­å¥...';
        }
        if (alterTableContent) {
            alterTableContent.textContent = '-- ç­‰å¾…ç”ŸæˆALTER TABLEè¯­å¥...';
        }
        
        // åªæ˜¾ç¤ºç®€å•çš„æˆåŠŸæ¶ˆæ¯ï¼Œä¸æ˜¾ç¤ºç»¿è‰²ä»£ç æ¡†
        addMessage(`âœ… **ä»£ç è·å–æˆåŠŸ**\n\nå·²è·å–è¡¨ ${table_name} çš„åŸå§‹ä»£ç ï¼Œå·²æ›´æ–°åˆ°å³ä¾§ç¼–è¾‘å™¨ã€‚`, 'ai');
        showInfo(`å·²è·å–è¡¨ ${table_name} çš„æºä»£ç `, 2000);
    }
    
    /**
     * åŠ è½½ä»£ç åˆ°ç¼–è¾‘å™¨
     */
    function loadCodeToEditor(code, tableName, language) {
        const codeEditor = document.getElementById('codeEditor');
        const fileName = document.getElementById('fileName');
        
        if (codeEditor) {
            codeEditor.value = code;
            originalCode = code;
            codeEditor.style.opacity = '1';
            
            // è®¾ç½®è¯­è¨€ç±»å‹class
            codeEditor.className = `code-editor ${language === 'python' ? 'language-python' : 'language-sql'}`;
        }
        
        if (fileName) {
            fileName.textContent = `${tableName} - åŸå§‹ä»£ç `;
        }
        
        // æ˜¾ç¤ºä»£ç é¢æ¿
        const codePanel = document.querySelector('.code-panel');
        if (codePanel) {
            codePanel.classList.add('active');
        }
        
        // æ˜¾ç¤ºåŠ è½½æˆåŠŸæç¤º
        showInfo(`ä»£ç å·²è‡ªåŠ¨åŠ è½½åˆ°ç¼–è¾‘å™¨ - ${tableName}`, 2000);
    }
    
    /**
     * åŠ è½½ä»£ç åˆ°ç¼–è¾‘å™¨å¹¶æ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
     */
    function loadCodeToEditorWithMeta(code, tableName, language, codeData) {
        // æ›´æ–°æ–°çš„ä¸‰æ ‡ç­¾é¡µä»£ç ç¼–è¾‘å™¨
        const enhancedCodeContent = document.getElementById('enhancedCodeContent');
        const codeEditor = document.getElementById('codeEditor');
        const languageTag = document.getElementById('languageTag');
        const fileName = document.getElementById('fileName');
        const branchInfo = document.getElementById('branchInfo');
        const branchName = document.getElementById('branchName');
        
        if (!languageTag || !fileName) {
            console.error('âŒ ä»£ç ç¼–è¾‘å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
            showError('ä»£ç ç¼–è¾‘å™¨å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        // æ›´æ–°å¢å¼ºä»£ç æ ‡ç­¾é¡µï¼ˆç”¨äºæ˜¾ç¤ºGitHubè·å–çš„åŸå§‹ä»£ç ï¼‰
        if (enhancedCodeContent && code) {
            enhancedCodeContent.textContent = code;
            // åº”ç”¨è¯­æ³•é«˜äº®
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(enhancedCodeContent);
            }
        }
        
        // åŒæ—¶æ›´æ–°éšè—çš„textareaï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
        if (codeEditor) {
            codeEditor.value = code;
            codeEditor.style.opacity = '1';
            originalCode = code;
        }
        
        // æ›´æ–°è¯­è¨€æ ‡ç­¾å’Œæ–‡ä»¶å
        const languageDisplay = language === 'python' ? 'PYTHON' : 'SQL';
        languageTag.textContent = languageDisplay;
        
        // ä¿®å¤è¯­è¨€æ ‡ç­¾æ ·å¼
        if (language === 'sql') {
            languageTag.style.background = '#f29111';
            languageTag.style.borderColor = '#f29111';
            languageTag.style.color = 'white';
        } else if (language === 'python') {
            languageTag.style.background = '#306998';
            languageTag.style.borderColor = '#306998';
            languageTag.style.color = 'white';
        }
        
        // æ ¹æ®ä»£ç æ•°æ®ç±»å‹æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
        if (codeData && codeData.file_name) {
            fileName.textContent = codeData.file_name;
        } else {
            fileName.textContent = `${tableName} - åŸå§‹ä»£ç `;
        }
        
        // æ›´æ–°å…ƒæ•°æ®ä¿¡æ¯é¢æ¿
        if (codeData) {
            const {
                file_name = '',
                branch_name = 'æœªçŸ¥',
                base_tables = []
            } = codeData;
            
            // æ˜¾ç¤ºåˆ†æ”¯ä¿¡æ¯åœ¨headerä¸­
            if (branch_name && branchName && branchInfo) {
                branchName.textContent = branch_name;
                branchInfo.style.display = 'flex';
            } else if (branchInfo) {
                branchInfo.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºä»£ç é¢æ¿
        const codePanel = document.querySelector('.code-panel');
        if (codePanel) {
            codePanel.classList.add('active');
        }
        
        // æ›´æ–°å…¨å±€å˜é‡
        currentFile = {
            name: codeData?.file_name || `${tableName}.${language === 'python' ? 'py' : 'sql'}`,
            language: language,
            path: codeData?.file_path || '',
            table_name: tableName
        };
        
        // æ˜¾ç¤ºåŠ è½½æˆåŠŸæç¤º
        showInfo(`ä»£ç å·²è‡ªåŠ¨åŠ è½½åˆ°ç¼–è¾‘å™¨ - ${tableName}`, 2000);
    }
    
    /**
     * åœ¨ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºä»£ç 
     */
    function showCodeInEditor(code, tableName) {
        // å¦‚æœå½“å‰ä¸åœ¨workspaceæ¨¡å¼ï¼Œåˆ‡æ¢åˆ°workspaceæ¨¡å¼
        if (currentPage !== 'workspace') {
            switchToWorkspaceMode('enhance');
            
            // ç­‰å¾…é¡µé¢åˆ‡æ¢å®Œæˆå†è®¾ç½®ä»£ç 
            setTimeout(() => {
                const codeEditor = document.getElementById('codeEditor');
                const fileName = document.getElementById('fileName');
                
                if (codeEditor) {
                    codeEditor.value = code;
                    originalCode = code;
                    codeEditor.style.opacity = '1';
                }
                
                if (fileName) {
                    fileName.textContent = `${tableName} - åŸå§‹ä»£ç `;
                }
                
                // æ˜¾ç¤ºä»£ç é¢æ¿
                const codePanel = document.querySelector('.code-panel');
                if (codePanel) {
                    codePanel.classList.add('active');
                }
                
                showInfo('ä»£ç å·²åŠ è½½åˆ°ç¼–è¾‘å™¨', 1500);
            }, 300);
        } else {
            // å·²ç»åœ¨workspaceæ¨¡å¼ï¼Œç›´æ¥è®¾ç½®ä»£ç 
            const codeEditor = document.getElementById('codeEditor');
            const fileName = document.getElementById('fileName');
            
            if (codeEditor) {
                codeEditor.value = code;
                originalCode = code;
                codeEditor.style.opacity = '1';
            }
            
            if (fileName) {
                fileName.textContent = `${tableName} - åŸå§‹ä»£ç `;
            }
            
            // æ˜¾ç¤ºä»£ç é¢æ¿
            const codePanel = document.querySelector('.code-panel');
            if (codePanel) {
                codePanel.classList.add('active');
            }
            
            showInfo('ä»£ç å·²åŠ è½½åˆ°ç¼–è¾‘å™¨', 1500);
        }
    }
    
    /**
     * æ˜¾ç¤ºå¢å¼ºåçš„ä»£ç 
     */
    function displayEnhancedCode(data) {
        const code = data.content || '';
        const tableName = data.table_name || 'æœªçŸ¥';
        const filePath = data.file_path || data.adb_path || '';
        const enhancementMode = data.enhancement_mode || 'initial_enhancement';
        const fieldsCount = data.fields_count || 0;
        
        // ğŸ¯ åªæ›´æ–°å³ä¾§ä»£ç ç¼–è¾‘å™¨ï¼ˆæ‰€æœ‰ä¸‰ä¸ªæ ‡ç­¾é¡µï¼‰
        const enhancedCodeContent = document.getElementById('enhancedCodeContent');
        const createTableContent = document.getElementById('createTableContent');
        const alterTableContent = document.getElementById('alterTableContent');
        const codeEditor = document.getElementById('codeEditor');
        const createTableEditor = document.getElementById('createTableEditor');
        const alterTableEditor = document.getElementById('alterTableEditor');
        const languageTag = document.getElementById('languageTag');
        const fileName = document.getElementById('fileName');
        
        // æ›´æ–°å¢å¼ºä»£ç æ ‡ç­¾é¡µ
        if (enhancedCodeContent && code) {
            enhancedCodeContent.textContent = code;
            // åŒæ—¶æ›´æ–°éšè—çš„textareaï¼ˆç”¨äºç¼–è¾‘æ¨¡å¼ï¼‰
            if (codeEditor) {
                codeEditor.value = code;
            }
            // åº”ç”¨è¯­æ³•é«˜äº®
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(enhancedCodeContent);
            }
        }
        
        // æ›´æ–°CREATE TABLEæ ‡ç­¾é¡µ
        if (createTableContent && data.create_table_sql) {
            createTableContent.textContent = data.create_table_sql;
            if (createTableEditor) {
                createTableEditor.value = data.create_table_sql;
            }
            // åº”ç”¨è¯­æ³•é«˜äº®
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(createTableContent);
            }
        }
        
        // æ›´æ–°ALTER TABLEæ ‡ç­¾é¡µ
        if (alterTableContent && data.alter_table_sql) {
            alterTableContent.textContent = data.alter_table_sql;
            if (alterTableEditor) {
                alterTableEditor.value = data.alter_table_sql;
            }
            // åº”ç”¨è¯­æ³•é«˜äº®
            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(alterTableContent);
            }
        }
        
        // æ›´æ–°æ–‡ä»¶åå’Œè¯­è¨€æ ‡ç­¾
        if (fileName && filePath) {
            const fileNameOnly = filePath.split('/').pop() || filePath.split('\\').pop() || 'enhanced_code.sql';
            fileName.textContent = fileNameOnly;
            fileName.title = filePath;
        }
        
        if (languageTag) {
            const language = filePath.endsWith('.py') ? 'PYTHON' : 'SQL';
            languageTag.textContent = language;
            languageTag.className = `language-tag ${language.toLowerCase()}`;
        }
        
        // è‡ªåŠ¨åˆ‡æ¢åˆ°å¢å¼ºä»£ç æ ‡ç­¾é¡µ
        switchCodeTab('enhanced-code');
        
        console.log('âœ… å³ä¾§ä»£ç ç¼–è¾‘å™¨å·²æ›´æ–°ï¼ˆåŒ…å«æ‰€æœ‰æ ‡ç­¾é¡µï¼‰');
        console.log('  - å¢å¼ºä»£ç :', code ? code.length + ' å­—ç¬¦' : 'æ— ');
        console.log('  - CREATE TABLE:', data.create_table_sql ? data.create_table_sql.length + ' å­—ç¬¦' : 'æ— ');
        console.log('  - ALTER TABLE:', data.alter_table_sql ? data.alter_table_sql.length + ' å­—ç¬¦' : 'æ— ');
    }
    
    /**
     * æ˜¾ç¤ºå¾®è°ƒåçš„ä»£ç 
     */
    function displayRefinedCode(code, round) {
        const messagesContainer = document.getElementById('chatMessages');
        const codeDiv = document.createElement('div');
        codeDiv.className = 'message ai refined-code';
        codeDiv.innerHTML = `
            <div class="refined-code-header">
                âœ¨ <strong>ä»£ç å¾®è°ƒå®Œæˆ</strong> - ç¬¬${round}è½®
            </div>
            <pre><code class="language-sql">${escapeHtml(code)}</code></pre>
            <div class="code-actions">
                <button onclick="copyToClipboard('${escapeHtml(code).replace(/'/g, "\\'")}')">ğŸ“‹ å¤åˆ¶ä»£ç </button>
            </div>
        `;
        messagesContainer.appendChild(codeDiv);
        
        // åº”ç”¨è¯­æ³•é«˜äº®
        if (typeof Prism !== 'undefined') {
            Prism.highlightAllUnder(codeDiv);
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
    
    /**
     * å¤„ç†ä¸­æ–­æç¤º
     */
    function handleInterruptPrompt(prompt, nodeName) {
        // ğŸ¯ æ–°å¢ï¼šæ”¶åˆ°ä¸­æ–­æ¶ˆæ¯æ—¶ç«‹å³éšè—æ€è€ƒæ¡†
        if (messageManager.thinkingState.visible) {
            console.log('ğŸ’­ æ”¶åˆ°ä¸­æ–­æ¶ˆæ¯ï¼Œéšè—æ€è€ƒæ¡†');
            messageManager.endThinking();
        }
        
        // æ·»åŠ ä¸­æ–­æç¤ºæ¶ˆæ¯ï¼Œä½¿ç”¨æ™®é€šAIæ¶ˆæ¯æ ·å¼
        const messagesContainer = document.getElementById('chatMessages');
        const interruptDiv = document.createElement('div');
        interruptDiv.className = 'message ai';
        
        try {
            // æ£€æŸ¥æ˜¯å¦ä¸ºmarkdownæ ¼å¼ï¼ˆåŒ…å«markdownç‰¹å¾ï¼‰
            const isMarkdownFormat = /^#+\s|```[\s\S]*?```|\*\*[\s\S]*?\*\*|^\s*[-\*\+]|\[.*?\]\(.*?\)|^\s*\d+\./m.test(prompt);
            
            let processedContent;
            if (isMarkdownFormat) {
                // ä½¿ç”¨markdownæ¸²æŸ“
                console.log('ğŸ”„ æ£€æµ‹åˆ°markdownæ ¼å¼çš„ä¸­æ–­æç¤ºï¼Œè¿›è¡Œæ¸²æŸ“');
                processedContent = marked.parse(prompt);
            } else {
                // æ™®é€šæ–‡æœ¬å¤„ç†
                const naturalPrompt = `ğŸ’­ ${escapeHtml(prompt)}\n\nè¯·æ‚¨åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­æä¾›æ‚¨çš„åé¦ˆæˆ–å»ºè®®ï¼Œç„¶åç‚¹å‡»å‘é€ã€‚`;
                processedContent = naturalPrompt.replace(/\n/g, '<br>');
            }
            
            interruptDiv.innerHTML = `
                <div class="avatar">ğŸ¤–</div>
                <div class="message-content">${processedContent}</div>
            `;
            
        } catch (error) {
            console.error('âŒ å¤„ç†ä¸­æ–­æç¤ºmarkdownå¤±è´¥ï¼Œå›é€€åˆ°çº¯æ–‡æœ¬:', error);
            // é™çº§å¤„ç†
            const naturalPrompt = `ğŸ’­ ${escapeHtml(prompt)}\n\nè¯·æ‚¨åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­æä¾›æ‚¨çš„åé¦ˆæˆ–å»ºè®®ï¼Œç„¶åç‚¹å‡»å‘é€ã€‚`;
            interruptDiv.innerHTML = `
                <div class="avatar">ğŸ¤–</div>
                <div class="message-content">${naturalPrompt.replace(/\n/g, '<br>')}</div>
            `;
        }
        
        messagesContainer.appendChild(interruptDiv);
        
        // å¤„ç†ä»£ç å—ï¼ˆå¦‚æœæœ‰ï¼‰
        setTimeout(() => {
            processCodeBlocksInMessage(interruptDiv);
        }, 50);
        
        // æ ‡è®°ç­‰å¾…ä¸­æ–­å“åº”
        window.waitingForInterruptResponse = true;
        window.currentInterruptNode = nodeName;
        
        // èšç„¦è¾“å…¥æ¡†
        document.getElementById('chatInput').focus();
        
        // æ›´æ–°è¾“å…¥æ¡†æç¤º - ä½¿ç”¨æ›´è‡ªç„¶çš„æç¤º
        document.getElementById('chatInput').placeholder = 'è¯·å›å¤ä¸Šé¢çš„é—®é¢˜...';
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
    
    /**
     * æ›´æ–°èŠ‚ç‚¹çŠ¶æ€
     */
    function updateNodeStatus(nodeName, status, message) {
        console.log(`ğŸ“Š èŠ‚ç‚¹ ${nodeName} çŠ¶æ€: ${status} - ${message}`);
        
        // æ”¶åˆ°ä»»ä½•èŠ‚ç‚¹çŠ¶æ€æ—¶ï¼Œå¦‚æœæ€è€ƒæ¡†ä¸å¯è§å°±æ˜¾ç¤ºå®ƒ
        if (!messageManager.thinkingState.visible) {
            console.log('ğŸ¤” é¦–æ¬¡æ”¶åˆ°èŠ‚ç‚¹çŠ¶æ€ï¼Œæ˜¾ç¤ºæ€è€ƒæ¡†');
            messageManager.startThinking(currentSessionId);
        }
        
        // æ›´æ–°æ€è€ƒæ­¥éª¤
        if (messageManager.thinkingState.visible) {
            console.log(`ğŸ”„ æ›´æ–°æ€è€ƒæ­¥éª¤: ${nodeName} -> ${status}`);
            updateThinkingStep(nodeName, status, message);
        } else {
            console.log('âš ï¸ æ€è€ƒæ¡†ä¸å¯è§ï¼Œè·³è¿‡æ­¥éª¤æ›´æ–°');
        }
        
        // é”™è¯¯çŠ¶æ€é¢å¤–æ˜¾ç¤ºé”™è¯¯æç¤º
        if (status === 'failed' || status === 'error') {
            showError(`èŠ‚ç‚¹ ${nodeName} æ‰§è¡Œå¤±è´¥: ${message}`, 5000);
        }
    }
    
    /**
     * æ›´æ–°èŠ‚ç‚¹çŠ¶æ€ï¼ˆå¸¦æ‚¬åœæ•°æ®ï¼‰
     * ç”¨äºå·¥å…·æ‰§è¡Œæ—¶ï¼Œå‚æ•°é€šè¿‡æ‚¬åœæ˜¾ç¤º
     */
    function updateNodeStatusWithHoverData(nodeName, status, message, hoverData) {
        console.log(`ğŸ“Š èŠ‚ç‚¹ ${nodeName} çŠ¶æ€: ${status} - ${message} (å¸¦æ‚¬åœæ•°æ®)`);
        
        // æ”¶åˆ°ä»»ä½•èŠ‚ç‚¹çŠ¶æ€æ—¶ï¼Œå¦‚æœæ€è€ƒæ¡†ä¸å¯è§å°±æ˜¾ç¤ºå®ƒ
        if (!messageManager.thinkingState.visible) {
            console.log('ğŸ¤” é¦–æ¬¡æ”¶åˆ°èŠ‚ç‚¹çŠ¶æ€ï¼Œæ˜¾ç¤ºæ€è€ƒæ¡†');
            messageManager.startThinking(currentSessionId);
        }
        
        // ä½¿ç”¨å¸¦æ‚¬åœåŠŸèƒ½çš„æ›´æ–°æ–¹æ³•
        if (messageManager.thinkingState.visible) {
            console.log(`ğŸ”„ æ›´æ–°æ€è€ƒæ­¥éª¤ï¼ˆå¸¦æ‚¬åœï¼‰: ${nodeName} -> ${status}`);
            messageManager.updateThinkingProgressWithHover(nodeName, status, message, hoverData);
        } else {
            console.log('âš ï¸ æ€è€ƒæ¡†ä¸å¯è§ï¼Œè·³è¿‡æ­¥éª¤æ›´æ–°');
        }
        
        // é”™è¯¯çŠ¶æ€é¢å¤–æ˜¾ç¤ºé”™è¯¯æç¤º
        if (status === 'failed' || status === 'error') {
            showError(`èŠ‚ç‚¹ ${nodeName} æ‰§è¡Œå¤±è´¥: ${message}`, 5000);
        }
    }
    
    /**
     * åˆ‡æ¢ä»£ç æ ‡ç­¾é¡µ
     */
    function switchCodeTab(tabName) {
        // æ›´æ–°æ ‡ç­¾æ ·å¼
        document.querySelectorAll('.code-tab').forEach(tab => {
            if (tab.dataset.tab === tabName) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // æ›´æ–°å†…å®¹é¢æ¿
        document.querySelectorAll('.tab-pane').forEach(pane => {
            if (pane.dataset.pane === tabName) {
                pane.classList.add('active');
            } else {
                pane.classList.remove('active');
            }
        });
    }
    
    /**
     * å¤åˆ¶ä»£ç å†…å®¹
     */
    function copyCodeContent(type) {
        let content = '';
        if (type === 'enhanced') {
            const codeElement = document.getElementById('enhancedCodeContent');
            const textarea = document.getElementById('codeEditor');
            content = codeElement ? codeElement.textContent : (textarea ? textarea.value : '');
        } else if (type === 'create') {
            const codeElement = document.getElementById('createTableContent');
            content = codeElement ? codeElement.textContent : '';
        } else if (type === 'alter') {
            const codeElement = document.getElementById('alterTableContent');
            content = codeElement ? codeElement.textContent : '';
        }
        
        if (content) {
            navigator.clipboard.writeText(content).then(() => {
                showSuccess('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 3000);
            });
        }
    }
    
    /**
     * åˆ‡æ¢å…¨å±æ¨¡å¼
     */
    function toggleFullscreen(type) {
        let displayElement = null;
        if (type === 'enhanced') {
            displayElement = document.getElementById('enhancedCodeDisplay');
        } else if (type === 'create') {
            displayElement = document.getElementById('createTableDisplay');
        } else if (type === 'alter') {
            displayElement = document.getElementById('alterTableDisplay');
        }
        
        if (displayElement) {
            if (!document.fullscreenElement) {
                displayElement.requestFullscreen().catch(err => {
                    console.error('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                    showError('å…¨å±æ¨¡å¼ä¸å¯ç”¨', 2000);
                });
            } else {
                document.exitFullscreen();
            }
        }
    }
    
    /**
     * åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
     */
    function toggleEditMode(type) {
        if (type !== 'enhanced') return; // åªæœ‰å¢å¼ºä»£ç æ”¯æŒç¼–è¾‘
        
        const displayElement = document.getElementById('enhancedCodeDisplay');
        const editorElement = document.getElementById('codeEditor');
        const button = event.target;
        
        if (displayElement && editorElement) {
            if (displayElement.style.display === 'none') {
                // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
                displayElement.style.display = 'block';
                editorElement.style.display = 'none';
                button.textContent = 'âœï¸ ç¼–è¾‘';
                
                // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                const codeContent = document.getElementById('enhancedCodeContent');
                if (codeContent) {
                    codeContent.textContent = editorElement.value;
                    // é‡æ–°åº”ç”¨è¯­æ³•é«˜äº®
                    if (typeof hljs !== 'undefined') {
                        hljs.highlightElement(codeContent);
                    }
                }
            } else {
                // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                displayElement.style.display = 'none';
                editorElement.style.display = 'block';
                button.textContent = 'ğŸ‘ï¸ æŸ¥çœ‹';
                editorElement.focus();
            }
        }
    }
    
    /**
     * å¤åˆ¶åˆ°å‰ªè´´æ¿
     */
    function copyToClipboard(text) {
        // è§£ç è½¬ä¹‰çš„æ–‡æœ¬
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        const decodedText = textarea.value;
        
        navigator.clipboard.writeText(decodedText).then(() => {
            showSuccess('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 3000);
        });
    }

    /**
     * æ˜¾ç¤ºCREATE TABLEè¯­å¥
     */
    function showCreateTableSQL(sql) {
        // è§£ç è½¬ä¹‰çš„æ–‡æœ¬
        const textarea = document.createElement('textarea');
        textarea.innerHTML = sql;
        const decodedSQL = textarea.value;
        
        // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºSQL
        const modal = document.createElement('div');
        modal.className = 'sql-modal';
        modal.innerHTML = `
            <div class="sql-modal-content">
                <div class="sql-modal-header">
                    <h3>ğŸ“ CREATE TABLE è¯­å¥</h3>
                    <button class="modal-close" onclick="this.closest('.sql-modal').remove()">âœ•</button>
                </div>
                <div class="sql-modal-body">
                    <pre><code class="language-sql">${escapeHtml(decodedSQL)}</code></pre>
                </div>
                <div class="sql-modal-footer">
                    <button onclick="copyToClipboard('${escapeHtml(decodedSQL).replace(/'/g, "\\'")}')">ğŸ“‹ å¤åˆ¶</button>
                    <button onclick="this.closest('.sql-modal').remove()">å…³é—­</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // åº”ç”¨è¯­æ³•é«˜äº®
        if (typeof Prism !== 'undefined') {
            Prism.highlightAllUnder(modal);
        }
    }

    /**
     * æ˜¾ç¤ºALTER TABLEè¯­å¥
     */
    function showAlterTableSQL(sql) {
        // è§£ç è½¬ä¹‰çš„æ–‡æœ¬
        const textarea = document.createElement('textarea');
        textarea.innerHTML = sql;
        const decodedSQL = textarea.value;
        
        // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºSQL
        const modal = document.createElement('div');
        modal.className = 'sql-modal';
        modal.innerHTML = `
            <div class="sql-modal-content">
                <div class="sql-modal-header">
                    <h3>ğŸ”§ ALTER TABLE è¯­å¥</h3>
                    <button class="modal-close" onclick="this.closest('.sql-modal').remove()">âœ•</button>
                </div>
                <div class="sql-modal-body">
                    <pre><code class="language-sql">${escapeHtml(decodedSQL)}</code></pre>
                </div>
                <div class="sql-modal-footer">
                    <button onclick="copyToClipboard('${escapeHtml(decodedSQL).replace(/'/g, "\\'")}')">ğŸ“‹ å¤åˆ¶</button>
                    <button onclick="this.closest('.sql-modal').remove()">å…³é—­</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // åº”ç”¨è¯­æ³•é«˜äº®
        if (typeof Prism !== 'undefined') {
            Prism.highlightAllUnder(modal);
        }
    }

    // ===== SocketIOç®¡ç† =====
    function initializeSocketIO() {
        try {
            socket = io('http://localhost:5000', {
                transports: ['websocket', 'polling'],
                autoConnect: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });

            socket.on('connect', function() {
                console.log('ğŸ”— SocketIOè¿æ¥æˆåŠŸ:', socket.id);
                socketConnected = true;
                // å·²ç§»é™¤å®æ—¶é€šä¿¡è¿æ¥æˆåŠŸæç¤º

                if (currentSessionId) {
                    joinSession(currentSessionId);
                }
            });

            socket.on('disconnect', function() {
                console.log('ğŸ”Œ SocketIOè¿æ¥æ–­å¼€');
                socketConnected = false;
                // å·²ç§»é™¤å®æ—¶é€šä¿¡è¿æ¥æ–­å¼€æç¤º
            });

            socket.on('connect_error', function(error) {
                console.error('âŒ SocketIOè¿æ¥é”™è¯¯:', error);
                socketConnected = false;
                // å·²ç§»é™¤å®æ—¶é€šä¿¡è¿æ¥å¤±è´¥æç¤º
            });

            socket.on('reconnect', function() {
                console.log('ğŸ”„ SocketIOé‡è¿æˆåŠŸ');
                socketConnected = true;
                // å·²ç§»é™¤å®æ—¶é€šä¿¡å·²æ¢å¤æç¤º

                if (currentSessionId) {
                    joinSession(currentSessionId);
                }
            });

            socket.on('agent_message', function(data) {
                console.log('ğŸ“¨ æ”¶åˆ°Agentå®æ—¶æ¶ˆæ¯:', data.type, data);
                handleRealtimeAgentMessage(data);
            });

            socket.on('session_joined', function(data) {
                console.log('ğŸ  å·²åŠ å…¥ä¼šè¯:', data.session_id);
                showInfo(`å·²åŠ å…¥ä¼šè¯ ${data.session_id.slice(-8)}`, 1500);
            });

            socket.on('session_left', function(data) {
                console.log('ğŸšª å·²ç¦»å¼€ä¼šè¯:', data.session_id);
            });

        } catch (error) {
            console.error('âŒ åˆå§‹åŒ–SocketIOå¤±è´¥:', error);
            // å·²ç§»é™¤å®æ—¶é€šä¿¡åˆå§‹åŒ–å¤±è´¥æç¤º
        }
    }

    function joinSession(sessionId) {
        if (socket && socketConnected) {
            socket.emit('join_session', { session_id: sessionId });
            console.log('ğŸ  åŠ å…¥ä¼šè¯æˆ¿é—´:', sessionId);
        }
    }

    function leaveSession(sessionId) {
        if (socket && socketConnected) {
            socket.emit('leave_session', { session_id: sessionId });
            console.log('ğŸšª ç¦»å¼€ä¼šè¯æˆ¿é—´:', sessionId);
        }
    }

    // ===== ä¼šè¯ç®¡ç† =====
    function updateSessionInfo(messageCount = null) {
        const sessionInfoElement = document.getElementById('sessionMessageCount');
        if (sessionInfoElement && currentSessionId) {
            if (messageCount) {
                sessionInfoElement.textContent = `${messageCount} æ¡æ¶ˆæ¯`;
            } else {
                sessionInfoElement.textContent = 'ä¼šè¯ä¸­...';
            }
        }
    }

    async function loadSessionHistory() {
        try {
            const response = await fetch('http://localhost:5000/api/sessions');
            const result = await response.json();

            if (result.success) {
                displaySessionList(result.data.sessions);
            }
        } catch (error) {
            console.error('åŠ è½½ä¼šè¯å†å²å¤±è´¥:', error);
        }
    }

    function displaySessionList(sessions) {
        const sessionList = document.getElementById('sessionList');

        if (!sessions || sessions.length === 0) {
            sessionList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— ä¼šè¯å†å²</div>';
            return;
        }

        sessionList.innerHTML = sessions.map(session => {
            const isActive = session.session_id === currentSessionId;
            const lastActivity = new Date(session.last_activity).toLocaleString();

            return `
                <div class="session-item ${isActive ? 'active' : ''}" data-session-id="${session.session_id}">
                    <div class="session-item-header">
                        <div class="session-id">${session.session_id.slice(-8)}...</div>
                        <div class="session-message-count">${session.message_count}</div>
                    </div>
                    <div class="session-last-activity">${lastActivity}</div>
                    <div class="session-actions">
                        <button class="session-load-btn" onclick="loadSession('${session.session_id}')">åŠ è½½</button>
                        <button class="session-clear-btn" onclick="clearSession('${session.session_id}')">æ¸…é™¤</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadSession(sessionId) {
        try {
            const response = await fetch(`http://localhost:5000/api/sessions/${sessionId}`);
            const result = await response.json();

            if (result.success) {
                currentSessionId = sessionId;

                // æ¸…ç©ºå½“å‰æ¶ˆæ¯ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
                const messagesContainer = document.getElementById('chatMessages');
                const welcomeMessage = messagesContainer.querySelector('.message.ai[data-stable="true"]');
                messagesContainer.innerHTML = '';
                if (welcomeMessage) {
                    messagesContainer.appendChild(welcomeMessage);
                }

                // æ¸…ç†æ³¨å†Œè¡¨
                agentMessageRegistry.clear();

                // åŠ è½½å†å²æ¶ˆæ¯
                const messages = result.data.messages;
                messages.forEach(message => {
                    addMessage(message.content, message.role === 'user' ? 'user' : 'ai');
                });

                // æ›´æ–°ä¼šè¯ä¿¡æ¯
                updateSessionInfo(result.data.session_info.message_count);

                // æ›´æ–°ä¼šè¯åˆ—è¡¨æ˜¾ç¤º
                loadSessionHistory();

                // å…³é—­ä¼šè¯é¢æ¿
                toggleSessionPanel();
            }
        } catch (error) {
            console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
        }
    }

    async function clearSession(sessionId) {
        if (!confirm('ç¡®å®šè¦æ¸…é™¤è¿™ä¸ªä¼šè¯çš„å†å²è®°å½•å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:5000/api/sessions/${sessionId}`, {
                method: 'DELETE'
            });
            const result = await response.json();

            if (result.success) {
                // å¦‚æœæ¸…é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œé‡ç½®å½“å‰ä¼šè¯
                if (sessionId === currentSessionId) {
                    currentSessionId = null;
                    updateSessionInfo();
                    agentMessageRegistry.clear();
                }

                // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                loadSessionHistory();
            }
        } catch (error) {
            console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', error);
        }
    }

    function toggleSessionPanel() {
        const sessionPanel = document.getElementById('sessionPanel');
        sessionPanelOpen = !sessionPanelOpen;

        if (sessionPanelOpen) {
            sessionPanel.classList.add('open');
            loadSessionHistory();
        } else {
            sessionPanel.classList.remove('open');
        }
    }

    // ===== å®šæœŸæ¸…ç†å‡½æ•° =====
    // å®šæœŸæ¸…ç†å¤„ç†çŠ¶æ€
    setInterval(() => {
        const now = Date.now();
        const oneHourAgo = now - (60 * 60 * 1000);

        messageProcessingStates.forEach((state, messageId) => {
            if (state.completedAt && state.completedAt < oneHourAgo) {
                messageProcessingStates.delete(messageId);
            }
        });

        console.log('ğŸ§¹ æ¸…ç†Markdownå¤„ç†çŠ¶æ€ï¼Œå½“å‰æ•°é‡:', messageProcessingStates.size);
    }, 300000); // æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

    // ===== åˆå§‹åŒ– =====
    // åˆ›å»ºè‡ªå®šä¹‰rendererï¼Œè®©é“¾æ¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
    const renderer = new marked.Renderer();
    
    // é‡å†™linkæ–¹æ³•ï¼Œæ·»åŠ target="_blank"å’Œrel="noopener noreferrer"
    renderer.link = function(href, title, text) {
        const titleAttr = title ? ` title="${title}"` : '';
        return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
    };
    
    marked.setOptions({
        renderer: renderer,  // ä½¿ç”¨è‡ªå®šä¹‰renderer
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
        tables: true,
        sanitize: false
    });

    // ===== é¦–é¡µè¾“å…¥æ¡†åŠŸèƒ½ =====
    
    /**
     * è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
     */
    function autoResizeSearchInput(element) {
        element.style.height = 'auto';
        element.style.height = Math.min(element.scrollHeight, 200) + 'px';
        
        // æ ¹æ®å†…å®¹è°ƒæ•´border-radius
        if (element.scrollHeight > 60) {
            element.style.borderRadius = '20px';
        } else {
            element.style.borderRadius = '30px';
        }
    }

    /**
     * åº”ç”¨è¾“å…¥å»ºè®® - å…¨å±€å‡½æ•°
     */
    window.applySuggestion = function(suggestionElement) {
        const suggestionText = suggestionElement.querySelector('.suggestion-text').textContent;
        const searchInput = document.getElementById('searchInput');
        
        // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
        searchInput.value = suggestionText;
        
        // è°ƒæ•´é«˜åº¦
        autoResizeSearchInput(searchInput);
        
        // èšç„¦è¾“å…¥æ¡†
        searchInput.focus();
        
        // ä¸å†åœ¨ç‚¹å‡»å»ºè®®æ—¶éšè—ï¼Œä¿æŒå»ºè®®å¯è§ç›´åˆ°å‘é€æ¶ˆæ¯
        
        // æ·»åŠ ä¸€ä¸ªå°çš„è§†è§‰åé¦ˆ
        suggestionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            suggestionElement.style.transform = 'translateY(-2px)';
        }, 150);
        
        console.log('ğŸ¯ åº”ç”¨å»ºè®®:', suggestionText);
    };

    // ===== èŠå¤©è¾“å…¥æ¡†åŠŸèƒ½ =====
    
    /**
     * è‡ªåŠ¨è°ƒæ•´èŠå¤©è¾“å…¥æ¡†é«˜åº¦
     */
    function autoResizeChatInput(element) {
        element.style.height = 'auto';
        element.style.height = Math.min(element.scrollHeight, 200) + 'px';
    }

    /**
     * åº”ç”¨èŠå¤©è¾“å…¥å»ºè®® - å…¨å±€å‡½æ•°
     */
    window.applyChatSuggestion = function(suggestionElement) {
        const suggestionText = suggestionElement.querySelector('.suggestion-text').textContent;
        const chatInput = document.getElementById('chatInput');
        
        // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
        chatInput.value = suggestionText;
        
        // è°ƒæ•´é«˜åº¦
        autoResizeChatInput(chatInput);
        
        // èšç„¦è¾“å…¥æ¡†
        chatInput.focus();
        
        // éšè—å»ºè®®
        hideChatSuggestions();
        
        // æ·»åŠ ä¸€ä¸ªå°çš„è§†è§‰åé¦ˆ
        suggestionElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
            suggestionElement.style.transform = 'translateY(-1px)';
        }, 150);
        
        console.log('ğŸ’¬ åº”ç”¨èŠå¤©å»ºè®®:', suggestionText);
    };

    /**
     * éšè—è¾“å…¥å»ºè®®
     */
    function hideSuggestions() {
        const suggestions = document.getElementById('inputSuggestions');
        if (suggestions) {
            suggestions.classList.add('hidden');
        }
    }

    /**
     * æ˜¾ç¤ºè¾“å…¥å»ºè®®
     */
    function showSuggestions() {
        const suggestions = document.getElementById('inputSuggestions');
        if (suggestions) {
            suggestions.classList.remove('hidden');
        }
    }

    /**
     * éšè—èŠå¤©è¾“å…¥å»ºè®®
     */
    function hideChatSuggestions() {
        const suggestions = document.getElementById('chatInputSuggestions');
        if (suggestions) {
            suggestions.classList.add('hidden');
        }
    }

    /**
     * æ˜¾ç¤ºèŠå¤©è¾“å…¥å»ºè®®
     */
    function showChatSuggestions() {
        const suggestions = document.getElementById('chatInputSuggestions');
        if (suggestions) {
            suggestions.classList.remove('hidden');
        }
    }

    // è®°å½•èŠå¤©å»ºè®®æ˜¯å¦åº”è¯¥æ°¸ä¹…éšè—ï¼ˆå‘é€æ¶ˆæ¯åï¼‰
    let chatSuggestionsPermanentlyHidden = false;

    /**
     * æ£€æŸ¥èŠå¤©è¾“å…¥å»ºè®®å¯è§æ€§
     */
    function checkChatSuggestionsVisibility() {
        const chatInput = document.getElementById('chatInput');
        const suggestions = document.getElementById('chatInputSuggestions');
        
        if (!chatInput || !suggestions) return;
        
        // å¦‚æœå»ºè®®è¢«æ°¸ä¹…éšè—ï¼Œä¸å†æ˜¾ç¤º
        if (chatSuggestionsPermanentlyHidden) {
            hideChatSuggestions();
            return;
        }
        
        // åªåœ¨è¾“å…¥æ¡†æœ‰å†…å®¹æˆ–è·å¾—ç„¦ç‚¹æ—¶éšè—å»ºè®®ï¼Œä¸ä¸»åŠ¨æ˜¾ç¤ºå»ºè®®
        if (chatInput.value.trim() || document.activeElement === chatInput) {
            hideChatSuggestions();
        }
        // ç§»é™¤elseåˆ†æ”¯ï¼Œä¸å†ä¸»åŠ¨æ˜¾ç¤ºå»ºè®®ï¼Œé¿å…ç‚¹å‡»ç©ºç™½å¤„é‡æ–°æ˜¾ç¤º
    }

    /**
     * æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºå»ºè®® - é¦–é¡µå»ºè®®ä¿æŒä¸€ç›´å¯è§
     */
    function checkSuggestionsVisibility() {
        const suggestions = document.getElementById('inputSuggestions');
        
        if (!suggestions) return;
        
        // é¦–é¡µå»ºè®®ä¿æŒä¸€ç›´æ˜¾ç¤ºï¼Œåªæœ‰åœ¨å‘é€æ¶ˆæ¯æ—¶æ‰éšè—
        if (currentPage === 'homepage') {
            showSuggestions();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // è®¾ç½®åˆå§‹é¡µé¢çŠ¶æ€
        currentPage = 'homepage';
        
        // åˆå§‹åŒ–èŠå¤©å»ºè®®çŠ¶æ€
        chatSuggestionsPermanentlyHidden = false;
        
        // åˆå§‹åŒ–é¦–é¡µè¾“å…¥æ¡†åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            searchInput.addEventListener('input', function() {
                autoResizeSearchInput(this);
                // ä¸å†åœ¨è¾“å…¥æ—¶æ£€æŸ¥å»ºè®®å¯è§æ€§ï¼Œä¿æŒä¸€ç›´æ˜¾ç¤º
            });
            
            // é”®ç›˜äº‹ä»¶å¤„ç†
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('searchBtn').click();
                }
            });
            
            // åˆå§‹åŒ–æ—¶ç¡®ä¿å»ºè®®å¯è§
            checkSuggestionsVisibility();
        }

        const codeEditor = document.getElementById('codeEditor');
        originalCode = codeEditor.value;

        // ç›‘å¬ä»£ç ç¼–è¾‘å™¨å˜åŒ–
        codeEditor.addEventListener('input', handleCodeChange);

        // ç›‘å¬å›è½¦é”®å’Œç‚¹å‡»äº‹ä»¶
        document.getElementById('searchBtn').addEventListener('click', handleSearch);
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleSearch();
        });

        // èŠå¤©è¾“å…¥æ¡†äº‹ä»¶
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', function() {
                autoResizeChatInput(this);
                checkChatSuggestionsVisibility();
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = this.value.trim() === '' || isProcessing;
            });
            
            // ç„¦ç‚¹äº‹ä»¶ - åªä¿ç•™focusäº‹ä»¶ï¼Œç§»é™¤bluräº‹ä»¶é¿å…ç‚¹å‡»ç©ºç™½å¤„é‡æ–°æ˜¾ç¤ºå»ºè®®
            chatInput.addEventListener('focus', function() {
                checkChatSuggestionsVisibility();
            });
            
            // åˆå§‹åŒ–æ—¶æ£€æŸ¥å»ºè®®å¯è§æ€§
            checkChatSuggestionsVisibility();
        }

        // èšç„¦æœç´¢æ¡†
        document.getElementById('searchInput').focus();


        // åˆå§‹åŒ–SocketIOè¿æ¥
        if (typeof io !== 'undefined') {
            initializeSocketIO();
        } else {
            console.log('â„¹ï¸ SocketIOåº“æœªåŠ è½½ï¼Œä½¿ç”¨åŸºç¡€é€šçŸ¥ç³»ç»Ÿ');
            // å·²ç§»é™¤å®æ—¶é€šä¿¡åº“æœªåŠ è½½æç¤º
        }

        // å¯åŠ¨Agentæ¶ˆæ¯ä¿æŠ¤
        startAgentMessageProtection();

        // é€šçŸ¥ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ˆå·²ç§»é™¤ç³»ç»Ÿå‡†å¤‡å°±ç»ªæç¤ºï¼‰

        // å®šæœŸæ¸…ç†æ¶ˆæ¯å»é‡è®°å½•å’Œæ¶ˆæ¯ç®¡ç†å™¨
        setInterval(() => {
            if (processedMessages.size > 1000) {
                processedMessages.clear();
                console.log('ğŸ§¹ æ¸…ç†æ¶ˆæ¯å»é‡è®°å½•');
            }
            
            // æ¸…ç†æ¶ˆæ¯ç®¡ç†å™¨ä¸­çš„è¿‡æœŸæ¶ˆæ¯
            messageManager.cleanupOldMessages();
        }, 300000);

        // å®šæœŸæ¸…ç†Agentæ³¨å†Œè¡¨ï¼ˆä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯ï¼‰
        setInterval(() => {
            const now = Date.now();
            const oneHourAgo = now - (60 * 60 * 1000);

            agentMessageRegistry.forEach((value, key) => {
                if (value.timestamp < oneHourAgo) {
                    agentMessageRegistry.delete(key);
                }
            });

            if (agentMessageRegistry.size > 100) {
                const entries = Array.from(agentMessageRegistry.entries());
                entries.sort((a, b) => b[1].timestamp - a[1].timestamp);
                agentMessageRegistry.clear();
                entries.slice(0, 50).forEach(([key, value]) => {
                    agentMessageRegistry.set(key, value);
                });
            }

            console.log('ğŸ§¹ æ¸…ç†Agentæ³¨å†Œè¡¨ï¼Œå½“å‰å¤§å°:', agentMessageRegistry.size);
        }, 600000); // æ¯10åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
    });
</script>
</body>
</html>